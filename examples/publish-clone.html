<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <style type="text/css">
        html, body {
            margin: 0;
            padding: 0;
        }
    </style>


    <script type="text/javascript">

        var start = (function() {

            function extractVal(params, name) {
                if (!params) return null;
                var res; if (res = params.match(
                    new RegExp('[\\?&]' + name + '=([\\w\\.\\-]+)')
                )) return (res.length && res[1]) ? res[1] : null;
            }

            function injectVal(params, name, value) {
                if (!params) return name + '=' + value;
                var res = params.match(
                    new RegExp('[\\?&]' + name + '=[\\w-]+' ));
                if (!res || !res.length) return params + '&' + name + '=' + value;
                return params.replace(
                    new RegExp('([\\?&])' + name + '=[\\w-]+'),
                    '$1' + name + '=' + value
                );
            }

            function getRequiredRect(params, w, h) {
                // w and h are precalculated scene sizes
                // so if there is iframe wrapper, return iframe size,
                // if there are width/height in params, return them,
                // else return these precalculated sizes
                var iframe = window.parent ? window.parent.frames[0] : null;
                if (iframe) return [ iframe.innerWidth, iframe.innerHeight ];
                var wParam = parseInt(extractVal(params, 'w')),
                    hParam = parseInt(extractVal(params, 'h'));
                if (wParam && hParam) return [ wParam, hParam ];
                if (w && h) return [ w, h ];
            }

            // >>> DIFF WITH ORIGINAL
            var _params_ = location.search;
                _prefix_ = 'animatron-snapshots.s3.amazonaws.com',
                _project_id_ = _params_ ? extractVal(_params_, 'sid') : '--no-project-id--';
            var rect = getRequiredRect(_params_);
            if (rect) { if (_params_) { _params_ = injectVal(_params_, 'w', rect[0]);
                                        _params_ = injectVal(_params_, 'h', rect[1]); }
                        else { _params_ = '?w=' + rect[0] + '&' + 'h=' + rect[1]; } }
            var _snapshotUrl_ ='http://' + _prefix_ + '/' + _project_id_ + (_params_ || '');
            // <<< DIFF WITH ORIGINAL

            // >>> ORIGINAL SHOULD BE
            /* var _params_ = location.search;
            var rect = getRequiredRect(_params_, _width_, _height_);
            if (rect) { if (_params_) { _params_ = injectVal(_params_, 'w', rect[0]);
                                        _params_ = injectVal(_params_, 'h', rect[1]); }
                        else { _params_ = '?w=' + rect[0] + '&' + 'h=' + rect[1]; } }
            var _snapshotUrl_ = _contentUrl_ + (_params_ || ''); */
            // <<< ORIGINAL SHOULD BE

            return function() {
                try {
                    //_forcedJS('http://player.animatron.com/latest/bundle/animatron.js', function() {
                    _forcedJS('../dist/full/bundle/animatron.js', function() {
                        anm.Player.forSnapshot('canvas1', _snapshotUrl_, new AnimatronImporter());
                    });
                } catch(e) {
                    if (console) console.error(e);
                    else alert(e.message);
                }
            }

            function _reportError(_e) {
                if (console) console.error(_e);
                else alert(_e.message);
            }

            function _forcedJS(_path, _then) {
                var scriptElm = document.createElement('script');
                scriptElm.type = 'text/javascript';
                scriptElm.async = 'async';
                scriptElm.src = _path + '?' + (new Date()).getTime();
                scriptElm.onload = scriptElm.onreadystatechange = (function() {
                    var _success = false;
                    return function() {
                        if ( !_success && (!this.readyState || (this.readyState == 'complete')) )
                        {
                            _success = true;
                            _then();
                        } else if (!_success) {
                            _reportError(new Error('Request failed: ' + this.readyState));
                        }
                    }
                })();
                scriptElm.onerror = _reportError;
                var headElm = document.head || document.getElementsByTagName('head')[0];
                headElm.appendChild(scriptElm);
            }

        })();
    </script>
</head>

<body onload="start();">
<canvas id="canvas1"></canvas>
</body>
</html>
