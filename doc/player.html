<!DOCTYPE html>

<html>
<head>
  <title>player.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="anm.html">
                anm.js
              </a>
            
              
              <a class="source" href="builder.html">
                builder.js
              </a>
            
              
              <a class="source" href="player.html">
                player.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>player.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/*
 * Copyright (c) 2011-2013 by Animatron.
 * All rights are reserved.
 *
 * Animatron player is licensed under the MIT License, see LICENSE.
 *
 * @VERSION
 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1>Player Core</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>This file contains only the Animatron Player core source code, without <em>Builder</em> or any <em>modules</em>
included. The player is written with as minimum publicily-visible classes as possible, but
its internal structure hides more things, of course. Code in the file goes in
natural order, mostly from general things to internal ones. However, to make
code work properly it is not always possible to keep this principle.</p>
<p>Here I&#39;ll give the actual order of things with few notes on each thing to make you have a good <em>view
from above</em>.</p>
<ul>
<li><strong>Utils</strong> —</li>
<li><strong>Constants</strong> —</li>
<li><strong>Modules</strong> —</li>
<li><strong>Player</strong> —<ul>
<li><em>Player Control API</em> —</li>
</ul>
</li>
<li><strong>Scene</strong> —</li>
<li><strong>Element</strong> —</li>
<li><strong>Import</strong> —</li>
<li><strong>Rendering</strong> —</li>
<li><strong>Bands</strong> —</li>
<li><strong>Tweens</strong> —</li>
<li><strong>Easings</strong> —</li>
<li><strong>Path</strong> —<ul>
<li><em>Segments</em> —</li>
</ul>
</li>
<li><strong>Text</strong> —</li>
<li><strong>Sheet</strong> -</li>
<li><strong>Brush</strong> -</li>
<li><strong>Controls</strong> —</li>
<li><strong>Info Block</strong> —</li>
<li><strong>Strings</strong> —</li>
<li><strong>Exports</strong> —</li>
</ul>
<blockquote>
<p>While doing future refactorings, I may change this order a bit accidently or rename some sections and
forget to update this list (blame me), so please do not consider it to be the very strict
and representing something more than a general feel of file.</p>
<p>NB: Comments are in very early progress</p>
</blockquote>
<p>So, let&#39;s start</p>
<h2>Module Definition</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(((<span class="keyword">typeof</span> __anm !== <span class="string">'undefined'</span>) &amp;&amp; __anm.registerPlayer) || <span class="keyword">function</span>() {
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Player namespace is not initialized'</span>);
})(<span class="keyword">function</span>($glob, $wnd, $doc) {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2>Utils</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3>Framing</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* ----------- */</span>

<span class="comment">/* http://www.html5canvastutorials.com/advanced/html5-canvas-start-and-stop-an-animation/
   http://www.w3.org/TR/animation-timing/
   https://gist.github.com/1579671 */</span>

<span class="keyword">var</span> __frameFunc = <span class="keyword">function</span>() {
           <span class="keyword">return</span> $wnd.requestAnimationFrame ||
                  $wnd.webkitRequestAnimationFrame ||
                  $wnd.mozRequestAnimationFrame ||
                  $wnd.oRequestAnimationFrame ||
                  $wnd.msRequestAnimationFrame ||
                  $wnd.__anm__frameGen ||
                  <span class="keyword">function</span>(callback){
                    <span class="keyword">return</span> $wnd.setTimeout(callback, <span class="number">1000</span> / <span class="number">60</span>);
                  } };

<span class="keyword">var</span> __clearFrameFunc = <span class="keyword">function</span>() {
           <span class="keyword">return</span> $wnd.cancelAnimationFrame ||
                  $wnd.webkitCancelAnimationFrame ||
                  $wnd.mozCancelAnimationFrame ||
                  $wnd.oCancelAnimationFrame ||
                  $wnd.msCancelAnimationFrame ||
                  $wnd.__anm__frameRem ||
                  <span class="keyword">function</span>(id){
                    <span class="keyword">return</span> $wnd.clearTimeout(id);
                  } };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>assigns to call a function on next animation frame</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> __nextFrame;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>stops the animation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* FIXME: remove, not used, __supressFrames is used */</span>
<span class="keyword">var</span> __stopAnim = <span class="keyword">function</span>(requestId) {
    __clearFrameFunc()(requestId);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h3>Events</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* ---------- */</span>

<span class="keyword">var</span> provideEvents = __anm.provideEvents;
<span class="keyword">var</span> registerEvent = __anm.registerEvent;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3>Errors</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* ---------- */</span>

<span class="keyword">var</span> SystemError = __errorAs(<span class="string">'SystemError'</span>);
<span class="keyword">var</span> SysErr = SystemError;

<span class="keyword">var</span> PlayerError = __errorAs(<span class="string">'PlayerError'</span>);
<span class="keyword">var</span> PlayerErr = PlayerError;

<span class="keyword">var</span> AnimationError = __errorAs(<span class="string">'AnimationError'</span>);
<span class="keyword">var</span> AnimErr = AnimationError;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h3>Internal utilities</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* ---------------------- */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>collects all characters from string
before specified char, starting from start</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">__collect_to</span><span class="params">(str, start, ch)</span> {</span>
    <span class="keyword">var</span> result = <span class="string">''</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = start; str[i] !== ch; i++) {
        <span class="keyword">if</span> (i === str.length) <span class="keyword">throw</span> <span class="keyword">new</span> SysErr(<span class="string">'Reached end of string'</span>);
        result += str[i];
    }
    <span class="keyword">return</span> result;
}

guid = __anm.guid;

<span class="comment">/*function _strhash() {
  var hash = 0;
  if (this.length == 0) return hash;
  for (i = 0; i &lt; this.length; i++) {
    char = this.charCodeAt(i);
    hash = ((hash&lt;&lt;5)-hash)+char;
    hash = hash &amp; hash; // Convert to 32bit integer
  }
  return hash;
}*/</span>

<span class="function"><span class="keyword">function</span> <span class="title">get_rgb</span><span class="params">(hex)</span> {</span>
  <span class="keyword">if</span> (!hex || !hex.length) <span class="keyword">return</span> [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>];
  <span class="keyword">var</span> _hex = hex.substring(<span class="number">1</span>);
  <span class="keyword">if</span> (_hex.length === <span class="number">3</span>) {
    _hex = _hex[<span class="number">0</span>] + _hex[<span class="number">0</span>] +
           _hex[<span class="number">1</span>] + _hex[<span class="number">1</span>] +
           _hex[<span class="number">2</span>] + _hex[<span class="number">2</span>];
  }
  <span class="keyword">var</span> bigint = parseInt(_hex, <span class="number">16</span>);
  <span class="keyword">return</span> [ (bigint &gt;&gt; <span class="number">16</span>) &amp; <span class="number">255</span>,
           (bigint &gt;&gt; <span class="number">8</span>) &amp; <span class="number">255</span>,
           bigint &amp; <span class="number">255</span> ];
}

<span class="function"><span class="keyword">function</span> <span class="title">to_rgba</span><span class="params">(r, g, b, a)</span> {</span>
  <span class="keyword">return</span> <span class="string">"rgba("</span> + Math.floor(r) + <span class="string">","</span> +
                   Math.floor(g) + <span class="string">","</span> +
                   Math.floor(b) + <span class="string">","</span> +
                   ((<span class="keyword">typeof</span> a !== <span class="string">'undefined'</span>)
                          ? a : <span class="number">1</span>) + <span class="string">")"</span>;
}

<span class="function"><span class="keyword">function</span> <span class="title">fmt_time</span><span class="params">(time)</span> {</span>
  <span class="keyword">var</span> _time = Math.abs(time),
        _h = Math.floor(_time / <span class="number">3600</span>),
        _m = Math.floor((_time - (_h * <span class="number">3600</span>)) / <span class="number">60</span>),
        _s = Math.floor(_time - (_h * <span class="number">3600</span>) - (_m * <span class="number">60</span>));

  <span class="keyword">return</span> ((time &lt; <span class="number">0</span>) ? <span class="string">'-'</span> : <span class="string">''</span>) +
          ((_h &gt; <span class="number">0</span>)  ? (((_h &lt; <span class="number">10</span>) ? (<span class="string">'0'</span> + _h) : _h) + <span class="string">':'</span>) : <span class="string">''</span>) +
          ((_m &lt; <span class="number">10</span>) ? (<span class="string">'0'</span> + _m) : _m) + <span class="string">':'</span> +
          ((_s &lt; <span class="number">10</span>) ? (<span class="string">'0'</span> + _s) : _s)
}

<span class="function"><span class="keyword">function</span> <span class="title">ell_text</span><span class="params">(text, max_len)</span> {</span>
  <span class="keyword">if</span> (!text) <span class="keyword">return</span> <span class="string">''</span>;
  <span class="keyword">var</span> _len = text.length;
  <span class="keyword">if</span> (_len &lt;= max_len) <span class="keyword">return</span> text;
  <span class="keyword">var</span> _semilen = Math.floor(_len / <span class="number">2</span>) - <span class="number">2</span>;
  <span class="keyword">return</span> text.slice(<span class="number">0</span>, _semilen) + <span class="string">'...'</span>
         + text.slice(_len - _semilen);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h3>Arrays</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* ---------- */</span>

<span class="function"><span class="keyword">function</span> <span class="title">StopIteration</span><span class="params">()</span> {</span>}

<span class="function"><span class="keyword">function</span> <span class="title">iter</span><span class="params">(a)</span> {</span>
    <span class="keyword">if</span> (a.__iter) {
        a.__iter.reset();
        <span class="keyword">return</span> a.__iter;
    }
    <span class="keyword">var</span> pos = <span class="number">0</span>,
        len = a.length;
    <span class="keyword">return</span> (a.__iter = {
        next: <span class="keyword">function</span>() {
                  <span class="keyword">if</span> (pos &lt; len) <span class="keyword">return</span> a[pos++];
                  pos = <span class="number">0</span>;
                  <span class="keyword">throw</span> <span class="keyword">new</span> StopIteration();
              },
        hasNext: <span class="keyword">function</span>() { <span class="keyword">return</span> (pos &lt; len); },
        remove: <span class="keyword">function</span>() { len--; <span class="keyword">return</span> a.splice(--pos, <span class="number">1</span>); },
        reset: <span class="keyword">function</span>() { pos = <span class="number">0</span>; len = a.length; },
        get: <span class="keyword">function</span>() { <span class="keyword">return</span> a[pos]; },
        each: <span class="keyword">function</span>(f, rf) {
                  <span class="keyword">this</span>.reset();
                  <span class="keyword">while</span> (<span class="keyword">this</span>.hasNext()) {
                    <span class="keyword">if</span> (f(<span class="keyword">this</span>.next()) === <span class="literal">false</span>) {
                        <span class="keyword">if</span> (rf) rf(<span class="keyword">this</span>.remove()); <span class="keyword">else</span> <span class="keyword">this</span>.remove();
                    }
                  }
              }
    });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h3>DOM</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* ------- */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>for one-level objects, so no hasOwnProperty check</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">obj_clone</span><span class="params">(what)</span> {</span>
    <span class="keyword">var</span> dest = {};
    <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> what) {
        dest[prop] = what[prop];
    }
    <span class="keyword">return</span> dest;
}

<span class="comment">/* FIXME: replace with elm.getBoundingClientRect();
   see http://stackoverflow.com/questions/8070639/find-elements-position-in-browser-scroll */</span>
<span class="function"><span class="keyword">function</span> <span class="title">find_pos</span><span class="params">(elm)</span> {</span>
    <span class="keyword">var</span> curleft = <span class="number">0</span>,
        curtop = <span class="number">0</span>;
    <span class="keyword">do</span> {
        curleft += elm.offsetLeft<span class="comment">/* - elm.scrollLeft*/</span>;
        curtop += elm.offsetTop<span class="comment">/* - elm.scrollTop*/</span>;
    } <span class="keyword">while</span> (elm = elm.offsetParent);
    <span class="keyword">return</span> [ curleft, curtop ];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h3>AJAX</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* -------- */</span>

<span class="function"><span class="keyword">function</span> <span class="title">ajax</span><span class="params">(url, callback, errback)</span> {</span>
    <span class="keyword">var</span> req = <span class="literal">false</span>;

    <span class="keyword">if</span> (!$wnd.ActiveXObject) {
        req = <span class="keyword">new</span> $wnd.XMLHttpRequest();
    } <span class="keyword">else</span> {
        <span class="keyword">try</span> {
            req = <span class="keyword">new</span> $wnd.ActiveXObject(<span class="string">"Msxml2.XMLHTTP"</span>);
        } <span class="keyword">catch</span> (e1) {
            <span class="keyword">try</span> {
                req = $wnd.ActiveXObject(<span class="string">"Microsoft.XMLHTTP"</span>);
            } <span class="keyword">catch</span> (e2) {
                <span class="keyword">throw</span> <span class="keyword">new</span> SysErr(<span class="string">'No AJAX/XMLHttp support'</span>);
            }
        }
    }

    <span class="comment">/*if (req.overrideMimeType) {
        req.overrideMimeType('text/xml');
      } */</span>

    <span class="keyword">if</span> (!req) {
      <span class="keyword">throw</span> <span class="keyword">new</span> SysErr(<span class="string">'Failed to create XMLHttp instance'</span>);
    }

    <span class="keyword">var</span> whenDone = <span class="keyword">function</span>() {
        <span class="keyword">if</span> (req.readyState == <span class="number">4</span>) {
            <span class="keyword">if</span> (req.status == <span class="number">200</span>) {
                <span class="keyword">if</span> (callback) callback(req);
            } <span class="keyword">else</span> {
                <span class="keyword">var</span> error = <span class="keyword">new</span> SysErr(<span class="string">'AJAX request for '</span> + url +
                                 <span class="string">' returned '</span> + req.status +
                                 <span class="string">' instead of 200'</span>);
                <span class="keyword">if</span> (errback) { errback(error, req); }
                <span class="keyword">else</span> { <span class="keyword">throw</span> error; }
            }
        }
    };

    req.onreadystatechange = whenDone;
    req.open(<span class="string">'GET'</span>, url, <span class="literal">true</span>);
    req.send(<span class="literal">null</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h3>Canvas-related Utilities</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* ---------------------------- */</span>

<span class="function"><span class="keyword">function</span> <span class="title">getPxRatio</span><span class="params">()</span> {</span> <span class="keyword">return</span> $wnd.devicePixelRatio || <span class="number">1</span>; }

<span class="keyword">var</span> DEF_CNVS_WIDTH = <span class="number">400</span>;
<span class="keyword">var</span> DEF_CNVS_HEIGHT = <span class="number">250</span>;
<span class="keyword">var</span> DEF_CNVS_BG = <span class="string">'#fff'</span>;

<span class="function"><span class="keyword">function</span> <span class="title">canvasOpts</span><span class="params">(canvas, opts, ratio)</span> {</span>
    <span class="keyword">var</span> isObj = !(opts <span class="keyword">instanceof</span> Array),
        _w = isObj ? opts.width : opts[<span class="number">0</span>],
        _h = isObj ? opts.height : opts[<span class="number">1</span>];
    <span class="keyword">if</span> (isObj &amp;&amp; opts.bgcolor &amp;&amp; opts.bgcolor.color) {
        canvas.style.backgroundColor = opts.bgcolor.color;
    }
    <span class="keyword">if</span> (isObj) {
        canvas.__anm_usr_x = opts.x;
        canvas.__anm_usr_y = opts.y;
    }
    canvas.__pxRatio = ratio;
    canvas.style.width = _w + <span class="string">'px'</span>;
    canvas.style.height = _h + <span class="string">'px'</span>;
    canvas.setAttribute(<span class="string">'width'</span>, _w * (ratio || <span class="number">1</span>));
    canvas.setAttribute(<span class="string">'height'</span>, _h * (ratio || <span class="number">1</span>));
}

<span class="function"><span class="keyword">function</span> <span class="title">newCanvas</span><span class="params">(dimen, ratio)</span> {</span>
    <span class="keyword">var</span> _canvas = $doc.createElement(<span class="string">'canvas'</span>);
    canvasOpts(_canvas, dimen, ratio);
    <span class="keyword">return</span> _canvas;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h3>Internal Helpers</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* -------------------- */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>value/typecheck</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> is = __anm.is;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>map back to functions for faster access (is it really so required?)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> __finite  = is.finite,
    __nan     = is.nan,
    __builder = is.builder,
    __arr     = is.arr,
    __num     = is.num,
    __fun     = is.fun,
    __obj     = is.obj,
    __str     = is.str;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h4>mathematics</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">__close</span><span class="params">(n1, n2, precision)</span> {</span>
    <span class="keyword">if</span> (!(precision === <span class="number">0</span>)) {
        precision = precision || <span class="number">2</span>;
    }
    <span class="keyword">var</span> multiplier = Math.pow(<span class="number">10</span>, precision);
    <span class="keyword">return</span> Math.round(n1 * multiplier) ==
           Math.round(n2 * multiplier);
}

<span class="function"><span class="keyword">function</span> <span class="title">__roundTo</span><span class="params">(n, precision)</span> {</span>
    <span class="keyword">if</span> (!precision) <span class="keyword">return</span> Math.round(n);</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>return n.toPrecision(precision);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> multiplier = Math.pow(<span class="number">10</span>, precision);
    <span class="keyword">return</span> Math.round(n * multiplier) / multiplier;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h4>other</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">__errorAs</span><span class="params">(name, _constructor, _toStr)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>FIXME: breaks instanceof due to re-using same constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> _producer = _constructor ?
    <span class="keyword">function</span>(message) {
      _constructor.apply(<span class="keyword">this</span>, arguments);
      <span class="keyword">if</span> (!<span class="keyword">this</span>.message) <span class="keyword">this</span>.message = message || <span class="string">''</span>;
      Error.apply(<span class="keyword">this</span>, arguments);
    } :
    <span class="keyword">function</span>(message) {
      <span class="keyword">this</span>.message = message || <span class="string">''</span>;
      Error.apply(<span class="keyword">this</span>, arguments);
    };
  <span class="comment">/* var _constructor = function(msg) { this.message = msg; } */</span>
  _producer.prototype = <span class="keyword">new</span> Error(); <span class="comment">//Error.prototype;</span>
  _producer.prototype.constructor = _producer;
  _producer.prototype.name = name || <span class="string">'Unknown'</span>;
  _producer.prototype.toString = _toStr || <span class="keyword">function</span>() { <span class="keyword">return</span> <span class="keyword">this</span>.name + (<span class="keyword">this</span>.message ? <span class="string">': '</span> + <span class="keyword">this</span>.message : <span class="string">''</span>); }
  <span class="keyword">return</span> _producer;
}

<span class="function"><span class="keyword">function</span> <span class="title">__paramsToObj</span><span class="params">(pstr)</span> {</span>
  <span class="keyword">var</span> o = {}, ps = pstr.split(<span class="string">'&amp;'</span>), i = ps.length, pair;
  <span class="keyword">while</span> (i--) { pair = ps[i].split(<span class="string">'='</span>); o[pair[<span class="number">0</span>]] = pair[<span class="number">1</span>]; }
  <span class="keyword">return</span> o;
}

<span class="function"><span class="keyword">function</span> <span class="title">_mrg_obj</span><span class="params">(src, backup)</span> {</span>
    <span class="keyword">if</span> (!backup) <span class="keyword">return</span> src;
    <span class="keyword">var</span> res = {};
    <span class="keyword">for</span> (prop <span class="keyword">in</span> backup) {
        res[prop] = (<span class="keyword">typeof</span> src[prop] !== <span class="string">'undefined'</span>) ? src[prop] : backup[prop]; };
    <span class="keyword">return</span> res;
}

<span class="function"><span class="keyword">function</span> <span class="title">_strf</span><span class="params">(str, subst)</span> {</span>
  <span class="keyword">var</span> args = subst;
  <span class="keyword">return</span> str.replace(<span class="regexp">/{(\d+)}/g</span>, <span class="keyword">function</span>(match, number) {
    <span class="keyword">return</span> <span class="keyword">typeof</span> args[number] != <span class="string">'undefined'</span>
      ? args[number]
      : match
    ;
  });
};

<span class="keyword">var</span> trashBin = <span class="literal">null</span>;
<span class="function"><span class="keyword">function</span> <span class="title">disposeElm</span><span class="params">(domElm)</span> {</span>
    <span class="keyword">if</span> (!trashBin) {
        trashBin = $doc.createElement(<span class="string">'div'</span>);
        trashBin.id = <span class="string">'trash-bin'</span>;
        trashBin.style.display = <span class="string">'none'</span>;
        $doc.body.appendChild(trashBin);
    }
    trashBin.appendChild(domElm);
    trashBin.innerHTML = <span class="string">''</span>;
}

<span class="comment">/* TODO: Create custom `undefined`, consider changing Infinity to Number.POSITIVE_INIFINITY */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h2>Internal Constants</h2>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> TIME_PRECISION = <span class="number">9</span>; <span class="comment">// the number of digits after the floating point</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>to round the time when comparing with bands and so on;
used to get rid of floating point-conversion issues</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">__adjust</span><span class="params">(t)</span> {</span>
  <span class="keyword">return</span> __roundTo(t, TIME_PRECISION);
}

<span class="function"><span class="keyword">function</span> <span class="title">__t_cmp</span><span class="params">(t0, t1)</span> {</span>
  <span class="keyword">if</span> (__adjust(t0) &gt; __adjust(t1)) <span class="keyword">return</span> <span class="number">1</span>;
  <span class="keyword">if</span> (__adjust(t0) &lt; __adjust(t1)) <span class="keyword">return</span> -<span class="number">1</span>;
  <span class="keyword">return</span> <span class="number">0</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2>Constants</h2>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> C = __anm.C; <span class="comment">// will be transferred to public namespace both from bottom of player.js</span>

<span class="keyword">var</span> _ResMan = __anm.resource_manager;
<span class="keyword">var</span> _PlrMan = __anm.player_manager;</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h3>Player states</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* ----------------- */</span>

C.NOTHING = -<span class="number">1</span>;
C.STOPPED = <span class="number">0</span>;
C.PLAYING = <span class="number">1</span>;
C.PAUSED = <span class="number">2</span>;
C.LOADING = <span class="number">3</span>;
C.RES_LOADING = <span class="number">4</span>;
C.ERROR = <span class="number">5</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>public constants below are also appended to C object, but with <code>X_</code>-like prefix
to indicate their scope, see through all file</p>
<h3>Player Modes constants</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* -------------------------- */</span>

C.M_CONTROLS_ENABLED = <span class="number">1</span>;    C.M_CONTROLS_DISABLED = <span class="number">2</span>;
C.M_INFO_ENABLED = <span class="number">4</span>;        C.M_INFO_DISABLED = <span class="number">8</span>;
C.M_HANDLE_EVENTS = <span class="number">16</span>;      C.M_DO_NOT_HANDLE_EVENTS = <span class="number">32</span>;
C.M_DRAW_STILL = <span class="number">64</span>;         C.M_DO_NOT_DRAW_STILL = <span class="number">128</span>;
C.M_INFINITE_DURATION = <span class="number">256</span>; C.M_FINITE_DURATION = <span class="number">512</span>;

C.M_PREVIEW = C.M_CONTROLS_DISABLED
              | C.M_INFO_DISABLED
              | C.M_DO_NOT_HANDLE_EVENTS
              | C.M_DRAW_STILL
              | C.M_FINITE_DURATION;
C.M_DYNAMIC = C.M_CONTROLS_DISABLED
              | C.M_INFO_DISABLED
              | C.M_HANDLE_EVENTS
              | C.M_DO_NOT_DRAW_STILL
              | C.M_INFINITE_DURATION;
C.M_VIDEO = C.M_CONTROLS_ENABLED
            | C.M_INFO_ENABLED
            | C.M_DO_NOT_HANDLE_EVENTS
            | C.M_DRAW_STILL
            | C.M_FINITE_DURATION;
C.M_SANDBOX = C.M_CONTROLS_DISABLED
            | C.M_INFO_DISABLED
            | C.M_DO_NOT_HANDLE_EVENTS
            | C.M_DO_NOT_DRAW_STILL
            | C.M_FINITE_DURATION;</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h3>Load targets</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* ---------------- */</span>

C.LT_BUILDER = <span class="number">1</span>;
C.LT_SCENE = <span class="number">2</span>;
C.LT_CLIPS = <span class="number">3</span>;
C.LT_IMPORT = <span class="number">4</span>;
C.LT_URL = <span class="number">5</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h3>Events</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* ---------- */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>NB: All of the events must have different values, or the flow will be broken
FIXME: allow grouping events, i.e. value may a group_marker + name of an event
       also, allow events to belong to several groups, it may replace a tests like
       XT_MOUSE or XT_CONTROL or isPlayerEvent</p>
<ul>
<li>mouse</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>registerEvent(<span class="string">'X_MCLICK'</span>, <span class="string">'mclick'</span>, <span class="number">1</span>);
registerEvent(<span class="string">'X_MDCLICK'</span>, <span class="string">'mdclick'</span>, <span class="number">2</span>);
registerEvent(<span class="string">'X_MUP'</span>, <span class="string">'mup'</span>, <span class="number">4</span>);
registerEvent(<span class="string">'X_MDOWN'</span>, <span class="string">'mdown'</span>, <span class="number">8</span>);
registerEvent(<span class="string">'X_MMOVE'</span>, <span class="string">'mmove'</span>, <span class="number">16</span>);
registerEvent(<span class="string">'X_MOVER'</span>, <span class="string">'mover'</span>, <span class="number">32</span>);
registerEvent(<span class="string">'X_MOUT'</span>, <span class="string">'mout'</span>, <span class="number">64</span>);

registerEvent(<span class="string">'XT_MOUSE'</span>, <span class="string">'mouse'</span>,
  (C.X_MCLICK | C.X_MDCLICK | C.X_MUP | C.X_MDOWN | C.X_MMOVE | C.X_MOVER | C.X_MOUT));</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <ul>
<li>keyboard</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>registerEvent(<span class="string">'X_KPRESS'</span>, <span class="string">'kpress'</span>, <span class="number">128</span>);
registerEvent(<span class="string">'X_KUP'</span>, <span class="string">'kup'</span>, <span class="number">256</span>);
registerEvent(<span class="string">'X_KDOWN'</span>, <span class="string">'kdown'</span>, <span class="number">1024</span>);

registerEvent(<span class="string">'XT_KEYBOARD'</span>, <span class="string">'keyboard'</span>,
  (C.X_KPRESS | C.X_KUP | C.X_KDOWN));</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <ul>
<li>controllers</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>registerEvent(<span class="string">'XT_CONTROL'</span>, <span class="string">'control'</span>, (C.XT_KEYBOARD | C.XT_MOUSE));</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <ul>
<li>draw</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>registerEvent(<span class="string">'X_DRAW'</span>, <span class="string">'draw'</span>, <span class="string">'draw'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <ul>
<li>bands</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>registerEvent(<span class="string">'X_START'</span>, <span class="string">'start'</span>, <span class="string">'x_start'</span>);
registerEvent(<span class="string">'X_STOP'</span>, <span class="string">'stop'</span>, <span class="string">'x_stop'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <ul>
<li>playing (player state)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>registerEvent(<span class="string">'S_PLAY'</span>, <span class="string">'play'</span>, <span class="string">'play'</span>);
registerEvent(<span class="string">'S_PAUSE'</span>, <span class="string">'pause'</span>, <span class="string">'pause'</span>);
registerEvent(<span class="string">'S_STOP'</span>, <span class="string">'stop'</span>, <span class="string">'stop'</span>);
registerEvent(<span class="string">'S_REPEAT'</span>, <span class="string">'repeat'</span>, <span class="string">'repeat'</span>);
registerEvent(<span class="string">'S_IMPORT'</span>, <span class="string">'import'</span>, <span class="string">'import'</span>);
registerEvent(<span class="string">'S_LOAD'</span>, <span class="string">'load'</span>, <span class="string">'load'</span>);
registerEvent(<span class="string">'S_RES_LOAD'</span>, <span class="string">'res_load'</span>, <span class="string">'res_load'</span>);
registerEvent(<span class="string">'S_ERROR'</span>, <span class="string">'error'</span>, <span class="string">'error'</span>);

<span class="comment">/* X_ERROR, X_FOCUS, X_RESIZE, X_SELECT, touch events */</span>

<span class="comment">/* TODO: the problem with controls receiving events is that `handle_` method is now saved as 'handle_8' instead of 'handle_mclick' */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <h2>Modules</h2>

            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> M = {};

C.MOD_PLAYER = <span class="string">'player'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <h3>Options</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* ----------- */</span>

<span class="keyword">var</span> global_opts = { <span class="string">'liveDebug'</span>: <span class="literal">false</span>,
                    <span class="string">'autoFocus'</span>: <span class="literal">true</span>,
                    <span class="string">'setTabindex'</span>: <span class="literal">true</span> };

M[C.MOD_PLAYER] = global_opts;</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <h2>Importers</h2>

            </div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> I = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h2>Player</h2>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">Player</span><span class="params">()</span> {</span>
    <span class="keyword">this</span>.id = <span class="string">''</span>;
    <span class="keyword">this</span>.state = <span class="literal">null</span>;
    <span class="keyword">this</span>.anim = <span class="literal">null</span>;
    <span class="keyword">this</span>.canvas = <span class="literal">null</span>;
    <span class="keyword">this</span>.ctx = <span class="literal">null</span>;
    <span class="keyword">this</span>.controls = <span class="literal">null</span>;
    <span class="keyword">this</span>.__canvasPrepared = <span class="literal">false</span>;
    <span class="keyword">this</span>.__instanceNum = ++Player.__instances;
    <span class="keyword">this</span>.__makeSafe(Player._SAFE_METHODS);
}
Player.__instances = <span class="number">0</span>;

Player.PREVIEW_POS = <span class="number">0</span>; <span class="comment">// was 1/3</span>
Player.PEFF = <span class="number">0</span>; <span class="comment">// seconds to play more when reached end of movie</span>
Player.NO_TIME = -<span class="number">1</span>;

Player.MARKER_ATTR = <span class="string">'anm-player'</span>; <span class="comment">// marks player existence on canvas element</span>
Player.URL_ATTR = <span class="string">'data-url'</span>;

Player.DEFAULT_CANVAS = { <span class="string">'width'</span>: DEF_CNVS_WIDTH,
                          <span class="string">'height'</span>: DEF_CNVS_HEIGHT,
                          <span class="string">'bgcolor'</span>: <span class="literal">null</span><span class="comment">/*{ 'color': DEF_CNVS_BG }*/</span> };
Player.DEFAULT_CONFIGURATION = { <span class="string">'debug'</span>: <span class="literal">false</span>,
                                 <span class="string">'inParent'</span>: <span class="literal">false</span>,
                                 <span class="string">'muteErrors'</span>: <span class="literal">false</span>,
                                 <span class="string">'repeat'</span>: <span class="literal">false</span>,
                                 <span class="string">'mode'</span>: C.M_VIDEO,
                                 <span class="string">'zoom'</span>: <span class="number">1.0</span>,
                                 <span class="string">'meta'</span>: { <span class="string">'title'</span>: <span class="string">''</span>,
                                           <span class="string">'author'</span>: <span class="string">'Anonymous'</span>,
                                           <span class="string">'copyright'</span>: <span class="string">''</span>,
                                           <span class="string">'version'</span>: <span class="literal">null</span>,
                                           <span class="string">'description'</span>: <span class="string">''</span> },
                                 <span class="string">'anim'</span>: { <span class="string">'fps'</span>: <span class="number">30</span>,
                                           <span class="string">'width'</span>: DEF_CNVS_WIDTH,
                                           <span class="string">'height'</span>: DEF_CNVS_HEIGHT,
                                           <span class="string">'bgcolor'</span>: <span class="literal">null</span>,
                                           <span class="string">'duration'</span>: <span class="number">0</span> }
                               };</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <h3>Playing Control API</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* ----------------------- */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>methods listed below are directly wrapped with try/catch to check
which way of handling/suppressing errors is current one for this player
and act with catched errors basing on this way</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Player._SAFE_METHODS = [ <span class="string">'init'</span>, <span class="string">'load'</span>, <span class="string">'play'</span>, <span class="string">'stop'</span>, <span class="string">'pause'</span>, <span class="string">'drawAt'</span> ];

<span class="comment">/* TODO: add load/play/pause/stop events */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p><code>id</code> is canvas id</p>
<p>you may pass null for options, but if you provide them, at least <code>mode</code> is required
to be set (all other are optional).</p>
<p>options format:</p>
<pre><code>{ &quot;debug&quot;: false,
  &quot;inParent&quot;: false,
  &quot;muteErrors&quot;: false,
  &quot;mode&quot;: C.M_VIDEO,
  &quot;zoom&quot;: 1.0,
  &quot;meta&quot;: { &quot;title&quot;: &quot;Default&quot;,
            &quot;author&quot;: &quot;Anonymous&quot;,
            &quot;copyright&quot;: &quot;© NaN&quot;,
            &quot;version&quot;: -1.0,
            &quot;description&quot;:
                    &quot;Default project description&quot;,
            [ &quot;modified&quot;: &quot;2012-04-10T15:06:12.246Z&quot; ] }, // not used
  &quot;anim&quot;: { &quot;fps&quot;: 30,
            &quot;width&quot;: 400,
            &quot;height&quot;: 250,
            &quot;bgcolor&quot;: { color: &quot;#fff&quot; },
            &quot;duration&quot;: 0 } }</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>Player.prototype.init = <span class="keyword">function</span>(cvs, opts) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.canvas) <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.INIT_TWICE);
    <span class="keyword">if</span> (<span class="keyword">this</span>.anim) <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.INIT_AFTER_LOAD);
    <span class="keyword">this</span>._initHandlers(); <span class="comment">/* TODO: make automatic */</span>
    <span class="keyword">this</span>._prepare(cvs);
    <span class="keyword">this</span>._loadOpts(opts);
    <span class="keyword">this</span>._postInit();
    <span class="comment">/* TODO: if (this.canvas.hasAttribute('data-url')) */</span>

    _PlrMan.fire(C.S_NEW_PLAYER, <span class="keyword">this</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>;
}
Player.prototype.load = <span class="keyword">function</span>(arg1, arg2, arg3, arg4) {
    <span class="keyword">var</span> player = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>if player loads remote resources just now,
postpone this task and exit. postponed tasks
will be called when all remote resources were
finished loading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (player.state.happens === C.RES_LOADING) {
        player._clearPostpones();</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>TODO: cancel resource requests?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }

    <span class="comment">/* object */</span>
    <span class="comment">/* object, callback */</span>
    <span class="comment">/* object, importer */</span>
    <span class="comment">/* object, duration */</span>
    <span class="comment">/* object, importer, callback */</span>
    <span class="comment">/* object, duration, callback */</span>
    <span class="comment">/* object, duration, importer, callback */</span>

    <span class="keyword">var</span> object = arg1, duration, importer, callback;

    <span class="keyword">var</span> durationPassed = <span class="literal">false</span>;

    <span class="keyword">if</span> (__fun(arg2)) { callback = arg2 } <span class="comment">/* object, callback */</span>
    <span class="keyword">else</span> <span class="keyword">if</span> (__num(arg2)) { <span class="comment">/* object, duration[, ...] */</span>
        duration = arg2;
        durationPassed = <span class="literal">true</span>;
        <span class="keyword">if</span> (__obj(arg3)) { <span class="comment">/* object, duration, importer[, callback] */</span>
          importer = arg3; callback = arg4;
        } <span class="keyword">else</span> <span class="keyword">if</span> (__fun(arg3)) { <span class="comment">/* object, duration, callback */</span>
          callback = arg3;
        }
    } <span class="keyword">else</span> <span class="keyword">if</span> (__obj(arg2)) { <span class="comment">/* object, importer[, ...] */</span>
        importer = arg2;
        callback = arg3;
    }

    <span class="keyword">if</span> (!object) {
        player.anim = <span class="literal">null</span>;
        player._reset();
        player.stop();
        <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.NO_SCENE_PASSED);
    }

    <span class="keyword">if</span> ((player.state.happens === C.PLAYING) ||
        (player.state.happens === C.PAUSED)) {
        <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.COULD_NOT_LOAD_WHILE_PLAYING);
    }

    <span class="keyword">if</span> (!player.__canvasPrepared) <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.CANVAS_NOT_PREPARED);

    player._reset();

    player.state.happens = C.LOADING;

    <span class="keyword">var</span> whenDone = <span class="keyword">function</span>(result) {
        <span class="keyword">var</span> scene = player.anim;
        <span class="keyword">if</span> (player.mode &amp; C.M_HANDLE_EVENTS) {
            player.__subscribeDynamicEvents(scene);
        }
        <span class="keyword">var</span> remotes = scene._collectRemoteResources();
        <span class="keyword">if</span> (!remotes.length) {
            player.fire(C.S_LOAD, result);
            <span class="keyword">if</span> (!(player.mode &amp; C.M_HANDLE_EVENTS)) player.stop();
            <span class="keyword">if</span> (callback) callback(result);
        } <span class="keyword">else</span> {
            player.state.happens = C.RES_LOADING;
            player.fire(C.S_RES_LOAD, remotes);
            _ResMan.subscribe(remotes, [ player.__defAsyncSafe(
                <span class="keyword">function</span>(res_results, err_count) {
                    <span class="keyword">if</span> (!err_count) {
                        <span class="keyword">if</span> (player.anim === result) { <span class="comment">// avoid race condition when there were two requests</span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>to load different scenes and first one finished loading
after the second one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            player.state.happens = C.LOADING;
                            player.fire(C.S_LOAD, result);
                            <span class="keyword">if</span> (!(player.mode &amp; C.M_HANDLE_EVENTS)) player.stop();
                            player._callPostpones();
                            <span class="keyword">if</span> (callback) callback(result);
                        }
                    } <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(Errors.A.RESOURCES_FAILED_TO_LOAD);
                }
            ) ]);
        }
    };
    whenDone = player.__defAsyncSafe(whenDone);

    <span class="comment">/* TODO: configure canvas using clips bounds */</span>

    <span class="keyword">if</span> (player.anim) {
        player.__unsubscribeDynamicEvents(player.anim);
    }

    <span class="keyword">if</span> (object) {

        <span class="keyword">if</span> (__builder(object)) {  <span class="comment">// Builder instance</span>
            player._loadTarget = C.LT_BUILDER;
            L.loadBuilder(player, object, whenDone);
        } <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Scene) { <span class="comment">// Scene instance</span>
            player._loadTarget = C.LT_SCENE;
            L.loadScene(player, object, whenDone);
        } <span class="keyword">else</span> <span class="keyword">if</span> (__arr(object)) { <span class="comment">// array of clips</span>
            player._loadTarget = C.LT_CLIPS;
            L.loadClips(player, object, whenDone);
        } <span class="keyword">else</span> <span class="keyword">if</span> (__str(object)) { <span class="comment">// URL</span>
            <span class="keyword">var</span> controls = player.controls;
            player._loadTarget = C.LT_URL;
            player._loadSrc = object;
            <span class="keyword">if</span> (controls) controls._scheduleLoading();
            L.loadFromUrl(player, object, importer, <span class="keyword">function</span>(result) {
                <span class="keyword">if</span> (controls) controls._stopLoading();
                whenDone(result);
            });
        } <span class="keyword">else</span> { <span class="comment">// any object with importer</span>
            player._loadTarget = C.LT_IMPORT;
            L.loadFromObj(player, object, importer, whenDone);
        }

    } <span class="keyword">else</span> {
        player._loadTarget = C.LT_SCENE;
        player.anim = <span class="keyword">new</span> Scene();
        whenDone(player.anim);
    }

    <span class="keyword">if</span> (durationPassed) { <span class="comment">// FIXME: move to whenDone?</span>
      player.anim.setDuration(duration);
      player.setDuration(duration);
    }

    <span class="keyword">return</span> player;
}

Player.prototype.play = <span class="keyword">function</span>(from, speed, stopAfter) {

    <span class="keyword">if</span> (<span class="keyword">this</span>.state.happens === C.PLAYING) {
        <span class="keyword">if</span> (<span class="keyword">this</span>.mode &amp; C.M_HANDLE_EVENTS) <span class="keyword">return</span>; <span class="comment">// it's ok to skip this call if it's some dynamic scene (FIXME?)</span>
        <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.ALREADY_PLAYING);
    }
    <span class="keyword">if</span> (<span class="keyword">this</span>.state.happens === C.RES_LOADING) { <span class="keyword">this</span>._postpone(<span class="string">'play'</span>, arguments);
                                                <span class="keyword">return</span>; } <span class="comment">// if player loads remote resources just now,</span></pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>postpone this task and exit. postponed tasks
will be called when all remote resources were
finished loading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> player = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>reassigns var to ensure proper function is used</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    __nextFrame = __frameFunc();

    player._ensureHasAnim();
    player._ensureHasState();

    <span class="keyword">var</span> state = player.state;

    state.__lastPlayConf = [ from, speed, stopAfter ];

    <span class="keyword">if</span> (state.duration == <span class="literal">undefined</span>) <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.DURATION_IS_NOT_KNOWN);

    state.from = from || state.from;
    state.speed = speed || state.speed;
    state.stop = (<span class="keyword">typeof</span> stopAfter !== <span class="string">'undefined'</span>) ? stopAfter : state.stop;

    state.__startTime = Date.now();
    state.__redraws = <span class="number">0</span>;
    state.__rsec = <span class="number">0</span>;

    state.__supressFrames = <span class="literal">false</span>;

    <span class="comment">/*if (state.__drawInterval !== null) {
        clearInterval(player.state.__drawInterval);
    }*/</span>

    state.happens = C.PLAYING;

    <span class="keyword">var</span> scene = player.anim;
    scene.reset();
    player.setDuration(scene.duration);</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>if (state.from &gt; 2) throw new Error(&#39;Test&#39;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    state.__firstReq = __r_loop(player.ctx,
                                state, scene,
                                player.__beforeFrame(scene),
                                player.__afterFrame(scene),
                                player.__userBeforeRender,
                                player.__userAfterRender);

    player.fire(C.S_PLAY, state.from);

    <span class="keyword">return</span> player;
}

Player.prototype.stop = <span class="keyword">function</span>() {
    <span class="comment">/* if (state.happens === C.STOPPED) return; */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>if player loads remote resources just now,
postpone this task and exit. postponed tasks
will be called when all remote resources were
finished loading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (<span class="keyword">this</span>.state.happens === C.RES_LOADING) {
        <span class="keyword">this</span>._postpone(<span class="string">'stop'</span>, arguments);
        <span class="keyword">return</span>;
    }

    <span class="keyword">var</span> player = <span class="keyword">this</span>,
        scene = player.anim;

    player._ensureHasState();

    <span class="keyword">var</span> state = player.state;

    <span class="keyword">if</span> ((state.happens === C.PLAYING) ||
        (state.happens === C.PAUSED)) {
        player.__supressFrames = <span class="literal">true</span>;
        __stopAnim(state.__firstReq);
    }

    state.time = Player.NO_TIME;
    state.from = <span class="number">0</span>;
    state.stop = Player.NO_TIME;

    <span class="keyword">if</span> (scene) {
        state.happens = C.STOPPED;
        <span class="keyword">if</span> (player.mode &amp; C.M_DRAW_STILL) {
            player.drawAt(state.duration * Player.PREVIEW_POS);
        }
        <span class="keyword">if</span> (player.controls<span class="comment">/* &amp;&amp; !player.controls.hidden*/</span>) {
            player._renderControlsAt(state.time);
        }
    } <span class="keyword">else</span> <span class="keyword">if</span> (state.happens !== C.ERROR) {
        state.happens = C.NOTHING;
        player._drawSplash();
    }

    player.fire(C.S_STOP);

    <span class="keyword">if</span> (scene) scene.reset();

    <span class="keyword">return</span> player;
}

Player.prototype.pause = <span class="keyword">function</span>() {
    <span class="keyword">var</span> player = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>if player loads remote resources just now,
postpone this task and exit. postponed tasks
will be called when all remote resources were
finished loading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (player.state.happens === C.RES_LOADING) {
        player._postpone(<span class="string">'pause'</span>, arguments);
        <span class="keyword">return</span>;
    }

    player._ensureHasState();
    player._ensureHasAnim();

    <span class="keyword">var</span> state = player.state;
    <span class="keyword">if</span> (state.happens === C.STOPPED) {
        <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.PAUSING_WHEN_STOPPED);
    }

    <span class="keyword">if</span> (state.happens === C.PLAYING) {
        state.__supressFrames = <span class="literal">true</span>;
        __stopAnim(state.__firstReq);
    }

    <span class="keyword">if</span> (state.time &gt; state.duration) {
        state.time = state.duration;
    }

    state.from = state.time;
    state.happens = C.PAUSED;

    player.drawAt(state.time);

    player.fire(C.S_PAUSE, state.time);

    <span class="keyword">return</span> player;
}

<span class="comment">/*Player.prototype.reset = function() {

}*/</span>

Player.prototype.onerror = <span class="keyword">function</span>(callback) {
    <span class="keyword">this</span>.__err_handler = callback;

    <span class="keyword">return</span> <span class="keyword">this</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <h3>Inititalization</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* ------------------- */</span>

provideEvents(Player, [C.S_IMPORT, C.S_LOAD, C.S_RES_LOAD, C.S_PLAY, C.S_PAUSE, C.S_STOP, C.S_REPEAT, C.S_ERROR]);
Player.prototype._prepare = <span class="keyword">function</span>(cvs) {
    <span class="keyword">if</span> (__str(cvs)) {
        <span class="keyword">this</span>.canvas = $doc.getElementById(cvs);
        <span class="keyword">if</span> (!<span class="keyword">this</span>.canvas) <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(_strf(Errors.P.NO_CANVAS_WITH_ID, [cvs]));
        <span class="keyword">this</span>.id = cvs;
    } <span class="keyword">else</span> {
        <span class="keyword">if</span> (!cvs) <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.NO_CANVAS_PASSED);
        <span class="keyword">this</span>.id = cvs.id;
        <span class="keyword">this</span>.canvas = cvs;
    }
    <span class="keyword">var</span> canvas = <span class="keyword">this</span>.canvas;
    <span class="keyword">if</span> (canvas.getAttribute(Player.MARKER_ATTR)) <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.ALREADY_ATTACHED);
    canvas.setAttribute(Player.MARKER_ATTR, <span class="literal">true</span>);
    <span class="keyword">this</span>.ctx = canvas.getContext(<span class="string">"2d"</span>);
    <span class="keyword">this</span>.state = Player.createState(<span class="keyword">this</span>);
    <span class="keyword">this</span>.subscribeEvents(canvas);
}
Player.prototype._loadOpts = <span class="keyword">function</span>(opts) {
    <span class="keyword">var</span> cvs_opts = Player._mergeOpts(Player._optsFromCvsAttrs(<span class="keyword">this</span>.canvas),
                                     Player.DEFAULT_CONFIGURATION);
    <span class="keyword">var</span> opts = opts ? Player._mergeOpts(opts, cvs_opts) : cvs_opts;
    <span class="keyword">this</span>.inParent = opts.inParent;
    <span class="keyword">this</span>.mode = (opts.mode != <span class="literal">null</span>) ? opts.mode : C.M_VIDEO;
    <span class="keyword">this</span>.debug = opts.debug;
    <span class="keyword">this</span>.state.zoom = opts.zoom || <span class="number">1</span>;
    <span class="keyword">this</span>.state.repeat = opts.repeat;

    <span class="keyword">this</span>.configureAnim(opts.anim || Player.DEFAULT_CONFIGURATION.anim);

    <span class="keyword">this</span>._checkMode();

    <span class="keyword">this</span>.configureMeta(opts.meta || Player.DEFAULT_CONFIGURATION.meta);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>initial state of the player, called from constuctor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Player.prototype._postInit = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.stop();
    <span class="comment">/* TODO: load some default information into player */</span>
    Text._ensureHasBuffer(); <span class="comment">/* so it will be performed onload */</span>
    <span class="keyword">var</span> mayBeUrl = <span class="keyword">this</span>.canvas.getAttribute(Player.URL_ATTR);
    <span class="keyword">if</span> (mayBeUrl) <span class="keyword">this</span>.load(mayBeUrl<span class="comment">/*,
                            this.canvas.getAttribute(Player.IMPORTER_ATTR)*/</span>);
}
Player.prototype.changeRect = <span class="keyword">function</span>(rect) {
    <span class="keyword">this</span>._reconfigureCanvas({
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y,
        bgcolor: <span class="keyword">this</span>.state.bgcolor
    });
}
Player.prototype._rectChanged = <span class="keyword">function</span>(rect) {
    <span class="keyword">var</span> cur = <span class="keyword">this</span>._canvasConf;
    <span class="keyword">return</span> (cur.width != rect.width) || (cur.height != rect.height) ||
           (cur.x != rect.x) || (cur.y != rect.y);
}
Player.prototype.forceRedraw = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.controls) <span class="keyword">this</span>.controls.forceNextRedraw();
    <span class="keyword">switch</span> (<span class="keyword">this</span>.state.happens) {
        <span class="keyword">case</span> C.STOPPED: <span class="keyword">this</span>.stop(); <span class="keyword">break</span>;
        <span class="keyword">case</span> C.PAUSED: <span class="keyword">if</span> (<span class="keyword">this</span>.anim) <span class="keyword">this</span>.drawAt(<span class="keyword">this</span>.state.time); <span class="keyword">break</span>;
        <span class="keyword">case</span> C.PLAYING: <span class="keyword">if</span> (<span class="keyword">this</span>.anim) { <span class="keyword">this</span>._stopAndContinue(); } <span class="keyword">break</span>;
        <span class="keyword">case</span> C.NOTHING: <span class="keyword">case</span> C.LOADING: <span class="keyword">case</span> C.RES_LOADING: <span class="keyword">this</span>._drawSplash(); <span class="keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>case C.ERROR: this._drawErrorSplash(); break;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }
}
Player.prototype.changeZoom = <span class="keyword">function</span>(ratio) {
    <span class="keyword">this</span>.state.zoom = ratio;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>update player state with passed configuration, usually done before
loading some scene or by importer, <code>conf</code> has the data about title,
author/copyright, fps and width/height of the player</p>
<p>Anim-info format:</p>
<pre><code>{ [&quot;fps&quot;: 24.0,] // NB: currently not applied in any way, default is 30
  &quot;width&quot;: 640,
  &quot;height&quot;: 480,
  [&quot;bgcolor&quot;: { color: &quot;#f00&quot; },] // in canvas-friendly format
  [&quot;duration&quot;: 10.0] // in seconds
}</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>Player.prototype.configureAnim = <span class="keyword">function</span>(conf) {
    <span class="keyword">this</span>._animInfo = conf;
    <span class="keyword">var</span> cnvs = <span class="keyword">this</span>.canvas;

    <span class="keyword">if</span> (!conf.width &amp;&amp; cnvs.hasAttribute(<span class="string">'width'</span>)) conf.width = cnvs.getAttribute(<span class="string">'width'</span>);
    <span class="keyword">if</span> (!conf.height &amp;&amp; cnvs.hasAttribute(<span class="string">'height'</span>)) conf.height = cnvs.getAttribute(<span class="string">'height'</span>);

    <span class="keyword">this</span>._reconfigureCanvas(conf);

    <span class="keyword">if</span> (conf.bgcolor) <span class="keyword">this</span>.state.bgcolor = conf.bgcolor;

    <span class="keyword">if</span> (conf.fps) <span class="keyword">this</span>.state.fps = conf.fps;
    <span class="keyword">if</span> (conf.duration) <span class="keyword">this</span>.state.duration = conf.duration;

}</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>update player information block with passed configuration, usually done before
loading some scene or by importer, <code>conf</code> has the data about title,
author/copyright, version.</p>
<p>Meta-info format:</p>
<pre><code>{ [&quot;id&quot;: &quot;......&quot;,]
  &quot;title&quot;: &quot;Default&quot;,
  &quot;author&quot;: &quot;Anonymous&quot;,
  &quot;copyright&quot;: &quot;© 2011&quot;,
  &quot;version&quot;: 0.1,
  &quot;description&quot;: &quot;Default project description&quot;
}</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>Player.prototype.configureMeta = <span class="keyword">function</span>(info) {
    <span class="keyword">this</span>._metaInfo = info;
    <span class="keyword">if</span> (<span class="keyword">this</span>.controls) <span class="keyword">this</span>.controls.inject(info, <span class="keyword">this</span>._animInfo);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>draw current scene at specified time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Player.prototype.drawAt = <span class="keyword">function</span>(time) {
    <span class="keyword">if</span> (time === Player.NO_TIME) <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.PASSED_TIME_VALUE_IS_NO_TIME);
    <span class="keyword">if</span> (<span class="keyword">this</span>.state.happens === C.RES_LOADING) { <span class="keyword">this</span>._postpone(<span class="string">'drawAt'</span>, arguments);
                                                <span class="keyword">return</span>; } <span class="comment">// if player loads remote resources just now,</span></pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>postpone this task and exit. postponed tasks
will be called when all remote resources were
finished loading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> ((time &lt; <span class="number">0</span>) || (time &gt; <span class="keyword">this</span>.state.duration)) {
        <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(_strf(Errors.P.PASSED_TIME_NOT_IN_RANGE, [time]));
    }
    <span class="keyword">var</span> scene = <span class="keyword">this</span>.anim,
        u_before = <span class="keyword">this</span>.__userBeforeRender,
        u_after = <span class="keyword">this</span>.__userAfterRender,
        after = <span class="keyword">function</span>(gtime, ctx) {
            scene.reset();
            scene.__informEnabled = <span class="literal">true</span>;
            u_after(gtime, ctx);
        };

    scene.reset();
    scene.__informEnabled = <span class="literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>__r_at is the alias for Render.at, but a bit more quickly-accessible,
because it is a single function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    __r_at(time, <span class="keyword">this</span>.ctx, <span class="keyword">this</span>.state, <span class="keyword">this</span>.anim, u_before, u_after);

    <span class="keyword">if</span> (<span class="keyword">this</span>.controls) <span class="keyword">this</span>._renderControlsAt(time);

    <span class="keyword">return</span> <span class="keyword">this</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>TODO: change to before/after for events?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Player.prototype.beforeFrame = <span class="keyword">function</span>(callback) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.state.happens === C.PLAYING) <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.BEFOREFRAME_BEFORE_PLAY);
    <span class="keyword">this</span>.__userBeforeFrame = callback;
}
Player.prototype.afterFrame = <span class="keyword">function</span>(callback) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.state.happens === C.PLAYING) <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.AFTERFRAME_BEFORE_PLAY);
    <span class="keyword">this</span>.__userAfterFrame = callback;
}
Player.prototype.beforeRender = <span class="keyword">function</span>(callback) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.state.happens === C.PLAYING) <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.BEFORENDER_BEFORE_PLAY);
    <span class="keyword">this</span>.__userBeforeRender = callback;
}
Player.prototype.afterRender = <span class="keyword">function</span>(callback) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.state.happens === C.PLAYING) <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.AFTERRENDER_BEFORE_PLAY);
    <span class="keyword">this</span>.__userAfterRender = callback;
}
Player.prototype.detach = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.controls) <span class="keyword">this</span>.controls.detach(<span class="keyword">this</span>.canvas);
    <span class="keyword">this</span>.canvas.removeAttribute(Player.MARKER_ATTR);
    <span class="keyword">this</span>._reset();
    _PlrMan.fire(C.S_PLAYER_DETACH, <span class="keyword">this</span>);
}
Player.attachedTo = <span class="keyword">function</span>(canvas) {
    <span class="keyword">return</span> (canvas.getAttribute(Player.MARKER_ATTR) == <span class="literal">null</span>) ||
           (canvas.getAttribute(Player.MARKER_ATTR) == <span class="literal">undefined</span>);
}
Player.__getPosAndRedraw = <span class="keyword">function</span>(player) {
    <span class="keyword">return</span> <span class="keyword">function</span>(evt) {
        <span class="comment">/*var canvas = player.canvas;
        var pos = find_pos(canvas),
            rect = {
                'width': canvas.clientWidth,
                'height': canvas.clientHeight,
                'x': pos[0],
                'y': pos[1]
            };
        if (player._rectChanged(rect)) player.changeRect(rect);*/</span>
        <span class="comment">/* if (player.controls) {
            player.controls.update(player.canvas);
            player.controls.handleAreaChange();</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>player._renderControls();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } */
    };
}
Player.prototype.subscribeEvents = function(canvas) {
    $wnd.addEventListener('load', Player.__getPosAndRedraw(this), false);
    $wnd.addEventListener('scroll', Player.__getPosAndRedraw(this), false);
    $wnd.addEventListener('resize', Player.__getPosAndRedraw(this), false);
    this.canvas.addEventListener('mouseover', (function(player) {
                        return function(evt) {
                            if (global_opts.autoFocus &amp;&amp;
                                (player.mode &amp; C.M_HANDLE_EVENTS) &amp;&amp;
                                player.canvas) {
                                player.canvas.focus();
                            }
                            return true;
                        };
                    })(this), false);
    this.canvas.addEventListener('mouseout', (function(player) {
                        return function(evt) {
                            if (global_opts.autoFocus &amp;&amp;
                                (player.mode &amp; C.M_HANDLE_EVENTS) &amp;&amp;
                                player.canvas) {
                                player.canvas.blur();
                            }
                            return true;
                        };
                    })(this), false);
}
Player.prototype.setDuration = function(value) {
    this.state.duration = (value &gt;= 0) ? value : 0;
    if (this.controls) this.controls.setDuration((value &gt;= 0) ? value : 0);
}
Player.prototype._drawSplash = function() {
    var ctx = this.ctx,
        w = this.state.width,
        h = this.state.height;

    ctx.save();

    ctx.setTransform(1, 0, 0, 1, 0, 0);

    var ratio = this.state.ratio;
    if (ratio != 1) ctx.scale(ratio, ratio);</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>background</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ctx.fillStyle = <span class="string">'#ffe'</span>;
    ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, w, h);

    <span class="keyword">if</span> (<span class="keyword">this</span>.controls) {
       ctx.restore();
       <span class="keyword">return</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>text</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ctx.fillStyle = <span class="string">'#999966'</span>;
    ctx.font = <span class="string">'18px sans-serif'</span>;
    ctx.fillText(Strings.COPYRIGHT, <span class="number">20</span>, h - <span class="number">20</span>);

    ctx.globalAlpha = <span class="number">.6</span>;

    ctx.beginPath();
    ctx.arc(w / <span class="number">2</span>, h / <span class="number">2</span>, Math.min(w / <span class="number">2</span>, h / <span class="number">2</span>) * <span class="number">.5</span>, <span class="number">0</span>, <span class="number">2</span> * Math.PI);
    ctx.fillStyle = <span class="string">'#a00'</span>;
    ctx.strokeStyle = <span class="string">'#ffe'</span>;
    ctx.lineWidth = <span class="number">10</span>;
    ctx.stroke();
    ctx.fill();

    ctx.globalAlpha = <span class="number">.9</span>;

    ctx.restore();

    Controls._drawGuyInCenter(ctx, Controls.THEME, w, h, <span class="number">2.5</span>);
    <span class="comment">/* drawAnimatronGuy(ctx, w / 2, h / 2, Math.min(w, h) * .35,
                     [ '#fff', '#aa0' ]); */</span>

}
Player.prototype._drawLoadingSplash = <span class="keyword">function</span>(text) {
    <span class="keyword">this</span>._drawSplash();
    <span class="keyword">if</span> (<span class="keyword">this</span>.controls) <span class="keyword">return</span>;
    <span class="keyword">var</span> ctx = <span class="keyword">this</span>.ctx;
    ctx.save();
    ctx.setTransform(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);
    ctx.fillStyle = <span class="string">'#006'</span>;
    ctx.font = <span class="string">'12px sans-serif'</span>;
    ctx.fillText(text || Strings.LOADING, <span class="number">20</span>, <span class="number">25</span>);
    ctx.restore();
}
Player.prototype._drawErrorSplash = <span class="keyword">function</span>(e) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.controls) {
        <span class="keyword">this</span>.controls.forceNextRedraw();
        <span class="keyword">this</span>.controls.render();
        <span class="keyword">return</span>;
    }
    <span class="keyword">this</span>._drawSplash();
    <span class="keyword">var</span> ctx = <span class="keyword">this</span>.ctx;
    ctx.save();
    ctx.setTransform(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);
    ctx.fillStyle = <span class="string">'#006'</span>;
    ctx.font = <span class="string">'14px sans-serif'</span>;
    ctx.fillText(Strings.ERROR +
                 (e ? <span class="string">': '</span> + (e.message || (<span class="keyword">typeof</span> Error))
                    : <span class="string">''</span>) + <span class="string">'.'</span>, <span class="number">20</span>, <span class="number">25</span>);
    ctx.restore();
}
Player.prototype.toString = <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="string">"[ Player '"</span> + <span class="keyword">this</span>.id + <span class="string">"' m-"</span> + <span class="keyword">this</span>.mode + <span class="string">" ]"</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>reset player to initial state, called before loading any scene</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Player.prototype._reset = <span class="keyword">function</span>() {
    <span class="keyword">var</span> state = <span class="keyword">this</span>.state;
    state.debug = <span class="keyword">this</span>.debug;
    state.happens = C.NOTHING;
    state.from = <span class="number">0</span>;
    state.time = Player.NO_TIME;
    <span class="comment">/*state.zoom = 1;*/</span> <span class="comment">// do not override the zoom</span>
    state.duration = <span class="literal">undefined</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.controls) <span class="keyword">this</span>.controls.reset();
    <span class="keyword">this</span>.ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, state.width * state.ratio,
                             state.height * state.ratio);
    <span class="comment">/*this.stop();*/</span>
}
Player.prototype._stopAndContinue = <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>state.__lastPlayConf = [ from, speed, stopAfter ];</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> state = <span class="keyword">this</span>.state,
      last_conf = state.__lastPlayConf;
  <span class="keyword">var</span> stoppedAt = state.time;
  <span class="keyword">this</span>.stop();
  <span class="keyword">this</span>.play(stoppedAt, last_conf[<span class="number">1</span>], last_conf[<span class="number">2</span>]);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>update player&#39;s canvas with configuration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Player.prototype._reconfigureCanvas = <span class="keyword">function</span>(opts) {
    <span class="keyword">var</span> canvas = <span class="keyword">this</span>.canvas;
    <span class="keyword">var</span> pxRatio = getPxRatio();
    <span class="keyword">this</span>._canvasConf = opts;
    <span class="keyword">var</span> _w = opts.width ? Math.floor(opts.width) : DEF_CNVS_WIDTH;
    <span class="keyword">var</span> _h = opts.height ? Math.floor(opts.height) : DEF_CNVS_HEIGHT;
    opts.width = _w;
    opts.height = _h;
    <span class="keyword">this</span>.state.width = _w;
    <span class="keyword">this</span>.state.height = _h;
    <span class="keyword">this</span>.state.ratio = pxRatio;
    <span class="keyword">if</span> (opts.bgcolor) <span class="keyword">this</span>.state.bgcolor = opts.bgcolor;
    canvasOpts(canvas, opts, pxRatio);
    Player._saveCanvasPos(canvas);
    <span class="keyword">if</span> (<span class="keyword">this</span>.controls) <span class="keyword">this</span>.controls.update(canvas);
    <span class="keyword">this</span>.__canvasPrepared = <span class="literal">true</span>;
    <span class="keyword">this</span>.forceRedraw();
    <span class="keyword">return</span> <span class="keyword">this</span>;
}
Player.prototype._checkMode = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.canvas) <span class="keyword">return</span>;

    <span class="keyword">if</span> (<span class="keyword">this</span>.anim &amp;&amp; (<span class="keyword">this</span>.mode &amp; C.M_HANDLE_EVENTS)) {
        <span class="keyword">this</span>.__subscribeDynamicEvents(<span class="keyword">this</span>.anim);
    }

    <span class="keyword">if</span> (<span class="keyword">this</span>.mode &amp; C.M_CONTROLS_ENABLED) {
        <span class="keyword">this</span>._enableControls();
        <span class="keyword">if</span> (<span class="keyword">this</span>.mode &amp; C.M_INFO_ENABLED) {
            <span class="keyword">this</span>._enableInfo();
        } <span class="keyword">else</span> {
            <span class="keyword">this</span>._disableInfo();
        }
    } <span class="keyword">else</span> {
        <span class="keyword">this</span>._disableInfo();
        <span class="keyword">this</span>._disableControls();
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>FIXME: methods below may be removed, but they are required for tests</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Player.prototype._enableControls = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.controls) <span class="keyword">this</span>.controls = <span class="keyword">new</span> Controls(<span class="keyword">this</span>);
    <span class="keyword">this</span>.controls.enable();
}
Player.prototype._disableControls = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.controls) <span class="keyword">return</span>;
    <span class="keyword">this</span>.controls.disable();
    <span class="keyword">this</span>.controls = <span class="literal">null</span>;
}
Player.prototype._enableInfo = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.controls) <span class="keyword">return</span>;
    <span class="keyword">this</span>.controls.enableInfo();
}
Player.prototype._disableInfo = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.controls) <span class="keyword">return</span>;
    <span class="keyword">this</span>.controls.disableInfo();
}
Player.prototype._renderControlsAt = <span class="keyword">function</span>(time) {
    <span class="keyword">this</span>.controls.render(time);
}
Player.prototype.__subscribeDynamicEvents = <span class="keyword">function</span>(scene) {
    <span class="keyword">if</span> (global_opts.setTabindex) {
        <span class="keyword">this</span>.canvas.setAttribute(<span class="string">'tabindex'</span>,<span class="keyword">this</span>.__instanceNum);
    }
    <span class="keyword">if</span> (scene) {
        <span class="keyword">var</span> subscribed = <span class="literal">false</span>;
        <span class="keyword">if</span> (!<span class="keyword">this</span>.__boundTo) {
            <span class="keyword">this</span>.__boundTo = [];
        } <span class="keyword">else</span> {
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, ix = <span class="keyword">this</span>.__boundTo, il = ix.length; i &lt; il; i++) {
                <span class="keyword">if</span> ((scene.id === ix[i][<span class="number">0</span>]) &amp;&amp;
                    (<span class="keyword">this</span>.canvas === ix[i][<span class="number">1</span>])) {
                    subscribed = <span class="literal">true</span>;
                }
            }
        }
        <span class="keyword">if</span> (!subscribed) {
            <span class="keyword">this</span>.__boundTo.push([ scene.id, <span class="keyword">this</span>.canvas ]);
            scene.subscribeEvents(<span class="keyword">this</span>.canvas);
        }
    }
}
Player.prototype.__unsubscribeDynamicEvents = <span class="keyword">function</span>(scene) {
    <span class="keyword">if</span> (global_opts.setTabindex) {
        <span class="keyword">this</span>.canvas.setAttribute(<span class="string">'tabindex'</span>,<span class="literal">undefined</span>);
    }
    <span class="keyword">if</span> (scene) {
        <span class="keyword">if</span> (!<span class="keyword">this</span>.__boundTo) <span class="keyword">return</span>;
        <span class="keyword">var</span> toRemove = -<span class="number">1</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, ix = <span class="keyword">this</span>.__boundTo, il = ix.length; i &lt; il; i++) {
            <span class="keyword">if</span> (scene.id === ix[i][<span class="number">0</span>]) {
                toRemove = i;
                scene.unsubscribeEvents(ix[i][<span class="number">1</span>]);
            }
        }
        <span class="keyword">if</span> (toRemove &gt;= <span class="number">0</span>) {
            <span class="keyword">this</span>.__boundTo.splice(toRemove, <span class="number">1</span>);
        }
    }
}
Player.prototype._ensureHasState = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.state) <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.NO_STATE);
}
Player.prototype._ensureHasAnim = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.anim) <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.NO_SCENE);
}
Player.prototype.__beforeFrame = <span class="keyword">function</span>(scene) {
    <span class="keyword">return</span> (<span class="keyword">function</span>(player, state, scene, callback) {
        <span class="keyword">return</span> <span class="keyword">function</span>(time) {
            <span class="keyword">if</span> (state.happens !== C.PLAYING) <span class="keyword">return</span> <span class="literal">false</span>;
            <span class="keyword">if</span> (((state.stop !== Player.NO_TIME) &amp;&amp;
                 (time &gt;= (state.from + state.stop))) ||
                 (time &gt; (state.duration + Player.PEFF))) {
                state.time = <span class="number">0</span>;
                scene.reset();
                player.stop();
                <span class="keyword">if</span> (state.repeat) {
                   player.play();
                   player.fire(C.S_REPEAT);
                } <span class="keyword">else</span> <span class="keyword">if</span> (!(player.mode &amp; C.M_INFINITE_DURATION)
                       &amp;&amp; __finite(state.duration)) {
                   player.drawAt(state.duration);
                }
                <span class="keyword">return</span> <span class="literal">false</span>;
            }
            <span class="keyword">if</span> (callback) callback(time, player.ctx);
            <span class="keyword">return</span> <span class="literal">true</span>;
        }
    })(<span class="keyword">this</span>, <span class="keyword">this</span>.state, scene, <span class="keyword">this</span>.__userBeforeFrame);
}
Player.prototype.__afterFrame = <span class="keyword">function</span>(scene) {
    <span class="keyword">return</span> (<span class="keyword">function</span>(player, state, scene, callback) {
        <span class="keyword">return</span> <span class="keyword">function</span>(time) {
            <span class="keyword">if</span> (player.controls &amp;&amp; !player.controls.hidden) {
                player._renderControlsAt(time);
            }
            <span class="keyword">if</span> (callback) callback(time);
            <span class="keyword">return</span> <span class="literal">true</span>;
        }
    })(<span class="keyword">this</span>, <span class="keyword">this</span>.state, scene, <span class="keyword">this</span>.__userAfterFrame);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Called when any error happens during player initialization or animation
Player should mute all non-system errors by default, and if it got a system error, it may show
this error over itself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Player.prototype.__onerror = <span class="keyword">function</span>(err) {
  <span class="keyword">var</span> player = <span class="keyword">this</span>;
  <span class="keyword">var</span> doMute = (player.state &amp;&amp; player.state.muteErrors);
      doMute = doMute &amp;&amp; !(err <span class="keyword">instanceof</span> SysErr);

  <span class="keyword">try</span> {
    player.state.happens = C.ERROR;
    player.__lastError = err;
    player.fire(C.S_ERROR, err);

    player.anim = <span class="literal">null</span>;
    <span class="comment">/*if (player.state)*/</span> player.__unsafe_stop();
  } <span class="keyword">catch</span>(e) { <span class="keyword">throw</span> <span class="keyword">new</span> SysErr(_strf(Errors.S.ERROR_HANDLING_FAILED, [err.message || err])); }

  doMute = (<span class="keyword">this</span>.__err_handler &amp;&amp; <span class="keyword">this</span>.__err_handler(err)) || doMute;

  <span class="keyword">if</span> (!doMute) {
      <span class="keyword">this</span>._drawErrorSplash(err);
      <span class="keyword">throw</span> err;
  }
}
Player.prototype.__callSafe = <span class="keyword">function</span>(f) {
  <span class="keyword">try</span> {
    <span class="keyword">return</span> f.call(<span class="keyword">this</span>);
  } <span class="keyword">catch</span>(err) {
    <span class="keyword">this</span>.__onerror(err);
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>safe call generator for player method (synchronous calls)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Player.prototype.__defSafe = <span class="keyword">function</span>(method_f) {
  <span class="keyword">var</span> player = <span class="keyword">this</span>;
  <span class="keyword">return</span> <span class="keyword">function</span>() {
    <span class="keyword">var</span> args = arguments;
    <span class="keyword">if</span> (!<span class="keyword">this</span>.__safe_ctx) { <span class="comment">// already in safe context</span>
      <span class="keyword">this</span>.__safe_ctx = <span class="literal">true</span>;
      <span class="keyword">try</span> {
        <span class="keyword">var</span> ret_val = player.__callSafe(<span class="keyword">function</span>() {
          <span class="keyword">return</span> method_f.apply(player, args);
        });
        <span class="keyword">this</span>.__safe_ctx = <span class="literal">false</span>;
        <span class="keyword">return</span> ret_val;
      } <span class="keyword">catch</span>(err) {
        <span class="keyword">this</span>.__safe_ctx = <span class="literal">false</span>;
        <span class="keyword">throw</span> err;
      }
    } <span class="keyword">else</span> {
      <span class="keyword">return</span> method_f.apply(player, args);
    }
  };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>safe call generator for asycnhronous function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Player.prototype.__defAsyncSafe = <span class="keyword">function</span>(func) {
  <span class="keyword">var</span> player = <span class="keyword">this</span>;
  <span class="keyword">return</span> <span class="keyword">function</span>() {
    <span class="keyword">var</span> args = arguments;
    <span class="keyword">try</span> {
      <span class="keyword">var</span> ret_val = player.__callSafe(<span class="keyword">function</span>() {
        <span class="keyword">return</span> func.apply(player, args);
      });
      <span class="keyword">return</span> ret_val;
    } <span class="keyword">catch</span>(err) {
      <span class="keyword">throw</span> err;
    }
  };
}
Player.prototype.__makeSafe = <span class="keyword">function</span>(methods) {
  <span class="keyword">var</span> player = <span class="keyword">this</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, il = methods.length; i &lt; il; i++) {
    <span class="keyword">var</span> method = methods[i];
    <span class="keyword">if</span> (!player[method]) <span class="keyword">throw</span> <span class="keyword">new</span> SysErr(_strf(Errors.S.NO_METHOD_FOR_PLAYER, [method]));
    player[<span class="string">'__unsafe_'</span>+method] = player[method];
    player[method] = player.__defSafe(player[method]);
  }
}
Player.prototype.handle__x = <span class="keyword">function</span>(type, evt) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.anim) <span class="keyword">this</span>.anim.fire(type, <span class="keyword">this</span>);
    <span class="keyword">return</span> <span class="literal">true</span>;
}
Player.prototype._clearPostpones = <span class="keyword">function</span>() {
    <span class="keyword">this</span>._queue = [];
}
Player.prototype._postpone = <span class="keyword">function</span>(method, args) {
    <span class="keyword">if</span> (!<span class="keyword">this</span>._queue) <span class="keyword">this</span>._queue = [];
    <span class="keyword">this</span>._queue.push([ method, args ]);
}
Player.prototype._callPostpones = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>._queue &amp;&amp; <span class="keyword">this</span>._queue.length) {
        <span class="keyword">var</span> q = <span class="keyword">this</span>._queue, spec;
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, il = q.length; i &lt; il; i++) {
          spec = q[i]; <span class="keyword">this</span>[spec[<span class="number">0</span>]].apply(<span class="keyword">this</span>, spec[<span class="number">1</span>]);
        }
    }
    <span class="keyword">this</span>._queue = [];
}

<span class="comment">/* Player.prototype.__originateErrors = function() {
    return (function(player) { return function(err) {
        return player._fireError(err);
    }})(this);
} */</span>
Player._saveCanvasPos = <span class="keyword">function</span>(cvs) {
    <span class="keyword">var</span> gcs = ($doc.defaultView &amp;&amp;
               $doc.defaultView.getComputedStyle); <span class="comment">// last is assigned</span></pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>computed padding-left</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> cpl = gcs ?
          (parseInt(gcs(cvs, <span class="literal">null</span>).paddingLeft, <span class="number">10</span>) || <span class="number">0</span>) : <span class="number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>computed padding-top</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        cpt = gcs ?
          (parseInt(gcs(cvs, <span class="literal">null</span>).paddingTop, <span class="number">10</span>) || <span class="number">0</span>) : <span class="number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>computed bodrer-left</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        cbl = gcs ?
          (parseInt(gcs(cvs, <span class="literal">null</span>).borderLeftWidth,  <span class="number">10</span>) || <span class="number">0</span>) : <span class="number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>computed bodrer-top</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        cbt = gcs ?
          (parseInt(gcs(cvs, <span class="literal">null</span>).borderTopWidth,  <span class="number">10</span>) || <span class="number">0</span>) : <span class="number">0</span>;

    <span class="keyword">var</span> html = $doc.body.parentNode,
        htol = html.offsetLeft,
        htot = html.offsetTop;

    <span class="keyword">var</span> elm = cvs,
        ol = cpl + cbl + htol,
        ot = cpt + cbt + htot;

    <span class="keyword">if</span> (elm.offsetParent !== <span class="literal">undefined</span>) {
        <span class="keyword">do</span> {
            ol += elm.offsetLeft;
            ot += elm.offsetTop;
        } <span class="keyword">while</span> (elm = elm.offsetParent)
    }

    ol += cpl + cbl + htol;
    ot += cpt + cbt + htot;

    <span class="comment">/* FIXME: find a method with no injection of custom properties
              (data-xxx attributes are stored as strings and may work
               a bit slower for events) */</span>
    cvs.__rOffsetLeft = ol || cvs.__anm_usr_x;
    cvs.__rOffsetTop = ot || cvs.__anm_usr_y;
}

Player.createState = <span class="keyword">function</span>(player) {
    <span class="keyword">return</span> {
        <span class="string">'time'</span>: Player.NO_TIME, <span class="string">'from'</span>: <span class="number">0</span>, <span class="string">'stop'</span>: Player.NO_TIME,
        <span class="string">'speed'</span>: <span class="number">1</span>, <span class="string">'fps'</span>: <span class="number">30</span>, <span class="string">'afps'</span>: <span class="number">0</span>, <span class="string">'duration'</span>: <span class="number">0</span>,
        <span class="string">'debug'</span>: <span class="literal">false</span>, <span class="string">'iactive'</span>: <span class="literal">false</span>,
        <span class="comment">/* TODO: use iactive to determine if controls/info should be init-zed */</span>
        <span class="string">'width'</span>: player.canvas.offsetWidth,
        <span class="string">'height'</span>: player.canvas.offsetHeight,
        <span class="string">'zoom'</span>: <span class="number">1.0</span>, <span class="string">'bgcolor'</span>: <span class="literal">null</span>,
        <span class="string">'happens'</span>: C.NOTHING,
        <span class="string">'duration'</span>: <span class="literal">undefined</span>,
        <span class="string">'__startTime'</span>: -<span class="number">1</span>,
        <span class="string">'__redraws'</span>: <span class="number">0</span>, <span class="string">'__rsec'</span>: <span class="number">0</span>
        <span class="comment">/*'__drawInterval': null*/</span>
    };
}

Player._isPlayerEvent = <span class="keyword">function</span>(type) {</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>TODO: make some marker to group types of events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> ((type == C.S_PLAY) || (type == C.S_PAUSE) ||
            (type == C.S_STOP) || (type == C.S_REPEAT) ||
            (type == C.S_LOAD) || (type == C.S_RES_LOAD) ||
            (type == C.S_ERROR) || (type == C.S_IMPORT));
}
<span class="function"><span class="keyword">function</span> <span class="title">__attrOr</span><span class="params">(canvas, attr, _default)</span> {</span>
    <span class="keyword">return</span> canvas.hasAttribute(attr)
           ? canvas.getAttribute(attr)
           : _<span class="keyword">default</span>;
}
Player._mergeOpts = <span class="keyword">function</span>(what, where) {
    <span class="keyword">var</span> res = _mrg_obj(what, where);
    res.meta = what.meta ? _mrg_obj(what.meta, where.meta || {}) : (where.meta || {});
    res.anim = what.anim ? _mrg_obj(what.anim, where.anim || {}) : (where.anim || {});
    <span class="keyword">return</span> res;
}
Player._optsFromCvsAttrs = <span class="keyword">function</span>(canvas) {
    <span class="keyword">var</span> width, height,
        pxRatio = getPxRatio();
    <span class="keyword">return</span> { <span class="string">'debug'</span>: __attrOr(canvas, <span class="string">'data-debug'</span>, <span class="literal">undefined</span>),
             <span class="string">'inParent'</span>: <span class="literal">undefined</span>,
             <span class="string">'muteErrors'</span>: __attrOr(canvas, <span class="string">'data-mute-errors'</span>, <span class="literal">false</span>),
             <span class="string">'repeat'</span>: __attrOr(canvas, <span class="string">'data-repeat'</span>, <span class="literal">undefined</span>),
             <span class="string">'mode'</span>: __attrOr(canvas, <span class="string">'data-mode'</span>, <span class="literal">undefined</span>),
             <span class="string">'zoom'</span>: __attrOr(canvas, <span class="string">'data-zoom'</span>, <span class="literal">undefined</span>),
             <span class="string">'meta'</span>: { <span class="string">'title'</span>: __attrOr(canvas, <span class="string">'data-title'</span>, <span class="literal">undefined</span>),
                       <span class="string">'author'</span>: __attrOr(canvas, <span class="string">'data-author'</span>, <span class="literal">undefined</span>),
                       <span class="string">'copyright'</span>: <span class="literal">undefined</span>,
                       <span class="string">'version'</span>: <span class="literal">undefined</span>,
                       <span class="string">'description'</span>: <span class="literal">undefined</span> },
             <span class="string">'anim'</span>: { <span class="string">'fps'</span>: <span class="literal">undefined</span>,
                       <span class="string">'width'</span>: (__attrOr(canvas, <span class="string">'data-width'</span>,
                                (width = __attrOr(canvas, <span class="string">'width'</span>, <span class="literal">undefined</span>),
                                 width ? (width / pxRatio) : <span class="literal">undefined</span>))),
                       <span class="string">'height'</span>: (__attrOr(canvas, <span class="string">'data-height'</span>,
                                 (height = __attrOr(canvas, <span class="string">'height'</span>, <span class="literal">undefined</span>),
                                  height ? (height / pxRatio) : <span class="literal">undefined</span>))),
                       <span class="string">'bgcolor'</span>: canvas.hasAttribute(<span class="string">'data-bgcolor'</span>)
                                 ? { <span class="string">'color'</span>: canvas.getAttribute(<span class="string">'data-bgcolor'</span>) }
                                 : <span class="literal">undefined</span>,
                       <span class="string">'duration'</span>: <span class="literal">undefined</span> } };
};
Player._optsFromUrlParams = <span class="keyword">function</span>(params<span class="comment">/* as object */</span>) {
    <span class="keyword">return</span> { <span class="string">'debug'</span>: params.debug,
             <span class="string">'inParent'</span>: <span class="literal">undefined</span>,
             <span class="string">'muteErrors'</span>: <span class="literal">false</span>,
             <span class="string">'repeat'</span>: params.r,
             <span class="string">'mode'</span>: params.m,
             <span class="string">'zoom'</span>: params.z,
             <span class="string">'anim'</span>: { <span class="string">'fps'</span>: <span class="literal">undefined</span>,
                       <span class="string">'width'</span>: params.w,
                       <span class="string">'height'</span>: params.h,
                       <span class="string">'bgcolor'</span>: { color: params.bg ? <span class="string">"#"</span> + params.bg : <span class="literal">null</span> },
                       <span class="string">'duration'</span>: <span class="literal">undefined</span> } };
}
Player.forSnapshot = <span class="keyword">function</span>(canvasId, snapshotUrl, importer, callback) {
    <span class="keyword">var</span> urlWithParams = snapshotUrl.split(<span class="string">'?'</span>),
        snapshotUrl = urlWithParams[<span class="number">0</span>],
        urlParams = urlWithParams[<span class="number">1</span>], <span class="comment">// TODO: validate them?</span>
        params = (urlParams &amp;&amp; urlParams.length &gt; <span class="number">0</span>) ? __paramsToObj(urlParams) : {},
        options = Player._optsFromUrlParams(params),
        player = <span class="keyword">new</span> Player();
    player.init(canvasId, options);
    <span class="function"><span class="keyword">function</span> <span class="title">updateWithParams</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> params.t !== <span class="string">'undefined'</span>) {
            player.play(params.t / <span class="number">100</span>);
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> params.p !== <span class="string">'undefined'</span>) {
            player.play(params.p / <span class="number">100</span>).pause();
        }
        <span class="keyword">if</span> (params.w &amp;&amp; params.h) {
            player._reconfigureCanvas({ width: params.w, height: params.h });
        }
        <span class="keyword">if</span> (params.bg) player.canvas.style.backgroundColor = <span class="string">'#'</span> + params.bg;
        <span class="keyword">if</span> (callback) callback();
    }

    player.load(snapshotUrl, importer, updateWithParams);

    <span class="keyword">return</span> player;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <h2>Scene</h2>

            </div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <blockquote>
<p>Scene % ()</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">Scene</span><span class="params">()</span> {</span>
    <span class="keyword">this</span>.id = guid();
    <span class="keyword">this</span>.tree = [];
    <span class="keyword">this</span>.hash = {};
    <span class="keyword">this</span>.name = <span class="string">''</span>;
    <span class="keyword">this</span>.duration = <span class="literal">undefined</span>;
    <span class="keyword">this</span>.bgfill = <span class="literal">null</span>;
    <span class="keyword">this</span>.width = <span class="literal">undefined</span>;
    <span class="keyword">this</span>.height = <span class="literal">undefined</span>;
    <span class="keyword">this</span>.__informEnabled = <span class="literal">true</span>;
    <span class="keyword">this</span>._initHandlers(); <span class="comment">// TODO: make automatic</span>
}

Scene.DEFAULT_LEN = <span class="number">10</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>mouse/keyboard events are assigned in L.loadScene</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* TODO: move them into scene */</span>
provideEvents(Scene, [ C.X_MCLICK, C.X_MDCLICK, C.X_MUP, C.X_MDOWN,
                       C.X_MMOVE, C.X_MOVER, C.X_MOUT,
                       C.X_KPRESS, C.X_KUP, C.X_KDOWN,
                       C.X_DRAW,</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>player events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                       C.S_PLAY, C.S_PAUSE, C.S_STOP, C.S_REPEAT,
                       C.S_IMPORT, C.S_LOAD, C.S_RES_LOAD, C.S_ERROR ]);
Scene.prototype.setDuration = <span class="keyword">function</span>(val) {
  <span class="keyword">this</span>.duration = (val &gt;= <span class="number">0</span>) ? val : <span class="number">0</span>;
}
<span class="comment">/* TODO: add chaining to all external Scene methods? */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <blockquote>
<p>Scene.add % (elem: Element | Clip)
Scene.add % (elems: Array[Element]) =&gt; Clip
Scene.add % (draw: Function(ctx: Context),
               onframe: Function(time: Float),
               [ transform: Function(ctx: Context,
                                     prev: Function(Context)) ])
               =&gt; Element
Scene.add % (builder: Builder)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Scene.prototype.add = <span class="keyword">function</span>(arg1, arg2, arg3) {
    <span class="keyword">if</span> (arg2) { <span class="comment">// element by functions mode</span>
        <span class="keyword">var</span> _elm = <span class="keyword">new</span> Element(arg1, arg2);
        <span class="keyword">if</span> (arg3) _elm.changeTransform(arg3);
        <span class="keyword">this</span>._addToTree(_elm);
        <span class="keyword">return</span> _elm;
    } <span class="keyword">else</span> <span class="keyword">if</span> (__arr(arg1)) { <span class="comment">// elements array mode</span>
        <span class="keyword">var</span> _clip = <span class="keyword">new</span> Clip();
        _clip.add(arg1);
        <span class="keyword">this</span>._addToTree(_clip);
        <span class="keyword">return</span> _clip;
    } <span class="keyword">else</span> <span class="keyword">if</span> (__builder(arg1)) { <span class="comment">// builder instance</span>
        <span class="keyword">this</span>._addToTree(arg1.v);
    } <span class="keyword">else</span> { <span class="comment">// element object mode</span>
        <span class="keyword">this</span>._addToTree(arg1);
    }
}
<span class="comment">/* addS allowed to add static element before, such as image, may be return it in some form? */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <blockquote>
<p>Scene.remove % (elm: Element)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Scene.prototype.remove = <span class="keyword">function</span>(elm) {</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>error will be thrown in _unregister method
if (!this.hash[elm.id]) throw new AnimErr(Errors.A.ELEMENT_IS_NOT_REGISTERED);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (elm.parent) {</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>it will unregister element inside</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        elm.parent.remove(elm);
    } <span class="keyword">else</span> {
        <span class="keyword">this</span>._unregister(elm);
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <blockquote>
<p>Scene.prototype.clear % ()</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* Scene.prototype.clear = function() {
    this.hash = {};
    this.tree = [];
    this.duration = 0;
    var hash = this.hash;
    this.hash = {};
    for (var elmId in hash) {
        hash[elm.id]._unbind(); // unsafe, because calls unregistering
    }
} */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <blockquote>
<p>Scene.visitElems % (visitor: Function(elm: Element))</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Scene.prototype.visitElems = <span class="keyword">function</span>(visitor, data) {
    <span class="keyword">for</span> (<span class="keyword">var</span> elmId <span class="keyword">in</span> <span class="keyword">this</span>.hash) {
        visitor(<span class="keyword">this</span>.hash[elmId], data);
    }
}
Scene.prototype.travelChildren = Scene.prototype.visitElems;</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <blockquote>
<p>Scene.visitRoots % (visitor: Function(elm: Element))</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Scene.prototype.visitRoots = <span class="keyword">function</span>(visitor, data) {
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, tlen = <span class="keyword">this</span>.tree.length; i &lt; tlen; i++) {
        visitor(<span class="keyword">this</span>.tree[i], data);
    }
}
Scene.prototype.visitChildren = Scene.prototype.visitRoots;
Scene.prototype.iterateRoots = <span class="keyword">function</span>(func, rfunc) {
    iter(<span class="keyword">this</span>.tree).each(func, rfunc);
}
Scene.prototype.render = <span class="keyword">function</span>(ctx, time, zoom) {
    ctx.save();
    <span class="keyword">if</span> (zoom != <span class="number">1</span>) {
        ctx.scale(zoom, zoom);
    }
    <span class="keyword">if</span> (<span class="keyword">this</span>.bgfill) {
        ctx.fillStyle = Brush.create(ctx, <span class="keyword">this</span>.bgfill);
        ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>.width, <span class="keyword">this</span>.height);
    }
    <span class="keyword">this</span>.visitRoots(<span class="keyword">function</span>(elm) {
        elm.render(ctx, time);
    });
    ctx.restore();
    <span class="keyword">this</span>.fire(C.X_DRAW,ctx);
}
Scene.prototype.handle__x = <span class="keyword">function</span>(type, evt) {
    <span class="keyword">this</span>.visitElems(<span class="keyword">function</span>(elm) {
        elm.fire(type, evt);
    });
    <span class="keyword">return</span> <span class="literal">true</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>TODO: test</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Scene.prototype.getFittingDuration = <span class="keyword">function</span>() {
    <span class="keyword">var</span> max_pos = -<span class="literal">Infinity</span>;
    <span class="keyword">var</span> me = <span class="keyword">this</span>;
    <span class="keyword">this</span>.visitRoots(<span class="keyword">function</span>(elm) {
        <span class="keyword">var</span> elm_tpos = elm._max_tpos();
        <span class="keyword">if</span> (elm_tpos &gt; max_pos) max_pos = elm_tpos;
    });
    <span class="keyword">return</span> max_pos;
}
Scene.prototype.reset = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.__informEnabled = <span class="literal">true</span>;
    <span class="keyword">this</span>.visitRoots(<span class="keyword">function</span>(elm) {
        elm.reset();
    });
}
Scene.prototype.dispose = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.disposeHandlers();
    <span class="keyword">var</span> me = <span class="keyword">this</span>;
    <span class="comment">/* FIXME: unregistering removes from tree, ensure it is safe */</span>
    <span class="keyword">this</span>.iterateRoots(<span class="keyword">function</span>(elm) {
        me._unregister_no_rm(elm);
        elm.dispose();
        <span class="keyword">return</span> <span class="literal">false</span>;
    });
}
Scene.prototype.isEmpty = <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="keyword">this</span>.tree.length == <span class="number">0</span>;
}
Scene.prototype.toString = <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="string">"[ Scene "</span>+(<span class="keyword">this</span>.name ? <span class="string">"'"</span>+<span class="keyword">this</span>.name+<span class="string">"'"</span> : <span class="string">""</span>)+<span class="string">"]"</span>;
}
Scene.prototype.subscribeEvents = <span class="keyword">function</span>(canvas) {
    <span class="keyword">var</span> anim = <span class="keyword">this</span>;
    <span class="keyword">if</span> (canvas.__anm_handlers &amp;&amp; canvas.__anm_handlers[<span class="keyword">this</span>.id]) <span class="keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>canvas.__anm_subscription_id = guid();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> handlers = {
      mouseup:   <span class="keyword">function</span>(evt) { anim.fire(C.X_MUP,     mevt(evt, canvas)); },
      mousedown: <span class="keyword">function</span>(evt) { anim.fire(C.X_MDOWN,   mevt(evt, canvas)); },
      mousemove: <span class="keyword">function</span>(evt) { anim.fire(C.X_MMOVE,   mevt(evt, canvas)); },
      mouseover: <span class="keyword">function</span>(evt) { anim.fire(C.X_MOVER,   mevt(evt, canvas)); },
      mouseout:  <span class="keyword">function</span>(evt) { anim.fire(C.X_MOUT,    mevt(evt, canvas)); },
      click:     <span class="keyword">function</span>(evt) { anim.fire(C.X_MCLICK,  mevt(evt, canvas)); },
      dblclick:  <span class="keyword">function</span>(evt) { anim.fire(C.X_MDCLICK, mevt(evt, canvas)); },
      keyup:     <span class="keyword">function</span>(evt) { anim.fire(C.X_KUP,     kevt(evt, canvas)); },
      keydown:   <span class="keyword">function</span>(evt) { anim.fire(C.X_KDOWN,   kevt(evt, canvas)); },
      keypress:  <span class="keyword">function</span>(evt) { anim.fire(C.X_KPRESS,  kevt(evt, canvas)); }
    };
    <span class="keyword">for</span> (<span class="keyword">var</span> evt_type <span class="keyword">in</span> handlers) {
      canvas.addEventListener(evt_type, handlers[evt_type], <span class="literal">false</span>);
    }
    <span class="keyword">if</span> (!canvas.__anm_handlers) canvas.__anm_handlers = {};
    canvas.__anm_handlers[<span class="keyword">this</span>.id] = handlers;
}
Scene.prototype.unsubscribeEvents = <span class="keyword">function</span>(canvas) {
    <span class="keyword">if</span> (!canvas.__anm_handlers) <span class="keyword">return</span>;
    <span class="keyword">var</span> handlers = canvas.__anm_handlers[<span class="keyword">this</span>.id];
    <span class="keyword">if</span> (!handlers) <span class="keyword">return</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> evt_type <span class="keyword">in</span> handlers) {
      canvas.removeEventListener(evt_type, handlers[evt_type], <span class="literal">false</span>);
    }
}
Scene.prototype._addToTree = <span class="keyword">function</span>(elm) {
    <span class="keyword">if</span> (!elm.children) {
        <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(<span class="string">'It appears that it is not a clip object or element that you pass'</span>);
    }
    <span class="keyword">this</span>._register(elm);
    <span class="comment">/*if (elm.children) this._addElems(elm.children);*/</span>
    <span class="keyword">this</span>.tree.push(elm);
}
<span class="comment">/*Scene.prototype._addElems = function(elems) {
    for (var ei = 0; ei &lt; elems.length; ei++) {
        var _elm = elems[ei];
        this._register(_elm);
    }
}*/</span>
Scene.prototype._register = <span class="keyword">function</span>(elm) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.hash[elm.id]) <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(Errors.A.ELEMENT_IS_REGISTERED);
    elm.registered = <span class="literal">true</span>;
    elm.scene = <span class="keyword">this</span>;
    <span class="keyword">this</span>.hash[elm.id] = elm;
    <span class="keyword">var</span> me = <span class="keyword">this</span>;
    elm.visitChildren(<span class="keyword">function</span>(elm) {
        me._register(elm);
    });
}
Scene.prototype._unregister_no_rm = <span class="keyword">function</span>(elm) {
    <span class="keyword">this</span>._unregister(elm, <span class="literal">true</span>);
}
Scene.prototype._unregister = <span class="keyword">function</span>(elm, save_in_tree) { <span class="comment">// save_in_tree is optional and false by default</span>
    <span class="keyword">if</span> (!elm.registered) <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(Errors.A.ELEMENT_IS_NOT_REGISTERED);
    <span class="keyword">var</span> me = <span class="keyword">this</span>;
    elm.visitChildren(<span class="keyword">function</span>(elm) {
        me._unregister(elm);
    });
    <span class="keyword">var</span> pos = -<span class="number">1</span>;
    <span class="keyword">if</span> (!save_in_tree) {
      <span class="keyword">while</span> ((pos = <span class="keyword">this</span>.tree.indexOf(elm)) &gt;= <span class="number">0</span>) {
        <span class="keyword">this</span>.tree.splice(pos, <span class="number">1</span>);
      }
    }
    <span class="keyword">delete</span> <span class="keyword">this</span>.hash[elm.id];
    elm.registered = <span class="literal">false</span>;
    elm.scene = <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>elm.parent = null;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}
Scene.prototype._collectRemoteResources = <span class="keyword">function</span>() {
    <span class="keyword">var</span> remotes = [];
    <span class="keyword">this</span>.visitElems(<span class="keyword">function</span>(elm) {
        <span class="keyword">if</span> (elm._hasRemoteResources()) {
           remotes = remotes.concat(elm._getRemoteResources());
        }
    });
    <span class="keyword">return</span> remotes;
}

Scene.prototype.findById = <span class="keyword">function</span>(id) {
    <span class="keyword">return</span> <span class="keyword">this</span>.hash[id];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <h2>Element</h2>

            </div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>repeat mode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>C.R_ONCE = <span class="number">0</span>;
C.R_STAY = <span class="number">1</span>;
C.R_LOOP = <span class="number">2</span>;
C.R_BOUNCE = <span class="number">3</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>composite operation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>C.C_SRC_OVER = <span class="number">1</span>; <span class="comment">// first (default) is 1, to pass if test</span>
C.C_SRC_ATOP = <span class="number">2</span>;
C.C_SRC_IN = <span class="number">3</span>;
C.C_SRC_OUT = <span class="number">4</span>;
C.C_DST_OVER = <span class="number">5</span>;
C.C_DST_ATOP = <span class="number">6</span>;
C.C_DST_IN = <span class="number">7</span>;
C.C_DST_OUT = <span class="number">8</span>;
C.C_LIGHTER = <span class="number">9</span>;
C.C_DARKER = <span class="number">10</span>;
C.C_COPY = <span class="number">11</span>;
C.C_XOR = <span class="number">12</span>;

C.AC_NAMES = [];
C.AC_NAMES[C.C_SRC_OVER] = <span class="string">'source-over'</span>;
C.AC_NAMES[C.C_SRC_ATOP] = <span class="string">'source-atop'</span>;
C.AC_NAMES[C.C_SRC_IN] = <span class="string">'source-in'</span>;
C.AC_NAMES[C.C_SRC_OUT] = <span class="string">'source-out'</span>;
C.AC_NAMES[C.C_DST_OVER] = <span class="string">'destination-over'</span>;
C.AC_NAMES[C.C_DST_ATOP] = <span class="string">'destination-atop'</span>;
C.AC_NAMES[C.C_DST_IN] = <span class="string">'destination-in'</span>;
C.AC_NAMES[C.C_DST_OUT] = <span class="string">'destination-out'</span>;
C.AC_NAMES[C.C_LIGHTER] = <span class="string">'lighter'</span>;
C.AC_NAMES[C.C_DARKER] = <span class="string">'darker'</span>;
C.AC_NAMES[C.C_COPY] = <span class="string">'copy'</span>;
C.AC_NAMES[C.C_XOR] = <span class="string">'xor'</span>;

Element.DEFAULT_PVT = [ <span class="number">0.5</span>, <span class="number">0.5</span> ];
Element.DEFAULT_REG = [ <span class="number">0.0</span>, <span class="number">0.0</span> ];

Element.TYPE_MAX_BIT = <span class="number">16</span>;
Element.PRRT_MAX_BIT = <span class="number">8</span>; <span class="comment">// used to calculate modifiers/painters id's:</span></pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>they are: (type &lt;&lt; TYPE_MAX_BIT) | (priot &lt;&lt; PRRT_MAX_BIT) | i</p>
<p>modifiers classes
the order is also determined with value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.SYS_MOD = <span class="number">0</span>;
Element.TWEEN_MOD = <span class="number">1</span>;
Element.USER_MOD = <span class="number">2</span>;
<span class="comment">/* TODO: JUMP_MOD */</span>
Element.EVENT_MOD = <span class="number">3</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>these two simplify checking in <strong>mafter/</strong>mbefore</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.FIRST_MOD = Element.SYS_MOD;
Element.LAST_MOD = Element.EVENT_MOD;</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>modifiers groups</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.ALL_MODIFIERS = [ Element.SYS_MOD, Element.TWEEN_MOD,
                          Element.USER_MOD, Element.EVENT_MOD ];
Element.NOEVT_MODIFIERS = [ Element.SYS_MOD, Element.TWEEN_MOD,
                            Element.USER_MOD ];</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>painters classes
the order is also determined with value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.SYS_PNT = <span class="number">0</span>;
Element.USER_PNT = <span class="number">1</span>;
Element.DEBUG_PNT = <span class="number">2</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>these two simplify checking in <strong>mafter/</strong>mbefore</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.FIRST_PNT = Element.SYS_PNT;
Element.LAST_PNT = Element.DEBUG_PNT;</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>painters groups</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.ALL_PAINTERS = [ Element.SYS_PNT, Element.USER_PNT,
                         Element.DEBUG_PNT ];
Element.NODBG_PAINTERS = [ Element.SYS_PNT, Element.USER_PNT ];</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <blockquote>
<p>Element % (draw: Function(ctx: Context),
              onframe: Function(time: Float))</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">Element</span><span class="params">(draw, onframe)</span> {</span>
    <span class="keyword">this</span>.id = guid();
    <span class="keyword">this</span>.name = <span class="string">''</span>;
    <span class="keyword">this</span>.bstate = Element.createBaseState();
    <span class="keyword">this</span>.state = Element.createState(<span class="keyword">this</span>);
    <span class="keyword">this</span>.astate = <span class="literal">null</span>; <span class="comment">// actual state</span>
    <span class="keyword">this</span>.xdata = Element.createXData(<span class="keyword">this</span>);
    <span class="keyword">this</span>.children = [];
    <span class="keyword">this</span>.parent = <span class="literal">null</span>;
    <span class="keyword">this</span>.scene = <span class="literal">null</span>;
    <span class="keyword">this</span>.visible = <span class="literal">true</span>; <span class="comment">// user flag, set by user</span>
    <span class="keyword">this</span>.shown = <span class="literal">false</span>; <span class="comment">// system flag, set by engine</span>
    <span class="keyword">this</span>.registered = <span class="literal">false</span>;
    <span class="keyword">this</span>.disabled = <span class="literal">false</span>;
    <span class="keyword">this</span>.rendering = <span class="literal">false</span>;
    <span class="keyword">this</span>.__data = <span class="literal">null</span>;
    <span class="keyword">this</span>._modifiers = [];
    <span class="keyword">this</span>._painters = [];
    <span class="keyword">if</span> (onframe) <span class="keyword">this</span>.__modify({ type: Element.USER_MOD }, onframe);
    <span class="keyword">if</span> (draw) <span class="keyword">this</span>.__paint({ type: Element.USER_PNT }, draw);
    <span class="keyword">this</span>.__lastJump = <span class="literal">null</span>;
    <span class="keyword">this</span>.__jumpLock = <span class="literal">false</span>;
    <span class="keyword">this</span>.__modifying = <span class="literal">null</span>; <span class="comment">// current modifiers class, if modifying</span>
    <span class="keyword">this</span>.__painting = <span class="literal">null</span>; <span class="comment">// current painters class, if painting</span>
    <span class="keyword">this</span>.__evtCache = [];
    <span class="keyword">this</span>.__detachQueue = [];
    <span class="keyword">this</span>.__frameProcessors = [];
    <span class="keyword">this</span>._initHandlers(); <span class="comment">// TODO: make automatic</span>
    <span class="keyword">var</span> _me = <span class="keyword">this</span>,
        default_on = <span class="keyword">this</span>.on;
    <span class="keyword">this</span>.on = <span class="keyword">function</span>(type, handler) {
        <span class="keyword">if</span> (type &amp; C.XT_CONTROL) {
            <span class="keyword">this</span>.m_on.call(_me, type, handler);
        } <span class="keyword">else</span> default_on.call(_me, type, handler);
    };
    Element.__addSysModifiers(<span class="keyword">this</span>);
    Element.__addSysPainters(<span class="keyword">this</span>);
    <span class="keyword">if</span> (global_opts.liveDebug) Element.__addDebugRender(<span class="keyword">this</span>);
}
Element.NO_BAND = <span class="literal">null</span>;
Element.DEFAULT_LEN = <span class="literal">Infinity</span>;
Element._customImporters = [];
provideEvents(Element, [ C.X_MCLICK, C.X_MDCLICK, C.X_MUP, C.X_MDOWN,
                         C.X_MMOVE, C.X_MOVER, C.X_MOUT,
                         C.X_KPRESS, C.X_KUP, C.X_KDOWN,
                         C.X_DRAW, C.X_START, C.X_STOP,</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>player events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                         C.S_PLAY, C.S_PAUSE, C.S_STOP, C.S_REPEAT,
                         C.S_IMPORT, C.S_LOAD, C.S_RES_LOAD, C.S_ERROR ]);</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <blockquote>
<p>Element.prepare % () =&gt; Boolean</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.prepare = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.state._matrix.reset();
    <span class="keyword">return</span> <span class="literal">true</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <blockquote>
<p>Element.onframe % (gtime: Float) =&gt; Boolean</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.onframe = <span class="keyword">function</span>(ltime) {
    <span class="keyword">return</span> <span class="keyword">this</span>.__callModifiers(Element.ALL_MODIFIERS, ltime);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <blockquote>
<p>Element.drawTo % (ctx: Context)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.drawTo = <span class="keyword">function</span>(ctx) {
    <span class="keyword">return</span> <span class="keyword">this</span>.__callPainters(Element.ALL_PAINTERS, ctx);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <blockquote>
<p>Element.draw % (ctx: Context)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.draw = Element.prototype.drawTo</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <blockquote>
<p>Element.transform % (ctx: Context)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.transform = <span class="keyword">function</span>(ctx) {
    <span class="keyword">var</span> s = <span class="keyword">this</span>.state,
        bs = <span class="keyword">this</span>.bstate,
        as = Element._mergeStates(bs, s);
    <span class="keyword">this</span>.astate = as;
    s._matrix = Element._getMatrixOf(as, s._matrix);
    ctx.globalAlpha *= as.alpha;
    s._matrix.apply(ctx);
    as._matrix = s._matrix;</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>FIXME: do not store matrix in a state here,
but return it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <blockquote>
<p>Element.render % (ctx: Context, gtime: Float)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.render = <span class="keyword">function</span>(ctx, gtime) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.disabled) <span class="keyword">return</span>;
    <span class="keyword">this</span>.rendering = <span class="literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>context is saved even before decision, if we draw or not, for safety:
because context anyway may be changed with user functions,
like modifiers who return false (and we do not want to restrict
user to do that)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ctx.save();
    <span class="keyword">var</span> drawMe = <span class="literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>checks if any time jumps (including repeat
modes) were performed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> ltime = <span class="keyword">this</span>.ltime(gtime);
    drawMe = <span class="keyword">this</span>.__preRender(gtime, ltime, ctx);</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>fire band start/end events
FIXME: may not fire STOP on low-FPS, move an additional check
FIXME: masks have no scene set to something, but should to (see masks tests)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (<span class="keyword">this</span>.scene &amp;&amp; <span class="keyword">this</span>.scene.__informEnabled) <span class="keyword">this</span>.inform(ltime);
    <span class="keyword">if</span> (drawMe) {
        drawMe = <span class="keyword">this</span>.fits(ltime)
                 &amp;&amp; <span class="keyword">this</span>.onframe(ltime)
                 &amp;&amp; <span class="keyword">this</span>.prepare()
                 &amp;&amp; <span class="keyword">this</span>.visible;
    }
    <span class="keyword">if</span> (drawMe) {</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>update global time with new local time (it may&#39;ve been
changed if there were jumps or something), so children will
get the proper value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        gtime = <span class="keyword">this</span>.gtime(ltime);
        <span class="keyword">if</span> (!<span class="keyword">this</span>.__mask) {</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>draw directly to context, if has no mask</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.transform(ctx);
            <span class="keyword">this</span>.draw(ctx);
            <span class="keyword">this</span>.visitChildren(<span class="keyword">function</span>(elm) {
                elm.render(ctx, gtime);
            });
        } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>draw to back canvas, if has</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.__ensureHasMaskCanvas();
            <span class="keyword">var</span> mcvs = <span class="keyword">this</span>.__maskCvs,
                mctx = <span class="keyword">this</span>.__maskCtx,
                bcvs = <span class="keyword">this</span>.__backCvs,
                bctx = <span class="keyword">this</span>.__backCtx;

            <span class="keyword">var</span> scene_width = <span class="keyword">this</span>.scene.width,
                scene_height = <span class="keyword">this</span>.scene.height,
                dbl_scene_width = scene_width * <span class="number">2</span>,
                dbl_scene_height = scene_height * <span class="number">2</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>at this point:
mcvs.height is twice scene height
mcvs.width  is twice scene width</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            bctx.save();
            bctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, dbl_scene_width,
                                 dbl_scene_height);

            bctx.save();
            bctx.translate(scene_width, scene_height);
            <span class="keyword">this</span>.transform(bctx);
            <span class="keyword">this</span>.visitChildren(<span class="keyword">function</span>(elm) {
                elm.render(bctx, gtime);
            });
            <span class="keyword">this</span>.draw(bctx);
            bctx.restore();
            bctx.globalCompositeOperation = <span class="string">'destination-in'</span>;

            mctx.save();
            mctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, dbl_scene_width,
                                 dbl_scene_height);
            mctx.translate(scene_width, scene_height);
            <span class="keyword">this</span>.__mask.render(mctx, gtime);
            mctx.restore();

            bctx.drawImage(mcvs, <span class="number">0</span>, <span class="number">0</span>, dbl_scene_width,
                                       dbl_scene_height);
            bctx.restore();

            ctx.drawImage(bcvs, -scene_width, -scene_height,
                          dbl_scene_width, dbl_scene_height);
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>immediately when drawn, element becomes shown,
it is reasonable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">this</span>.shown = drawMe;
    ctx.restore();
    <span class="keyword">this</span>.__postRender();
    <span class="keyword">this</span>.rendering = <span class="literal">false</span>;
    <span class="keyword">if</span> (drawMe) <span class="keyword">this</span>.fire(C.X_DRAW,ctx);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <blockquote>
<p>Element.addModifier % (( configuration: Object,
                           modifier: Function(time: Float,
                                              data: Any) =&gt; Boolean)
                       | ( modifier: Function(time: Float,
                                            data: Any) =&gt; Boolean,
                           [easing: Function()],
                           [data: Any],
                           [priority: Int]
                        ) =&gt; Integer</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.addModifier = <span class="keyword">function</span>(modifier, easing, data, priority) {
    <span class="keyword">if</span> (__obj(modifier)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>modifier is configuration here and easing is modifier factually</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      modifier.type = Element.USER_MOD; <span class="comment">// here, type should always be user-modifier</span>
      <span class="keyword">return</span> <span class="keyword">this</span>.__modify(modifier, easing);
    } <span class="keyword">else</span> {
      <span class="keyword">return</span> <span class="keyword">this</span>.__modify({ type: Element.USER_MOD,
                             priority: priority,
                             easing: easing,
                             data: data }, modifier);
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <blockquote>
<p>Element.addTModifier % (restriction: Array[Float, 2] | Float,
                          modifier: Function(time: Float,
                                             data: Any) =&gt; Boolean,
                          [easing: Function()],
                          [data: Any],
                          [priority: Int]
                         ) =&gt; Integer</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.addTModifier = <span class="keyword">function</span>(time, modifier, easing, data, priority) {
    <span class="keyword">return</span> <span class="keyword">this</span>.__modify({ type: Element.USER_MOD,
                           priority: priority,
                           time: time,
                           easing: easing,
                           data: data }, modifier);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <blockquote>
<p>Element.addRModifier % (modifier: Function(time: Float,
                                            data: Any) =&gt; Boolean,
                          [easing: Function()],
                          [data: Any],
                          [priority: Int]
                         ) =&gt; Integer</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.addRModifier = <span class="keyword">function</span>(modifier, easing, data, priority) {
    <span class="keyword">return</span> <span class="keyword">this</span>.__modify({ type: Element.USER_MOD,
                           priority: priority,
                           easing: easing,
                           relative: <span class="literal">true</span>,
                           data: data }, modifier);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <blockquote>
<p>Element.addRTModifier % (restriction: Array[Float, 2] | Float,
                           modifier: Function(time: Float,
                                              data: Any) =&gt; Boolean,
                           [easing: Function()],
                           [data: Any],
                           [priority: Int]
                          ) =&gt; Integer</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.addRTModifier = <span class="keyword">function</span>(time, modifier, easing, data, priority) {
    <span class="keyword">return</span> <span class="keyword">this</span>.__modify({ type: Element.USER_MOD,
                           priority: priority,
                           time: time,
                           easing: easing,
                           relative: <span class="literal">true</span>,
                           data: data }, modifier);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <blockquote>
<p>Element.removeModifier % (modifier: Function)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.removeModifier = <span class="keyword">function</span>(modifier) {
    <span class="keyword">if</span> (!modifier.__m_ids) <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(Errors.A.MODIFIER_NOT_ATTACHED);</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>if (this.__modifying) throw new AnimErr(&quot;Can&#39;t remove modifiers while modifying&quot;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> id = modifier.__m_ids[<span class="keyword">this</span>.id];
    <span class="keyword">delete</span> modifier.__m_ids[<span class="keyword">this</span>.id];
    <span class="keyword">if</span> (!id) <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(<span class="string">'Modifier wasn\'t applied to this element'</span>);
    <span class="keyword">var</span> TB = Element.TYPE_MAX_BIT,
        PB = Element.PRRT_MAX_BIT;
    <span class="keyword">var</span> type = id &gt;&gt; TB,
        priority = (id - (type &lt;<span class="xml"><span class="tag">&lt; <span class="attribute">TB</span>)) &gt;</span>&gt; PB,
        i = id - (type <span class="tag">&lt;<span class="title">&lt;</span> <span class="attribute">TB</span>) <span class="attribute">-</span> (<span class="attribute">priority</span> &lt;&lt; <span class="attribute">PB</span>);
    <span class="attribute">this._modifiers</span>[<span class="attribute">type</span>][<span class="attribute">priority</span>][<span class="attribute">i</span>] = <span class="attribute">null</span>;
}
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <blockquote>
<p>Element.addPainter % (painter: Function(ctx: Context))
                        =&gt; Integer</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.addPainter = <span class="keyword">function</span>(painter, data, priority) {
    <span class="keyword">return</span> <span class="keyword">this</span>.__paint({ type: Element.USER_PNT,
                          priority: priority,
                          data: data }, painter);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <blockquote>
<p>Element.removePainter % (painter: Function)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.removePainter = <span class="keyword">function</span>(painter) {
    <span class="keyword">if</span> (!painter.__p_ids) <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(<span class="string">'Painter wasn\'t applied to anything'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>if (this.__painting) throw new AnimErr(&quot;Can&#39;t remove painters while painting&quot;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> id = painter.__p_ids[<span class="keyword">this</span>.id];
    <span class="keyword">delete</span> painter.__p_ids[<span class="keyword">this</span>.id];
    <span class="keyword">var</span> TB = Element.TYPE_MAX_BIT,
        PB = Element.PRRT_MAX_BIT;
    <span class="keyword">var</span> type = id &gt;&gt; TB,
        priority = (id - (type &lt;<span class="xml"><span class="tag">&lt; <span class="attribute">TB</span>)) &gt;</span>&gt; PB,
        i = id - (type <span class="tag">&lt;<span class="title">&lt;</span> <span class="attribute">TB</span>) <span class="attribute">-</span> (<span class="attribute">priority</span> &lt;&lt; <span class="attribute">PB</span>);
    <span class="attribute">this._painters</span>[<span class="attribute">type</span>][<span class="attribute">priority</span>][<span class="attribute">i</span>] = <span class="attribute">null</span>;
}
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <blockquote>
<p>Element.addTween % (tween: Tween)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.addTween = <span class="keyword">function</span>(tween) {
    <span class="keyword">return</span> Element.__addTweenModifier(<span class="keyword">this</span>, tween);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <blockquote>
<p>Element.changeTransform % (transform: Function(ctx: Context,
                                                  prev: Function(Context)))</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.changeTransform = <span class="keyword">function</span>(transform) {
    <span class="keyword">this</span>.transform = (<span class="keyword">function</span>(elm, new_, prev) {
        <span class="keyword">return</span> <span class="keyword">function</span>(ctx) {
           new_.call(elm, ctx, prev);
        }
    } )(<span class="keyword">this</span>, transform, <span class="keyword">this</span>.transform);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <blockquote>
<p>Element.add % (elem: Element | Clip)
Element.add % (elems: Array[Element])
Element.add % (draw: Function(ctx: Context),
                  onframe: Function(time: Float),
                  [ transform: Function(ctx: Context,
                                        prev: Function(Context)) ])
                  =&gt; Element</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.add = <span class="keyword">function</span>(arg1, arg2, arg3) {
    <span class="keyword">if</span> (arg2) { <span class="comment">// element by functions mode</span>
        <span class="keyword">var</span> _elm = <span class="keyword">new</span> Element(arg1, arg2);
        <span class="keyword">if</span> (arg3) _elm.changeTransform(arg3);
        <span class="keyword">this</span>._addChild(_elm);
        <span class="keyword">return</span> _elm;
    } <span class="keyword">else</span> <span class="keyword">if</span> (__arr(arg1)) { <span class="comment">// elements array mode</span>
        <span class="keyword">this</span>._addChildren(arg1);
    } <span class="keyword">else</span> <span class="keyword">if</span> (__builder(arg1)) { <span class="comment">// builder instance</span>
        <span class="keyword">this</span>._addChild(arg1.v);
    } <span class="keyword">else</span> { <span class="comment">// element object mode</span>
        <span class="keyword">this</span>._addChild(arg1);
    }
}
Element.prototype.__safeDetach = <span class="keyword">function</span>(what, _cnt) {
    <span class="keyword">var</span> pos = -<span class="number">1</span>, found = _cnt || <span class="number">0</span>;
    <span class="keyword">var</span> children = <span class="keyword">this</span>.children;
    <span class="keyword">if</span> ((pos = children.indexOf(what)) &gt;= <span class="number">0</span>) {
        <span class="keyword">if</span> (<span class="keyword">this</span>.rendering || what.rendering) {
            <span class="keyword">this</span>.__detachQueue.push(what<span class="comment">/*pos*/</span>);
        } <span class="keyword">else</span> {
            <span class="keyword">if</span> (<span class="keyword">this</span>.__unsafeToRemove) <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(Errors.A.UNSAFE_TO_REMOVE);
            what._unbind();
            children.splice(pos, <span class="number">1</span>);
        }
        <span class="keyword">return</span> <span class="number">1</span>;
    } <span class="keyword">else</span> {
        <span class="keyword">this</span>.visitChildren(<span class="keyword">function</span>(ielm) {
            found += ielm.__safeDetach(what, found);
        });
        <span class="keyword">return</span> found;
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <blockquote>
<p>Element.remove % (elm: Element)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.remove = <span class="keyword">function</span>(elm) {
    <span class="keyword">if</span> (!elm) <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(Errors.A.NO_ELEMENT_TO_REMOVE);
    <span class="keyword">if</span> (<span class="keyword">this</span>.__safeDetach(elm) == <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(Errors.A.NO_ELEMENT);
}
Element.prototype._unbind = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.parent.__unsafeToRemove ||
        <span class="keyword">this</span>.__unsafeToRemove) <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(Errors.A.UNSAFE_TO_REMOVE);
    <span class="keyword">this</span>.parent = <span class="literal">null</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.scene) <span class="keyword">this</span>.scene._unregister(<span class="keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>this.scene should be null after unregistering</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <blockquote>
<p>Element.detach % ()</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.detach = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.parent.__safeDetach(<span class="keyword">this</span>) == <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(Errors.A.ELEMENT_NOT_ATTACHED);
}
<span class="comment">/* make element band fit all children bands */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <blockquote>
<p>Element.makeBandFit % ()</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.makeBandFit = <span class="keyword">function</span>() {
    <span class="keyword">var</span> wband = <span class="keyword">this</span>.findWrapBand();
    <span class="keyword">this</span>.xdata.gband = wband;
    <span class="keyword">this</span>.xdata.lband[<span class="number">1</span>] = wband[<span class="number">1</span>] - wband[<span class="number">0</span>];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <blockquote>
<p>Element.setBand % (band: Array[2, Float])</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.setBand = <span class="keyword">function</span>(band) {
    <span class="keyword">this</span>.xdata.lband = band;
    Bands.recalc(<span class="keyword">this</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <blockquote>
<p>Element.fits % (ltime: Float) -&gt; Boolean</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.fits = <span class="keyword">function</span>(ltime) {
    <span class="keyword">if</span> (ltime &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;
    <span class="keyword">return</span> __t_cmp(ltime, <span class="keyword">this</span>.xdata.lband[<span class="number">1</span>] - <span class="keyword">this</span>.xdata.lband[<span class="number">0</span>]) &lt;= <span class="number">0</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <blockquote>
<p>Element.gtime % (ltime: Float) -&gt; Float</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.gtime = <span class="keyword">function</span>(ltime) {
    <span class="keyword">return</span> <span class="keyword">this</span>.xdata.gband[<span class="number">0</span>] + ltime;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <blockquote>
<p>Element.ltime % (gtime: Float) -&gt; Float</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.ltime = <span class="keyword">function</span>(gtime) {
    <span class="keyword">var</span> x = <span class="keyword">this</span>.xdata;
    <span class="keyword">if</span> (!__finite(x.gband[<span class="number">1</span>])) <span class="keyword">return</span> <span class="keyword">this</span>.__checkJump(gtime - x.gband[<span class="number">0</span>]);
    <span class="keyword">switch</span> (x.mode) {
        <span class="keyword">case</span> C.R_ONCE:
            <span class="keyword">return</span> <span class="keyword">this</span>.__checkJump(gtime - x.gband[<span class="number">0</span>]);
        <span class="keyword">case</span> C.R_STAY:
            <span class="keyword">return</span> (__t_cmp(gtime, x.gband[<span class="number">1</span>]) &lt;= <span class="number">0</span>)
                   ? <span class="keyword">this</span>.__checkJump(gtime - x.gband[<span class="number">0</span>])
                   : <span class="keyword">this</span>.__checkJump(x.lband[<span class="number">1</span>] - x.lband[<span class="number">0</span>]);
        <span class="keyword">case</span> C.R_LOOP: {
                <span class="keyword">var</span> p = <span class="keyword">this</span>.parent,
                    px = p ? p.xdata : <span class="literal">null</span>;
                <span class="keyword">var</span> durtn = x.lband[<span class="number">1</span>] -
                            x.lband[<span class="number">0</span>],
                    pdurtn = p
                        ? (px.lband[<span class="number">1</span>] -
                           px.lband[<span class="number">0</span>])
                        : durtn;
                <span class="keyword">if</span> (durtn &lt; <span class="number">0</span>) <span class="keyword">return</span> -<span class="number">1</span>;
                <span class="keyword">var</span> ffits = (gtime - x.gband[<span class="number">0</span>]) / durtn,
                    fits = Math.floor(ffits);
                <span class="keyword">if</span> ((fits &lt; <span class="number">0</span>) || (ffits &gt; x.nrep)) <span class="keyword">return</span> -<span class="number">1</span>;
                <span class="keyword">var</span> t = (gtime - x.gband[<span class="number">0</span>]) - (fits * durtn);
                <span class="keyword">return</span> <span class="keyword">this</span>.__checkJump(t);
            }
        <span class="keyword">case</span> C.R_BOUNCE: {
                <span class="keyword">var</span> p = <span class="keyword">this</span>.parent,
                    px = p ? p.xdata : <span class="literal">null</span>;
                <span class="keyword">var</span> durtn = x.lband[<span class="number">1</span>] -
                            x.lband[<span class="number">0</span>],
                    pdurtn = p
                        ? (px.lband[<span class="number">1</span>] -
                           px.lband[<span class="number">0</span>])
                        : durtn;
                <span class="keyword">if</span> (durtn &lt; <span class="number">0</span>) <span class="keyword">return</span> -<span class="number">1</span>;
                <span class="keyword">var</span> ffits = (gtime - x.gband[<span class="number">0</span>]) / durtn,
                    fits = Math.floor(ffits);
                <span class="keyword">if</span> ((fits &lt; <span class="number">0</span>) || (ffits &gt; x.nrep)) <span class="keyword">return</span> -<span class="number">1</span>;
                <span class="keyword">var</span> t = (gtime - x.gband[<span class="number">0</span>]) - (fits * durtn),
                    t = ((fits % <span class="number">2</span>) === <span class="number">0</span>) ? t : durtn - t;
                <span class="keyword">return</span> <span class="keyword">this</span>.__checkJump(t);
            }
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <blockquote>
<p>Element.handlePlayerEvent % (event: C.S_*, handler: Function(player: Player))</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.handlePlayerEvent = <span class="keyword">function</span>(event, handler) {
    <span class="keyword">if</span> (!Player._isPlayerEvent(event)) <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'This method is intended to assign only player-related handles'</span>);
    <span class="keyword">this</span>.on(event, handler);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <blockquote>
<p>Element.inform % (ltime: Float)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.inform = <span class="keyword">function</span>(ltime) {
    <span class="keyword">if</span> (__t_cmp(ltime, <span class="number">0</span>) &gt;= <span class="number">0</span>) {
        <span class="keyword">var</span> duration = <span class="keyword">this</span>.xdata.lband[<span class="number">1</span>] - <span class="keyword">this</span>.xdata.lband[<span class="number">0</span>],
            cmp = __t_cmp(ltime, duration);
        <span class="keyword">if</span> (!<span class="keyword">this</span>.__firedStart) {
            <span class="keyword">this</span>.fire(C.X_START, ltime, duration);
            <span class="keyword">this</span>.travelChildren(<span class="keyword">function</span>(elm) { <span class="comment">// TODO: implement __fireDeep</span>
                <span class="keyword">if</span> (!elm.__firedStart) {
                    elm.fire(C.X_START, ltime, duration);
                    elm.__firedStart = <span class="literal">true</span>;
                }
            });
            <span class="keyword">this</span>.__firedStart = <span class="literal">true</span>; <span class="comment">// (store the counters for fired events?)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>TODO: handle START event by changing band to start at given time?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        }
        <span class="keyword">if</span> (cmp &gt;= <span class="number">0</span>) {
            <span class="keyword">if</span> (!<span class="keyword">this</span>.__firedStop) {
                <span class="keyword">this</span>.fire(C.X_STOP, ltime, duration);
                <span class="keyword">this</span>.travelChildren(<span class="keyword">function</span>(elm) { <span class="comment">// TODO: implement __fireDeep</span>
                    <span class="keyword">if</span> (!elm.__firedStop) {
                        elm.fire(C.X_STOP, ltime, duration);
                        elm.__firedStop = <span class="literal">true</span>;
                    }
                });
                <span class="keyword">this</span>.__firedStop = <span class="literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>TODO: handle STOP event by changing band to end at given time?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            }
        };
    };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <blockquote>
<p>Element.duration % () -&gt; Float</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.duration = <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="keyword">this</span>.xdata.lband[<span class="number">1</span>] - <span class="keyword">this</span>.xdata.lband[<span class="number">0</span>];
}
<span class="comment">/* TODO: duration cut with global band */</span>
<span class="comment">/* Element.prototype.rel_duration = function() {
    return
} */</span>
Element.prototype._max_tpos = <span class="keyword">function</span>() {
    <span class="keyword">return</span> (<span class="keyword">this</span>.xdata.gband[<span class="number">1</span>] &gt;= <span class="number">0</span>) ? <span class="keyword">this</span>.xdata.gband[<span class="number">1</span>] : <span class="number">0</span>;
}
<span class="comment">/* Element.prototype.neg_duration = function() {
    return (this.xdata.lband[0] &lt; 0)
            ? ((this.xdata.lband[1] &lt; 0) ? Math.abs(this.xdata.lband[0] + this.xdata.lband[1]) : Math.abs(this.xdata.lband[0]))
            : 0;
} */</span>
Element.prototype.m_on = <span class="keyword">function</span>(type, handler) {
    <span class="keyword">return</span> <span class="keyword">this</span>.__modify({ type: Element.EVENT_MOD },
      <span class="keyword">function</span>(t) { <span class="comment">/* FIXME: handlers must have priority? */</span>
        <span class="keyword">if</span> (<span class="keyword">this</span>.__evt_st &amp; type) {
          <span class="keyword">var</span> evts = <span class="keyword">this</span>.__evts[type];
          <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, el = evts.length; i &lt; el; i++) {
              <span class="keyword">if</span> (handler.call(<span class="keyword">this</span>,evts[i],t) === <span class="literal">false</span>) <span class="keyword">return</span> <span class="literal">false</span>;
          }
        }
    });
}
<span class="comment">/*Element.prototype.posAtStart = function(ctx) {
    var s = this.state;
    ctx.translate(s.lx, s.ly);
    ctx.scale(s.sx, s.sy);
    ctx.rotate(s.angle);
}*/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>calculates band that fits all child elements, recursively</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* FIXME: test */</span>
Element.prototype.findWrapBand = <span class="keyword">function</span>() {
    <span class="keyword">var</span> children = <span class="keyword">this</span>.children;
    <span class="keyword">if</span> (children.length === <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">this</span>.xdata.gband;
    <span class="keyword">var</span> result = [ <span class="literal">Infinity</span>, <span class="number">0</span> ];
    <span class="keyword">this</span>.visitChildren(<span class="keyword">function</span>(elm) {
        result = Bands.expand(result, elm.xdata.gband);</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>result = Bands.expand(result, elm.findWrapBand());</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    });
    <span class="keyword">return</span> (result[<span class="number">0</span>] !== <span class="literal">Infinity</span>) ? result : <span class="literal">null</span>;
}
Element.prototype.dispose = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.disposeHandlers();
    <span class="keyword">this</span>.disposeXData();
    <span class="keyword">this</span>.visitChildren(<span class="keyword">function</span>(elm) {
        elm.dispose();
    });
}
Element.prototype.disposeXData = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.xdata.path) <span class="keyword">this</span>.xdata.path.dispose();
    <span class="keyword">if</span> (<span class="keyword">this</span>.xdata.text) <span class="keyword">this</span>.xdata.text.dispose();
    <span class="keyword">if</span> (<span class="keyword">this</span>.xdata.sheet) <span class="keyword">this</span>.xdata.sheet.dispose();
}
Element.prototype.reset = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.__resetState();
    <span class="keyword">this</span>.__lastJump = <span class="literal">null</span>;
    <span class="keyword">this</span>.__firedStart = <span class="literal">false</span>;
    <span class="keyword">this</span>.__firedStop = <span class="literal">false</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.__mask) <span class="keyword">this</span>.__removeMaskCanvases();
    <span class="comment">/*this.__clearEvtState();*/</span>
    (<span class="keyword">function</span>(elm) {
        elm.__forAllModifiers(<span class="keyword">function</span>(modifier) {
            <span class="keyword">if</span> (modifier.__wasCalled) modifier.__wasCalled[elm.id] = <span class="literal">false</span>;
            <span class="keyword">if</span> (modifier.__wasCalledAt) modifier.__wasCalledAt[elm.id] = -<span class="number">1</span>;
        });
    })(<span class="keyword">this</span>);
    <span class="keyword">this</span>.visitChildren(<span class="keyword">function</span>(elm) {
        elm.reset();
    });
}
Element.prototype.visitChildren = <span class="keyword">function</span>(func) {
    <span class="keyword">var</span> children = <span class="keyword">this</span>.children;
    <span class="keyword">this</span>.__unsafeToRemove = <span class="literal">true</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> ei = <span class="number">0</span>, el = children.length; ei &lt; el; ei++) {
        func(children[ei]);
    };
    <span class="keyword">this</span>.__unsafeToRemove = <span class="literal">false</span>;
}
Element.prototype.travelChildren = <span class="keyword">function</span>(func) {
    <span class="keyword">var</span> children = <span class="keyword">this</span>.children;
    <span class="keyword">this</span>.__unsafeToRemove = <span class="literal">true</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> ei = <span class="number">0</span>, el = children.length; ei &lt; el; ei++) {
        <span class="keyword">var</span> elem = children[ei];
        func(elem);
        elem.travelChildren(func);
    };
    <span class="keyword">this</span>.__unsafeToRemove = <span class="literal">false</span>;
}
Element.prototype.iterateChildren = <span class="keyword">function</span>(func, rfunc) {
    <span class="keyword">this</span>.__unsafeToRemove = <span class="literal">true</span>;
    iter(<span class="keyword">this</span>.children).each(func, rfunc);
    <span class="keyword">this</span>.__unsafeToRemove = <span class="literal">false</span>;
}
Element.prototype.hasChildren = <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="keyword">this</span>.children.length &gt; <span class="number">0</span>;
}
Element.prototype.deepIterateChildren = <span class="keyword">function</span>(func, rfunc) {
    <span class="keyword">this</span>.__unsafeToRemove = <span class="literal">true</span>;
    iter(<span class="keyword">this</span>.children).each(<span class="keyword">function</span>(elem) {
        elem.deepIterateChildren(func, rfunc);
        <span class="keyword">return</span> func(elem);
    }, rfunc);
    <span class="keyword">this</span>.__unsafeToRemove = <span class="literal">false</span>;
}
Element.prototype.__performDetach = <span class="keyword">function</span>() {
    <span class="keyword">var</span> children = <span class="keyword">this</span>.children;
    iter(<span class="keyword">this</span>.__detachQueue).each(<span class="keyword">function</span>(elm) {
        <span class="keyword">if</span> ((idx = children.indexOf(elm)) &gt;= <span class="number">0</span>) {
            children.splice(idx, <span class="number">1</span>);
            elm._unbind();
        }
    });
    <span class="keyword">this</span>.__detachQueue = [];
}
Element.prototype.clear = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.__unsafeToRemove) <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(Errors.A.UNSAFE_TO_REMOVE);
    <span class="keyword">if</span> (!<span class="keyword">this</span>.rendering) {
        <span class="keyword">var</span> children = <span class="keyword">this</span>.children;
        <span class="keyword">this</span>.children = [];
        iter(children).each(<span class="keyword">function</span>(elm) { elm._unbind(); });
    } <span class="keyword">else</span> {
        <span class="keyword">this</span>.__detachQueue = <span class="keyword">this</span>.__detachQueue.concat(<span class="keyword">this</span>.children);
    }
}
Element.prototype.lock = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.__jumpLock = <span class="literal">true</span>;
    <span class="keyword">this</span>.__lstate = obj_clone(<span class="keyword">this</span>.state);
    <span class="keyword">this</span>.__pstate = <span class="keyword">this</span>._state ? obj_clone(<span class="keyword">this</span>._state) : <span class="literal">null</span>;
}
Element.prototype.unlock = <span class="keyword">function</span>() {
    <span class="keyword">var</span> result = <span class="keyword">this</span>.state;
    <span class="keyword">this</span>.state = <span class="keyword">this</span>.__lstate;
    <span class="keyword">this</span>._state = <span class="keyword">this</span>.__pstate;
    <span class="keyword">this</span>.__lstate = <span class="literal">null</span>;
    <span class="keyword">this</span>.__jumpLock = <span class="literal">false</span>;
    <span class="keyword">return</span> result;
}
Element.prototype.stateAt = <span class="keyword">function</span>(t) { <span class="comment">/* FIXME: test */</span>
    <span class="keyword">this</span>.lock();
    <span class="keyword">var</span> success = <span class="keyword">this</span>.__callModifiers(Element.NOEVT_MODIFIERS, t);
    <span class="keyword">var</span> state = <span class="keyword">this</span>.unlock();
    <span class="keyword">return</span> success ? Element._mergeStates(<span class="keyword">this</span>.bstate, state) : <span class="literal">null</span>;
}
Element.prototype.getPosition = <span class="keyword">function</span>() {
    <span class="keyword">return</span> [ <span class="keyword">this</span>.bstate.x + <span class="keyword">this</span>.state.x,
             <span class="keyword">this</span>.bstate.y + <span class="keyword">this</span>.state.y ];
}
Element.prototype.offset = <span class="keyword">function</span>() {
    <span class="keyword">var</span> xsum = <span class="number">0</span>, ysum = <span class="number">0</span>;
    <span class="keyword">var</span> p = <span class="keyword">this</span>.parent;
    <span class="keyword">while</span> (p) {
        <span class="keyword">var</span> pbs = p.bstate,
            ps = p.state;
        xsum += pbs.x + ps.x;
        ysum += pbs.y + ps.y;
        p = p.parent;
    }
    <span class="keyword">return</span> [ xsum, ysum ];
}
<span class="comment">/*Element.prototype.local = function(pt) {
    var off = this.offset();
    return [ pt[0] - off[0], pt[1] - off[1] ];
}
Element.prototype.global = function(pt) {
    var off = this.offset();
    return [ pt[0] + off[0], pt[1] + off[1] ];
} */</span>
Element.prototype.dimen = <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>TODO: allow to set _dimen?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (<span class="keyword">this</span>._dimen) <span class="keyword">return</span> <span class="keyword">this</span>._dimen;
    <span class="keyword">var</span> x = <span class="keyword">this</span>.xdata;
    <span class="keyword">var</span> subj = x.path || x.text || x.sheet;
    <span class="keyword">if</span> (subj) <span class="keyword">return</span> subj.dimen();
}
Element.prototype.lbounds = <span class="keyword">function</span>() {
    <span class="keyword">var</span> x = <span class="keyword">this</span>.xdata;
    <span class="keyword">var</span> subj = x.path || x.text || x.sheet;
    <span class="keyword">if</span> (subj) <span class="keyword">return</span> subj.bounds();
}
Element.prototype.lrect = <span class="keyword">function</span>() {
    <span class="keyword">var</span> b = <span class="keyword">this</span>.lbounds();
    <span class="keyword">if</span> (!b) <span class="keyword">return</span> <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>returns clockwise coordinates of the points
for easier drawing
minX, minY, maxX, minY,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> [ b[<span class="number">0</span>], b[<span class="number">1</span>], b[<span class="number">2</span>], b[<span class="number">1</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>maxX, maxY, minX, maxY</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>             b[<span class="number">2</span>], b[<span class="number">3</span>], b[<span class="number">0</span>], b[<span class="number">3</span>] ];
}
Element.prototype.setMask = <span class="keyword">function</span>(elm) {
    <span class="keyword">if</span> (!elm) <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(<span class="string">'No valid masking element was passed'</span>);
    <span class="keyword">if</span> (<span class="keyword">this</span>.scene) <span class="keyword">this</span>.__ensureHasMaskCanvas();
    <span class="keyword">this</span>.__mask = elm;
}
Element.prototype.__ensureHasMaskCanvas = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.__maskCvs || <span class="keyword">this</span>.__backCvs) <span class="keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>console.log(&#39;creating mask and back canvases for &#39; + this.id + &#39; &#39; + this.name);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> scene = <span class="keyword">this</span>.scene;
    <span class="keyword">if</span> (!scene) <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(<span class="string">'Element to be masked should be attached to scene when rendering'</span>);
    <span class="keyword">this</span>.__maskCvs = newCanvas([scene.width * <span class="number">2</span>, scene.height * <span class="number">2</span>], <span class="keyword">this</span>.state.ratio);
    <span class="keyword">this</span>.__maskCtx = <span class="keyword">this</span>.__maskCvs.getContext(<span class="string">'2d'</span>);
    <span class="keyword">this</span>.__backCvs = newCanvas([scene.width * <span class="number">2</span>, scene.height * <span class="number">2</span>], <span class="keyword">this</span>.state.ratio);
    <span class="keyword">this</span>.__backCtx = <span class="keyword">this</span>.__backCvs.getContext(<span class="string">'2d'</span>);
    <span class="comment">/* $doc.body.appendChild(this.__maskCvs); */</span>
    <span class="comment">/* $doc.body.appendChild(this.__backCvs); */</span>
}
Element.prototype.__removeMaskCanvases = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.__maskCvs) {</pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>console.log(&#39;removing mask canvas for &#39; + this.id + &#39; &#39; + this.name);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        disposeElm(<span class="keyword">this</span>.__maskCvs);
        <span class="keyword">this</span>.__maskCvs = <span class="literal">null</span>;
        <span class="keyword">this</span>.__maskCtx = <span class="literal">null</span>;
    }
    <span class="keyword">if</span> (<span class="keyword">this</span>.__backCvs) {</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>console.log(&#39;removing back canvas for &#39; + this.id + &#39; &#39; + this.name);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        disposeElm(<span class="keyword">this</span>.__backCvs);
        <span class="keyword">this</span>.__backCvs = <span class="literal">null</span>;
        <span class="keyword">this</span>.__backCtx = <span class="literal">null</span>;
    }
}
Element.prototype.clearMask = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.__mask = <span class="literal">null</span>;
    <span class="keyword">this</span>.__removeMaskCanvases();
}
Element.prototype.data = <span class="keyword">function</span>(val) {
  <span class="keyword">if</span> (<span class="keyword">typeof</span> val !== <span class="string">'undefined'</span>) <span class="keyword">return</span> (<span class="keyword">this</span>.__data = val);
  <span class="keyword">return</span> <span class="keyword">this</span>.__data;
}
Element.prototype.toString = <span class="keyword">function</span>() {
    <span class="keyword">var</span> buf = [ <span class="string">'[ Element '</span> ];
    buf.push(<span class="string">'\''</span> + (<span class="keyword">this</span>.name || <span class="keyword">this</span>.id) + <span class="string">'\' '</span>);
    <span class="comment">/*if (this.children.length &gt; 0) {
        buf.push('( ');
        this.visitChildren(function(child) {
            buf.push(child.toString() + ', ');
        });
        buf.push(') ');
    }
    if (this.parent) {
        buf.push('&lt; \'' + (this.parent.name || this.parent.id) + '\' &gt; ');
    }*/</span>
    buf.push(<span class="string">']'</span>);
    <span class="keyword">return</span> buf.join(<span class="string">""</span>);
}
Element.prototype.clone = <span class="keyword">function</span>() {
    <span class="keyword">var</span> clone = <span class="keyword">new</span> Element();
    clone.name = <span class="keyword">this</span>.name;
    clone.children = [].concat(<span class="keyword">this</span>.children);
    clone._modifiers = [].concat(<span class="keyword">this</span>._modifiers);
    clone._painters = [].concat(<span class="keyword">this</span>._painters);
    clone.xdata = obj_clone(<span class="keyword">this</span>.xdata);
    clone.xdata.$ = clone;
    clone.__data = <span class="keyword">this</span>.__data;
    <span class="keyword">return</span> clone;
}
Element.prototype.deepClone = <span class="keyword">function</span>() {
    <span class="keyword">var</span> clone = <span class="keyword">this</span>.clone();
    clone.children = [];
    <span class="keyword">var</span> src_children = <span class="keyword">this</span>.children;
    <span class="keyword">var</span> trg_children = clone.children;
    <span class="keyword">for</span> (<span class="keyword">var</span> sci = <span class="number">0</span>, scl = src_children.length; sci &lt; scl; sci++) {
        <span class="keyword">var</span> csrc = src_children[sci],
            cclone = csrc.deepClone();
        cclone.parent = clone;
        trg_children.push(cclone);
    }
    clone._modifiers = [];
    <span class="comment">/* FIXME: use __forAllModifiers &amp; __forAllPainters */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>loop through type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> (<span class="keyword">var</span> mti = <span class="number">0</span>, mtl = <span class="keyword">this</span>._modifiers.length; mti &lt; mtl; mti++) {
        <span class="keyword">var</span> type_group = <span class="keyword">this</span>._modifiers[mti];
        <span class="keyword">if</span> (!type_group) <span class="keyword">continue</span>;
        clone._modifiers[mti] = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>loop through priority</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">for</span> (<span class="keyword">var</span> mpi = <span class="number">0</span>, mpl = type_group.length; mpi &lt; mpl; mpi++) {
            <span class="keyword">var</span> priority_group = type_group[mpi];
            <span class="keyword">if</span> (!priority_group) <span class="keyword">continue</span>;
            clone._modifiers[mti][mpi] = [].concat(priority_group);
            <span class="keyword">for</span> (mi = <span class="number">0</span>, ml = priority_group.length; mi &lt; ml; mi++) {
                <span class="keyword">var</span> modifier = priority_group[mi];
                <span class="keyword">if</span> (modifier &amp;&amp; modifier.__m_ids) {
                    modifier.__m_ids[clone.id] = modifier.__m_ids[<span class="keyword">this</span>.id];
                }
            }
        }
    }
    clone._painters = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>loop through type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> (<span class="keyword">var</span> pti = <span class="number">0</span>, ptl = <span class="keyword">this</span>._painters.length; pti &lt; ptl; pti++) {
        <span class="keyword">var</span> type_group = <span class="keyword">this</span>._painters[pti];
        <span class="keyword">if</span> (!type_group) <span class="keyword">continue</span>;
        clone._painters[pti] = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>loop through priority</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">for</span> (<span class="keyword">var</span> ppi = <span class="number">0</span>, ppl = type_group.length; ppi &lt; ppl; ppi++) {
            <span class="keyword">var</span> priority_group = type_group[ppi];
            <span class="keyword">if</span> (!priority_group) <span class="keyword">continue</span>;
            clone._painters[pti][ppi] = [].concat(priority_group);
            <span class="keyword">for</span> (pi = <span class="number">0</span>, pl = priority_group.length; pi &lt; pl; pi++) {
                <span class="keyword">var</span> painter = priority_group[pi];
                <span class="keyword">if</span> (painter &amp;&amp; painter.__p_ids) {
                    painter.__p_ids[clone.id] = painter.__p_ids[<span class="keyword">this</span>.id];
                }
            }
        }
    }
    clone.__data = obj_clone(<span class="keyword">this</span>.__data);
    <span class="keyword">var</span> src_x = <span class="keyword">this</span>.xdata,
        trg_x = clone.xdata;
    <span class="keyword">if</span> (src_x.path) trg_x.path = src_x.path.clone();
    <span class="keyword">if</span> (src_x.text) trg_x.text = src_x.text.clone();
    <span class="keyword">if</span> (src_x.sheet) trg_x.sheet = src_x.sheet.clone();
    trg_x.pos = [].concat(src_x.pos);
    trg_x.pvt = [].concat(src_x.pvt);
    trg_x.reg = [].concat(src_x.reg);
    trg_x.lband = [].concat(src_x.lband);
    trg_x.gband = [].concat(src_x.gband);
    trg_x.keys = obj_clone(src_x.keys);
    <span class="keyword">return</span> clone;
}
Element.prototype._addChild = <span class="keyword">function</span>(elm) {
    elm.parent = <span class="keyword">this</span>;
    <span class="keyword">this</span>.children.push(elm); <span class="comment">/* or add elem.id? */</span>
    <span class="keyword">if</span> (<span class="keyword">this</span>.scene) <span class="keyword">this</span>.scene._register(elm); <span class="comment">/* TODO: rollback parent and child? */</span>
    Bands.recalc(<span class="keyword">this</span>);
}
Element.prototype._addChildren = <span class="keyword">function</span>(elms) {
    <span class="keyword">for</span> (<span class="keyword">var</span> ei = <span class="number">0</span>, el = elms.length; ei &lt; el; ei++) {
        <span class="keyword">this</span>._addChild(elms[ei]);
    }
}
Element.prototype._stateStr = <span class="keyword">function</span>() {
    <span class="keyword">var</span> state = <span class="keyword">this</span>.state;
    <span class="keyword">return</span> <span class="string">"x: "</span> + s.x + <span class="string">" y: "</span> + s.y + <span class="string">'\n'</span> +
           <span class="string">"sx: "</span> + s.sx + <span class="string">" sy: "</span> + s.sy + <span class="string">'\n'</span> +
           <span class="string">"angle: "</span> + s.angle + <span class="string">" alpha: "</span> + s.alpha + <span class="string">'\n'</span> +
           <span class="string">"p: "</span> + s.p + <span class="string">" t: "</span> + s.t + <span class="string">" key: "</span> + s.key + <span class="string">'\n'</span>;
}
Element.prototype.__adaptModTime = <span class="keyword">function</span>(ltime, conf, state, modifier) {
  <span class="keyword">var</span> lband = <span class="keyword">this</span>.xdata.lband,
      elm_duration = lband[<span class="number">1</span>] - lband[<span class="number">0</span>],
      easing = conf.easing,
      time = conf.time, <span class="comment">// time or band of the modifier, if set</span>
      relative = conf.relative;
  <span class="keyword">var</span> _tpair = <span class="literal">null</span>;
  <span class="keyword">if</span> (time == <span class="literal">null</span>) {
      _tpair = [ relative
                     ? __adjust(ltime) / __adjust(elm_duration)
                     : __adjust(ltime),
                 __adjust(elm_duration) ];
  } <span class="keyword">else</span> <span class="keyword">if</span> (__arr(time)) { <span class="comment">// modifier is band-restricted</span>
      <span class="keyword">var</span> band = time;
      <span class="keyword">if</span> (!relative) {
          <span class="keyword">var</span> mod_duration = band[<span class="number">1</span>] - band[<span class="number">0</span>];
          <span class="keyword">if</span> (__t_cmp(ltime, band[<span class="number">0</span>]) &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;
          <span class="keyword">if</span> (__t_cmp(ltime, band[<span class="number">1</span>]) &gt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;
          _tpair = [ __adjust(ltime - band[<span class="number">0</span>]),
                     __adjust(mod_duration) ];
      } <span class="keyword">else</span> {
          <span class="keyword">var</span> abs_band = [ band[<span class="number">0</span>] * elm_duration,
                           band[<span class="number">1</span>] * elm_duration ];
          <span class="keyword">var</span> mod_duration = abs_band[<span class="number">1</span>] - abs_band[<span class="number">0</span>];
          <span class="keyword">if</span> (__t_cmp(ltime, abs_band[<span class="number">0</span>]) &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;
          <span class="keyword">if</span> (__t_cmp(ltime, abs_band[<span class="number">1</span>]) &gt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;
          _tpair = [ __adjust(ltime - abs_band[<span class="number">0</span>]) / __adjust(mod_duration),
                     __adjust(mod_duration) ];
      }
  } <span class="keyword">else</span> <span class="keyword">if</span> (__num(time)) {
      <span class="keyword">if</span> (modifier.__wasCalled &amp;&amp; modifier.__wasCalled[<span class="keyword">this</span>.id]) <span class="keyword">return</span> <span class="literal">false</span>;
      <span class="keyword">var</span> tpos = relative ? (time * elm_duration) : time;
      <span class="keyword">if</span> (__t_cmp(ltime, tpos) &gt;= <span class="number">0</span>) {
          <span class="keyword">if</span> (!modifier.__wasCalled) modifier.__wasCalled = {};
          <span class="keyword">if</span> (!modifier.__wasCalledAt) modifier.__wasCalledAt = {};
          modifier.__wasCalled[<span class="keyword">this</span>.id] = <span class="literal">true</span>;
          modifier.__wasCalledAt[<span class="keyword">this</span>.id] = ltime;
      } <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">false</span>;
      _tpair = [ relative
                     ? __adjust(ltime) / __adjust(elm_duration)
                     : __adjust(ltime),
                 __adjust(elm_duration) ];
  } <span class="keyword">else</span> _tpair = [ relative
                        ? __adjust(ltime) / __adjust(elm_duration)
                        : __adjust(ltime),
                    __adjust(elm_duration) ];
  <span class="keyword">return</span> !easing ? _tpair : [ easing(_tpair[<span class="number">0</span>], _tpair[<span class="number">1</span>]), _tpair[<span class="number">1</span>] ];
}
Element.prototype.__callModifiers = <span class="keyword">function</span>(order, ltime) {
    <span class="keyword">return</span> (<span class="keyword">function</span>(elm) {</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>save the previous state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        elm.state._ = <span class="literal">null</span>; <span class="comment">// clear the pointer, so it will not be cloned</span>
        elm._state = Element.createState(elm);
        elm._state._ = obj_clone(elm.state);</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>now it looks like:</p>
<pre><code>this.
    .state    -&gt; state from the last modifiers call
    ._state   -&gt; clone of the last state, it is passed to modifiers as `this`
    ._state._ -&gt; a pointer to the last state, so it will be accessible in
                 modifiers as `this._`</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>        elm.__loadEvts(elm._state);

        <span class="keyword">if</span> (!elm.__forAllModifiers(order,
            <span class="keyword">function</span>(modifier, conf) { <span class="comment">/* each modifier */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>lbtime is band-apadted time, if modifier has its own band</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> lbtime = elm.__adaptModTime(ltime, conf, elm._state, modifier);</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p><code>false</code> will be returned from <code>__adaptModTime</code>
for trigger-like modifier if it is required to skip current one,
on the other hand <code>true</code> in <code>forAllModifiers</code> means
&quot;skip this one, but not finish the whole process&quot;,
FIXME: this unobvious line</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (lbtime === <span class="literal">false</span>) <span class="keyword">return</span> <span class="literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>modifier will return false if it is required to skip all next modifiers,
returning false from our function means the same</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> modifier.call(elm._state, lbtime[<span class="number">0</span>], lbtime[<span class="number">1</span>], conf.data);
            }, <span class="keyword">function</span>(type) { <span class="comment">/* before each new type */</span>
                elm.__modifying = type;
                elm.__mbefore(type);
            }, <span class="keyword">function</span>(type) { <span class="comment">/* after each new type */</span>
                elm.__mafter(ltime, type, <span class="literal">true</span>);
            })) { <span class="comment">// one of modifiers returned false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>forget things...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                elm.__mafter(ltime, elm.__modifying, <span class="literal">false</span>);
                elm.__modifying = <span class="literal">null</span>;
                elm.__clearEvts(elm._state);</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>NB: nothing happens to the state or element here,
    the modified things are not applied</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// ...and get out of the function</span>
            };

        elm.__modifying = <span class="literal">null</span>;
        elm._state._applied = <span class="literal">true</span>;
        elm._state._appliedAt = ltime;

        elm.__clearEvts(elm._state);</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>save modified state as last</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        elm.state = elm._state;
        elm._state = <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>state._ keeps pointing to prev state</p>
<p>apply last state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> <span class="literal">true</span>;
    })(<span class="keyword">this</span>);
}
Element.prototype.__callPainters = <span class="keyword">function</span>(order, ctx) {
    (<span class="keyword">function</span>(elm) {
        elm.__forAllPainters(order,
            <span class="keyword">function</span>(painter, conf) { <span class="comment">/* each painter */</span>
                painter.call(elm.xdata, ctx, conf.data);
            }, <span class="keyword">function</span>(type) { <span class="comment">/* before each new type */</span>
                elm.__painting = type;
                elm.__pbefore(ctx, type);
            }, <span class="keyword">function</span>(type) { <span class="comment">/* after each new type */</span>
                elm.__pafter(ctx, type);
            });
        elm.__painting = <span class="literal">null</span>;
    })(<span class="keyword">this</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>Element.prototype.__addTypedModifier = function(type, priority, band, modifier, easing, data) {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.prototype.__addTypedModifier = <span class="keyword">function</span>(conf, modifier) {
    <span class="keyword">if</span> (!modifier) <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(Errors.A.NO_MODIFIER_PASSED);
    <span class="keyword">var</span> modifiers = <span class="keyword">this</span>._modifiers;
    <span class="keyword">var</span> elm_id = <span class="keyword">this</span>.id;
    <span class="keyword">if</span> (!modifier.__m_ids) modifier.__m_ids = {};
    <span class="keyword">else</span> <span class="keyword">if</span> (modifier.__m_ids[elm_id]) <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(Errors.A.MODIFIER_REGISTERED);
    <span class="keyword">var</span> priority = conf.priority || <span class="number">0</span>,
        type = conf.type;
    <span class="keyword">if</span> (!modifiers[type]) modifiers[type] = [];
    <span class="keyword">if</span> (!modifiers[type][priority]) modifiers[type][priority] = [];
    modifiers[type][priority].push([ modifier, { type: type, <span class="comment">// configuration is cloned for safety</span>
                                                 priority: priority,
                                                 time: conf.time,
                                                 relative: conf.relative,
                                                 easing: Element.__convertEasing(conf.easing, <span class="literal">null</span>, conf.relative),
                                                 data: conf.data } ]);
    modifier.__m_ids[elm_id] = (type &lt;<span class="xml"><span class="tag">&lt; <span class="attribute">Element.TYPE_MAX_BIT</span>) | (<span class="attribute">priority</span> &lt;&lt; <span class="attribute">Element.PRRT_MAX_BIT</span>) |
                               (<span class="attribute">modifiers</span>[<span class="attribute">type</span>][<span class="attribute">priority</span>]<span class="attribute">.length</span> <span class="attribute">-</span> <span class="attribute">1</span>);
    <span class="attribute">return</span> <span class="attribute">modifier</span>;
}
<span class="attribute">Element.prototype.__modify</span> = <span class="attribute">Element.prototype.__addTypedModifier</span>; // <span class="attribute">quick</span> <span class="attribute">alias</span>
<span class="attribute">Element.prototype.__forAllModifiers</span> = <span class="attribute">function</span>(<span class="attribute">order</span>, <span class="attribute">f</span>, <span class="attribute">before_type</span>, <span class="attribute">after_type</span>) {
    <span class="attribute">var</span> <span class="attribute">modifiers</span> = <span class="attribute">this._modifiers</span>;
    <span class="attribute">var</span> <span class="attribute">type</span>, <span class="attribute">seq</span>, <span class="attribute">cur</span>;
    <span class="attribute">for</span> (<span class="attribute">var</span> <span class="attribute">typenum</span> = <span class="attribute">0</span>, <span class="attribute">last</span> = <span class="attribute">order.length</span>;
         <span class="attribute">typenum</span> &lt; <span class="attribute">last</span>; <span class="attribute">typenum</span>++) {
        <span class="attribute">type</span> = <span class="attribute">order</span>[<span class="attribute">typenum</span>];
        <span class="attribute">seq</span> = <span class="attribute">modifiers</span>[<span class="attribute">type</span>];
        <span class="attribute">if</span> (<span class="attribute">before_type</span>) <span class="attribute">before_type</span>(<span class="attribute">type</span>);
        <span class="attribute">if</span> (<span class="attribute">seq</span>) {
          <span class="attribute">for</span> (<span class="attribute">var</span> <span class="attribute">pi</span> = <span class="attribute">0</span>, <span class="attribute">pl</span> = <span class="attribute">seq.length</span>; <span class="attribute">pi</span> &lt; <span class="attribute">pl</span>; <span class="attribute">pi</span>++) { // <span class="attribute">by</span> <span class="attribute">priority</span>
            <span class="attribute">if</span> (<span class="attribute">cur</span> = <span class="attribute">seq</span>[<span class="attribute">pi</span>]) {
              <span class="attribute">for</span> (<span class="attribute">var</span> <span class="attribute">ci</span> = <span class="attribute">0</span>, <span class="attribute">cl</span> = <span class="attribute">cur.length</span>; <span class="attribute">ci</span> &lt; <span class="attribute">cl</span>; <span class="attribute">ci</span>++) {
                <span class="attribute">var</span> <span class="attribute">modifier</span>;
                <span class="attribute">if</span> (<span class="attribute">modifier</span> = <span class="attribute">cur</span>[<span class="attribute">ci</span>]) {
                  <span class="attribute">if</span> (<span class="attribute">f</span>(<span class="attribute">modifier</span>[<span class="attribute">0</span>], <span class="attribute">modifier</span>[<span class="attribute">1</span>]) =<span class="value">==</span> <span class="attribute">false</span>) <span class="attribute">return</span> <span class="attribute">false</span>;
                } /* <span class="attribute">if</span> <span class="attribute">cur</span>[<span class="attribute">ci</span>] */
              } /* <span class="attribute">for</span> <span class="attribute">var</span> <span class="attribute">ci</span> */
            } /* <span class="attribute">if</span> <span class="attribute">cur</span> = <span class="attribute">seq</span>[<span class="attribute">pi</span>] */
          } /* <span class="attribute">for</span> <span class="attribute">var</span> <span class="attribute">pi</span> */
        } /* <span class="attribute">if</span> <span class="attribute">seq</span> */
        <span class="attribute">if</span> (<span class="attribute">after_type</span>) <span class="attribute">after_type</span>(<span class="attribute">type</span>);
    }
    <span class="attribute">return</span> <span class="attribute">true</span>;
}
<span class="attribute">Element.prototype.__addTypedPainter</span> = <span class="attribute">function</span>(<span class="attribute">conf</span>, <span class="attribute">painter</span>) {
    <span class="attribute">if</span> (!<span class="attribute">painter</span>) <span class="attribute">throw</span> <span class="attribute">new</span> <span class="attribute">AnimErr</span>(<span class="attribute">Errors.A.NO_PAINTER_PASSED</span>);
    <span class="attribute">var</span> <span class="attribute">painters</span> = <span class="attribute">this._painters</span>;
    <span class="attribute">var</span> <span class="attribute">elm_id</span> = <span class="attribute">this.id</span>;
    <span class="attribute">if</span> (!<span class="attribute">painter.__p_ids</span>) <span class="attribute">painter.__p_ids</span> = {};
    <span class="attribute">else</span> <span class="attribute">if</span> (<span class="attribute">painter.__p_ids</span>[<span class="attribute">elm_id</span>]) <span class="attribute">throw</span> <span class="attribute">new</span> <span class="attribute">AnimErr</span>(<span class="attribute">Errors.A.PAINTER_REGISTERED</span>);
    <span class="attribute">var</span> <span class="attribute">priority</span> = <span class="attribute">conf.priority</span> || <span class="attribute">0</span>,
        <span class="attribute">type</span> = <span class="attribute">conf.type</span>;
    <span class="attribute">if</span> (!<span class="attribute">painters</span>[<span class="attribute">type</span>]) <span class="attribute">painters</span>[<span class="attribute">type</span>] = [];
    <span class="attribute">if</span> (!<span class="attribute">painters</span>[<span class="attribute">type</span>][<span class="attribute">priority</span>]) <span class="attribute">painters</span>[<span class="attribute">type</span>][<span class="attribute">priority</span>] = [];
    <span class="attribute">painters</span>[<span class="attribute">type</span>][<span class="attribute">priority</span>]<span class="attribute">.push</span>([ <span class="attribute">painter</span>, { <span class="attribute">type:</span> <span class="attribute">type</span>, // <span class="attribute">configuration</span> <span class="attribute">is</span> <span class="attribute">cloned</span> <span class="attribute">for</span> <span class="attribute">safety</span>
                                               <span class="attribute">priority:</span> <span class="attribute">priority</span>,
                                               <span class="attribute">data:</span> <span class="attribute">conf.data</span> } ]);
    <span class="attribute">painter.__p_ids</span>[<span class="attribute">elm_id</span>] = (<span class="attribute">type</span> &lt;&lt; <span class="attribute">Element.TYPE_MAX_BIT</span>) | (<span class="attribute">priority</span> &lt;&lt; <span class="attribute">Element.PRRT_MAX_BIT</span>) |
                              (<span class="attribute">painters</span>[<span class="attribute">type</span>][<span class="attribute">priority</span>]<span class="attribute">.length</span> <span class="attribute">-</span> <span class="attribute">1</span>);
    <span class="attribute">return</span> <span class="attribute">painter</span>;
}
<span class="attribute">Element.prototype.__paint</span> = <span class="attribute">Element.prototype.__addTypedPainter</span>; // <span class="attribute">quick</span> <span class="attribute">alias</span>
<span class="attribute">Element.prototype.__forAllPainters</span> = <span class="attribute">function</span>(<span class="attribute">order</span>, <span class="attribute">f</span>, <span class="attribute">before_type</span>, <span class="attribute">after_type</span>) {
    <span class="attribute">var</span> <span class="attribute">painters</span> = <span class="attribute">this._painters</span>;
    <span class="attribute">var</span> <span class="attribute">type</span>, <span class="attribute">seq</span>, <span class="attribute">cur</span>;
    <span class="attribute">for</span> (<span class="attribute">var</span> <span class="attribute">typenum</span> = <span class="attribute">0</span>, <span class="attribute">last</span> = <span class="attribute">order.length</span>;
         <span class="attribute">typenum</span> &lt; <span class="attribute">last</span>; <span class="attribute">typenum</span>++) {
        <span class="attribute">type</span> = <span class="attribute">order</span>[<span class="attribute">typenum</span>];
        <span class="attribute">seq</span> = <span class="attribute">painters</span>[<span class="attribute">type</span>];
        <span class="attribute">if</span> (<span class="attribute">before_type</span>) <span class="attribute">before_type</span>(<span class="attribute">type</span>);
        <span class="attribute">if</span> (<span class="attribute">seq</span>) {
          <span class="attribute">for</span> (<span class="attribute">var</span> <span class="attribute">pi</span> = <span class="attribute">0</span>, <span class="attribute">pl</span> = <span class="attribute">seq.length</span>; <span class="attribute">pi</span> &lt; <span class="attribute">pl</span>; <span class="attribute">pi</span>++) { // <span class="attribute">by</span> <span class="attribute">priority</span>
            <span class="attribute">if</span> (<span class="attribute">cur</span> = <span class="attribute">seq</span>[<span class="attribute">pi</span>]) {
              <span class="attribute">for</span> (<span class="attribute">var</span> <span class="attribute">ci</span> = <span class="attribute">0</span>, <span class="attribute">cl</span> = <span class="attribute">cur.length</span>; <span class="attribute">ci</span> &lt; <span class="attribute">cl</span>; <span class="attribute">ci</span>++) {
                <span class="attribute">if</span> (<span class="attribute">cur</span>[<span class="attribute">ci</span>]) <span class="attribute">f</span>(<span class="attribute">cur</span>[<span class="attribute">ci</span>][<span class="attribute">0</span>], <span class="attribute">cur</span>[<span class="attribute">ci</span>][<span class="attribute">1</span>]);
              }
            }
          }
        }
        <span class="attribute">if</span> (<span class="attribute">after_type</span>) <span class="attribute">after_type</span>(<span class="attribute">type</span>);
    }
    <span class="attribute">return</span> <span class="attribute">true</span>;
}
<span class="attribute">Element.prototype.__mbefore</span> = <span class="attribute">function</span>(<span class="attribute">t</span>, <span class="attribute">type</span>) {
    /*<span class="attribute">if</span> (<span class="attribute">type</span> =<span class="value">==</span> <span class="attribute">Element.EVENT_MOD</span>) {
        <span class="attribute">this.__loadEvtsFromCache</span>();
    }*/
}
<span class="attribute">Element.prototype.__mafter</span> = <span class="attribute">function</span>(<span class="attribute">t</span>, <span class="attribute">type</span>, <span class="attribute">result</span>) {
    /*<span class="attribute">if</span> (!<span class="attribute">result</span> || (<span class="attribute">type</span> =<span class="value">==</span> <span class="attribute">Element.USER_MOD</span>)) {
        <span class="attribute">this.__lmatrix</span> = <span class="attribute">Element._getIMatrixOf</span>(<span class="attribute">this.bstate</span>, <span class="attribute">this.state</span>);
    }*/
    /*<span class="attribute">if</span> (!<span class="attribute">result</span> || (<span class="attribute">type</span> =<span class="value">==</span> <span class="attribute">Element.EVENT_MOD</span>)) {
        <span class="attribute">this.__clearEvtState</span>();
    }*/
}
<span class="attribute">Element.prototype.__pbefore</span> = <span class="attribute">function</span>(<span class="attribute">ctx</span>, <span class="attribute">type</span>) { }
<span class="attribute">Element.prototype.__pafter</span> = <span class="attribute">function</span>(<span class="attribute">ctx</span>, <span class="attribute">type</span>) { }
<span class="attribute">Element.prototype.__checkJump</span> = <span class="attribute">function</span>(<span class="attribute">at</span>) {
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>FIXME: test if jumping do not fails with floating points problems</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> x = <span class="keyword">this</span>.xdata,
        s = <span class="keyword">this</span>.state;
    <span class="keyword">if</span> (x.tf) <span class="keyword">return</span> x.tf(at);
    <span class="keyword">var</span> t = <span class="literal">null</span>,
        duration = x.lband[<span class="number">1</span>] - x.lband[<span class="number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p>if jump-time was set either
directly or relatively or with key,
get its absolute local value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    t = (s.p !== <span class="literal">null</span>) ? s.p : <span class="literal">null</span>;
    t = ((t === <span class="literal">null</span>) &amp;&amp; (s.t !== <span class="literal">null</span>))
        ? s.t * duration
        : t;
    t = ((t === <span class="literal">null</span>) &amp;&amp; (s.key !== <span class="literal">null</span>))
        ? x.keys[s.key]
        : t;
    <span class="keyword">if</span> (t !== <span class="literal">null</span>) {
        <span class="keyword">if</span> ((t &lt; <span class="number">0</span>) || (t &gt; duration)) {
            <span class="keyword">throw</span> <span class="keyword">new</span> AnimErr(<span class="string">'failed to calculate jump'</span>);
        }
        <span class="keyword">if</span> (!<span class="keyword">this</span>.__jumpLock) {</pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>jump was performed if t or rt or key
were set:
save jump time and return it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.__lastJump = [ at, t ];
            s.p = <span class="literal">null</span>;
            s.t = <span class="literal">null</span>;
            s.key = <span class="literal">null</span>;
            <span class="keyword">return</span> t;
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>set t to jump-time, and if no jump-time
was passed or it requires to be ignored,
just set it to actual local time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    t = (t !== <span class="literal">null</span>) ? t : at;
    <span class="keyword">if</span> (<span class="keyword">this</span>.__lastJump !== <span class="literal">null</span>) {
       <span class="comment">/* return (jump_pos + (t - jumped_at)) */</span>
       <span class="keyword">return</span> <span class="keyword">this</span>.__lastJump[<span class="number">1</span>] + (t - <span class="keyword">this</span>.__lastJump[<span class="number">0</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p>overflow will be checked in fits() method,
or recalculated with loop/bounce mode
so if this clip longs more than allowed,
it will be just ended there</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>       <span class="comment">/* return ((this.__lastJump + t) &gt; x.gband[1])
             ? (this.__lastJump + t)
             : x.gband[1]; */</span>
    }
    <span class="keyword">return</span> t;
}
Element.prototype.handle__x = <span class="keyword">function</span>(type, evt) {
    <span class="keyword">if</span> (!Player._isPlayerEvent(type)
        &amp;&amp; (type != C.X_START)
        &amp;&amp; (type != C.X_STOP)) {
      <span class="keyword">if</span> (<span class="keyword">this</span>.shown) {
        <span class="keyword">this</span>.__saveEvt(type, evt);
      } <span class="keyword">else</span> {
        <span class="keyword">return</span> <span class="literal">false</span>;
      }
    }
    <span class="keyword">return</span> <span class="literal">true</span>;
}
Element.prototype.__saveEvt = <span class="keyword">function</span>(type, evt) {
    <span class="keyword">this</span>.__evtCache.push([type, evt]);
}
Element.prototype.__loadEvts = <span class="keyword">function</span>(to) {
    <span class="keyword">var</span> cache = <span class="keyword">this</span>.__evtCache;
    <span class="keyword">var</span> cache_len = cache.length;
    <span class="keyword">this</span>.__clearEvts(to);
    <span class="keyword">if</span> (cache_len &gt; <span class="number">0</span>) {
        <span class="keyword">var</span> edata, type, evts;
        <span class="keyword">for</span> (<span class="keyword">var</span> ei = <span class="number">0</span>; ei &lt; cache_len; ei++) {
            edata = cache[ei];
            type = edata[<span class="number">0</span>];
            to.__evt_st |= type;
            evts = to.__evts;
            <span class="keyword">if</span> (!evts[type]) evts[type] = [];
            evts[type].push(edata[<span class="number">1</span>]);
        }
        <span class="keyword">this</span>.__evtCache = [];
    }
}
Element.prototype.__clearEvts = <span class="keyword">function</span>(from) {
    from.__evt_st = <span class="number">0</span>; from.__evts = {};
}
Element.prototype.__preRender = <span class="keyword">function</span>(gtime, ltime, ctx) {
    <span class="keyword">var</span> cr = <span class="keyword">this</span>.__frameProcessors;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, cl = cr.length; i &lt; cl; i++) {
        <span class="keyword">if</span> (cr[i].call(<span class="keyword">this</span>, gtime, ltime, ctx) === <span class="literal">false</span>) <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="keyword">return</span> <span class="literal">true</span>;
}
Element.prototype.__postRender = <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>clear detach-queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">this</span>.__performDetach();
}
Element.prototype.__resetState = <span class="keyword">function</span>() {
    <span class="keyword">var</span> s = <span class="keyword">this</span>.state;
    s.x = <span class="number">0</span>; s.y = <span class="number">0</span>;
    s.angle = <span class="number">0</span>; s.alpha = <span class="number">1</span>;
    s.sx = <span class="number">1</span>; s.sy = <span class="number">1</span>;
    s.p = <span class="literal">null</span>; s.t = <span class="literal">null</span>; s.key = <span class="literal">null</span>;
    s._applied = <span class="literal">false</span>;
    s._appliedAt = <span class="literal">null</span>;
    s._matrix.reset();
}
Element.prototype._hasRemoteResources = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.xdata.sheet) <span class="keyword">return</span> <span class="literal">true</span>;
}
Element.prototype._getRemoteResources = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.xdata.sheet) <span class="keyword">return</span> <span class="literal">null</span>;
    <span class="keyword">return</span> [ <span class="keyword">this</span>.xdata.sheet.src ];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>base (initial) state of the element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.createBaseState = <span class="keyword">function</span>() {
    <span class="keyword">return</span> { <span class="string">'x'</span>: <span class="number">0</span>, <span class="string">'y'</span>: <span class="number">0</span>,   <span class="comment">// dynamic position</span>
             <span class="string">'angle'</span>: <span class="number">0</span>,       <span class="comment">// rotation angle</span>
             <span class="string">'sx'</span>: <span class="number">1</span>, <span class="string">'sy'</span>: <span class="number">1</span>, <span class="comment">// scale by x / by y</span>
             <span class="string">'hx'</span>: <span class="number">0</span>, <span class="string">'hy'</span>: <span class="number">0</span>, <span class="comment">// shear by x / by y</span>
             <span class="string">'alpha'</span>: <span class="number">1</span>,       <span class="comment">// opacity</span>
             <span class="string">'p'</span>: <span class="literal">null</span>, <span class="string">'t'</span>: <span class="literal">null</span>, <span class="string">'key'</span>: <span class="literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>cur local time (p) or 0..1 time (t) or by key (p have highest priority),
if both are null — stays as defined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>             <span class="string">'_applied'</span>: <span class="literal">true</span> }; <span class="comment">// always applied</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p>state of the element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.createState = <span class="keyword">function</span>(owner) {
    <span class="keyword">return</span> { <span class="string">'x'</span>: <span class="number">0</span>, <span class="string">'y'</span>: <span class="number">0</span>,   <span class="comment">// dynamic position</span>
             <span class="string">'angle'</span>: <span class="number">0</span>,       <span class="comment">// rotation angle</span>
             <span class="string">'sx'</span>: <span class="number">1</span>, <span class="string">'sy'</span>: <span class="number">1</span>, <span class="comment">// scale by x / by y</span>
             <span class="string">'hx'</span>: <span class="number">0</span>, <span class="string">'hy'</span>: <span class="number">0</span>, <span class="comment">// shear by x / by y</span>
             <span class="string">'alpha'</span>: <span class="number">1</span>,       <span class="comment">// opacity</span>
             <span class="string">'p'</span>: <span class="literal">null</span>, <span class="string">'t'</span>: <span class="literal">null</span>, <span class="string">'key'</span>: <span class="literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>cur local time (p) or 0..1 time (t) or by key (p have highest priority),
if both are null — stays as defined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>             <span class="string">'_matrix'</span>: <span class="keyword">new</span> Transform(),
             <span class="string">'_evts'</span>: {},
             <span class="string">'_evt_st'</span>: <span class="number">0</span>,
             <span class="string">'$'</span>: owner };
};</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p>geometric data of the element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Element.createXData = <span class="keyword">function</span>(owner) {
    <span class="keyword">return</span> { <span class="string">'pvt'</span>: Element.DEFAULT_PVT,      <span class="comment">// pivot (relative to dimensions)</span>
             <span class="string">'reg'</span>: Element.DEFAULT_REG,      <span class="comment">// registration point (static values)</span>
             <span class="string">'path'</span>: <span class="literal">null</span>,     <span class="comment">// Path instanse, if it is a shape</span>
             <span class="string">'text'</span>: <span class="literal">null</span>,     <span class="comment">// Text data, if it is a text (`path` holds stroke and fill)</span>
             <span class="string">'sheet'</span>: <span class="literal">null</span>,    <span class="comment">// Sheet instance, if it is an image or a sprite sheet</span>
             <span class="string">'mode'</span>: C.R_ONCE,            <span class="comment">// playing mode,</span>
             <span class="string">'nrep'</span>: <span class="literal">Infinity</span>,        <span class="comment">// number of repetions for the mode</span>
             <span class="string">'lband'</span>: [<span class="number">0</span>, Element.DEFAULT_LEN], <span class="comment">// local band</span>
             <span class="string">'gband'</span>: [<span class="number">0</span>, Element.DEFAULT_LEN], <span class="comment">// global band</span>
             <span class="string">'keys'</span>: {},       <span class="comment">// aliases for time jumps</span>
             <span class="string">'tf'</span>: <span class="literal">null</span>,       <span class="comment">// time jumping function</span>
             <span class="string">'acomp'</span>: <span class="literal">null</span>,    <span class="comment">// alpha composition</span>
             <span class="string">'_mpath'</span>: <span class="literal">null</span>,
             <span class="string">'$'</span>: owner };
}
Element.__addSysModifiers = <span class="keyword">function</span>(elm) {</pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>band check performed in checkJump</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="comment">/* if (xdata.gband) this.__modify(Element.SYS_MOD, 0, null, Render.m_checkBand, xdata.gband); */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p>elm.<strong>modify({ type: Element.SYS_MOD }, Render.m_saveReg);
elm.</strong>modify({ type: Element.SYS_MOD }, Render.m_applyPos);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}
Element.__addSysPainters = <span class="keyword">function</span>(elm) {
    elm.__paint({ type: Element.SYS_PNT }, Render.p_usePivot);
    elm.__paint({ type: Element.SYS_PNT }, Render.p_useReg);
    elm.__paint({ type: Element.SYS_PNT }, Render.p_applyAComp);
    elm.__paint({ type: Element.SYS_PNT }, Render.p_drawXData);
}
Element.__addDebugRender = <span class="keyword">function</span>(elm) {
    elm.__paint({ type: Element.DEBUG_PNT }, Render.p_drawPivot);
    elm.__paint({ type: Element.DEBUG_PNT }, Render.p_drawReg);
    elm.__paint({ type: Element.DEBUG_PNT }, Render.p_drawName);
    elm.__paint({ type: Element.DEBUG_PNT,
                     priority: <span class="number">1</span> },
                   Render.p_drawMPath);
}
Element.__addTweenModifier = <span class="keyword">function</span>(elm, conf) {</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p>if (!conf.type) throw new AnimErr(&#39;Tween type is not defined&#39;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> tween_f = Tweens[conf.type](),
        m_tween;</pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p>all tweens functions actually work with 0..1 parameter, but modifiers
differ by &#39;relative&#39; option</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (conf.relative) {
      m_tween = tween_f;
    } <span class="keyword">else</span> {
      m_tween = <span class="keyword">function</span>(t, duration, data) {
        <span class="keyword">return</span> tween_f.call(<span class="keyword">this</span>, t / duration, duration, data);
      };
    }
    <span class="keyword">return</span> elm.__modify({ type: Element.TWEEN_MOD,
                          priority: Tween.TWEENS_PRIORITY[conf.type],
                          time: conf.band || conf.time,
                          relative: conf.relative,
                          easing: conf.easing,
                          data: conf.data }, m_tween);
}
Element.__convertEasing = <span class="keyword">function</span>(easing, data, relative) {
    <span class="keyword">if</span> (!easing) <span class="keyword">return</span> <span class="literal">null</span>;
    <span class="keyword">if</span> (__str(easing)) {
        <span class="keyword">var</span> f = EasingImpl[easing](data);
        <span class="keyword">return</span> relative ? f : <span class="keyword">function</span>(t, len) { <span class="keyword">return</span> f(t / len, len) * len; }
    }
    <span class="keyword">if</span> (__fun(easing) &amp;&amp; !data) <span class="keyword">return</span> easing;
    <span class="keyword">if</span> (__fun(easing) &amp;&amp; data) <span class="keyword">return</span> easing(data);
    <span class="keyword">if</span> (easing.type) {
        <span class="keyword">var</span> f = EasingImpl[easing.type](easing.data || data);
        <span class="keyword">return</span> relative ? f : <span class="keyword">function</span>(t, len) { <span class="keyword">return</span> f(t / len, len) * len; }
    }
    <span class="keyword">if</span> (easing.f) <span class="keyword">return</span> easing.f(easing.data || data);
}
Element._mergeStates = <span class="keyword">function</span>(s1, s2) {
    <span class="keyword">return</span> {
        x: s1.x + s2.x, y: s1.y + s2.y,
        sx: s1.sx * s2.sx, sy: s1.sy * s2.sy,
        hx: s1.hx + s2.hx, hy: s1.hy + s2.hy,
        angle: s1.angle + s2.angle,
        alpha: s1.alpha * s2.alpha,
        _applied: s1._applied &amp;&amp; s2._applied<span class="comment">/*, TODO:
        _appliedAt: s1._appliedAt || s2._appliedAt*/</span>
    }
}
Element._getMatrixOf = <span class="keyword">function</span>(s, m) {
    <span class="keyword">var</span> _t = (m ? (m.reset(), m)
                : <span class="keyword">new</span> Transform());
    _t.translate(s.x, s.y);
    _t.rotate(s.angle);
    _t.scale(s.sx, s.sy);
    _t.shear(s.hx, s.hy);
    <span class="keyword">return</span> _t;
}
Element._getIMatrixOf = <span class="keyword">function</span>(s, m) {
    <span class="keyword">var</span> _t = Element._getMatrixOf(s, m);
    _t.invert();
    <span class="keyword">return</span> _t;
}
<span class="comment">/* TODO: add createFromImgUrl?
 Element.imgFromURL = function(url) {
    return new Sheet(url);
}*/</span>

<span class="keyword">var</span> Clip = Element;</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <h2>Events</h2>

            </div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">kevt</span><span class="params">(e)</span> {</span>
    <span class="keyword">return</span> { key: e.which || e.keyCode,
             char: String.fromCharCode(e.which || e.keyCode),
             ch: e.charCode,
             original: e };
}

<span class="function"><span class="keyword">function</span> <span class="title">mevt</span><span class="params">(e, cvs)</span> {</span>
    <span class="keyword">return</span> { pos: [ e.pageX - cvs.__rOffsetLeft,
                    e.pageY - cvs.__rOffsetTop ],
             original: e };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <h2>Import</h2>

            </div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> L = {}; <span class="comment">// means "Loading/Loader"</span>

L.loadFromUrl = <span class="keyword">function</span>(player, url, importer, callback) {
    <span class="keyword">if</span> (!JSON) <span class="keyword">throw</span> <span class="keyword">new</span> SysErr(Errors.S.NO_JSON_PARSER);

    player._drawLoadingSplash(_strf(Strings.LOADING_ANIMATION, [url.substring(<span class="number">0</span>, <span class="number">50</span>)]));

    <span class="keyword">var</span> success = <span class="keyword">function</span>(req) {
        L.loadFromObj(player, JSON.parse(req.responseText), importer, callback);
    };
    <span class="keyword">var</span> failure = player.__defAsyncSafe(<span class="keyword">function</span>(err) {
      <span class="keyword">throw</span> <span class="keyword">new</span> SysErr(<span class="string">'Snapshot failed to load'</span>);
    });

    ajax(url, success, failure);
}
L.loadFromObj = <span class="keyword">function</span>(player, object, importer, callback) {
    <span class="keyword">if</span> (!importer) <span class="keyword">throw</span> <span class="keyword">new</span> PlayerErr(Errors.P.NO_IMPORTER_TO_LOAD_WITH);
    <span class="keyword">if</span> (importer.configureAnim) {
        player.configureAnim(importer.configureAnim(object));
    }
    <span class="keyword">if</span> (importer.configureMeta) {
        player.configureMeta(importer.configureMeta(object));
    }
    <span class="keyword">var</span> scene = importer.load(object);
    player.fire(C.S_IMPORT, importer, scene, object);
    L.loadScene(player, scene, callback);
}
L.loadScene = <span class="keyword">function</span>(player, scene, callback) {
    <span class="keyword">if</span> (player.anim) player.anim.dispose();</pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <p>add debug rendering</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (player.state.debug
        &amp;&amp; !global_opts.liveDebug)
        scene.visitElems(Element.__addDebugRender); <span class="comment">/* FIXME: ensure not to add twice */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <p>assign</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    player.anim = scene;</pre></div></div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p>update duration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (player.state.duration == <span class="literal">undefined</span>) {
        <span class="keyword">var</span> _duration;
        <span class="keyword">if</span> (scene.duration !== <span class="literal">undefined</span>) { _duration = scene.duration; }
        <span class="keyword">else</span> {
          <span class="keyword">if</span> (player.mode &amp; C.M_INFINITE_DURATION) { _duration = <span class="literal">Infinity</span>; }
          <span class="keyword">else</span> {
            <span class="keyword">if</span> (scene.isEmpty()) { _duration = <span class="number">0</span>; }
            <span class="keyword">else</span> { _duration = Scene.DEFAULT_LEN; }
          }
        }
        scene.setDuration(_duration);
        player.setDuration(_duration);
    }
    <span class="keyword">if</span> ((scene.width === <span class="literal">undefined</span>) &amp;&amp; (scene.height === <span class="literal">undefined</span>)) {
        scene.width = player.state.width;
        scene.height = player.state.height;
    }
    <span class="keyword">if</span> (callback) callback.call(player, scene);
}
L.loadClips = <span class="keyword">function</span>(player, clips, callback) {
    <span class="keyword">var</span> _anim = <span class="keyword">new</span> Scene();
    _anim.add(clips);
    L.loadScene(player, _anim, callback);
}
L.loadBuilder = <span class="keyword">function</span>(player, builder, callback) {
    <span class="keyword">var</span> _anim = <span class="keyword">new</span> Scene();
    _anim.add(builder.v);
    <span class="keyword">if</span> (builder.d != <span class="literal">undefined</span>) _anim.setDuration(builder.d);
    L.loadScene(player, _anim, callback);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <h2>Rendering</h2>

            </div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Render = {}; <span class="comment">// means "Render", render loop + system modifiers &amp; painters</span></pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p>functions below, the ones named in a way like <code>__r_*</code> are the real functions
acting under their aliases <code>Render.*</code>; it is done this way because probably
the separate function which is not an object propertly, will be a bit faster to
access during animation loop</p>
<p>draws current state of animation on canvas and postpones to call itself for
the next time period (so to start animation, you just need to call it once
when the first time must occur and it will chain its own calls automatically)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">__r_loop</span><span class="params">(ctx, pl_state, scene, before, after, before_render, after_render)</span> {</span>
    <span class="keyword">if</span> (pl_state.happens !== C.PLAYING) <span class="keyword">return</span>;

    <span class="keyword">var</span> msec = (Date.now() - pl_state.__startTime);
    <span class="keyword">var</span> sec = msec / <span class="number">1000</span>;

    <span class="keyword">var</span> time = (sec * pl_state.speed) + pl_state.from;
    pl_state.time = time;

    <span class="keyword">if</span> (before) {
        <span class="keyword">if</span> (!before(time)) <span class="keyword">return</span>;
    }

    <span class="keyword">if</span> (pl_state.__rsec === <span class="number">0</span>) pl_state.__rsec = msec;
    <span class="keyword">if</span> ((msec - pl_state.__rsec) &gt;= <span class="number">1000</span>) {
        pl_state.afps = pl_state.__redraws;
        pl_state.__rsec = msec;
        pl_state.__redraws = <span class="number">0</span>;
    }
    pl_state.__redraws++;

    __r_at(time, ctx, pl_state, scene, before_render, after_render);</pre></div></div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p>show fps</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (pl_state.debug) { <span class="comment">// TODO: move to player.onrender</span>
        __r_fps(ctx, pl_state.afps, time);
    }

    <span class="keyword">if</span> (after) {
        <span class="keyword">if</span> (!after(time)) <span class="keyword">return</span>;
    }

    <span class="keyword">if</span> (pl_state.__supressFrames) <span class="keyword">return</span>;

    <span class="keyword">return</span> __nextFrame(<span class="keyword">function</span>() {
        __r_loop(ctx, pl_state, scene, before, after, before_render, after_render);
    })
}
<span class="function"><span class="keyword">function</span> <span class="title">__r_at</span><span class="params">(time, ctx, pl_state, scene, before, after)</span> {</span>
    ctx.save();
    <span class="keyword">var</span> ratio = pl_state.ratio;
    <span class="keyword">if</span> (ratio != <span class="number">1</span>) ctx.scale(ratio, ratio);
    <span class="keyword">var</span> size_differs = (pl_state.width  != scene.width) ||
                       (pl_state.height != scene.height);
    <span class="keyword">if</span> (!size_differs) {
        ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, scene.width,
                          scene.height);
        <span class="keyword">if</span> (before) before(time, ctx);
        scene.render(ctx, time, pl_state.zoom<span class="comment">/*, pl_state.afps*/</span>);
        <span class="keyword">if</span> (after) after(time, ctx);
        ctx.restore();
    } <span class="keyword">else</span> {
        __r_with_ribbons(ctx, pl_state.width, pl_state.height,
                              scene.width, scene.height,
            <span class="keyword">function</span>(_scale) {
              ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, scene.width, scene.height);
              <span class="keyword">if</span> (before) before(time, ctx);
              scene.render(ctx, time, pl_state.zoom<span class="comment">/*, pl_state.afps*/</span>);
              <span class="keyword">if</span> (after) after(time, ctx);
              ctx.restore();
            });
    }
}
<span class="function"><span class="keyword">function</span> <span class="title">__r_with_ribbons</span><span class="params">(ctx, pw, ph, sw, sh, draw_f)</span> {</span>
    <span class="keyword">var</span> xw = pw / sw,
        xh = ph / sh;
    <span class="keyword">var</span> x = Math.min(xw, xh);
    <span class="keyword">var</span> hcoord = (pw - sw * x) / <span class="number">2</span>,
        vcoord = (ph - sh * x) / <span class="number">2</span>;
    <span class="keyword">var</span> scaled = (xw != <span class="number">1</span>) || (xh != <span class="number">1</span>);
    <span class="keyword">if</span> (scaled) {
        ctx.save();
        ctx.save();
        ctx.fillStyle = <span class="string">'#000'</span>;
        <span class="keyword">if</span> (hcoord != <span class="number">0</span>) {
          ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, hcoord, ph);
          ctx.fillRect(hcoord + (sw * x), <span class="number">0</span>, hcoord, ph);
        }
        <span class="keyword">if</span> (vcoord != <span class="number">0</span>) {
          ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, pw, vcoord);
          ctx.fillRect(<span class="number">0</span>, vcoord + (sh * x), pw, vcoord);
        }
        ctx.restore();
        ctx.beginPath();
        ctx.rect(hcoord, vcoord, sw * x, sh * x);
        ctx.clip();
        ctx.translate(hcoord, vcoord);
        ctx.scale(x, x);
    }
    draw_f(x);
    <span class="keyword">if</span> (scaled) {
        ctx.restore();
    }
}
<span class="function"><span class="keyword">function</span> <span class="title">__r_fps</span><span class="params">(ctx, fps, time)</span> {</span>
    ctx.fillStyle = <span class="string">'#999'</span>;
    ctx.font = <span class="string">'20px sans-serif'</span>;
    ctx.fillText(Math.floor(fps), <span class="number">8</span>, <span class="number">20</span>);
    ctx.font = <span class="string">'10px sans-serif'</span>;
    ctx.fillText(Math.floor(time * <span class="number">1000</span>) / <span class="number">1000</span>, <span class="number">8</span>, <span class="number">35</span>);
}
Render.loop = __r_loop;
Render.at = __r_at;
Render._drawFPS = __r_fps;

Render.p_drawPivot = <span class="keyword">function</span>(ctx, pvt) {
    <span class="keyword">if</span> (!(pvt = pvt || <span class="keyword">this</span>.pvt)) <span class="keyword">return</span>;
    <span class="keyword">var</span> dimen = <span class="keyword">this</span>.$.dimen() || [ <span class="number">0</span>, <span class="number">0</span> ];
    <span class="keyword">var</span> stokeStyle = dimen ? <span class="string">'#600'</span> : <span class="string">'#f00'</span>;
    ctx.save();</pre></div></div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p>WHY it is required??</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ctx.translate(pvt[<span class="number">0</span>] * dimen[<span class="number">0</span>],
                  pvt[<span class="number">1</span>] * dimen[<span class="number">1</span>]);
    ctx.beginPath();
    ctx.lineWidth = <span class="number">1.0</span>;
    ctx.strokeStyle = stokeStyle;
    ctx.moveTo(<span class="number">0</span>, -<span class="number">10</span>);
    ctx.lineTo(<span class="number">0</span>, <span class="number">0</span>);
    ctx.moveTo(<span class="number">3</span>, <span class="number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p>ctx.moveTo(0, 5);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ctx.arc(<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,Math.PI*<span class="number">2</span>,<span class="literal">true</span>);
    ctx.closePath();
    ctx.stroke();
    ctx.restore();
}

Render.p_drawReg = <span class="keyword">function</span>(ctx, reg) {
    <span class="keyword">if</span> (!(reg = reg || <span class="keyword">this</span>.reg)) <span class="keyword">return</span>;
    ctx.save();
    ctx.lineWidth = <span class="number">1.0</span>;
    ctx.strokeStyle = <span class="string">'#00f'</span>;
    ctx.fillStyle = <span class="string">'rgba(0,0,255,.3)'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p>WHY it is required??</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ctx.translate(reg[<span class="number">0</span>], reg[<span class="number">1</span>]);
    ctx.beginPath();
    ctx.moveTo(-<span class="number">4</span>, -<span class="number">4</span>);
    ctx.lineTo(<span class="number">4</span>, -<span class="number">4</span>);
    ctx.lineTo(<span class="number">4</span>, <span class="number">4</span>);
    ctx.lineTo(-<span class="number">4</span>, <span class="number">4</span>);
    ctx.lineTo(-<span class="number">4</span>, -<span class="number">4</span>);
    ctx.closePath();
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(<span class="number">0</span>, -<span class="number">10</span>);
    ctx.lineTo(<span class="number">0</span>, <span class="number">0</span>);
    ctx.moveTo(<span class="number">3</span>, <span class="number">0</span>);
    ctx.closePath();
    ctx.stroke();
    ctx.restore();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <p>TODO: p_drawReg</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Render.p_drawXData = <span class="keyword">function</span>(ctx) {
    <span class="keyword">var</span> subj = <span class="keyword">this</span>.path || <span class="keyword">this</span>.text || <span class="keyword">this</span>.sheet;
    <span class="keyword">if</span> (!subj) <span class="keyword">return</span>;
    subj.apply(ctx); <span class="comment">// apply does ctx.save/ctx.restore by itself</span>
}

Render.p_drawName = <span class="keyword">function</span>(ctx, name) {
    <span class="keyword">if</span> (!(name = name || <span class="keyword">this</span>.$.name)) <span class="keyword">return</span>;
    ctx.save();
    ctx.fillStyle = <span class="string">'#666'</span>;
    ctx.font = <span class="string">'12px sans-serif'</span>;
    ctx.fillText(name, <span class="number">0</span>, <span class="number">10</span>);
    ctx.restore();
}

Render.p_applyAComp = <span class="keyword">function</span>(ctx) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.acomp) ctx.globalCompositeOperation = C.AC_NAMES[<span class="keyword">this</span>.acomp];
}

Render.p_useReg = <span class="keyword">function</span>(ctx) {
    <span class="keyword">var</span> reg = <span class="keyword">this</span>.reg;
    <span class="keyword">if</span> ((reg[<span class="number">0</span>] === <span class="number">0</span>) &amp;&amp; (reg[<span class="number">1</span>] === <span class="number">0</span>)) <span class="keyword">return</span>;
    ctx.translate(-reg[<span class="number">0</span>], -reg[<span class="number">1</span>]);
}

Render.p_usePivot = <span class="keyword">function</span>(ctx) {
    <span class="keyword">var</span> dimen = <span class="keyword">this</span>.$.dimen(),
        pvt = <span class="keyword">this</span>.pvt;
    <span class="keyword">if</span> (!dimen) <span class="keyword">return</span>;
    <span class="keyword">if</span> ((pvt[<span class="number">0</span>] === <span class="number">0</span>) &amp;&amp; (pvt[<span class="number">1</span>] === <span class="number">0</span>)) <span class="keyword">return</span>;
    ctx.translate(-(pvt[<span class="number">0</span>] * dimen[<span class="number">0</span>]),
                  -(pvt[<span class="number">1</span>] * dimen[<span class="number">1</span>]));
}

Render.p_drawMPath = <span class="keyword">function</span>(ctx, mPath) {
    <span class="keyword">if</span> (!(mPath = mPath || <span class="keyword">this</span>.$.state._mpath)) <span class="keyword">return</span>;
    ctx.save();</pre></div></div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              <p>var s = this.$.astate;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    mPath.cstroke(<span class="string">'#600'</span>, <span class="number">2.0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <p>ctx.translate(-s.x, -s.y);
ctx.rotate(-s.angle);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ctx.beginPath();
    mPath.apply(ctx);
    ctx.closePath();
    ctx.stroke();
    ctx.restore();
}

Render.m_checkBand = <span class="keyword">function</span>(time, duration, band) {
    <span class="keyword">if</span> (band[<span class="number">0</span>] &gt; (duration * time)) <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// exit</span>
    <span class="keyword">if</span> (band[<span class="number">1</span>] &lt; (duration * time)) <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// exit</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <h2>Bands</h2>

            </div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Bands = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p>recalculate all global bands down to the very
child, starting from given element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Bands.recalc = <span class="keyword">function</span>(elm, in_band) {
    <span class="keyword">var</span> x = elm.xdata;
    <span class="keyword">var</span> in_band = in_band ||
                  ( elm.parent
                  ? elm.parent.xdata.gband
                  : [<span class="number">0</span>, <span class="number">0</span>] );
    x.gband = [ in_band[<span class="number">0</span>] + x.lband[<span class="number">0</span>],
                in_band[<span class="number">0</span>] + x.lband[<span class="number">1</span>] ];
    elm.visitChildren(<span class="keyword">function</span>(celm) {
        Bands.recalc(celm, x.gband);
    });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-205">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              <p>makes inner band coords relative to outer space</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Bands.wrap = <span class="keyword">function</span>(outer, inner) {
    <span class="keyword">if</span> (!outer) <span class="keyword">return</span> inner;
    <span class="keyword">return</span> [ outer[<span class="number">0</span>] + inner[<span class="number">0</span>],
             ((outer[<span class="number">0</span>] + inner[<span class="number">1</span>]) &lt;= outer[<span class="number">1</span>])
              ? (outer[<span class="number">0</span>] + inner[<span class="number">1</span>])
              : outer[<span class="number">1</span>]
            ];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-206">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              <p>makes band maximum wide to fith both bands</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Bands.expand = <span class="keyword">function</span>(from, to) {
    <span class="keyword">if</span> (!from) <span class="keyword">return</span> to;
    <span class="keyword">return</span> [ ((to[<span class="number">0</span>] &lt; from[<span class="number">0</span>])
              ? to[<span class="number">0</span>] : from[<span class="number">0</span>]),
             ((to[<span class="number">1</span>] &gt; from[<span class="number">1</span>])
              ? to[<span class="number">1</span>] : from[<span class="number">1</span>])
           ];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-207">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              <p>finds minimum intersection of the bands</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Bands.reduce = <span class="keyword">function</span>(from, to) {
    <span class="keyword">if</span> (!from) <span class="keyword">return</span> to;
    <span class="keyword">return</span> [ ((to[<span class="number">0</span>] &gt; from[<span class="number">0</span>])
              ? to[<span class="number">0</span>] : from[<span class="number">0</span>]),
             ((to[<span class="number">1</span>] &lt; from[<span class="number">1</span>])
              ? to[<span class="number">1</span>] : from[<span class="number">1</span>])
           ];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-208">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-208">&#182;</a>
              </div>
              <h2>Tweens</h2>

            </div>
            
        </li>
        
        
        <li id="section-209">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-209">&#182;</a>
              </div>
              <p>Tween constants</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>C.T_TRANSLATE   = <span class="string">'TRANSLATE'</span>;
C.T_SCALE       = <span class="string">'SCALE'</span>;
C.T_ROTATE      = <span class="string">'ROTATE'</span>;
C.T_ROT_TO_PATH = <span class="string">'ROT_TO_PATH'</span>;
C.T_ALPHA       = <span class="string">'ALPHA'</span>;
C.T_SHEAR       = <span class="string">'SHEAR'</span>;

<span class="keyword">var</span> Tween = {}; <span class="comment">// FIXME: make tween a class</span>
<span class="keyword">var</span> Easing = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-210">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-210">&#182;</a>
              </div>
              <p>tween order</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Tween.TWEENS_PRIORITY = {};

Tween.TWEENS_PRIORITY[C.T_TRANSLATE]   = <span class="number">0</span>;
Tween.TWEENS_PRIORITY[C.T_SCALE]       = <span class="number">1</span>;
Tween.TWEENS_PRIORITY[C.T_ROTATE]      = <span class="number">2</span>;
Tween.TWEENS_PRIORITY[C.T_ROT_TO_PATH] = <span class="number">3</span>;
Tween.TWEENS_PRIORITY[C.T_ALPHA]       = <span class="number">4</span>;
Tween.TWEENS_PRIORITY[C.T_SHEAR]       = <span class="number">5</span>;

Tween.TWEENS_COUNT = <span class="number">6</span>;

<span class="keyword">var</span> Tweens = {};
Tweens[C.T_ROTATE] =
    <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">function</span>(t, duration, data) {
        <span class="keyword">this</span>.angle = data[<span class="number">0</span>] * (<span class="number">1</span> - t) + data[<span class="number">1</span>] * t;</pre></div></div>
            
        </li>
        
        
        <li id="section-211">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-211">&#182;</a>
              </div>
              <p>state.angle = (Math.PI / 180) * 45;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      };
    };
Tweens[C.T_TRANSLATE] =
    <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">function</span>(t, duration, data) {
          <span class="keyword">var</span> p = data.pointAt(t);
          <span class="keyword">this</span>._mpath = data;
          <span class="keyword">this</span>.x = p[<span class="number">0</span>];
          <span class="keyword">this</span>.y = p[<span class="number">1</span>];
      };
    };
Tweens[C.T_ALPHA] =
    <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">function</span>(t, duration, data) {
        <span class="keyword">this</span>.alpha = data[<span class="number">0</span>] * (<span class="number">1.0</span> - t) + data[<span class="number">1</span>] * t;
      };
    };
Tweens[C.T_SCALE] =
    <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">function</span>(t, duration, data) {
        <span class="keyword">this</span>.sx = data[<span class="number">0</span>][<span class="number">0</span>] * (<span class="number">1.0</span> - t) + data[<span class="number">1</span>][<span class="number">0</span>] * t;
        <span class="keyword">this</span>.sy = data[<span class="number">0</span>][<span class="number">1</span>] * (<span class="number">1.0</span> - t) + data[<span class="number">1</span>][<span class="number">1</span>] * t;
      };
    };
Tweens[C.T_ROT_TO_PATH] =
    <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">function</span>(t, duration, data) {
        <span class="keyword">var</span> path = <span class="keyword">this</span>._mpath;
        <span class="keyword">if</span> (path) <span class="keyword">this</span>.angle = path.tangentAt(t); <span class="comment">// Math.atan2(this.y, this.x);</span>
      };
    };
Tweens[C.T_SHEAR] =
    <span class="keyword">function</span>() {
      <span class="keyword">return</span> <span class="keyword">function</span>(t, duration, data) {
        <span class="keyword">this</span>.hx = data[<span class="number">0</span>][<span class="number">0</span>] * (<span class="number">1.0</span> - t) + data[<span class="number">1</span>][<span class="number">0</span>] * t;
        <span class="keyword">this</span>.hy = data[<span class="number">0</span>][<span class="number">1</span>] * (<span class="number">1.0</span> - t) + data[<span class="number">1</span>][<span class="number">1</span>] * t;
      };
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-212">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-212">&#182;</a>
              </div>
              <h2>Easings</h2>

            </div>
            
        </li>
        
        
        <li id="section-213">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-213">&#182;</a>
              </div>
              <p>Easings constants</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>C.E_PATH = <span class="string">'PATH'</span>; <span class="comment">// Path</span>
C.E_FUNC = <span class="string">'FUNC'</span>; <span class="comment">// Function</span>
C.E_CSEG = <span class="string">'CSEG'</span>; <span class="comment">// Function</span>
<span class="comment">/*C.E_CINOUT = 'CINOUT'; // Cubic InOut*/</span>
<span class="comment">/*....*/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-214">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p>function-based easings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> EasingImpl = {};

EasingImpl[C.E_PATH] =
    <span class="keyword">function</span>(path) {
        <span class="comment">/*var path = Path.parse(str);*/</span>
        <span class="keyword">return</span> <span class="keyword">function</span>(t) {
            <span class="keyword">return</span> path.pointAt(t)[<span class="number">1</span>];
        }
    };
EasingImpl[C.E_FUNC] =
    <span class="keyword">function</span>(f) {
        <span class="keyword">return</span> f;
    };
EasingImpl[C.E_CSEG] =
    <span class="keyword">function</span>(seg) {
        <span class="keyword">return</span> <span class="keyword">function</span>(t) {
            <span class="keyword">return</span> seg.atT([<span class="number">0</span>, <span class="number">0</span>], t)[<span class="number">1</span>];
        };
    };
<span class="comment">/*EasingImpl[C.E_CINOUT] =
    function() {
        return function(t) {
            var t =  2 * t;
            if (t &lt; 1) {
                return -1/2 * (Math.sqrt(1 - t*t) - 1);
            } else {
                return 1/2 * (Math.sqrt(1 - (t-2)*(t-2)) + 1);
            }
        }
    };*/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-215">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-215">&#182;</a>
              </div>
              <p>segment-based easings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Easing.__SEGS = {}; <span class="comment">// segments cache for easings</span>

<span class="function"><span class="keyword">function</span> <span class="title">__registerSegEasing</span><span class="params">(alias, points)</span> {</span>
    C[<span class="string">'E_'</span>+alias] = alias;
    <span class="keyword">var</span> seg = <span class="keyword">new</span> CSeg(points);
    Easing.__SEGS[alias] = seg;
    <span class="keyword">var</span> func =
        <span class="keyword">function</span>(t) {
            <span class="keyword">return</span> seg.atT([<span class="number">0</span>, <span class="number">0</span>], t)[<span class="number">1</span>];
        };
    C[<span class="string">'EF_'</span>+alias] = func;
    EasingImpl[alias] = <span class="keyword">function</span>() {
        <span class="keyword">return</span> func;
    }
}

__registerSegEasing(<span class="string">'DEF'</span>,    [<span class="number">0.250</span>, <span class="number">0.100</span>, <span class="number">0.250</span>, <span class="number">1.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Default</span>
__registerSegEasing(<span class="string">'IN'</span>,     [<span class="number">0.420</span>, <span class="number">0.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// In</span>
__registerSegEasing(<span class="string">'OUT'</span>,    [<span class="number">0.000</span>, <span class="number">0.000</span>, <span class="number">0.580</span>, <span class="number">1.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Out</span>
__registerSegEasing(<span class="string">'INOUT'</span>,  [<span class="number">0.420</span>, <span class="number">0.000</span>, <span class="number">0.580</span>, <span class="number">1.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// InOut</span>
__registerSegEasing(<span class="string">'SIN'</span>,    [<span class="number">0.470</span>, <span class="number">0.000</span>, <span class="number">0.745</span>, <span class="number">0.715</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Sine In</span>
__registerSegEasing(<span class="string">'SOUT'</span>,   [<span class="number">0.390</span>, <span class="number">0.575</span>, <span class="number">0.565</span>, <span class="number">1.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Sine Out</span>
__registerSegEasing(<span class="string">'SINOUT'</span>, [<span class="number">0.445</span>, <span class="number">0.050</span>, <span class="number">0.550</span>, <span class="number">0.950</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Sine InOut</span>
__registerSegEasing(<span class="string">'QIN'</span>,    [<span class="number">0.550</span>, <span class="number">0.085</span>, <span class="number">0.680</span>, <span class="number">0.530</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Quad In</span>
__registerSegEasing(<span class="string">'QOUT'</span>,   [<span class="number">0.250</span>, <span class="number">0.460</span>, <span class="number">0.450</span>, <span class="number">0.940</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Quad Out</span>
__registerSegEasing(<span class="string">'QINOUT'</span>, [<span class="number">0.455</span>, <span class="number">0.030</span>, <span class="number">0.515</span>, <span class="number">0.955</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Quad InOut</span>
__registerSegEasing(<span class="string">'CIN'</span>,    [<span class="number">0.550</span>, <span class="number">0.055</span>, <span class="number">0.675</span>, <span class="number">0.190</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Cubic In</span>
__registerSegEasing(<span class="string">'COUT'</span>,   [<span class="number">0.215</span>, <span class="number">0.610</span>, <span class="number">0.355</span>, <span class="number">1.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Cubic Out</span>
__registerSegEasing(<span class="string">'CINOUT'</span>, [<span class="number">0.645</span>, <span class="number">0.045</span>, <span class="number">0.355</span>, <span class="number">1.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Cubic InOut</span>
__registerSegEasing(<span class="string">'QTIN'</span>,   [<span class="number">0.895</span>, <span class="number">0.030</span>, <span class="number">0.685</span>, <span class="number">0.220</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Quart In</span>
__registerSegEasing(<span class="string">'QTOUT'</span>,  [<span class="number">0.165</span>, <span class="number">0.840</span>, <span class="number">0.440</span>, <span class="number">1.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Quart Out</span>
__registerSegEasing(<span class="string">'QTINOUT'</span>,[<span class="number">0.770</span>, <span class="number">0.000</span>, <span class="number">0.175</span>, <span class="number">1.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Quart InOut</span>
__registerSegEasing(<span class="string">'QIIN'</span>,   [<span class="number">0.755</span>, <span class="number">0.050</span>, <span class="number">0.855</span>, <span class="number">0.060</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Quint In</span>
__registerSegEasing(<span class="string">'QIOUT'</span>,  [<span class="number">0.230</span>, <span class="number">1.000</span>, <span class="number">0.320</span>, <span class="number">1.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Quart Out</span>
__registerSegEasing(<span class="string">'QIINOUT'</span>,[<span class="number">0.860</span>, <span class="number">0.000</span>, <span class="number">0.070</span>, <span class="number">1.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Quart InOut</span>
__registerSegEasing(<span class="string">'EIN'</span>,    [<span class="number">0.950</span>, <span class="number">0.050</span>, <span class="number">0.795</span>, <span class="number">0.035</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Expo In</span>
__registerSegEasing(<span class="string">'EOUT'</span>,   [<span class="number">0.190</span>, <span class="number">1.000</span>, <span class="number">0.220</span>, <span class="number">1.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Expo Out</span>
__registerSegEasing(<span class="string">'EINOUT'</span>, [<span class="number">1.000</span>, <span class="number">0.000</span>, <span class="number">0.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Expo InOut</span>
__registerSegEasing(<span class="string">'CRIN'</span>,   [<span class="number">0.600</span>, <span class="number">0.040</span>, <span class="number">0.980</span>, <span class="number">0.335</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Circ In</span>
__registerSegEasing(<span class="string">'CROUT'</span>,  [<span class="number">0.075</span>, <span class="number">0.820</span>, <span class="number">0.165</span>, <span class="number">1.000</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Circ Out</span>
__registerSegEasing(<span class="string">'CRINOUT'</span>,[<span class="number">0.785</span>, <span class="number">0.135</span>, <span class="number">0.150</span>, <span class="number">0.860</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Circ InOut</span>
__registerSegEasing(<span class="string">'BIN'</span>,    [<span class="number">0.600</span>, -<span class="number">0.280</span>, <span class="number">0.735</span>, <span class="number">0.045</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Back In</span>
__registerSegEasing(<span class="string">'BOUT'</span>,   [<span class="number">0.175</span>, <span class="number">0.885</span>, <span class="number">0.320</span>, <span class="number">1.275</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Back Out</span>
__registerSegEasing(<span class="string">'BINOUT'</span>, [<span class="number">0.680</span>, -<span class="number">0.550</span>, <span class="number">0.265</span>, <span class="number">1.550</span>, <span class="number">1.000</span>, <span class="number">1.000</span>]); <span class="comment">// Back InOut</span></pre></div></div>
            
        </li>
        
        
        <li id="section-216">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-216">&#182;</a>
              </div>
              <h2>Paths</h2>

            </div>
            
        </li>
        
        
        <li id="section-217">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-217">&#182;</a>
              </div>
              <p>M<X> <Y> - move to
L<X> <Y> - line to
C<X1> <Y1> <X2> <Y2> <X3> <Y3> - curve to
Z - close path
lowercase marker means relative coord
Example: &quot;M0 10 L20 20 C10 20 15 30 10 9 Z&quot;</p>
<p>all commands:
V = vertical lineto
C = curveto
S = smooth curveto
Q = quadratic Bézier curve
T = smooth quadratic Bézier curveto
A = elliptical Arc
Z = closepath</p>
<p>Currently our format differs in a number format:
&quot;M0.0 10.0 L20.0 20.0 C10.0 20.0 15.0 30.0 10.0 9.0 Z&quot;</p>
<p>path constants</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>C.P_MOVETO = <span class="number">0</span>;
C.P_LINETO = <span class="number">1</span>;
C.P_CURVETO = <span class="number">2</span>;

C.PC_ROUND = <span class="string">'round'</span>;
C.PC_BUTT = <span class="string">'butt'</span>;
C.PC_MITER = <span class="string">'miter'</span>;
C.PC_SQUARE = <span class="string">'square'</span>;
C.PC_BEVEL = <span class="string">'bevel'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-218">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-218">&#182;</a>
              </div>
              <blockquote>
<p>Path % (str: String)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">Path</span><span class="params">(str, fill, stroke, shadow)</span> {</span>
    <span class="keyword">this</span>.str = str;
    <span class="keyword">this</span>.fill = fill;
    <span class="keyword">this</span>.stroke = stroke;
    <span class="keyword">this</span>.shadow = shadow;
    <span class="keyword">this</span>.segs = [];
    <span class="keyword">this</span>.parse(str);
}

Path.DEFAULT_CAP = C.PC_ROUND;
Path.DEFAULT_JOIN = C.PC_ROUND;
Path.EMPTY_FILL = { <span class="string">'color'</span>: <span class="string">'transparent'</span> };
Path.DEFAULT_FILL = Path.EMPTY_FILL;
Path.BASE_FILL = { <span class="string">'color'</span>: <span class="string">'#fff666'</span> };
Path.EMPTY_STROKE = { <span class="string">'width'</span>: <span class="number">0</span>, color: <span class="string">'transparent'</span> };
Path.DEFAULT_STROKE = Path.EMPTY_STROKE;
Path.BASE_STROKE = { <span class="string">'width'</span>: <span class="number">1.0</span>,
                     <span class="string">'color'</span>: <span class="string">'#000'</span>,
                     <span class="string">'cap'</span>: Path.DEFAULT_CAP,
                     <span class="string">'join'</span>: Path.DEFAULT_JOIN
                   };</pre></div></div>
            
        </li>
        
        
        <li id="section-219">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <p>visits every chunk of path in array-form and calls
visitor function, so visitor function gets
chunk marker and positions sequentially
data argument will be also passed to visitor if specified</p>
<blockquote>
<p>Path.visit % (visitor: Function[Segment, Any], data: Any)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path.prototype.visit = <span class="keyword">function</span>(visitor, data) {
    <span class="keyword">var</span> segments = <span class="keyword">this</span>.segs;
    <span class="keyword">for</span> (<span class="keyword">var</span> si = <span class="number">0</span>, sl = segments.length; si &lt; sl; si++) {
        visitor(segments[si], data);
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-220">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-220">&#182;</a>
              </div>
              <p>path length, in points</p>
<blockquote>
<p>Path.length % () =&gt; Double</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path.prototype.length = <span class="keyword">function</span>() {
    <span class="keyword">var</span> sum = <span class="number">0</span>;
    <span class="keyword">var</span> p = <span class="keyword">this</span>.start();
    <span class="keyword">this</span>.visit(<span class="keyword">function</span>(segment) {
        sum += segment.length(p);
        p = segment.last();
    });
    <span class="keyword">return</span> sum;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-221">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <blockquote>
<p>Path.add % (seg: Segment)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path.prototype.add = <span class="keyword">function</span>(seg) {
    <span class="keyword">this</span>.segs.push(seg);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-222">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-222">&#182;</a>
              </div>
              <blockquote>
<p>Path.apply % (ctx: Context)</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path.prototype.apply = <span class="keyword">function</span>(ctx) {
    <span class="keyword">var</span> p = <span class="keyword">this</span>;
    Path.applyF(ctx, p.fill || Path.DEFAULT_FILL,
                     p.stroke || Path.DEFAULT_STROKE,
                     p.shadow,
             <span class="keyword">function</span>() { p.visit(Path._applyVisitor, ctx); });

    <span class="comment">/* ctx.save();
    ctx.beginPath();
    Brush.fill(ctx, fill);
    Brush.stroke(ctx, stroke);
    this.visit(Path._applyVisitor, ctx);
    ctx.closePath();

    if (Brush._hasVal(fill)) ctx.fill();
    if (Brush._hasVal(stroke)) ctx.stroke();
    ctx.restore(); */</span>
}
Path.prototype.cstroke = <span class="keyword">function</span>(color, width, cap, join) {
    <span class="keyword">this</span>.stroke = {
        <span class="string">'width'</span>: (width != <span class="literal">null</span>) ? width
                 : Path.DEFAULT_STROKE.width,
        <span class="string">'color'</span>: color,
        <span class="string">'cap'</span>: cap || Path.DEFAULT_CAP,
        <span class="string">'join'</span>: join || Path.DEFAULT_JOIN
    };
}
Path.prototype.cfill = <span class="keyword">function</span>(color) {
    <span class="keyword">this</span>.fill = {
        <span class="string">'color'</span>: color
    };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-223">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-223">&#182;</a>
              </div>
              <blockquote>
<p>Path.parse % (str: String) =&gt; Path</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path.prototype.parse = <span class="keyword">function</span>(str) {
    <span class="keyword">if</span> (str) Path.parse(str, <span class="keyword">this</span>);
    <span class="keyword">return</span> <span class="keyword">this</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-224">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-224">&#182;</a>
              </div>
              <p>find a segment data in a path that corresponds to specified distance (t)
of the path (0..1),</p>
<blockquote>
<p>Path.hitAt % (t: [0..1]) =&gt; Array[Int, 2]</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path.prototype.hitAt = <span class="keyword">function</span>(t<span class="comment">/*, func*/</span>) {
    <span class="keyword">var</span> startp = <span class="keyword">this</span>.start();
    <span class="keyword">if</span> (t === <span class="number">0</span>) <span class="keyword">return</span> {
          <span class="string">'seg'</span>: <span class="keyword">this</span>.segs[<span class="number">0</span>], <span class="string">'start'</span>: startp, <span class="string">'slen'</span>: <span class="number">0.0</span>, <span class="string">'segt'</span>: <span class="number">0.0</span>
        };
    <span class="keyword">var</span> endp = <span class="keyword">this</span>.end();
    <span class="comment">/*if (t == 1) return func ? func(startp, endp) : endp;*/</span>

    <span class="keyword">var</span> plen = <span class="keyword">this</span>.length(); <span class="comment">// path length in pixels</span>
    <span class="keyword">var</span> nsegs = <span class="keyword">this</span>.segs.length; <span class="comment">// number of segments</span>
    <span class="keyword">var</span> distance = t * plen;
    <span class="keyword">var</span> p = startp;
    <span class="keyword">var</span> length = <span class="number">0</span>; <span class="comment">// checked length in pixels</span>
    <span class="keyword">var</span> seg, slen;
    <span class="keyword">for</span> (<span class="keyword">var</span> si = <span class="number">0</span>; si &lt; nsegs; si++) {
        seg = <span class="keyword">this</span>.segs[si];
        slen = seg.length(p); <span class="comment">// segment length</span>
        <span class="keyword">if</span> (distance &lt;= (length + slen)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-225">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-225">&#182;</a>
              </div>
              <p>inside current segment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> segdist = distance - length;
            <span class="keyword">return</span> {
              <span class="string">'seg'</span>: seg, <span class="string">'start'</span>: p, <span class="string">'slen'</span>: slen, <span class="string">'segt'</span>: (slen != <span class="number">0</span>) ? (segdist / slen) : <span class="number">0</span>
            };
        }
        length += slen;</pre></div></div>
            
        </li>
        
        
        <li id="section-226">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-226">&#182;</a>
              </div>
              <p>end point of segment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        p = seg.last();
    };
    <span class="keyword">var</span> lseg = <span class="keyword">this</span>.segs[<span class="keyword">this</span>.segs.length - <span class="number">1</span>];
    <span class="keyword">return</span> {
      <span class="string">'seg'</span>: lseg, <span class="string">'start'</span>: p, <span class="string">'slen'</span>: lseg.length(p), <span class="string">'segt'</span>: <span class="number">1.0</span>
    };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-227">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-227">&#182;</a>
              </div>
              <p>find a point on a path at specified distance (t) of the path (0..1),
a function that transforms the result point (using given start point of
segment and a point on a segment) may be passed</p>
<blockquote>
<p>Path.pointAt % (t: [0..1]) =&gt; Array[Int, 2]</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path.prototype.pointAt = <span class="keyword">function</span>(t) {
    <span class="keyword">var</span> hit = <span class="keyword">this</span>.hitAt(t);
    <span class="keyword">return</span> hit.seg.atT(hit.start, hit.segt);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-228">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-228">&#182;</a>
              </div>
              <p>find a tangent on a path at specified distance (t) of the path (0..1)</p>
<blockquote>
<p>Path.tangentAt % (t: [0..1]) =&gt; Double</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path.prototype.tangentAt = <span class="keyword">function</span>(t) {
    <span class="keyword">var</span> hit = <span class="keyword">this</span>.hitAt(t);
    <span class="keyword">return</span> hit.seg.tangentAt(hit.start, hit.segt);
}
Path.prototype.start = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.segs.length &lt; <span class="number">1</span>) <span class="keyword">return</span> <span class="literal">null</span>;
    <span class="keyword">return</span> [ <span class="keyword">this</span>.segs[<span class="number">0</span>].pts[<span class="number">0</span>],   <span class="comment">// first-x</span>
             <span class="keyword">this</span>.segs[<span class="number">0</span>].pts[<span class="number">1</span>] ]; <span class="comment">// first-y</span>
}
Path.prototype.end = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.segs.length &lt; <span class="number">1</span>) <span class="keyword">return</span> <span class="literal">null</span>;
    <span class="keyword">var</span> lastidx = <span class="keyword">this</span>.segs.length - <span class="number">1</span>;
    <span class="keyword">var</span> s = <span class="keyword">this</span>.segs[lastidx].count; <span class="comment">// size of the last segment</span>
    <span class="keyword">return</span> [ <span class="keyword">this</span>.segs[lastidx].pts[s-<span class="number">2</span>],   <span class="comment">// last-x</span>
             <span class="keyword">this</span>.segs[lastidx].pts[s-<span class="number">1</span>] ]; <span class="comment">// last-y</span>
}
Path.prototype.bounds = <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-229">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <p>FIXME: it is not ok for curve path, possibly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (<span class="keyword">this</span>.segs.length &lt;= <span class="number">0</span>) <span class="keyword">return</span> [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>];
    <span class="keyword">var</span> minX = <span class="keyword">this</span>.segs[<span class="number">0</span>].pts[<span class="number">0</span>], maxX = <span class="keyword">this</span>.segs[<span class="number">0</span>].pts[<span class="number">0</span>],
        minY = <span class="keyword">this</span>.segs[<span class="number">0</span>].pts[<span class="number">1</span>], maxY = <span class="keyword">this</span>.segs[<span class="number">0</span>].pts[<span class="number">1</span>];
    <span class="keyword">this</span>.visit(<span class="keyword">function</span>(segment) {
        <span class="keyword">var</span> pts = segment.pts,
            pnum = pts.length;
        <span class="keyword">for</span> (<span class="keyword">var</span> pi = <span class="number">0</span>; pi &lt; pnum; pi+=<span class="number">2</span>) {
            minX = Math.min(minX, pts[pi]);
            maxX = Math.max(maxX, pts[pi]);
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> pi = <span class="number">1</span>; pi &lt; pnum; pi+=<span class="number">2</span>) {
            minY = Math.min(minY, pts[pi]);
            maxY = Math.max(maxY, pts[pi]);
        }
    });
    <span class="keyword">return</span> [ minX, minY, maxX, maxY ];
}
Path.prototype.dimen = <span class="keyword">function</span>() {
    <span class="keyword">var</span> bounds = <span class="keyword">this</span>.bounds();
    <span class="keyword">return</span> [ bounds[<span class="number">2</span>], bounds[<span class="number">3</span>] ];
}
Path.prototype.rect = <span class="keyword">function</span>() {
    <span class="keyword">var</span> b = <span class="keyword">this</span>.bounds();</pre></div></div>
            
        </li>
        
        
        <li id="section-230">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-230">&#182;</a>
              </div>
              <p>returns clockwise coordinates of the points
for easier drawing
minX, minY, maxX, minY,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> [ b[<span class="number">0</span>], b[<span class="number">1</span>], b[<span class="number">2</span>], b[<span class="number">1</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-231">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-231">&#182;</a>
              </div>
              <p>maxX, maxY, minX, maxY</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>             b[<span class="number">2</span>], b[<span class="number">3</span>], b[<span class="number">0</span>], b[<span class="number">3</span>] ];
}
<span class="comment">/* TODO: rename to `modify`? */</span>
Path.prototype.vpoints = <span class="keyword">function</span>(func) {
    <span class="keyword">this</span>.visit(<span class="keyword">function</span>(segment) {
        <span class="keyword">var</span> pts = segment.pts,
            pnum = pts.length;
        <span class="keyword">for</span> (<span class="keyword">var</span> pi = <span class="number">0</span>; pi &lt; pnum; pi+=<span class="number">2</span>) {
            <span class="keyword">var</span> res = func(pts[pi], pts[pi+<span class="number">1</span>]);
            <span class="keyword">if</span> (res) {
                pts[pi] = res[<span class="number">0</span>];
                pts[pi+<span class="number">1</span>] = res[<span class="number">1</span>];
            }
        }
    });
}
Path.prototype.shift = <span class="keyword">function</span>(pt) {
    <span class="keyword">this</span>.vpoints(<span class="keyword">function</span>(x, y) {
        <span class="keyword">return</span> [ x + pt[<span class="number">0</span>],
                 y + pt[<span class="number">1</span>] ];
    });
};
Path.prototype.zoom = <span class="keyword">function</span>(vals) {
    <span class="keyword">this</span>.vpoints(<span class="keyword">function</span>(x, y) {
        <span class="keyword">return</span> [ x * vals[<span class="number">0</span>],
                 y * vals[<span class="number">1</span>] ];
    });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-232">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-232">&#182;</a>
              </div>
              <p>moves path to be positioned at 0,0 and
returns subtracted top-left point
and a center point</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path.prototype.normalize = <span class="keyword">function</span>() {
    <span class="keyword">var</span> bounds = <span class="keyword">this</span>.bounds();
    <span class="keyword">var</span> w = (bounds[<span class="number">2</span>]-bounds[<span class="number">0</span>]),
        h = (bounds[<span class="number">3</span>]-bounds[<span class="number">1</span>]);
    <span class="keyword">var</span> hw = Math.floor(w/<span class="number">2</span>),
        hh = Math.floor(h/<span class="number">2</span>);
    <span class="keyword">var</span> min_x = bounds[<span class="number">0</span>],
        min_y = bounds[<span class="number">1</span>];
    <span class="keyword">this</span>.vpoints(<span class="keyword">function</span>(x, y) {
        <span class="keyword">return</span> [ x - min_x - hw,
                 y - min_y - hh];
        });
    <span class="keyword">return</span> [ hw, hh ];
}
Path.prototype.getPoints = <span class="keyword">function</span>() {
    <span class="keyword">var</span> points = [];
    <span class="keyword">this</span>.visit(<span class="keyword">function</span>(seg) {
        points = points.concat(seg.pts);
    });
    <span class="keyword">return</span> points;
}
Path.prototype.toString = <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="string">"[ Path '"</span> + Path.toSVGString(<span class="keyword">this</span>) + <span class="string">"' ]"</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-233">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-233">&#182;</a>
              </div>
              <p>not a clone, but only segments-copy</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path.prototype.duplicate = <span class="keyword">function</span>() {
    <span class="keyword">var</span> seg_copy = <span class="keyword">new</span> Path();
    <span class="keyword">this</span>.visit(<span class="keyword">function</span>(seg) {
        seg_copy.add(Path.makeSeg(seg.type, [].concat(seg.pts)));
    });
    <span class="keyword">return</span> seg_copy;
}
Path.prototype.clone = <span class="keyword">function</span>() {
    <span class="keyword">var</span> clone = <span class="keyword">this</span>.duplicate();
    <span class="keyword">if</span> (<span class="keyword">this</span>.stroke) clone.stroke = obj_clone(<span class="keyword">this</span>.stroke);
    <span class="keyword">if</span> (<span class="keyword">this</span>.fill) clone.fill = obj_clone(<span class="keyword">this</span>.fill);
    <span class="keyword">return</span> clone;
}
Path.prototype.dispose = <span class="keyword">function</span>() { }


Path.applyF = <span class="keyword">function</span>(ctx, fill, stroke, shadow, func) {
    ctx.save();
    ctx.beginPath();
    Brush.fill(ctx, fill);
    Brush.stroke(ctx, stroke);
    Brush.shadow(ctx, shadow);
    func();

    <span class="keyword">if</span> (Brush._hasVal(fill)) ctx.fill();
    <span class="keyword">if</span> (Brush._hasVal(stroke)) ctx.stroke();
    ctx.restore();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-234">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-234">&#182;</a>
              </div>
              <p>visits every chunk of path in string-form and calls
visitor function, so visitor function gets
chunk marker and positions sequentially
data argument will be also passed to visitor if specified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path.visitStrPath = <span class="keyword">function</span>(path, visitor, data) {
    <span class="keyword">var</span> cur_pos = <span class="number">0</span>;
    <span class="keyword">while</span> (<span class="literal">true</span>) {
        <span class="keyword">var</span> marker = path[cur_pos];
        <span class="keyword">if</span> (marker === <span class="string">'Z'</span>) {
            visitor(marker, [], data);
            <span class="keyword">return</span>;
        }
        <span class="keyword">var</span> pos_data = <span class="literal">null</span>;
        <span class="keyword">if</span> ((marker === <span class="string">'M'</span>) || (marker === <span class="string">'L'</span>)) {
            pos_data = Path._collectPositions(path, cur_pos, <span class="number">2</span>);
        } <span class="keyword">else</span> <span class="keyword">if</span> (marker === <span class="string">'C'</span>) {
            pos_data = Path._collectPositions(path, cur_pos, <span class="number">6</span>);
        }
        cur_pos += pos_data[<span class="number">0</span>];
        <span class="keyword">var</span> positions = pos_data[<span class="number">1</span>];
        visitor(marker, positions, data);
    }
}
Path.toSVGString = <span class="keyword">function</span>(path) {
    <span class="keyword">var</span> buffer = [];
    path.visit(Path._encodeVisitor, buffer);
    buffer.push(<span class="string">'Z'</span>);
    <span class="keyword">return</span> buffer.join(<span class="string">' '</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-235">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-235">&#182;</a>
              </div>
              <p>parses <code>count</code> positions from path (string form),
starting at <code>start</code>, returns a length of parsed data and
positions array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path._collectPositions = <span class="keyword">function</span>(path, start, count) {
    <span class="keyword">var</span> pos = start + <span class="number">1</span>;
    <span class="keyword">var</span> positions = [];
    <span class="keyword">var</span> got = <span class="number">0</span>;
    <span class="keyword">while</span> (got != count) {
        <span class="keyword">var</span> posstr = __collect_to(path, pos, <span class="string">' '</span>);
        pos += posstr.length + <span class="number">1</span>; got++;
        positions.push(parseFloat(posstr));
    }
    <span class="keyword">return</span> [pos - start, positions];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-236">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p>visitor to parse a string path into Path object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path._parserVisitor = <span class="keyword">function</span>(marker, positions, path) {
    <span class="keyword">if</span> (marker === <span class="string">'M'</span>) {
        path.add(<span class="keyword">new</span> MSeg(positions));
    } <span class="keyword">else</span> <span class="keyword">if</span> (marker === <span class="string">'L'</span>) {
        path.add(<span class="keyword">new</span> LSeg(positions));
    } <span class="keyword">else</span> <span class="keyword">if</span> (marker === <span class="string">'C'</span>) {
        path.add(<span class="keyword">new</span> CSeg(positions));
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-237">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-237">&#182;</a>
              </div>
              <p>visitor to apply string path to context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path._strApplyVisitor = <span class="keyword">function</span>(marker, positions, ctx) {
    <span class="keyword">if</span> (marker === <span class="string">'M'</span>) {
        ctx.moveTo(positions[<span class="number">0</span>], positions[<span class="number">1</span>]);
    } <span class="keyword">else</span> <span class="keyword">if</span> (marker === <span class="string">'L'</span>) {
        ctx.lineTo(positions[<span class="number">0</span>], positions[<span class="number">1</span>]);
    } <span class="keyword">else</span> <span class="keyword">if</span> (marker === <span class="string">'C'</span>) {
        ctx.bezierCurveTo(positions[<span class="number">0</span>], positions[<span class="number">1</span>],
                          positions[<span class="number">2</span>], positions[<span class="number">3</span>],
                          positions[<span class="number">4</span>], positions[<span class="number">5</span>]);
    }
};
Path._applyVisitor = <span class="keyword">function</span>(segment, ctx) {
    <span class="keyword">var</span> type = segment.type;
    <span class="keyword">var</span> positions = segment.pts;
    <span class="keyword">if</span> (type === C.P_MOVETO) {
        ctx.moveTo(positions[<span class="number">0</span>], positions[<span class="number">1</span>]);
    } <span class="keyword">else</span> <span class="keyword">if</span> (type === C.P_LINETO) {
        ctx.lineTo(positions[<span class="number">0</span>], positions[<span class="number">1</span>]);
    } <span class="keyword">else</span> <span class="keyword">if</span> (type === C.P_CURVETO) {
        ctx.bezierCurveTo(positions[<span class="number">0</span>], positions[<span class="number">1</span>],
                          positions[<span class="number">2</span>], positions[<span class="number">3</span>],
                          positions[<span class="number">4</span>], positions[<span class="number">5</span>]);
    }
}
Path._encodeVisitor = <span class="keyword">function</span>(segment, buffer) {
    <span class="keyword">var</span> type = segment.type;
    <span class="keyword">var</span> positions = segment.pts;
    <span class="keyword">if</span> (type === C.P_MOVETO) {
        buffer.push(<span class="string">'M'</span>+positions[<span class="number">0</span>]+<span class="string">' '</span>+positions[<span class="number">1</span>]);
    } <span class="keyword">else</span> <span class="keyword">if</span> (type === C.P_LINETO) {
        buffer.push(<span class="string">'L'</span>+positions[<span class="number">0</span>]+<span class="string">' '</span>+positions[<span class="number">1</span>]);
    } <span class="keyword">else</span> <span class="keyword">if</span> (type === C.P_CURVETO) {
        buffer.push(<span class="string">'C'</span>+positions[<span class="number">0</span>]+<span class="string">' '</span>+positions[<span class="number">1</span>]+<span class="string">' '</span>+
                        positions[<span class="number">2</span>]+<span class="string">' '</span>+positions[<span class="number">3</span>]+<span class="string">' '</span>+
                        positions[<span class="number">4</span>]+<span class="string">' '</span>+positions[<span class="number">5</span>]);
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-238">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-238">&#182;</a>
              </div>
              <p>converts path given in string form to array of segments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path.parse = <span class="keyword">function</span>(path, target) {
    <span class="keyword">var</span> target = target || <span class="keyword">new</span> Path();
    target.segs = [];
    Path.visitStrPath(path, Path._parserVisitor, target);
    target.str = path;
    <span class="keyword">return</span> target;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-239">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-239">&#182;</a>
              </div>
              <p>parses a path in string form and immediately applies it to context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Path.parseAndApply = <span class="keyword">function</span>(ctx, path) {
    Path.visitStrPath(path, Path._strApplyVisitor, ctx);
}
Path.makeSeg = <span class="keyword">function</span>(type, pts) {
    <span class="keyword">if</span> (type === C.P_MOVETO) { <span class="keyword">return</span> <span class="keyword">new</span> MSeg(pts); }
    <span class="keyword">else</span> <span class="keyword">if</span> (type === C.P_LINETO) { <span class="keyword">return</span> <span class="keyword">new</span> LSeg(pts); }
    <span class="keyword">else</span> <span class="keyword">if</span> (type === C.P_CURVETO) { <span class="keyword">return</span> <span class="keyword">new</span> CSeg(pts); }
}

<span class="function"><span class="keyword">function</span> <span class="title">MSeg</span><span class="params">(pts)</span> {</span>
    <span class="keyword">this</span>.type = C.P_MOVETO;
    <span class="keyword">this</span>.pts = pts;
    <span class="keyword">this</span>.count = pts.length;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-240">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-240">&#182;</a>
              </div>
              <blockquote>
<p>MSeg.length(start: Array[Int,2]) =&gt; Double</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>MSeg.prototype.length = <span class="keyword">function</span>(start) {
    <span class="keyword">return</span> <span class="number">0</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-241">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-241">&#182;</a>
              </div>
              <p>distance is specified in points</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>MSeg.prototype.atDist = <span class="keyword">function</span>(start, dist) {
    <span class="keyword">return</span> [ <span class="keyword">this</span>.pts[<span class="number">0</span>], <span class="keyword">this</span>.pts[<span class="number">1</span>] ];
}
MSeg.prototype.atT = <span class="keyword">function</span>(start, t) {
    <span class="keyword">return</span> <span class="keyword">this</span>.atDist(start, <span class="literal">null</span>);
}
MSeg.prototype.tangentAt = <span class="keyword">function</span>(start, t) {
    <span class="keyword">return</span> Math.atan2(<span class="keyword">this</span>.pts[<span class="number">0</span>], <span class="keyword">this</span>.pts[<span class="number">1</span>]);
}
MSeg.prototype.last = <span class="keyword">function</span>() {
    <span class="keyword">return</span> [ <span class="keyword">this</span>.pts[<span class="number">0</span>], <span class="keyword">this</span>.pts[<span class="number">1</span>] ];
}

<span class="function"><span class="keyword">function</span> <span class="title">LSeg</span><span class="params">(pts)</span> {</span>
    <span class="keyword">this</span>.type = C.P_LINETO;
    <span class="keyword">this</span>.pts = pts;
    <span class="keyword">this</span>.count = pts.length;
}
LSeg.prototype.length = <span class="keyword">function</span>(start) {
    <span class="keyword">var</span> dx = <span class="keyword">this</span>.pts[<span class="number">0</span>] - start[<span class="number">0</span>];
    <span class="keyword">var</span> dy = <span class="keyword">this</span>.pts[<span class="number">1</span>] - start[<span class="number">1</span>];
    <span class="keyword">return</span> Math.sqrt(dx*dx + dy*dy);
}
LSeg.prototype.atDist = <span class="keyword">function</span>(start, dist) {
    <span class="keyword">return</span> <span class="keyword">this</span>.atT(start, dist / <span class="keyword">this</span>.length(start));
}
LSeg.prototype.atT = <span class="keyword">function</span>(start, t) {
    <span class="keyword">var</span> p0x = start[<span class="number">0</span>];
    <span class="keyword">var</span> p0y = start[<span class="number">1</span>];
    <span class="keyword">var</span> p1x = <span class="keyword">this</span>.pts[<span class="number">0</span>];
    <span class="keyword">var</span> p1y = <span class="keyword">this</span>.pts[<span class="number">1</span>];
    <span class="keyword">return</span> [
        p0x + (p1x - p0x) * t,
        p0y + (p1y - p0y) * t
    ];
}
LSeg.prototype.tangentAt = <span class="keyword">function</span>(start, t) {
    <span class="keyword">return</span> Math.atan2(<span class="keyword">this</span>.pts[<span class="number">1</span>] - start[<span class="number">1</span>],
                      <span class="keyword">this</span>.pts[<span class="number">0</span>] - start[<span class="number">0</span>]);
}
LSeg.prototype.last = <span class="keyword">function</span>() {
    <span class="keyword">return</span> [ <span class="keyword">this</span>.pts[<span class="number">0</span>], <span class="keyword">this</span>.pts[<span class="number">1</span>] ];
}

<span class="function"><span class="keyword">function</span> <span class="title">CSeg</span><span class="params">(pts)</span> {</span>
    <span class="keyword">this</span>.type = C.P_CURVETO;
    <span class="keyword">this</span>.pts = pts;
    <span class="keyword">this</span>.count = pts.length;
}
CSeg.prototype.length = <span class="keyword">function</span>(start) {
    <span class="comment">/* FIXME: cache length data and points somewhere */</span>
    <span class="keyword">var</span> positions = <span class="keyword">this</span>.pts;
    <span class="keyword">var</span> p0x = start[<span class="number">0</span>];
    <span class="keyword">var</span> p0y = start[<span class="number">1</span>];
    <span class="keyword">var</span> p1x = positions[<span class="number">0</span>];
    <span class="keyword">var</span> p1y = positions[<span class="number">1</span>];
    <span class="keyword">var</span> p2x = positions[<span class="number">2</span>];
    <span class="keyword">var</span> p2y = positions[<span class="number">3</span>];
    <span class="keyword">var</span> p3x = positions[<span class="number">4</span>];
    <span class="keyword">var</span> p3y = positions[<span class="number">5</span>];

    <span class="keyword">var</span> p0to1 = Math.sqrt(Math.pow(p1x-p0x, <span class="number">2</span>) + Math.pow(p1y-p0y, <span class="number">2</span>));
    <span class="keyword">var</span> p1to2 = Math.sqrt(Math.pow(p2x-p1x, <span class="number">2</span>) + Math.pow(p2y-p1y, <span class="number">2</span>));
    <span class="keyword">var</span> p2to3 = Math.sqrt(Math.pow(p3x-p2x, <span class="number">2</span>) + Math.pow(p3y-p2y, <span class="number">2</span>));

    <span class="keyword">var</span> len = p0to1 + p1to2 + p2to3 + <span class="number">1</span>;

    <span class="keyword">var</span> count = len * <span class="number">3</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-242">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-242">&#182;</a>
              </div>
              <p>choose the step as 1/len</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> dt = <span class="number">1.0</span> / len;

    <span class="keyword">var</span> q1 = <span class="number">3</span> * dt;
    <span class="keyword">var</span> q2 = q1 * dt;
    <span class="keyword">var</span> q3 = dt * dt * dt;
    <span class="keyword">var</span> q4 = <span class="number">2</span> * q2;
    <span class="keyword">var</span> q5 = <span class="number">6</span> * q3;

    <span class="keyword">var</span> q6x = p0x - <span class="number">2</span> * p1x + p2x;
    <span class="keyword">var</span> q6y = p0y - <span class="number">2</span> * p1y + p2y;

    <span class="keyword">var</span> q7x = <span class="number">3</span> * (p1x - p2x) - p0x + p3x;
    <span class="keyword">var</span> q7y = <span class="number">3</span> * (p1y - p2y) - p0y + p3y;

    <span class="keyword">var</span> bx = p0x;
    <span class="keyword">var</span> by = p0y;

    <span class="keyword">var</span> dbx = (p1x - p0x) * q1 + q6x * q2 + q3 * q7x;
    <span class="keyword">var</span> dby = (p1y - p0y) * q1 + q6y * q2 + q3 * q7y;

    <span class="keyword">var</span> ddbx = q6x * q4 + q7x * q5;
    <span class="keyword">var</span> ddby = q6y * q4 + q7y * q5;

    <span class="keyword">var</span> dddbx = q7x * q5;
    <span class="keyword">var</span> dddby = q7y * q5;

    <span class="keyword">var</span> length = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> idx = <span class="number">0</span>; idx &lt; count; idx += <span class="number">3</span>) {
        <span class="keyword">var</span> px = bx;
        <span class="keyword">var</span> py = by;

        bx += dbx;
        by += dby;

        dbx += ddbx;
        dby += ddby;

        ddbx += dddbx;
        ddby += dddby;

        length += Math.sqrt((bx - px) * (bx - px) + (by - py) * (by - py));
    }
    <span class="keyword">return</span> length;
}
CSeg.prototype.atDist = <span class="keyword">function</span>(start, dist) {
    <span class="keyword">return</span> <span class="keyword">this</span>.atT(start, dist / <span class="keyword">this</span>.length(start));
}
CSeg.prototype.atT = <span class="keyword">function</span>(start, t) {
    <span class="keyword">var</span> tt = t * t,       <span class="comment">// t^2</span>
        ttt = tt * t,      <span class="comment">// t^3</span>
        t1 = <span class="number">1</span> - t,       <span class="comment">// 1-t</span>
        tt1 = t1 * t1,     <span class="comment">// (1-t)^2</span>
        tt2 = tt1 * t1,    <span class="comment">// (1-t)^3</span>
        tt3 = <span class="number">3</span> * t * tt1,   <span class="comment">// 3*t*(1-t)^2</span>
        tt4 = <span class="number">3</span> * tt * t1;   <span class="comment">// 3*t^2*(1-t)</span>

    <span class="keyword">return</span> [ start[<span class="number">0</span>] * tt2 + <span class="keyword">this</span>.pts[<span class="number">0</span>] * tt3 + <span class="keyword">this</span>.pts[<span class="number">2</span>] * tt4 + <span class="keyword">this</span>.pts[<span class="number">4</span>] * ttt,
             start[<span class="number">1</span>] * tt2 + <span class="keyword">this</span>.pts[<span class="number">1</span>] * tt3 + <span class="keyword">this</span>.pts[<span class="number">3</span>] * tt4 + <span class="keyword">this</span>.pts[<span class="number">5</span>] * ttt ];
}
CSeg.prototype.last = <span class="keyword">function</span>() {
    <span class="keyword">return</span> [ <span class="keyword">this</span>.pts[<span class="number">4</span>], <span class="keyword">this</span>.pts[<span class="number">5</span>] ];
}
CSeg.prototype.tangentAt = <span class="keyword">function</span>(start, t) {
    <span class="keyword">this</span>._ensure_params(start);
    <span class="keyword">var</span> par = <span class="keyword">this</span>._params;
    <span class="keyword">var</span> tt = t * t; <span class="comment">// t^2</span>
    <span class="keyword">var</span> p = [ <span class="number">3</span> * par[<span class="number">0</span>] * tt + <span class="number">2</span> * par[<span class="number">1</span>] * t + par[<span class="number">2</span>],
              <span class="number">3</span> * par[<span class="number">4</span>] * tt + <span class="number">2</span> * par[<span class="number">5</span>] * t + par[<span class="number">6</span>] ];
    <span class="comment">/*var p = this.atT(start, t);*/</span>
    <span class="keyword">return</span> Math.atan2(p[<span class="number">1</span>], p[<span class="number">0</span>]);
}
CSeg.prototype._ensure_params = <span class="keyword">function</span>(start) {
    <span class="keyword">if</span> (<span class="keyword">this</span>._lstart &amp;&amp;
        (<span class="keyword">this</span>._lstart[<span class="number">0</span>] === start[<span class="number">0</span>]) &amp;&amp;
        (<span class="keyword">this</span>._lstart[<span class="number">1</span>] === start[<span class="number">1</span>])) <span class="keyword">return</span>;
    <span class="keyword">this</span>._lstart = start;
    <span class="keyword">this</span>._params = <span class="keyword">this</span>._calc_params(start);
}
CSeg.prototype._calc_params = <span class="keyword">function</span>(start) {</pre></div></div>
            
        </li>
        
        
        <li id="section-243">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-243">&#182;</a>
              </div>
              <p>See <a href="http://www.planetclegg.com/projects/WarpingTextToSplines.html">http://www.planetclegg.com/projects/WarpingTextToSplines.html</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> pts = <span class="keyword">this</span>.pts;
    <span class="keyword">var</span> params = [];
    <span class="keyword">var</span> p0x = start[<span class="number">0</span>];
    <span class="keyword">var</span> p0y = start[<span class="number">1</span>];
    <span class="keyword">var</span> p1x = pts[<span class="number">0</span>];
    <span class="keyword">var</span> p1y = pts[<span class="number">1</span>];
    <span class="keyword">var</span> p2x = pts[<span class="number">2</span>];
    <span class="keyword">var</span> p2y = pts[<span class="number">3</span>];
    <span class="keyword">var</span> p3x = pts[<span class="number">4</span>];
    <span class="keyword">var</span> p3y = pts[<span class="number">5</span>];

    params[<span class="number">0</span>] = p3x - <span class="number">3</span>*p2x + <span class="number">3</span>*p1x - p0x;  <span class="comment">// A = x3 - 3 * x2 + 3 * x1 - x0</span>
    params[<span class="number">1</span>] = <span class="number">3</span>*p2x - <span class="number">6</span>*p1x + <span class="number">3</span>*p0x;      <span class="comment">// B = 3 * x2 - 6 * x1 + 3 * x0</span>
    params[<span class="number">2</span>] = <span class="number">3</span>*p1x - <span class="number">3</span>*p0x;              <span class="comment">// C = 3 * x1 - 3 * x0</span>
    params[<span class="number">3</span>] = p0x;                        <span class="comment">// D = x0</span>

    params[<span class="number">4</span>] = p3y - <span class="number">3</span>*p2y + <span class="number">3</span>*p1y - p0y;  <span class="comment">// E = y3 - 3 * y2 + 3 * y1 - y0</span>
    params[<span class="number">5</span>] = <span class="number">3</span>*p2y - <span class="number">6</span>*p1y + <span class="number">3</span>*p0y;      <span class="comment">// F = 3 * y2 - 6 * y1 + 3 * y0</span>
    params[<span class="number">6</span>] = <span class="number">3</span>*p1y - <span class="number">3</span>*p0y;              <span class="comment">// G = 3 * y1 - 3 * y0</span>
    params[<span class="number">7</span>] = p0y;                        <span class="comment">// H = y0</span>

    <span class="keyword">return</span> params;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-244">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-244">&#182;</a>
              </div>
              <h2>Text</h2>

            </div>
            
        </li>
        
        
        <li id="section-245">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-245">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">Text</span><span class="params">(lines, font,
              fill, stroke, shadow, align, baseline, underlined)</span> {</span>
    <span class="keyword">this</span>.lines = lines;
    <span class="keyword">this</span>.font = font || Text.DEFAULT_FONT;
    <span class="keyword">this</span>.fill = fill || Text.DEFAULT_FILL;
    <span class="keyword">this</span>.stroke = stroke || Text.DEFAULT_STROKE;
    <span class="keyword">this</span>.shadow = shadow;
    <span class="keyword">this</span>.align = align || Text.DEFAULT_ALIGN;
    <span class="keyword">this</span>.baseline = baseline || Text.DEFAULT_BASELINE;
    <span class="keyword">this</span>.underlined = underlined || Text.DEFAULT_UNDERLINE;
    <span class="keyword">this</span>._bnds = <span class="literal">null</span>;
}

Text.DEFAULT_CAP = C.PC_ROUND;
Text.DEFAULT_JOIN = C.PC_ROUND;
Text.DEFAULT_FFACE = <span class="string">'sans-serif'</span>;
Text.DEFAULT_FSIZE = <span class="number">24</span>;
Text.DEFAULT_FONT = Text.DEFAULT_FSIZE + <span class="string">'px '</span> + Text.DEFAULT_FFACE;
Text.DEFAULT_FILL = { <span class="string">'color'</span>: <span class="string">'#000'</span> };
Text.DEFAULT_ALIGN = <span class="string">'left'</span>;
Text.DEFAULT_BASELINE = <span class="string">'bottom'</span>;
Text.DEFAULT_STROKE = <span class="literal">null</span><span class="comment">/*Path.EMPTY_STROKE*/</span>;
Text.DEFAULT_UNDERLINE = <span class="literal">false</span>;

Text.prototype.apply = <span class="keyword">function</span>(ctx, point, baseline) {
    ctx.save();
    <span class="keyword">var</span> point = point || [<span class="number">0</span>, <span class="number">0</span>],
        dimen = <span class="keyword">this</span>.dimen(),
        ascent = <span class="keyword">this</span>.ascent(dimen[<span class="number">1</span>]),
        underlined = <span class="keyword">this</span>.underlined;
    ctx.font = <span class="keyword">this</span>.font;
    ctx.textBaseline = <span class="keyword">this</span>.baseline || Text.DEFAULT_BASELINE;
    ctx.textAlign = <span class="keyword">this</span>.align || Text.DEFAULT_ALIGN;
    ctx.translate(point[<span class="number">0</span>]<span class="comment">/* + (dimen[0] / 2)*/</span>, point[<span class="number">1</span>]);

    <span class="keyword">if</span> (Brush._hasVal(<span class="keyword">this</span>.fill)) {
        Brush.shadow(ctx, <span class="keyword">this</span>.shadow);
        Brush.fill(ctx, <span class="keyword">this</span>.fill);
        ctx.save();
        <span class="keyword">this</span>.visitLines(<span class="keyword">function</span>(line) {
            ctx.fillText(line, <span class="number">0</span>, ascent);
            ctx.translate(<span class="number">0</span>, ascent);
        });
        ctx.restore();
    }
    <span class="keyword">if</span> (Brush._hasVal(<span class="keyword">this</span>.stroke)) {
        Brush.shadow(ctx, <span class="keyword">this</span>.shadow);
        Brush.stroke(ctx, <span class="keyword">this</span>.stroke);
        ctx.save();
        <span class="keyword">this</span>.visitLines(<span class="keyword">function</span>(line) {
            ctx.strokeText(line, <span class="number">0</span>, ascent);
            ctx.translate(<span class="number">0</span>, ascent);
        });
        ctx.restore();
    }
    <span class="keyword">if</span> (underlined) {
        <span class="keyword">var</span> offset = <span class="number">0</span>,
            stroke = <span class="keyword">this</span>.fill,
            me = <span class="keyword">this</span>; <span class="comment">//obj_clone(this.fill);</span>
        ctx.save();
        Brush.stroke(ctx, stroke);
        ctx.lineWidth = <span class="number">1</span>;
        <span class="keyword">this</span>.visitLines(<span class="keyword">function</span>(line) {
            <span class="keyword">var</span> width = me.dimen(line)[<span class="number">0</span>];
            ctx.beginPath();
            ctx.moveTo(<span class="number">0</span>, offset + ascent);
            ctx.lineTo(width, offset + ascent);
            ctx.stroke();

            offset += ascent;
        });
        ctx.restore();
    }
    ctx.restore();
}
Text.prototype.dimen = <span class="keyword">function</span>(lines_arg) {
    <span class="keyword">var</span> has_arg = (<span class="keyword">typeof</span> lines_arg !== <span class="string">'undefined'</span>);
    <span class="keyword">if</span> (!has_arg &amp;&amp; <span class="keyword">this</span>._dimen) <span class="keyword">return</span> <span class="keyword">this</span>._dimen;
    <span class="keyword">if</span> (!Text.__buff) <span class="keyword">throw</span> <span class="keyword">new</span> SysErr(<span class="string">'no Text buffer, bounds call failed'</span>);
    <span class="keyword">var</span> buff = Text.__buff,
        lines = has_arg ? lines_arg : <span class="keyword">this</span>.lines;
    buff.style.font = <span class="keyword">this</span>.font;
    buff.style.textAlign = <span class="keyword">this</span>.align;
    buff.style.verticalAlign = <span class="keyword">this</span>.baseline || Text.DEFAULT_BASELINE;
    <span class="keyword">if</span> (__arr(lines)) {
        buff.textContent = lines.join(<span class="string">'&lt;br/&gt;'</span>);
    } <span class="keyword">else</span> {
        buff.textContent = lines.toString();
    }
    <span class="keyword">return</span> has_arg
           ? [ buff.offsetWidth, buff.offsetHeight ]
           : (<span class="keyword">this</span>._dimen = [ buff.offsetWidth,
                              buff.offsetHeight ]);

}
Text.prototype.bounds = <span class="keyword">function</span>() {
    <span class="keyword">var</span> dimen = <span class="keyword">this</span>.dimen();
    <span class="keyword">return</span> [ <span class="number">0</span>, <span class="number">0</span>, dimen[<span class="number">0</span>], dimen[<span class="number">1</span>] ];
}
Text.prototype.ascent = <span class="keyword">function</span>(height) {
    <span class="keyword">return</span> height; <span class="comment">/* FIXME */</span>
}
Text._createBuffer = <span class="keyword">function</span>() {
    <span class="comment">/* FIXME: dispose buffer when text is removed from scene */</span>
    <span class="keyword">var</span> _div = $doc.createElement(<span class="string">'div'</span>);
    _div.style.visibility = <span class="string">'hidden'</span>;
    _div.style.position = <span class="string">'absolute'</span>;
    _div.style.top = -<span class="number">10000</span> + <span class="string">'px'</span>;
    _div.style.left = -<span class="number">10000</span> + <span class="string">'px'</span>;
    <span class="keyword">var</span> _span = $doc.createElement(<span class="string">'span'</span>);
    _div.appendChild(_span);
    $doc.body.appendChild(_div);
    <span class="keyword">return</span> _span;
}
Text.prototype.cstroke = <span class="keyword">function</span>(color, width, cap, join) {
    <span class="keyword">this</span>.stroke = {
        <span class="string">'width'</span>: (width != <span class="literal">null</span>) ? width : <span class="number">0</span>,
        <span class="string">'color'</span>: color,
        <span class="string">'cap'</span>: cap || Text.DEFAULT_CAP,
        <span class="string">'join'</span>: join || Text.DEFAULT_JOIN
    };
}
Text.prototype.cfill = <span class="keyword">function</span>(color) {
    <span class="keyword">this</span>.fill = {
        <span class="string">'color'</span>: color
    };
}
Text.prototype.visitLines = <span class="keyword">function</span>(func, data) {
    <span class="keyword">var</span> lines = <span class="keyword">this</span>.lines;
    <span class="keyword">if</span> (__arr(lines)) {
        <span class="keyword">var</span> line;
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, ilen = lines.length; i &lt; ilen; i++) {
            line = lines[i];
            func(line, data);
        }
    } <span class="keyword">else</span> {
        func(lines.toString(), data);
    }
}
Text.prototype.clone = <span class="keyword">function</span>() {
    <span class="keyword">var</span> c = <span class="keyword">new</span> Text(<span class="keyword">this</span>.lines, <span class="keyword">this</span>.font,
                     <span class="keyword">this</span>.fill, <span class="keyword">this</span>.stroke, <span class="keyword">this</span>.shadow);
    <span class="keyword">if</span> (<span class="keyword">this</span>.lines &amp;&amp; Array.isArray(<span class="keyword">this</span>.lines)) {
        c.lines = [].concat(<span class="keyword">this</span>.lines);
    }
    <span class="keyword">if</span> (<span class="keyword">this</span>.stroke) c.stroke = obj_clone(<span class="keyword">this</span>.stroke);
    <span class="keyword">if</span> (<span class="keyword">this</span>.fill) c.fill = obj_clone(<span class="keyword">this</span>.fill);
    <span class="keyword">return</span> c;
}
Text.prototype.dispose = <span class="keyword">function</span>() { }
Text._ensureHasBuffer = <span class="keyword">function</span>() {
  <span class="keyword">if</span> (!Text.__buff) Text.__buff = Text._createBuffer();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-246">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-246">&#182;</a>
              </div>
              <h2>Brush</h2>

            </div>
            
        </li>
        
        
        <li id="section-247">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-247">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Brush = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-248">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-248">&#182;</a>
              </div>
              <p>cached creation, returns previous result
if it was already created before</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Brush.create = <span class="keyword">function</span>(ctx, src) {</pre></div></div>
            
        </li>
        
        
        <li id="section-249">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-249">&#182;</a>
              </div>
              <p>FIXME: check if brush is valid color for string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (__str(src)) <span class="keyword">return</span> src;
  <span class="keyword">if</span> (src._style) <span class="keyword">return</span> src._style;
  src._style = Brush._create(ctx, src);
  <span class="keyword">return</span> src._style;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-250">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-250">&#182;</a>
              </div>
              <p>create canvas-compatible style from brush</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Brush._create = <span class="keyword">function</span>(ctx, brush) {
    <span class="keyword">if</span> (brush.color) <span class="keyword">return</span> brush.color;
    <span class="keyword">if</span> (brush.lgrad) {
        <span class="keyword">var</span> src = brush.lgrad,
            stops = src.stops,
            dir = src.dir,
            bounds = src.bounds;
        <span class="keyword">var</span> grad = bounds
            ? ctx.createLinearGradient(
                            bounds[<span class="number">0</span>] + dir[<span class="number">0</span>][<span class="number">0</span>] * bounds[<span class="number">2</span>], <span class="comment">// b.x + x0 * b.width</span>
                            bounds[<span class="number">1</span>] + dir[<span class="number">0</span>][<span class="number">1</span>] * bounds[<span class="number">3</span>], <span class="comment">// b.y + y0 * b.height</span>
                            bounds[<span class="number">0</span>] + dir[<span class="number">1</span>][<span class="number">0</span>] * bounds[<span class="number">2</span>], <span class="comment">// b.x + x1 * b.width</span>
                            bounds[<span class="number">1</span>] + dir[<span class="number">1</span>][<span class="number">1</span>] * bounds[<span class="number">3</span>]) <span class="comment">// b.y + y1 * b.height</span>
            : ctx.createLinearGradient(
                            dir[<span class="number">0</span>][<span class="number">0</span>], dir[<span class="number">0</span>][<span class="number">1</span>],  <span class="comment">// x0, y0</span>
                            dir[<span class="number">1</span>][<span class="number">0</span>], dir[<span class="number">1</span>][<span class="number">1</span>]); <span class="comment">// x1, y1</span>
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, slen = stops.length; i &lt; slen; i++) {
            <span class="keyword">var</span> stop = stops[i];
            grad.addColorStop(stop[<span class="number">0</span>], stop[<span class="number">1</span>]);
        }
        <span class="keyword">return</span> grad;
    }
    <span class="keyword">if</span> (brush.rgrad) {
        <span class="keyword">var</span> src = brush.rgrad,
            stops = src.stops,
            dir = src.dir,
            r = src.r,
            bounds = src.bounds;
        <span class="keyword">var</span> grad = bounds
            ? ctx.createRadialGradient(
                            bounds[<span class="number">0</span>] + dir[<span class="number">0</span>][<span class="number">0</span>] * bounds[<span class="number">2</span>], <span class="comment">// b.x + x0 * b.width</span>
                            bounds[<span class="number">1</span>] + dir[<span class="number">0</span>][<span class="number">1</span>] * bounds[<span class="number">3</span>], <span class="comment">// b.y + y0 * b.height</span>
                            Math.max(bounds[<span class="number">2</span>], bounds[<span class="number">3</span>]) * r[<span class="number">0</span>], <span class="comment">// max(width, height) * r0</span>
                            bounds[<span class="number">0</span>] + dir[<span class="number">1</span>][<span class="number">0</span>] * bounds[<span class="number">2</span>], <span class="comment">// b.x + x1 * b.width</span>
                            bounds[<span class="number">1</span>] + dir[<span class="number">1</span>][<span class="number">1</span>] * bounds[<span class="number">3</span>], <span class="comment">// b.y + y1 * b.height</span>
                            Math.max(bounds[<span class="number">2</span>], bounds[<span class="number">3</span>]) * r[<span class="number">1</span>]) <span class="comment">// max(width, height) * r1</span>
            : ctx.createRadialGradient(
                           dir[<span class="number">0</span>][<span class="number">0</span>], dir[<span class="number">0</span>][<span class="number">1</span>], r[<span class="number">0</span>],  <span class="comment">// x0, y0, r0</span>
                           dir[<span class="number">1</span>][<span class="number">0</span>], dir[<span class="number">1</span>][<span class="number">1</span>], r[<span class="number">1</span>]); <span class="comment">// x1, y1, r1</span>
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, slen = stops.length; i &lt; slen; i++) {
            <span class="keyword">var</span> stop = stops[i];
            grad.addColorStop(stop[<span class="number">0</span>], stop[<span class="number">1</span>]);
        }
        <span class="keyword">return</span> grad;
    }
    <span class="keyword">return</span> <span class="literal">null</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-251">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-251">&#182;</a>
              </div>
              <p>TODO: move to instance methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Brush.stroke = <span class="keyword">function</span>(ctx, stroke) {
    <span class="keyword">if</span> (!stroke) <span class="keyword">return</span>;
    ctx.lineWidth = stroke.width;
    ctx.strokeStyle = Brush.create(ctx, stroke);
    ctx.lineCap = stroke.cap;
    ctx.lineJoin = stroke.join;
}
Brush.fill = <span class="keyword">function</span>(ctx, fill) {
    <span class="keyword">if</span> (!fill) <span class="keyword">return</span>;
    ctx.fillStyle = Brush.create(ctx, fill);
}
Brush.shadow = <span class="keyword">function</span>(ctx, shadow) {
    <span class="keyword">if</span> (!shadow) <span class="keyword">return</span>;
    ctx.shadowColor = shadow.color;
    ctx.shadowBlur = shadow.blurRadius;
    ctx.shadowOffsetX = shadow.offsetX;
    ctx.shadowOffsetY = shadow.offsetY;
}
Brush._hasVal = <span class="keyword">function</span>(fsval) {
    <span class="keyword">return</span> (fsval &amp;&amp; (__str(fsval) || fsval.color || fsval.lgrad || fsval.rgrad));
}</pre></div></div>
            
        </li>
        
        
        <li id="section-252">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-252">&#182;</a>
              </div>
              <h2>Sheet</h2>

            </div>
            
        </li>
        
        
        <li id="section-253">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-253">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>Sheet.instances = <span class="number">0</span>;
<span class="comment">/* TODO: rename to Static and take optional function as source? */</span>
<span class="function"><span class="keyword">function</span> <span class="title">Sheet</span><span class="params">(src, callback, start_region)</span> {</span>
    <span class="keyword">this</span>.id = Sheet.instances++;
    <span class="keyword">this</span>.src = src;
    <span class="keyword">this</span>._dimen = <span class="comment">/*dimen ||*/</span> [<span class="number">0</span>, <span class="number">0</span>];
    <span class="keyword">this</span>.regions = [ [ <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span> ] ]; <span class="comment">// for image, sheet contains just one image</span>
    <span class="keyword">this</span>.regions_f = <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-254">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-254">&#182;</a>
              </div>
              <p>this.aliases = {}; // map of names to regions (or regions ranges)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="comment">/* use state property for region num? or conform with state jumps/positions */</span>
    <span class="comment">/* TODO: rename region to frame */</span>
    <span class="keyword">this</span>.cur_region = start_region || <span class="number">0</span>; <span class="comment">// current region may be changed with modifier</span>
    <span class="keyword">this</span>.ready = <span class="literal">false</span>;
    <span class="keyword">this</span>._image = <span class="literal">null</span>;
    <span class="keyword">this</span>._cvs_cache = <span class="literal">null</span>;
    <span class="keyword">this</span>.load(callback);
}
Sheet.prototype.load = <span class="keyword">function</span>(callback) {
    <span class="keyword">if</span> (<span class="keyword">this</span>._image) <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Already loaded'</span>); <span class="comment">// just skip loading?</span>
    <span class="keyword">var</span> me = <span class="keyword">this</span>;
    _ResMan.loadOrGet(me.src,
        <span class="keyword">function</span>(notify_success, notify_error) { <span class="comment">// loader</span>
            <span class="keyword">var</span> _img = <span class="keyword">new</span> Image();
            _img.onload = <span class="keyword">function</span>() {
                _img.__anm_ready = <span class="literal">true</span>;
                _img.isReady = <span class="literal">true</span>; <span class="comment">/* FIXME: use 'image.complete' and
                                      '...' (network exist) combination,
                                      'complete' fails on Firefox */</span>
                notify_success(_img);
            };
            _img.onerror = notify_error;
            <span class="keyword">try</span> { _img.src = me.src; }
            <span class="keyword">catch</span>(e) { notify_error(e); }
        },
        <span class="keyword">function</span>(image) {  <span class="comment">// oncomplete</span>
            me._image = image;</pre></div></div>
            
        </li>
        
        
        <li id="section-255">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-255">&#182;</a>
              </div>
              <p>if (me.regions.length == 1) me._drawToCache();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            me._dimen = [ image.width, image.height ];
            me.ready = <span class="literal">true</span>;
            me._drawToCache();
            <span class="keyword">if</span> (callback) callback.call(me, image);
        },
        <span class="keyword">function</span>(err) { __anm.console.error(err.message || err); });
}
Sheet.prototype._drawToCache = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.ready) <span class="keyword">return</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>._image.__cvs) {
        <span class="keyword">this</span>._cvs_cache = <span class="keyword">this</span>._image.__cvs;
        <span class="keyword">return</span>;
    }
    <span class="keyword">var</span> _canvas = newCanvas(<span class="keyword">this</span>._dimen, <span class="number">1</span> <span class="comment">/* FIXME: use real ratio */</span>);
    <span class="keyword">var</span> _ctx = _canvas.getContext(<span class="string">'2d'</span>);
    _ctx.drawImage(<span class="keyword">this</span>._image, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>._dimen[<span class="number">0</span>], <span class="keyword">this</span>._dimen[<span class="number">1</span>]);
    <span class="keyword">this</span>._image.__cvs = _canvas;
    <span class="keyword">this</span>._cvs_cache = _canvas;
}
Sheet.prototype.apply = <span class="keyword">function</span>(ctx) {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.ready) <span class="keyword">return</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.cur_region &lt; <span class="number">0</span>) <span class="keyword">return</span>;
    <span class="keyword">var</span> region;
    <span class="keyword">if</span> (<span class="keyword">this</span>.region_f) { region = <span class="keyword">this</span>.region_f(<span class="keyword">this</span>.cur_region); }
    <span class="keyword">else</span> {
        <span class="keyword">var</span> r = <span class="keyword">this</span>.regions[<span class="keyword">this</span>.cur_region],
            d = <span class="keyword">this</span>._dimen;
        region = [ r[<span class="number">0</span>] * d[<span class="number">0</span>], r[<span class="number">1</span>] * d[<span class="number">1</span>],
                   r[<span class="number">2</span>] * d[<span class="number">0</span>], r[<span class="number">3</span>] * d[<span class="number">1</span>] ];
    }
    <span class="keyword">this</span>._active_region = region;
    ctx.drawImage(<span class="keyword">this</span>._cvs_cache, region[<span class="number">0</span>], region[<span class="number">1</span>],
                                   region[<span class="number">2</span>], region[<span class="number">3</span>], <span class="number">0</span>, <span class="number">0</span>, region[<span class="number">2</span>], region[<span class="number">3</span>]);
}
Sheet.prototype.dimen = <span class="keyword">function</span>() {
    <span class="comment">/* if (!this.ready || !this._active_region) return [0, 0];
    var r = this._active_region;
    return [ r[2], r[3] ]; */</span>
    <span class="keyword">return</span> <span class="keyword">this</span>._dimen;
}
Sheet.prototype.bounds = <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-256">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-256">&#182;</a>
              </div>
              <p>TODO: when using current_region, bounds will depend on that region</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (!<span class="keyword">this</span>.ready || !<span class="keyword">this</span>._active_region) <span class="keyword">return</span> [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>];
    <span class="keyword">var</span> r = <span class="keyword">this</span>._active_region;
    <span class="keyword">return</span> [ <span class="number">0</span>, <span class="number">0</span>, r[<span class="number">2</span>], r[<span class="number">3</span>] ];
}
Sheet.prototype.rect = <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-257">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-257">&#182;</a>
              </div>
              <p>TODO: when using current_region, bounds will depend on that region</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Not Implemented. Why?'</span>);
}
Sheet.prototype.clone = <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="keyword">new</span> Sheet(<span class="keyword">this</span>.src);
}
Sheet.prototype.dispose = <span class="keyword">function</span>() {
    <span class="keyword">this</span>._cvs_cache = <span class="literal">null</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-258">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-258">&#182;</a>
              </div>
              <p>TODO: detach, dispose canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> _Image = Sheet; <span class="comment">// Image is the same thing as Sheet, with only one [1, 1] region</span></pre></div></div>
            
        </li>
        
        
        <li id="section-259">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-259">&#182;</a>
              </div>
              <p>it will be exported as <code>Image</code>, but renamed here not to confuse
with browser Image object</p>
<h2>Controls</h2>

            </div>
            
        </li>
        
        
        <li id="section-260">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-260">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">Controls</span><span class="params">(player)</span> {</span>
    <span class="keyword">this</span>.player = player;
    <span class="keyword">this</span>.canvas = <span class="literal">null</span>;
    <span class="keyword">this</span>.ctx = <span class="literal">null</span>;
    <span class="keyword">this</span>.ready = <span class="literal">false</span>;
    <span class="keyword">this</span>.bounds = [];
    <span class="keyword">this</span>.hidden = <span class="literal">false</span>;
    <span class="keyword">this</span>.focused = <span class="literal">false</span>; <span class="comment">// the current button is focused</span>
    <span class="keyword">this</span>.elapsed = <span class="literal">false</span>;
    <span class="keyword">this</span>.theme = <span class="literal">null</span>;
    <span class="keyword">this</span>.info = <span class="literal">null</span>;
    <span class="keyword">this</span>._time = -<span class="number">1000</span>;
    <span class="keyword">this</span>._ratio = <span class="number">1</span>;
    <span class="keyword">this</span>._lhappens = C.NOTHING;
    <span class="keyword">this</span>._initHandlers(); <span class="comment">/* TODO: make automatic */</span>
    <span class="keyword">this</span>._inParent = player.inParent;
}
Controls.DEFAULT_THEME = {
  <span class="string">'font'</span>: {
      <span class="string">'face'</span>: <span class="string">'Arial, sans-serif'</span>,
      <span class="string">'weight'</span>: <span class="string">'bold'</span>,
      <span class="string">'timesize'</span>: <span class="number">27</span>,
      <span class="string">'statussize'</span>: <span class="number">17</span>
  },
  <span class="string">'radius'</span>: { <span class="comment">// all radius values are relative to (Math.min(width, height) / 2)</span>
      <span class="string">'inner'</span>: <span class="number">.25</span>,
      <span class="string">'outer'</span>: <span class="number">.28</span>,
      <span class="string">'buttonv'</span>: <span class="number">.15</span>, <span class="comment">// height of a button</span>
      <span class="string">'buttonh'</span>: <span class="number">.14</span>, <span class="comment">// width of a button</span>
      <span class="string">'time'</span>: <span class="number">.5</span>, <span class="comment">// time text position</span>
      <span class="string">'status'</span>: <span class="number">.8</span>, <span class="comment">// info text position</span>
      <span class="string">'substatus'</span>: <span class="number">.9</span>
  },
  <span class="string">'width'</span>: { <span class="comment">// stroke width</span>
      <span class="string">'inner'</span>: <span class="number">3</span>, <span class="comment">// button stroke</span>
      <span class="string">'outer'</span>: <span class="number">3</span>, <span class="comment">// progress stroke</span>
      <span class="string">'button'</span>: <span class="number">7</span> <span class="comment">// button stroke</span>
  },
  <span class="string">'statuslimit'</span>: <span class="number">40</span>, <span class="comment">// maximum length of status line</span>
  <span class="string">'join'</span>: {
      <span class="string">'button'</span>: <span class="string">'round'</span> <span class="comment">// join for button stroke</span>
  },
  <span class="string">'colors'</span>: {
      <span class="string">'bggrad'</span>: { <span class="comment">// back gradient start is at (0.1 * Math.max(width/height))</span></pre></div></div>
            
        </li>
        
        
        <li id="section-261">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-261">&#182;</a>
              </div>
              <p>and end is at (1.0 * Math.max(width/height))
&#39;start&#39;: &#39;rgba(30,30,30,.7)&#39;,
&#39;end&#39;: &#39;rgba(30,30,30,1)&#39;
&#39;start&#39;: &#39;rgba(30,30,30,.20)&#39;, // fefbf2
&#39;end&#39;: &#39;rgba(30,30,30,.05)&#39; // eae5d8</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="string">'start'</span>: <span class="string">'rgba(234,229,216,.8)'</span>,
          <span class="string">'end'</span>: <span class="string">'rgba(234,229,216,.8)'</span>
      },
      <span class="string">'progress'</span>: {</pre></div></div>
            
        </li>
        
        
        <li id="section-262">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-262">&#182;</a>
              </div>
              <p>&#39;passed&#39;: &#39;rgba(0,0,0,.05)&#39;,
&#39;left&#39;: &#39;rgba(255,255,255,1)&#39;
&#39;passed&#39;: &#39;rgba(50,158,192,.85)&#39;,
&#39;passed&#39;: &#39;rgba(203,86,49,1)&#39;,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="string">'passed'</span>: <span class="string">'rgba(241,91,42,1.0)'</span>,
          <span class="string">'left'</span>: <span class="string">'rgba(255,255,255,1)'</span>
      },</pre></div></div>
            
        </li>
        
        
        <li id="section-263">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-263">&#182;</a>
              </div>
              <p>&#39;button&#39;: &#39;rgba(180,180,180,.85)&#39;,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="string">'button'</span>: <span class="string">'rgba(50,158,192,.85)'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-264">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-264">&#182;</a>
              </div>
              <p>&#39;stroke&#39;: &#39;rgba(180,180,180,.85)&#39;,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="string">'stroke'</span>: <span class="string">'rgba(50,158,192,.85)'</span>,
      <span class="string">'fill'</span>: <span class="string">'rgba(255,255,255,.6)'</span>,
      <span class="string">'hoverfill'</span>: <span class="string">'rgba(255,255,255,.6)'</span>,
      <span class="string">'disabledfill'</span>: <span class="string">'rgba(20,0,0,.2)'</span>,
      <span class="string">'text'</span>: <span class="string">'rgba(90,90,90,.8)'</span>,
      <span class="string">'error'</span>: <span class="string">'rgba(250,0,0,.8)'</span>,
      <span class="string">'infobg'</span>: <span class="string">'rgba(128,0,0,.8)'</span>,
      <span class="string">'secondary'</span>: <span class="string">'rgba(255,255,255,.6)'</span>
  },
  <span class="string">'anmguy'</span>: {
      <span class="string">'colors'</span>: [ <span class="string">'rgba(65,61,62,.9)'</span>, <span class="comment">// black</span>
                  <span class="string">'rgba(241,91,42,.9)'</span> <span class="comment">// orange</span>
                ],
      <span class="string">'center_pos'</span>: [ <span class="number">.5</span>, <span class="number">.8</span> ],
      <span class="string">'corner_pos'</span>: [ <span class="number">.9</span>, <span class="number">.9</span> ],
      <span class="string">'center_alpha'</span>: <span class="number">1</span>,
      <span class="string">'corner_alpha'</span>: <span class="number">.4</span>,
      <span class="string">'scale'</span>: <span class="number">.04</span> <span class="comment">// relatively to minimum side</span>
  }
};
Controls.THEME = Controls.DEFAULT_THEME;
provideEvents(Controls, [C.X_DRAW]);
Controls.prototype.update = <span class="keyword">function</span>(parent) {
    <span class="keyword">var</span> _ratio = parent.__pxRatio,
        _w = parent.width / _ratio,
        _h = parent.height / _ratio,
        _pp = find_pos(parent), <span class="comment">// parent position</span>
        _bp = [ _pp[<span class="number">0</span>] + parent.clientLeft, _pp[<span class="number">1</span>] + parent.clientTop ], <span class="comment">// bounds position</span>
        _cp = <span class="keyword">this</span>._inParent ? [ parent.parentNode.offsetLeft + parent.clientLeft,
                                 parent.parentNode.offsetTop  + parent.clientTop + _hdiff ]
                             : _bp; <span class="comment">// position to set in styles</span>
    <span class="keyword">var</span> _canvas = <span class="keyword">this</span>.canvas;
    <span class="keyword">if</span> (!_canvas) {
        _canvas = newCanvas([ _w, _h ], _ratio);
        <span class="keyword">if</span> (parent.id) { _canvas.id = <span class="string">'__'</span>+parent.id+<span class="string">'_ctrls'</span>; }
        _canvas.className = <span class="string">'anm-controls'</span>;
        _canvas.style.position = <span class="string">'absolute'</span>;
        _canvas.style.opacity = Controls.OPACITY;
        _canvas.style.zIndex = <span class="number">100</span>;
        _canvas.style.cursor = <span class="string">'pointer'</span>;
        _canvas.style.backgroundColor = <span class="string">'rgba(0, 0, 0, 0)'</span>;
        <span class="keyword">this</span>.id = _canvas.id;
        <span class="keyword">this</span>.canvas = _canvas;
        <span class="keyword">this</span>.ctx = _canvas.getContext(<span class="string">'2d'</span>);
        <span class="keyword">this</span>.changeTheme(Controls.THEME);
        <span class="keyword">this</span>.hide();
        <span class="keyword">this</span>.subscribeEvents(_canvas);
    } <span class="keyword">else</span> {
        canvasOpts(_canvas, [ _w, _h ], _ratio);
    }
    _canvas.style.left = _cp[<span class="number">0</span>] + <span class="string">'px'</span>;
    _canvas.style.top = _cp[<span class="number">1</span>] + <span class="string">'px'</span>;
    <span class="keyword">this</span>._ratio = _ratio;
    <span class="keyword">if</span> (!<span class="keyword">this</span>.ready) {
        <span class="keyword">var</span> appendTo = <span class="keyword">this</span>._inParent ? parent.parentNode
                                      : $doc.body;
        <span class="comment">/* FIXME: a dirty hack? */</span>
        <span class="keyword">if</span> (<span class="keyword">this</span>._inParent) { appendTo.style.position = <span class="string">'relative'</span>; }
        appendTo.appendChild(_canvas);
        <span class="keyword">this</span>.ready = <span class="literal">true</span>;
    }
    <span class="keyword">this</span>.page_bounds = [ _bp[<span class="number">0</span>], _bp[<span class="number">1</span>], _bp[<span class="number">0</span>]+_w,
                                         _bp[<span class="number">1</span>]+_h ];
    <span class="keyword">this</span>.bounds = <span class="keyword">this</span>.page_bounds;
    <span class="keyword">if</span> (<span class="keyword">this</span>.info) <span class="keyword">this</span>.info.update(parent);
}
Controls.prototype.subscribeEvents = <span class="keyword">function</span>(canvas<span class="comment">/*, parent*/</span>) {
    <span class="keyword">var</span> player = <span class="keyword">this</span>.player;
    <span class="comment">/* $wnd.addEventListener('scroll', (function(controls) {
            return function(evt) {
                controls.handleAreaChange();
            };
        })(this), false); */</span>
    $wnd.addEventListener(<span class="string">'mousemove'</span>, (<span class="keyword">function</span>(controls) {
            <span class="keyword">return</span> <span class="keyword">function</span>(evt) {
                controls.handleMouseMove(evt.pageX, evt.pageY, evt);
            };
        })(<span class="keyword">this</span>), <span class="literal">false</span>);
    player.canvas.addEventListener(<span class="string">'mouseover'</span>, (<span class="keyword">function</span>(controls) {
            <span class="keyword">return</span> <span class="keyword">function</span>(evt) {
                controls.handleMouseOver();
            };
        })(<span class="keyword">this</span>), <span class="literal">false</span>);
    player.canvas.addEventListener(<span class="string">'click'</span>, (<span class="keyword">function</span>(controls) {
            <span class="keyword">return</span> <span class="keyword">function</span>(evt) {
                controls.handlePlayerClick();
            };
        })(<span class="keyword">this</span>), <span class="literal">false</span>);
    canvas.addEventListener(<span class="string">'mousemove'</span>, (<span class="keyword">function</span>(controls) {
            <span class="keyword">return</span> <span class="keyword">function</span>(evt) {
                controls.handleMouseMove(evt.pageX, evt.pageY, evt);
            };
        })(<span class="keyword">this</span>), <span class="literal">false</span>);
    canvas.addEventListener(<span class="string">'mousedown'</span>, (<span class="keyword">function</span>(controls) {
            <span class="keyword">return</span> <span class="keyword">function</span>(evt) {
                controls.handleClick();
            };
        })(<span class="keyword">this</span>), <span class="literal">false</span>);
    canvas.addEventListener(<span class="string">'mouseout'</span>, (<span class="keyword">function</span>(controls) {
            <span class="keyword">return</span> <span class="keyword">function</span>(evt) {
               controls.handleMouseOut();
            };
        })(<span class="keyword">this</span>), <span class="literal">false</span>);
}
Controls.prototype.render = <span class="keyword">function</span>(time) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.hidden &amp;&amp; !<span class="keyword">this</span>.__force) <span class="keyword">return</span>;

    <span class="keyword">var</span> player = <span class="keyword">this</span>.player,
        state = player.state,
        _s = state.happens;</pre></div></div>
            
        </li>
        
        
        <li id="section-265">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-265">&#182;</a>
              </div>
              <p>if (_s == C.NOTHING) return;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> time = (time &gt; <span class="number">0</span>) ? time : <span class="number">0</span>;
    <span class="keyword">if</span> (!<span class="keyword">this</span>.__force &amp;&amp;
        (time === <span class="keyword">this</span>._time) &amp;&amp;
        (_s === <span class="keyword">this</span>._lhappens)) <span class="keyword">return</span>;
    <span class="keyword">this</span>._time = time;
    <span class="keyword">this</span>._lhappens = _s;

    <span class="keyword">var</span> ctx = <span class="keyword">this</span>.ctx,
        ratio = <span class="keyword">this</span>._ratio, <span class="comment">// pixelRatio (or use this.canvas.__pxRatio?)</span>
        theme = <span class="keyword">this</span>.theme,
        duration = state.duration,
        progress = time / ((duration !== <span class="number">0</span>) ? duration : <span class="number">1</span>);

    <span class="keyword">var</span> _w = (<span class="keyword">this</span>.bounds[<span class="number">2</span>] - <span class="keyword">this</span>.bounds[<span class="number">0</span>]) * ratio,
        _h = (<span class="keyword">this</span>.bounds[<span class="number">3</span>] - <span class="keyword">this</span>.bounds[<span class="number">1</span>]) * ratio;

    ctx.save();</pre></div></div>
            
        </li>
        
        
        <li id="section-266">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-266">&#182;</a>
              </div>
              <p>if (ratio != 1) ctx.scale(ratio, ratio);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, _w, _h);

    <span class="keyword">if</span> (_s === C.PLAYING) {
        <span class="comment">/* Controls._drawBack(ctx, theme, _w, _h, ratio);
        Controls._drawProgress(ctx, theme, _w, _h, ratio, progress);
        Controls._drawPause(ctx, theme, _w, _h, ratio, this.focused);
        if (duration) {
            Controls._drawTime(ctx, theme, _w, _h, ratio, time, duration);
        } */</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (_s === C.STOPPED) {
        Controls._drawBack(ctx, theme, _w, _h, ratio);
        Controls._drawPlay(ctx, theme, _w, _h, ratio, <span class="keyword">this</span>.focused);
    } <span class="keyword">else</span> <span class="keyword">if</span> (_s === C.PAUSED) {
        Controls._drawBack(ctx, theme, _w, _h, ratio);
        Controls._drawProgress(ctx, theme, _w, _h, ratio, progress);
        Controls._drawPlay(ctx, theme, _w, _h, ratio, <span class="keyword">this</span>.focused);
        <span class="keyword">if</span> (duration) {
            Controls._drawTime(ctx, theme, _w, _h, ratio, time, duration);
        }
    } <span class="keyword">else</span> <span class="keyword">if</span> (_s === C.NOTHING) {
        Controls._drawBack(ctx, theme, _w, _h, ratio);
        Controls._drawNoScene(ctx, theme, _w, _h, ratio, <span class="keyword">this</span>.focused);
    } <span class="keyword">else</span> <span class="keyword">if</span> ((_s === C.LOADING) || (_s === C.RES_LOADING)) { <span class="comment">// TODO: show resource loading progress</span>
        Controls._drawBack(ctx, theme, _w, _h, ratio);
        <span class="keyword">var</span> isRemoteLoading = (player._loadTarget === C.LT_URL);
        Controls._drawLoading(ctx, theme, _w, _h, ratio,
                              isRemoteLoading ? (((Date.now() / <span class="number">100</span>) % <span class="number">60</span>) / <span class="number">60</span>) : -<span class="number">1</span>,
                              isRemoteLoading ? <span class="comment">/*player._loadSrc*/</span> <span class="string">'...'</span> : <span class="string">''</span>);
    } <span class="keyword">else</span> <span class="keyword">if</span> (_s === C.ERROR) {
        Controls._drawBack(ctx, theme, _w, _h, ratio);
        Controls._drawError(ctx, theme, _w, _h, ratio, player.__lastError, <span class="keyword">this</span>.focused);
    }

    ctx.restore();
    <span class="keyword">this</span>.fire(C.X_DRAW, state);

    <span class="keyword">this</span>.__force = <span class="literal">false</span>;

    <span class="keyword">if</span> (<span class="keyword">this</span>.info) <span class="keyword">this</span>.info.render();
}
Controls.prototype.react = <span class="keyword">function</span>(time) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.hidden) <span class="keyword">return</span>;

    <span class="keyword">var</span> _p = <span class="keyword">this</span>.player,
        _s = _p.state.happens;
    <span class="keyword">if</span> ((_s === C.NOTHING) || (_s === C.LOADING) || (_s === C.ERROR)) <span class="keyword">return</span>;
    <span class="keyword">if</span> (_s === C.STOPPED) { <span class="comment">/*console.log('play from start');*/</span> _p.play(<span class="number">0</span>); <span class="keyword">return</span>; }
    <span class="keyword">if</span> (_s === C.PAUSED) { <span class="comment">/*console.log('play from ' + this._time);*/</span> _p.play(<span class="keyword">this</span>._time); <span class="keyword">return</span>; }
    <span class="keyword">if</span> (_s === C.PLAYING) { <span class="comment">/*console.log('pause at' + time);*/</span> <span class="keyword">this</span>._time = time; _p.pause(); <span class="keyword">return</span>; }
}
Controls.prototype.refreshByMousePos = <span class="keyword">function</span>(pageX, pageY) {
    <span class="keyword">var</span> state = <span class="keyword">this</span>.player.state,
        _lx = pageX - <span class="keyword">this</span>.bounds[<span class="number">0</span>],
        _ly = pageY - <span class="keyword">this</span>.bounds[<span class="number">1</span>],
        _w = <span class="keyword">this</span>.bounds[<span class="number">2</span>] - <span class="keyword">this</span>.bounds[<span class="number">0</span>],
        _h = <span class="keyword">this</span>.bounds[<span class="number">3</span>] - <span class="keyword">this</span>.bounds[<span class="number">1</span>],
        button_rad = Math.min(_w / <span class="number">2</span>, _h / <span class="number">2</span>) * <span class="keyword">this</span>.theme.radius.inner;
    <span class="keyword">var</span> lfocused = <span class="keyword">this</span>.focused;
    <span class="keyword">this</span>.focused = (_lx &gt;= (_w / <span class="number">2</span>) - button_rad) &amp;&amp;
                   (_lx &lt;= (_w / <span class="number">2</span>) + button_rad) &amp;&amp;
                   (_ly &gt;= (_h / <span class="number">2</span>) - button_rad) &amp;&amp;
                   (_ly &lt;= (_h / <span class="number">2</span>) + button_rad);
    <span class="keyword">if</span> (lfocused !== <span class="keyword">this</span>.focused) {
        <span class="keyword">this</span>.forceNextRedraw();
    }
    <span class="keyword">this</span>.render(state.time);
}
Controls.prototype.handleMouseMove = <span class="keyword">function</span>(pageX, pageY, evt) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.player.mode === C.M_DYNAMIC) <span class="keyword">return</span>;
    <span class="keyword">if</span> (evt) <span class="keyword">this</span>._last_mevt = evt;
    <span class="keyword">if</span> (<span class="keyword">this</span>.inBounds(pageX, pageY) &amp;&amp; (<span class="keyword">this</span>.player.state.happens !== C.PLAYING)) {
        <span class="keyword">this</span>.show();
        <span class="keyword">this</span>.refreshByMousePos(pageX, pageY);
    } <span class="keyword">else</span> {
        <span class="keyword">this</span>.handleMouseOut();
    }
}
Controls.prototype.handleClick = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.player.mode === C.M_DYNAMIC) <span class="keyword">return</span>;
    <span class="keyword">var</span> state = <span class="keyword">this</span>.player.state;
    <span class="keyword">this</span>.forceNextRedraw();
    <span class="keyword">this</span>.react(state.time);
    <span class="keyword">this</span>.render(state.time);
    <span class="keyword">if</span> (state.happens === C.PLAYING) <span class="keyword">this</span>.hide();
}
Controls.prototype.handlePlayerClick = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.player.mode === C.M_DYNAMIC) <span class="keyword">return</span>;
    <span class="keyword">var</span> state = <span class="keyword">this</span>.player.state;
    <span class="keyword">if</span> (state.happens === C.PLAYING) {
        <span class="keyword">this</span>.show();
        <span class="keyword">this</span>.forceNextRedraw();
        <span class="keyword">this</span>.react(state.time);
        <span class="keyword">this</span>.render(state.time);
    }
}
Controls.prototype.handleMouseOver = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.player.mode === C.M_DYNAMIC) <span class="keyword">return</span>;
    <span class="keyword">var</span> state = <span class="keyword">this</span>.player.state;
    <span class="keyword">if</span> (state.happens !== C.PLAYING) {
        <span class="keyword">if</span> (<span class="keyword">this</span>.hidden) <span class="keyword">this</span>.show();
        <span class="keyword">this</span>.forceNextRedraw();
        <span class="keyword">this</span>.render(state.time);
    }
}
Controls.prototype.handleMouseOut = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.player.mode === C.M_DYNAMIC) <span class="keyword">return</span>;
    <span class="keyword">var</span> state = <span class="keyword">this</span>.player.state;
    <span class="keyword">if</span> ((state.happens === C.NOTHING) ||
        (state.happens === C.LOADING) ||
        (state.happens === C.RES_LOADING) ||
        (state.happens === C.ERROR)) {
        <span class="keyword">this</span>.forceNextRedraw();
        <span class="keyword">this</span>.render(state.time);
    } <span class="keyword">else</span> {
        <span class="keyword">this</span>.hide();
    }
}
Controls.prototype.forceRefresh = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.forceNextRedraw();
    <span class="keyword">this</span>.render(<span class="keyword">this</span>.player.state.time);
}
<span class="comment">/* TODO: take initial state from imported project */</span>
Controls.prototype.hide = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.hidden = <span class="literal">true</span>;
    <span class="keyword">this</span>.canvas.style.display = <span class="string">'none'</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.info) <span class="keyword">this</span>.info.hide();
}
Controls.prototype.show = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.hidden = <span class="literal">false</span>;
    <span class="keyword">this</span>.canvas.style.display = <span class="string">'block'</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.info) <span class="keyword">this</span>.info.show();
}
Controls.prototype.reset = <span class="keyword">function</span>() {
    <span class="keyword">this</span>._time = -<span class="number">1000</span>;
    <span class="keyword">this</span>.elapsed = <span class="literal">false</span>;
    <span class="keyword">if</span> (<span class="keyword">this</span>.info) <span class="keyword">this</span>.info.reset();
}
Controls.prototype.detach = <span class="keyword">function</span>(parent) {
    (<span class="keyword">this</span>._inParent ? parent.parentNode
                    : $doc.body).removeChild(<span class="keyword">this</span>.canvas);
    <span class="keyword">if</span> (<span class="keyword">this</span>.info) <span class="keyword">this</span>.info.detach(parent);
}
Controls.prototype.inBounds = <span class="keyword">function</span>(pageX, pageY) {</pre></div></div>
            
        </li>
        
        
        <li id="section-267">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-267">&#182;</a>
              </div>
              <p>if (this.hidden) return false;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> _b = <span class="keyword">this</span>.bounds,
        _ratio = <span class="keyword">this</span>._ratio;
    <span class="keyword">return</span> (pageX &gt;= _b[<span class="number">0</span>]) &amp;&amp;
           (pageX &lt;= _b[<span class="number">2</span>]) &amp;&amp;
           (pageY &gt;= _b[<span class="number">1</span>]) &amp;&amp;
           (pageY &lt;= _b[<span class="number">3</span>]);
}
Controls.prototype.evtInBounds = <span class="keyword">function</span>(evt) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.hidden) <span class="keyword">return</span> <span class="literal">false</span>;
    <span class="keyword">return</span> <span class="keyword">this</span>.inBounds([evt.pageX, evt.pageY]);
}
Controls.prototype.changeTheme = <span class="keyword">function</span>(to) {
    <span class="keyword">this</span>.theme = to;</pre></div></div>
            
        </li>
        
        
        <li id="section-268">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-268">&#182;</a>
              </div>
              <p>TODO: redraw</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}
Controls.prototype.forceNextRedraw = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.__force = <span class="literal">true</span>;
}
Controls.prototype._scheduleLoading = <span class="keyword">function</span>() {
    <span class="keyword">var</span> controls = <span class="keyword">this</span>;
    <span class="keyword">this</span>._loadingInterval = setInterval(<span class="keyword">function</span>() {
         controls.forceNextRedraw();
         controls.render();
    }, <span class="number">50</span>);
}
Controls.prototype._stopLoading = <span class="keyword">function</span>() {
    clearInterval(<span class="keyword">this</span>._loadingInterval);
}
Controls.prototype.enable = <span class="keyword">function</span>() {
    <span class="keyword">var</span> player = <span class="keyword">this</span>.player,
        state = player.state;
    <span class="keyword">this</span>.update(<span class="keyword">this</span>.player.canvas);
    <span class="keyword">if</span> ((state.happens === C.NOTHING) ||
        (state.happens === C.LOADING) ||
        (state.happens === C.RES_LOADING) ||
        (state.happens === C.ERROR)) {
      <span class="keyword">this</span>.show();
      <span class="keyword">this</span>.forceNextRedraw();
      <span class="keyword">this</span>.render();
    }
}
Controls.prototype.disable = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.hide();
    <span class="keyword">this</span>.detach(<span class="keyword">this</span>.canvas);
}
Controls.prototype.enableInfo = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.info) <span class="keyword">this</span>.info = <span class="keyword">new</span> InfoBlock(<span class="keyword">this</span>.player);
    <span class="keyword">this</span>.info.update(<span class="keyword">this</span>.player.canvas);
}
Controls.prototype.disableInfo = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (<span class="keyword">this</span>.info) <span class="keyword">this</span>.info.detach(<span class="keyword">this</span>.player.canvas);
    <span class="comment">/*if (this.info) */</span><span class="keyword">this</span>.info = <span class="literal">null</span>;
}
Controls.prototype.setDuration = <span class="keyword">function</span>(value) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.info) <span class="keyword">this</span>.info.setDuration(value);
}
Controls.prototype.inject = <span class="keyword">function</span>(meta, anim) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.info) <span class="keyword">this</span>.info.inject(meta, anim);
}
Controls._drawBack = <span class="keyword">function</span>(ctx, theme, w, h, ratio) {
    ctx.save();
    <span class="keyword">var</span> cx = w / <span class="number">2</span>,
        cy = h / <span class="number">2</span>;

    <span class="keyword">var</span> grd = ctx.createRadialGradient(cx, cy, <span class="number">0</span>,
                                       cx, cy, Math.max(cx, cy) * <span class="number">1.2</span>);
    grd.addColorStop(<span class="number">.1</span>, theme.colors.bggrad.start);
    grd.addColorStop(<span class="number">1</span>, theme.colors.bggrad.end);

    ctx.fillStyle = grd;
    ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, w, h);

    ctx.restore();
}
Controls._drawProgress = <span class="keyword">function</span>(ctx, theme, w, h, ratio, progress) {
    ctx.save();

    <span class="keyword">var</span> cx = w / <span class="number">2</span>,
        cy = h / <span class="number">2</span>,
        progress_rad = Math.min(cx, cy) * theme.radius.outer;

    ctx.beginPath();
    ctx.arc(cx, cy, progress_rad, (<span class="number">1.5</span> * Math.PI), (<span class="number">1.5</span> * Math.PI) + ((<span class="number">2</span> * Math.PI) * progress));
    ctx.strokeStyle = theme.colors.progress.passed;
    ctx.lineWidth = theme.width.outer;
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(cx, cy, progress_rad, (<span class="number">1.5</span> * Math.PI), (<span class="number">1.5</span> * Math.PI) + ((<span class="number">2</span> * Math.PI) * progress), <span class="literal">true</span>);
    ctx.strokeStyle = theme.colors.progress.left;
    ctx.lineWidth = theme.width.outer;
    ctx.stroke();

    ctx.restore();

}
Controls._drawPause = <span class="keyword">function</span>(ctx, theme, w, h, ratio, focused) {
    ctx.save();

    <span class="keyword">var</span> cx = w / <span class="number">2</span>,
        cy = h / <span class="number">2</span>,
        inner_rad = Math.min(cx, cy) * theme.radius.inner,
        button_width = Math.min(cx, cy) * theme.radius.buttonh,
        button_height = Math.min(cx, cy) * theme.radius.buttonv;

    ctx.beginPath();
    ctx.arc(cx, cy, inner_rad, <span class="number">0</span>, <span class="number">2</span> * Math.PI);
    ctx.fillStyle = focused ? theme.colors.hoverfill : theme.colors.fill;
    ctx.strokeStyle = theme.colors.stroke;
    ctx.lineWidth = theme.width.inner;
    ctx.stroke();
    ctx.fill();

    <span class="keyword">var</span> x = cx - (button_width / <span class="number">2</span>),
        y = cy - (button_height / <span class="number">2</span>),
        bar_width = <span class="number">1</span> / <span class="number">4</span>,
        between = <span class="number">2</span> / <span class="number">4</span>;

    ctx.lineWidth = theme.width.button;
    ctx.lineJoin = theme.join.button;
    ctx.fillStyle = theme.colors.button;
    ctx.strokeStyle = theme.colors.button;
    ctx.strokeRect(x, y, bar_width * button_width, button_height);
    ctx.strokeRect(x + ((bar_width + between) * button_width), y,
                   bar_width * button_width, button_height);
    ctx.fillRect(x, y, bar_width * button_width, button_height);
    ctx.fillRect(x + (bar_width + between) * button_width, y,
                 bar_width * button_width, button_height);

    ctx.restore();

    Controls._drawGuyInCorner(ctx, theme, w, h, ratio);
}
Controls._drawPlay = <span class="keyword">function</span>(ctx, theme, w, h, ratio, focused) {
    ctx.save();

    <span class="keyword">var</span> cx = w / <span class="number">2</span>,
        cy = h / <span class="number">2</span>,
        inner_rad = Math.min(cx, cy) * theme.radius.inner,</pre></div></div>
            
        </li>
        
        
        <li id="section-269">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-269">&#182;</a>
              </div>
              <p>play button should be thinner than standard button</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        button_width = Math.min(cx, cy) * theme.radius.buttonh * <span class="number">0.8</span>,
        button_height = Math.min(cx, cy) * theme.radius.buttonv;

    ctx.beginPath();
    ctx.arc(cx, cy, inner_rad, <span class="number">0</span>, <span class="number">2</span> * Math.PI);
    ctx.fillStyle = focused ? theme.colors.hoverfill : theme.colors.fill;
    ctx.strokeStyle = theme.colors.stroke;
    ctx.lineWidth = theme.width.inner;
    ctx.stroke();
    ctx.fill();</pre></div></div>
            
        </li>
        
        
        <li id="section-270">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-270">&#182;</a>
              </div>
              <p>this way play button &quot;weight&quot; looks more centered</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ctx.translate(button_width / (((button_width &gt; button_height)
                                   ? (button_width / button_height)
                                   : (button_height / button_width)) * <span class="number">4</span>), <span class="number">0</span>);

    ctx.beginPath();
    ctx.moveTo(cx - (button_width / <span class="number">2</span>), cy - (button_height / <span class="number">2</span>));
    ctx.lineTo(cx + (button_width / <span class="number">2</span>), cy);
    ctx.lineTo(cx - (button_width / <span class="number">2</span>), cy + (button_height / <span class="number">2</span>));
    ctx.closePath();
    ctx.lineWidth = theme.width.button;
    ctx.lineJoin = theme.join.button;
    ctx.fillStyle = theme.colors.button;
    ctx.strokeStyle = theme.colors.button;
    ctx.stroke();
    ctx.fill();

    ctx.restore();

    Controls._drawGuyInCorner(ctx, theme, w, h, ratio);
}
Controls._drawLoading = <span class="keyword">function</span>(ctx, theme, w, h, ratio, hilite_pos, src) {
    ctx.save();

    <span class="keyword">var</span> cx = w / <span class="number">2</span>,
        cy = h / <span class="number">2</span>,
        circles = <span class="number">15</span>,
        outer_rad = Math.min(cx, cy) * theme.radius.outer,
        circle_rad = Math.min(cx, cy) / <span class="number">25</span>,
        two_pi = <span class="number">2</span> * Math.PI,
        hilite_idx = Math.ceil(circles * hilite_pos);

    ctx.translate(cx, cy);
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= circles; i++) {
        ctx.beginPath();
        ctx.arc(<span class="number">0</span>, outer_rad, circle_rad, <span class="number">0</span>, two_pi);
        ctx.fillStyle = (i != hilite_idx) ? theme.colors.stroke : theme.colors.text;
        ctx.fill();
        ctx.rotate(two_pi / circles);
    }
    ctx.restore();

    <span class="keyword">if</span> (src) {
        Controls._drawText(ctx, theme,
                     w / <span class="number">2</span>, ((h / <span class="number">2</span>) * (<span class="number">1</span> + theme.radius.status)),
                     theme.font.statussize,
                     ell_text(src, theme.statuslimit));
    } <span class="keyword">else</span> <span class="keyword">if</span> (hilite_pos == -<span class="number">1</span>) {
        Controls._drawText(ctx, theme,
                     w / <span class="number">2</span>, ((h / <span class="number">2</span>) * (<span class="number">1</span> + theme.radius.status)),
                     theme.font.statussize,
                     <span class="string">'...'</span>);
    }

    Controls._drawText(ctx, theme,
                   w / <span class="number">2</span>, ((h / <span class="number">2</span>) * (<span class="number">1</span> + theme.radius.substatus)),
                   theme.font.statussize,
                   Strings.COPYRIGHT);

    Controls._drawGuyInCenter(ctx, theme, w, h, ratio);
}
Controls._drawNoScene = <span class="keyword">function</span>(ctx, theme, w, h, ratio, focused) {
    ctx.save();

    <span class="keyword">var</span> cx = w / <span class="number">2</span>,
        cy = h / <span class="number">2</span>,
        inner_rad = Math.min(cx, cy) * theme.radius.inner,
        button_width = Math.min(cx, cy) * theme.radius.buttonh,
        button_height = Math.min(cx, cy) * theme.radius.buttonv;

    ctx.beginPath();
    ctx.arc(cx, cy, inner_rad, <span class="number">0</span>, <span class="number">2</span> * Math.PI);
    ctx.fillStyle = focused ? theme.colors.disabledfill : theme.colors.fill;
    ctx.strokeStyle = theme.colors.stroke;
    ctx.lineWidth = theme.width.inner;
    ctx.stroke();
    ctx.fill();

    ctx.translate(cx, cy);

    ctx.lineWidth = theme.width.button;
    ctx.lineJoin = theme.join.button;
    ctx.fillStyle = theme.colors.button;
    ctx.strokeStyle = theme.colors.button;
    ctx.rotate(-Math.PI / <span class="number">4</span>);
    ctx.strokeRect(-(button_width / <span class="number">2</span>), -(button_height / <span class="number">8</span>), button_width, button_height / <span class="number">4</span>);
    ctx.fillRect(  -(button_width / <span class="number">2</span>), -(button_height / <span class="number">8</span>), button_width, button_height / <span class="number">4</span>);

    ctx.rotate(<span class="number">2</span> * Math.PI / <span class="number">4</span>);
    ctx.strokeRect(-(button_width / <span class="number">2</span>), -(button_height / <span class="number">8</span>), button_width, button_height / <span class="number">4</span>);
    ctx.fillRect(  -(button_width / <span class="number">2</span>), -(button_height / <span class="number">8</span>), button_width, button_height / <span class="number">4</span>);

    ctx.restore();

    Controls._drawText(ctx, theme,
                   w / <span class="number">2</span>, ((h / <span class="number">2</span>) * (<span class="number">1</span> + theme.radius.status)),
                   theme.font.statussize,
                   Strings.COPYRIGHT);

    Controls._drawGuyInCenter(ctx, theme, w, h, ratio);

}
Controls._drawError = <span class="keyword">function</span>(ctx, theme, w, h, ratio, error, focused) {
    ctx.save();

    <span class="keyword">var</span> cx = w / <span class="number">2</span>,
        cy = h / <span class="number">2</span>,
        inner_rad = Math.min(cx, cy) * theme.radius.inner,
        button_width = Math.min(cx, cy) * theme.radius.buttonh,
        button_height = Math.min(cx, cy) * theme.radius.buttonv;

    ctx.beginPath();
    ctx.arc(cx, cy, inner_rad, <span class="number">0</span>, <span class="number">2</span> * Math.PI);
    ctx.fillStyle = focused ? theme.colors.disabledfill : theme.colors.fill;
    ctx.strokeStyle = theme.colors.stroke;
    ctx.lineWidth = theme.width.inner;
    ctx.stroke();
    ctx.fill();

    ctx.translate(cx, cy);

    ctx.lineWidth = theme.width.button;
    ctx.lineJoin = theme.join.button;
    ctx.fillStyle = theme.colors.error;
    ctx.strokeStyle = theme.colors.error;
    ctx.rotate(-Math.PI / <span class="number">4</span>);
    ctx.strokeRect(-(button_width / <span class="number">2</span>), -(button_height / <span class="number">8</span>), button_width, button_height / <span class="number">4</span>);
    ctx.fillRect(  -(button_width / <span class="number">2</span>), -(button_height / <span class="number">8</span>), button_width, button_height / <span class="number">4</span>);

    ctx.rotate(<span class="number">2</span> * Math.PI / <span class="number">4</span>);
    ctx.strokeRect(-(button_width / <span class="number">2</span>), -(button_height / <span class="number">8</span>), button_width, button_height / <span class="number">4</span>);
    ctx.fillRect(  -(button_width / <span class="number">2</span>), -(button_height / <span class="number">8</span>), button_width, button_height / <span class="number">4</span>);

    ctx.restore();

    Controls._drawText(ctx, theme,
                   w / <span class="number">2</span>, ((h / <span class="number">2</span>) * (<span class="number">1</span> + theme.radius.status)),
                   Math.floor(theme.font.statussize * <span class="number">1.2</span>),
                   (error &amp;&amp; error.message) ? ell_text(error.message, theme.statuslimit)
                                            : error, theme.colors.error);

    Controls._drawText(ctx, theme,
                   w / <span class="number">2</span>, ((h / <span class="number">2</span>) * (<span class="number">1</span> + theme.radius.substatus)),
                   theme.font.statussize,
                   Strings.COPYRIGHT);

    Controls._drawGuyInCenter(ctx, theme, w, h, ratio, [ theme.colors.button,
                                                         theme.colors.error ]);
}
Controls._drawTime = <span class="keyword">function</span>(ctx, theme, w, h, ratio, time, duration) {
    Controls._drawText(ctx, theme,
                       w / <span class="number">2</span>, ((h / <span class="number">2</span>) * (<span class="number">1</span> + theme.radius.time)),
                       theme.font.timesize,
                       fmt_time(time) + <span class="string">' / '</span> + fmt_time(duration));

}
Controls._drawText = <span class="keyword">function</span>(ctx, theme, x, y, size, text, color) {
    ctx.save();
    ctx.font = theme.font.weight + <span class="string">' '</span> + (size || <span class="number">15</span>) + <span class="string">'pt '</span> + theme.font.face;
    ctx.textAlign = <span class="string">'center'</span>;
    ctx.textBaseline = <span class="string">'middle'</span>;
    ctx.fillStyle = color || theme.colors.text;
    ctx.fillText(text, x, y);
    ctx.restore();
}
Controls._drawGuyInCorner = <span class="keyword">function</span>(ctx, theme, w, h, scale, colors) {
    drawAnimatronGuy(ctx, theme.anmguy.corner_pos[<span class="number">0</span>] * w,
                          theme.anmguy.corner_pos[<span class="number">1</span>] * h,
                     scale ? scale * theme.anmguy.scale * Math.min(w, h) : <span class="number">1</span>,
                     colors || theme.anmguy.colors, theme.anmguy.corner_alpha);</pre></div></div>
            
        </li>
        
        
        <li id="section-271">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-271">&#182;</a>
              </div>
              <p>FIXME: place COPYRIGHT text directly under the guy in drawAnimatronGuy function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Controls._drawText(ctx, theme,
                       w * <span class="number">.91</span>, h * <span class="number">.98</span>,
                       theme.font.statussize * <span class="number">.8</span>,
                       Strings.COPYRIGHT, theme.colors.secondary);
}
Controls._drawGuyInCenter = <span class="keyword">function</span>(ctx, theme, w, h, scale, colors) {
    drawAnimatronGuy(ctx, theme.anmguy.center_pos[<span class="number">0</span>] * w,
                          theme.anmguy.center_pos[<span class="number">1</span>] * h,
                     scale ? scale * theme.anmguy.scale * Math.min(w, h) : <span class="number">1</span>,
                     colors || theme.anmguy.colors, theme.anmguy.center_alpha);</pre></div></div>
            
        </li>
        
        
        <li id="section-272">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-272">&#182;</a>
              </div>
              <p>FIXME: place COPYRIGHT text directly under the guy in drawAnimatronGuy function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-273">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-273">&#182;</a>
              </div>
              <h2>Info Block</h2>

            </div>
            
        </li>
        
        
        <li id="section-274">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-274">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">InfoBlock</span><span class="params">(player)</span> {</span>
    <span class="keyword">this</span>.canvas = <span class="literal">null</span>;
    <span class="keyword">this</span>.ctx = <span class="literal">null</span>;
    <span class="keyword">this</span>.ready = <span class="literal">false</span>;
    <span class="keyword">this</span>.hidden = <span class="literal">false</span>;
    <span class="keyword">this</span>._inParent = player.inParent;
    <span class="keyword">this</span>.attached = <span class="literal">false</span>;
}
<span class="comment">/* FIXME: merge Info Block and Controls? */</span>
InfoBlock.BASE_BGCOLOR = Controls.THEME.colors.infobg;
InfoBlock.BASE_FGCOLOR = Controls.THEME.colors.text;
InfoBlock.OPACITY = <span class="number">1</span>;
InfoBlock.PADDING = <span class="number">6</span>;
InfoBlock.MARGIN = <span class="number">5</span>;
InfoBlock.FONT = Controls.THEME.font.face;
InfoBlock.DEFAULT_WIDTH = <span class="number">0</span>;
InfoBlock.DEFAULT_HEIGHT = <span class="number">60</span>;
InfoBlock.prototype.detach = <span class="keyword">function</span>(parent) {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.attached) <span class="keyword">return</span>;
    (<span class="keyword">this</span>._inParent ? parent.parentNode
                    : $doc.body).removeChild(<span class="keyword">this</span>.canvas);
    <span class="keyword">this</span>.attached = <span class="literal">false</span>;
}
InfoBlock.prototype.update = <span class="keyword">function</span>(parent) {
    <span class="keyword">var</span> _ratio = parent.__pxRatio,
        _p = InfoBlock.PADDING,
        _m = InfoBlock.MARGIN,
        _w = InfoBlock.DEFAULT_WIDTH,
        _h = InfoBlock.DEFAULT_HEIGHT - (_p + _p),
        _pp = <span class="keyword">this</span>._inParent ? [ parent.parentNode.offsetLeft + parent.clientLeft,
                                 parent.parentNode.offsetTop + parent.clientTop ]
                             : find_pos(parent),
        _l = _pp[<span class="number">0</span>] + parent.clientLeft + _m,
        _t = _pp[<span class="number">1</span>] + parent.clientTop + _m;
    <span class="keyword">var</span> _canvas = <span class="keyword">this</span>.canvas;
    <span class="keyword">if</span> (!_canvas) {
        _canvas = newCanvas([ _w, _h ], _ratio);
        <span class="keyword">if</span> (parent.id) { _canvas.id = <span class="string">'__'</span>+parent.id+<span class="string">'_info'</span>; }
        _canvas.className = <span class="string">'anm-info'</span>;
        _canvas.style.position = <span class="string">'absolute'</span>;
        _canvas.style.opacity = InfoBlock.OPACITY;
        _canvas.style.zIndex = <span class="number">100</span>;
        _canvas.style.backgroundColor = <span class="string">'rgba(0, 0, 0, 0)'</span>;
        <span class="keyword">this</span>.canvas = _canvas;
        <span class="keyword">this</span>.ctx = _canvas.getContext(<span class="string">'2d'</span>);
        <span class="keyword">this</span>.id = _canvas.id;
        <span class="keyword">this</span>.hide();
        <span class="keyword">this</span>.changeTheme(InfoBlock.BASE_FGCOLOR, InfoBlock.BASE_BGCOLOR);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-275">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-275">&#182;</a>
              </div>
              <p>width and height will be calculated on update</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="comment">/* _canvas.style.width = _w + 'px';
       _canvas.style.height = _h + 'px'; */</span>
    _canvas.style.top = _t + <span class="string">'px'</span>;
    _canvas.style.left = _l + <span class="string">'px'</span>;
    <span class="keyword">this</span>.bounds = [ _l, _t, _l+_w, _t+_h ];
    <span class="keyword">this</span>.canvas = _canvas;
    <span class="keyword">if</span> (!<span class="keyword">this</span>.ready) {
        <span class="keyword">var</span> appendTo = <span class="keyword">this</span>._inParent ? parent.parentNode
                                      : $doc.body;
        <span class="comment">/* FIXME: a dirty hack */</span>
        <span class="keyword">if</span> (<span class="keyword">this</span>._inParent) { appendTo.style.position = <span class="string">'relative'</span>; }
        appendTo.appendChild(_canvas);
        <span class="keyword">this</span>.attached = <span class="literal">true</span>;
        <span class="keyword">this</span>.ready = <span class="literal">true</span>;
    }
    <span class="keyword">this</span>.render();
}
InfoBlock.prototype.render = <span class="keyword">function</span>() {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.__data) <span class="keyword">return</span>;
    <span class="keyword">var</span> meta = <span class="keyword">this</span>.__data[<span class="number">0</span>],
        anim = <span class="keyword">this</span>.__data[<span class="number">1</span>],
        duration = <span class="keyword">this</span>.__data[<span class="number">2</span>] || meta.duration,
        ratio = <span class="keyword">this</span>.canvas.__pxRatio;
    Text._ensureHasBuffer();
    <span class="comment">/* TODO: show speed */</span>
    <span class="keyword">var</span> _tl = <span class="keyword">new</span> Text(meta.title || <span class="string">'[No title]'</span>, <span class="string">'bold '</span> + (<span class="number">14</span> * ratio) + <span class="string">'px '</span> + InfoBlock.FONT, { color: <span class="keyword">this</span>.__fgcolor }),
        _bl = <span class="keyword">new</span> Text((meta.author || <span class="string">'[Unknown]'</span>) + <span class="string">' '</span> + (duration ? (duration + <span class="string">'s'</span>) : <span class="string">'?s'</span>) +
                       <span class="string">' '</span> + (anim.width || <span class="number">0</span>) + <span class="string">'x'</span> + (anim.height || <span class="number">0</span>),
                      (<span class="number">12</span> * ratio) + <span class="string">'px '</span> + InfoBlock.FONT, { color: <span class="keyword">this</span>.__fgcolor }),  <span class="comment">// meta.version, meta.description, meta.copyright</span>
        _p = InfoBlock.PADDING,
        _td = _tl.dimen(),
        _bd = _bl.dimen(),
        _nw = Math.max(_td[<span class="number">0</span>], _bd[<span class="number">0</span>]) + _p + _p,
        _nh = _td[<span class="number">1</span>] + _bd[<span class="number">1</span>] + (_p * <span class="number">3</span>),
        ctx = <span class="keyword">this</span>.ctx;
    canvasOpts(<span class="keyword">this</span>.canvas, [ _nw, _nh ], <span class="keyword">this</span>.canvas.__pxRatio);
    ctx.save();
    ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, _nw, _nh);
    ctx.fillStyle = <span class="keyword">this</span>.__bgcolor;</pre></div></div>
            
        </li>
        
        
        <li id="section-276">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-276">&#182;</a>
              </div>
              <p>Controls.__roundRect(ctx, 0, 0, _nw, _nh, 5);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ctx.fill();
    ctx.fillStyle = <span class="keyword">this</span>.__fgcolor;
    ctx.translate(_p, _p);
    _tl.apply(ctx);
    ctx.globalAlpha = <span class="number">.8</span>;
    ctx.translate(<span class="number">0</span>, _bd[<span class="number">1</span>] + _p * <span class="number">2</span>);
    _bl.apply(ctx);
    ctx.restore();
}
InfoBlock.prototype.inject = <span class="keyword">function</span>(meta, anim, duration) {
    <span class="keyword">this</span>.__data = [ meta, anim, duration || meta.duration ];
    <span class="keyword">if</span> (<span class="keyword">this</span>.ready) <span class="keyword">this</span>.render();
}
InfoBlock.prototype.inBounds = <span class="keyword">function</span>(point) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.hidden || !<span class="keyword">this</span>.bounds) <span class="keyword">return</span> <span class="literal">false</span>;
    <span class="keyword">var</span> _b = <span class="keyword">this</span>.bounds;
    <span class="keyword">return</span> (point[<span class="number">0</span>] &gt;= _b[<span class="number">0</span>]) &amp;&amp;
           (point[<span class="number">0</span>] &lt;= _b[<span class="number">2</span>]) &amp;&amp;
           (point[<span class="number">1</span>] &gt;= _b[<span class="number">1</span>]) &amp;&amp;
           (point[<span class="number">1</span>] &lt;= _b[<span class="number">3</span>]);
}
InfoBlock.prototype.evtInBounds = <span class="keyword">function</span>(evt) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.hidden) <span class="keyword">return</span> <span class="literal">false</span>;
    <span class="keyword">return</span> <span class="keyword">this</span>.inBounds([evt.pageX, evt.pageY]);
}
InfoBlock.prototype.reset = <span class="keyword">function</span>() {

}
InfoBlock.prototype.hide = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.hidden = <span class="literal">true</span>;
    <span class="keyword">this</span>.canvas.style.display = <span class="string">'none'</span>;
}
InfoBlock.prototype.show = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.hidden = <span class="literal">false</span>;
    <span class="keyword">this</span>.canvas.style.display = <span class="string">'block'</span>;
}
InfoBlock.prototype.setDuration = <span class="keyword">function</span>(value) {
    <span class="keyword">if</span> (<span class="keyword">this</span>.__data) <span class="keyword">this</span>.inject(<span class="keyword">this</span>.__data[<span class="number">0</span>], <span class="keyword">this</span>.__data[<span class="number">1</span>], value);
}
InfoBlock.prototype.changeTheme = <span class="keyword">function</span>(front, back) {
    <span class="keyword">this</span>.__fgcolor = front;
    <span class="keyword">this</span>.__bgcolor = back;</pre></div></div>
            
        </li>
        
        
        <li id="section-277">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-277">&#182;</a>
              </div>
              <p>TODO: redraw</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-278">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-278">&#182;</a>
              </div>
              <h2>Strings</h2>

            </div>
            
        </li>
        
        
        <li id="section-279">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-279">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Strings = {};

Strings.COPYRIGHT = <span class="string">'© Animatron Player'</span>;
Strings.LOADING = <span class="string">'Loading...'</span>;
Strings.LOADING_ANIMATION = <span class="string">'Loading {0}...'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-280">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-280">&#182;</a>
              </div>
              <h3>Errors Strings</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/* ------------------ */</span>

<span class="comment">/* TODO: Move Scene and Element errors here */</span>

<span class="keyword">var</span> Errors = {};
Errors.S = {}; <span class="comment">// System Errors</span>
Errors.P = {}; <span class="comment">// Player Errors</span>
Errors.A = {}; <span class="comment">// Animation Errors</span>

Errors.S.NO_JSON_PARSER = <span class="string">'JSON parser is not accessible'</span>;
Errors.S.ERROR_HANDLING_FAILED = <span class="string">'Error-handling mechanics were broken with error {0}'</span>;
Errors.S.NO_METHOD_FOR_PLAYER = <span class="string">'No method \'{0}\' exist for player.'</span>;
Errors.P.NO_IMPORTER_TO_LOAD_WITH = <span class="string">'Cannot load project without importer. Please define it'</span>;
Errors.P.NO_CANVAS_WITH_ID = <span class="string">'No canvas found with given id: {0}'</span>;
Errors.P.NO_CANVAS_WAS_PASSED = <span class="string">'No canvas was passed'</span>;
Errors.P.CANVAS_NOT_PREPARED = <span class="string">'Canvas is not prepared, don\'t forget to call \'init\' method'</span>;
Errors.P.ALREADY_PLAYING = <span class="string">'Player is already in playing mode, please call '</span> +
                           <span class="string">'\'stop\' or \'pause\' before playing again'</span>;
Errors.P.PAUSING_WHEN_STOPPED = <span class="string">'Player is stopped, so it is not allowed to pause'</span>;
Errors.P.NO_SCENE_PASSED = <span class="string">'No scene passed to load method'</span>;
Errors.P.NO_STATE = <span class="string">'There\'s no player state defined, nowhere to draw, '</span> +
                    <span class="string">'please load something in player before '</span> +
                    <span class="string">'calling its playing-related methods'</span>;
Errors.P.NO_SCENE = <span class="string">'There\'s nothing at all to manage with, '</span> +
                    <span class="string">'please load something in player before '</span> +
                    <span class="string">'calling its playing-related methods'</span>;
Errors.P.COULD_NOT_LOAD_WHILE_PLAYING = <span class="string">'Could not load any scene while playing or paused, '</span> +
                    <span class="string">'please stop player before loading'</span>;
Errors.P.BEFOREFRAME_BEFORE_PLAY = <span class="string">'Please assign beforeFrame callback before calling play()'</span>;
Errors.P.AFTERFRAME_BEFORE_PLAY = <span class="string">'Please assign afterFrame callback before calling play()'</span>;
Errors.P.BEFORERENDER_BEFORE_PLAY = <span class="string">'Please assign beforeRender callback before calling play()'</span>;
Errors.P.AFTERRENDER_BEFORE_PLAY = <span class="string">'Please assign afterRender callback before calling play()'</span>;
Errors.P.PASSED_TIME_VALUE_IS_NO_TIME = <span class="string">'Given time is not allowed, it is treated as no-time'</span>;
Errors.P.PASSED_TIME_NOT_IN_RANGE = <span class="string">'Passed time ({0}) is not in scene range'</span>;
Errors.P.DURATION_IS_NOT_KNOWN = <span class="string">'Duration is not known'</span>;
Errors.P.ALREADY_ATTACHED = <span class="string">'Player is already attached to this canvas, please use another one'</span>;
Errors.P.INIT_TWICE = <span class="string">'Initialization was called twice'</span>;
Errors.P.INIT_AFTER_LOAD = <span class="string">'Initialization was called after loading a scene'</span>;
Errors.A.ELEMENT_IS_REGISTERED = <span class="string">'This element is already registered in scene'</span>;
Errors.A.ELEMENT_IS_NOT_REGISTERED = <span class="string">'There is no such element registered in scene'</span>;
Errors.A.UNSAFE_TO_REMOVE = <span class="string">'Unsafe to remove, please use iterator-based looping (with returning false from iterating function) to remove safely'</span>;
Errors.A.NO_ELEMENT_TO_REMOVE = <span class="string">'Please pass some element or use detach() method'</span>;
Errors.A.NO_ELEMENT = <span class="string">'No such element found'</span>;
Errors.A.ELEMENT_NOT_ATTACHED = <span class="string">'Element is not attached to something at all'</span>;
Errors.A.MODIFIER_NOT_ATTACHED = <span class="string">'Modifier wasn\'t applied to anything'</span>;
Errors.A.NO_MODIFIER_PASSED = <span class="string">'No modifier was passed'</span>;
Errors.A.NO_PAINTER_PASSED = <span class="string">'No painter was passed'</span>;
Errors.A.MODIFIER_REGISTERED = <span class="string">'Modifier was already added to this element'</span>;
Errors.A.PAINTER_REGISTERED = <span class="string">'Painter was already added to this element'</span>;
Errors.A.RESOURCES_FAILED_TO_LOAD = <span class="string">'Some of resources required to play this animation were failed to load'</span>;

<span class="keyword">var</span> _anmGuySpec = [
  [ <span class="number">180</span>, <span class="number">278</span> ], <span class="comment">// origin</span>
  [ <span class="number">235</span>, <span class="number">290</span> ], <span class="comment">// dimensions</span>
  [ <span class="string">"rgba(35,31,32,1.0)"</span>,
    <span class="string">"rgba(241,91,42,1.0)"</span> ], <span class="comment">// colors</span>
  [</pre></div></div>
            
        </li>
        
        
        <li id="section-281">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-281">&#182;</a>
              </div>
              <p>before the mask
[ color-id, path ]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [ <span class="number">0</span>, <span class="string">"M206.367 561.864 L210.181 558.724 C228.037 544.497 253.515 532.989 280.474 527.013 C310.171 520.432 331.881 522.276 352.215 531.595 L357.041 534.028 C357.35 534.198 357.661 534.362 357.965 534.536 C358.084 534.603 358.207 534.646 358.333 534.68 L358.358 534.693 C358.38 534.698 358.404 534.697 358.427 534.701 C358.499 534.716 358.572 534.723 358.644 534.726 C358.665 534.727 358.687 534.734 358.708 534.734 C358.718 534.734 358.727 534.729 358.736 534.729 C358.901 534.725 359.061 534.695 359.214 534.639 C359.235 534.631 359.255 534.624 359.275 534.617 C359.427 534.555 359.568 534.468 359.694 534.357 C359.703 534.35 359.713 534.347 359.72 534.34 C359.734 534.327 359.742 534.312 359.755 534.299 C359.812 534.242 359.864 534.182 359.911 534.115 C359.934 534.084 359.958 534.054 359.977 534.022 C359.987 534.005 360.0 533.993 360.01 533.976 C360.042 533.919 360.063 533.859 360.088 533.8 C360.099 533.773 360.113 533.747 360.123 533.719 C360.16 533.612 360.185 533.502 360.197 533.393 C360.199 533.372 360.197 533.352 360.197 533.331 C360.204 533.239 360.202 533.147 360.191 533.057 C360.189 533.042 360.192 533.029 360.19 533.014 C357.081 511.941 353.944 495.52 351.031 482.785 C357.244 479.02 363.189 474.743 368.789 469.964 C393.406 448.956 409.766 419.693 414.851 387.568 C414.984 386.729 414.572 385.898 413.824 385.495 C413.078 385.094 412.154 385.206 411.528 385.778 C411.211 386.068 379.366 414.738 343.77 414.738 C342.291 414.738 340.805 414.687 339.353 414.59 C337.351 414.454 335.324 414.175 333.283 413.779 C331.964 409.499 330.461 404.804 328.77 399.802 C359.392 384.303 365.286 347.489 365.523 345.916 L365.673 344.918 L364.958 344.204 C343.833 323.079 316.491 319.925 302.074 319.925 C297.818 319.925 294.309 320.184 292.346 320.397 C292.057 319.943 291.367 318.531 291.075 318.082 L291.075 318.082 L289.93 318.134 C288.782 318.186 262.998 319.502 240.402 333.108 C240.257 332.844 240.11 332.58 239.97 332.321 C239.519 331.483 238.543 331.077 237.63 331.355 C237.138 331.503 188.319 346.777 182.558 392.748 C179.346 418.379 183.819 442.529 195.154 460.749 C198.743 466.519 202.966 471.691 207.797 476.277 C205.628 493.159 199.308 523.779 199.131 560.445 C199.131 560.448 199.131 560.449 199.131 560.449 C199.103 560.84 199.374 561.582 199.61 561.929 C200.857 563.749 203.878 563.485 206.367 561.864 L206.367 561.864 M329.861 356.921 C337.152 356.921 343.681 355.511 347.423 354.501 C343.397 371.078 329.711 383.191 323.809 387.651 C319.732 376.532 315.353 363.711 309.755 351.798 C315.197 355.032 321.929 356.921 329.861 356.921 L329.861 356.921 M274.473 524.377 C255.607 528.559 237.545 535.219 222.207 543.738 C226.13 536.158 235.429 517.686 244.087 496.592 C250.783 498.607 257.965 500.123 265.665 501.096 C271.15 501.789 276.723 502.14 282.228 502.14 C295.39 502.14 308.416 500.139 320.898 496.304 C330.401 510.462 338.24 520.043 342.222 524.674 C323.029 518.972 299.648 518.8 274.473 524.377 L274.473 524.377 M206.367 561.864 Z"</span> ]
  ], [</pre></div></div>
            
        </li>
        
        
        <li id="section-282">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-282">&#182;</a>
              </div>
              <p>masking</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="string">"M228.106 361.104 L235.292 339.707 C220.431 347.023 207.762 353.681 193.499 382.89 L193.371 383.129 C193.335 383.196 193.081 398.216 215.426 411.593 L217.722 398.247 C213.866 395.442 209.922 392.815 203.684 382.392 L203.684 382.392 L206.09 382.041 C206.795 381.993 223.527 380.653 227.963 361.515 L228.106 361.104 L228.106 361.104 M228.106 361.104 Z"</span>,
    <span class="string">"M335.139 434.771 C330.899 418.584 314.627 362.091 288.434 321.155 C282.932 321.595 258.458 326.742 239.48 337.752 C237.387 342.508 222.985 385.396 214.605 457.106 C223.094 451.426 246.173 437.705 278.306 432.083 C289.482 430.127 298.912 429.177 307.136 429.177 C318.52 429.176 327.736 431.012 335.139 434.771 L335.139 434.771 M335.139 434.771 Z"</span>,
    <span class="string">"M261.669 283.483 C261.122 283.608 260.536 283.529 259.968 283.62 C259.175 283.855 244.69 288.784 240.497 330.304 L252.545 325.896 C252.958 325.746 253.41 325.735 253.829 325.865 C254.189 325.977 262.588 328.605 265.889 329.881 C265.942 329.886 266.001 329.886 266.067 329.886 C268.22 329.886 273.176 328.592 274.266 327.977 C274.929 327.028 277.335 323.153 279.406 319.753 C279.715 319.246 280.233 318.902 280.82 318.815 L287.047 317.888 C283.65 306.582 275.276 280.377 261.669 283.483 L261.669 283.483 M261.669 283.483 Z"</span>
  ],
  [</pre></div></div>
            
        </li>
        
        
        <li id="section-283">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-283">&#182;</a>
              </div>
              <p>after the mask
[ color-id, path ]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    [ <span class="number">0</span>, <span class="string">"M258.16 316.686 L260.482 319.943 C260.531 319.909 265.533 316.427 272.469 316.574 L272.549 312.574 C264.239 312.415 258.404 316.512 258.16 316.686 L258.16 316.686 M258.16 316.686 Z"</span> ],
    [ <span class="number">0</span>, <span class="string">"M291.524 319.015 C290.269 315.412 275.55 278.38 261.669 279.484 C260.863 279.548 259.839 279.603 258.948 279.754 C258.183 279.914 240.364 284.186 236.22 333.101 C236.162 333.782 236.456 334.445 236.999 334.86 C237.353 335.13 237.78 335.27 238.213 335.27 C238.444 335.27 238.677 335.23 238.9 335.148 L253.28 329.887 C255.368 330.545 261.949 332.636 264.544 333.651 C264.954 333.811 265.438 333.886 266.065 333.886 C266.065 333.886 266.065 333.886 266.065 333.886 C268.166 333.886 275.679 332.241 277.179 330.305 C277.858 329.427 281.074 323.856 282.394 321.697 L289.246 321.084 C289.809 321.0 290.95 321.105 291.263 320.63 C291.575 320.151 291.711 319.553 291.524 319.015 L291.524 319.015 M280.818 318.813 C280.231 318.901 279.713 319.245 279.404 319.751 C277.333 323.15 274.927 327.025 274.264 327.975 C273.174 328.59 268.218 329.884 266.065 329.884 C265.999 329.884 265.94 329.884 265.887 329.879 C262.586 328.604 254.187 325.976 253.827 325.863 C253.408 325.733 252.956 325.744 252.543 325.894 L240.495 330.302 C241.15 323.815 242.058 318.233 243.124 313.412 C246.317 310.925 256.071 305.486 274.186 302.326 L272.507 297.31 C256.366 300.166 248.436 303.975 245.019 306.105 C246.927 299.814 249.104 295.257 251.197 291.967 C253.956 288.64 261.686 281.937 265.486 288.565 C266.311 290.004 265.915 293.995 261.883 294.298 C261.883 294.298 271.143 298.247 272.283 289.079 C277.986 295.21 284.709 310.11 287.043 317.884 L280.818 318.813 L280.818 318.813 M291.524 319.015 Z"</span> ],
    [ <span class="number">1</span>, <span class="string">"M232.358 389.656 C232.358 389.656 247.035 382.551 257.026 379.59 L272.548 358.341 L289.591 374.478 C289.591 374.478 302.954 372.629 311.024 374.716 C311.024 374.716 291.608 351.323 279.443 344.346 L261.899 346.255 C256.74 352.255 242.601 369.901 232.358 389.656 L232.358 389.656 M232.358 389.656 Z"</span> ]
  ]
];

<span class="keyword">var</span> anmGuyCanvas,
    anmGuyCtx;
<span class="function"><span class="keyword">function</span> <span class="title">drawAnimatronGuy</span><span class="params">(ctx, x, y, size, colors, opacity)</span> {</span>
    <span class="keyword">var</span> spec = _anmGuySpec,
        origin = spec[<span class="number">0</span>],
        dimensions = spec[<span class="number">1</span>],
        scale = size ? (size / Math.max(dimensions[<span class="number">0</span>], dimensions[<span class="number">1</span>])) : <span class="number">1</span>,
        colors = colors || spec[<span class="number">2</span>],
        shapes_before = spec[<span class="number">3</span>]
        masking_shapes = spec[<span class="number">4</span>],
        shapes_after = spec[<span class="number">5</span>];

    <span class="keyword">var</span> w = dimensions[<span class="number">0</span>] * scale,
        h = dimensions[<span class="number">1</span>] * scale;

    <span class="keyword">if</span> (!anmGuyCanvas) {</pre></div></div>
            
        </li>
        
        
        <li id="section-284">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-284">&#182;</a>
              </div>
              <p>FIXME: change to engine code</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        anmGuyCanvas = newCanvas([ w, h ]);
        anmGuyCtx = anmGuyCanvas.getContext(<span class="string">'2d'</span>);
    } <span class="keyword">else</span> {
        anmGuyCanvas.width = w;
        anmGuyCanvas.height = h;
    }

    <span class="keyword">var</span> maskCanvas = anmGuyCanvas;
    <span class="keyword">var</span> maskCtx = anmGuyCtx;</pre></div></div>
            
        </li>
        
        
        <li id="section-285">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-285">&#182;</a>
              </div>
              <p>prepare</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    maskCtx.clearRect(<span class="number">0</span>, <span class="number">0</span>, w, h);
    <span class="keyword">if</span> (scale != <span class="number">1</span>) maskCtx.scale(scale, scale);
    maskCtx.translate(-origin[<span class="number">0</span>], -origin[<span class="number">1</span>]);
    maskCtx.save();</pre></div></div>
            
        </li>
        
        
        <li id="section-286">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-286">&#182;</a>
              </div>
              <p>draw masked shapes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; shapes_before.length; i++) {
        <span class="keyword">var</span> shape = shapes_before[i],
            fill = colors[shape[<span class="number">0</span>]],
            path = <span class="keyword">new</span> Path(shape[<span class="number">1</span>], fill);

        path.apply(maskCtx);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-287">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-287">&#182;</a>
              </div>
              <p>draw and apply mask</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    maskCtx.save();
    maskCtx.globalCompositeOperation = <span class="string">'destination-out'</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; masking_shapes.length; i++) {
        <span class="keyword">var</span> shape = masking_shapes[i],
            path = <span class="keyword">new</span> Path(shape, <span class="string">'#fff'</span>);

        path.apply(maskCtx);
    }
    maskCtx.restore();</pre></div></div>
            
        </li>
        
        
        <li id="section-288">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-288">&#182;</a>
              </div>
              <p>draw shapes after</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; shapes_after.length; i++) {
        <span class="keyword">var</span> shape = shapes_after[i],
            fill = colors[shape[<span class="number">0</span>]],
            path = <span class="keyword">new</span> Path(shape[<span class="number">1</span>], fill);

        path.apply(maskCtx);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-289">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-289">&#182;</a>
              </div>
              <p>draw over the main context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    maskCtx.restore();

    ctx.save();
    <span class="keyword">if</span> (opacity) ctx.globalAlpha = opacity;
    ctx.drawImage(maskCanvas, x - (w / <span class="number">2</span>), y - (h / <span class="number">2</span>));
    ctx.restore();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-290">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-290">&#182;</a>
              </div>
              <h2>Exports</h2>

            </div>
            
        </li>
        
        
        <li id="section-291">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-291">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">return</span> <span class="keyword">function</span>($trg) {

    <span class="keyword">if</span> (!$trg) $trg = {};

    <span class="keyword">if</span> (!$trg.MODULES)  $trg.MODULES = {};
    <span class="keyword">if</span> (!$trg._globals) $trg._globals = {};

    <span class="function"><span class="keyword">function</span> <span class="title">__createPlayer</span><span class="params">(cvs, opts)</span> {</span> <span class="keyword">var</span> p = <span class="keyword">new</span> Player();
                                         p.init(cvs, opts); <span class="keyword">return</span> p; }

    <span class="keyword">var</span> __globals = {
        <span class="string">'createPlayer'</span>: __createPlayer
    }
    <span class="keyword">for</span> (prop <span class="keyword">in</span> __globals) {
        $trg._globals[prop] = __globals[prop];
        $glob[prop] = __globals[prop];
    }

    <span class="comment">/*$trg.__js_pl_all = this;*/</span>

    $trg.createPlayer = __createPlayer;
    $trg.findById = <span class="keyword">function</span>(where, id) {
        <span class="keyword">var</span> found = [];
        <span class="keyword">if</span> (where.name == name) found.push(name);
        where.travelChildren(<span class="keyword">function</span>(elm)  {
            <span class="keyword">if</span> (elm.id == id) found.push(elm);
        });
        <span class="keyword">return</span> found;
    }
    $trg.findByName = <span class="keyword">function</span>(where, name) {
        <span class="keyword">var</span> found = [];
        <span class="keyword">if</span> (where.name == name) found.push(name);
        where.travelChildren(<span class="keyword">function</span>(elm)  {
            <span class="keyword">if</span> (elm.name == name) found.push(elm);
        });
        <span class="keyword">return</span> found;
    }


    Element.prototype.findByName = <span class="keyword">function</span>(name) {
}
Element.prototype.findById = <span class="keyword">function</span>(id) {
    <span class="keyword">var</span> found = [];
    <span class="keyword">this</span>.travelChildren(<span class="keyword">function</span>(elm)  {
        <span class="keyword">if</span> (elm.id == id) found.push(elm);
    });
    <span class="keyword">return</span> found;
}


    $trg._$ = __createPlayer;

    $trg.C = C; <span class="comment">// constants</span>
    $trg.M = M; <span class="comment">// modules</span>
    $trg.I = I; <span class="comment">// importers</span>
    $trg.Player = Player;
    $trg.Scene = Scene; $trg.Element = Element; $trg.Clip = Clip;
    $trg.Path = Path; $trg.Text = Text; $trg.Sheet = Sheet; $trg.Image = _Image;
    $trg.Tweens = Tweens; $trg.Tween = Tween; $trg.Easing = Easing;
    $trg.MSeg = MSeg; $trg.LSeg = LSeg; $trg.CSeg = CSeg;
    $trg.Render = Render; $trg.Bands = Bands;  <span class="comment">// why Render and Bands classes are visible to pulic?</span>
    $trg.Errors = Errors; $trg.SystemError = SystemError;
                          $trg.PlayerError = PlayerError;
                          $trg.AnimationError = AnimationError;

    $trg.obj_clone = obj_clone; $trg.ajax = ajax;</pre></div></div>
            
        </li>
        
        
        <li id="section-292">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-292">&#182;</a>
              </div>
              <p>TODO: remove duplicates using these typecheck/valuecheck and replace them to __anm.is</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $trg._typecheck = { builder: __builder,
                        arr: __arr,
                        num: __num,
                        obj: __obj,
                        fun: __fun,
                        str: __str };
    $trg._valcheck = { finite: __finite,
                       nan: __nan };
    $trg.__dev = { <span class="string">'_win'</span>: <span class="keyword">function</span>() { <span class="keyword">return</span> $wnd },
                   <span class="string">'_winf'</span>: <span class="keyword">function</span>(w) { $wnd = w; },
                   <span class="string">'strf'</span>: _strf,
                   <span class="string">'adjust'</span>: __adjust,
                   <span class="string">'t_cmp'</span>: __t_cmp,
                   <span class="string">'TIME_PRECISION'</span>: TIME_PRECISION<span class="comment">/*,
                   'Controls': Controls, 'Info': InfoBlock*/</span> };

    <span class="keyword">return</span> $trg;

}

});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
