<!DOCTYPE html>  <html> <head>   <title>player.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="builder.html">                 builder.js               </a>                                           <a class="source" href="player.html">                 player.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               player.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2011-2013 by Animatron.</span>
<span class="cm"> * All rights are reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Animatron player is licensed under the MIT License, see LICENSE.</span>
<span class="cm"> *</span>
<span class="cm"> * @VERSION</span>
<span class="cm"> */</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>Player Core</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>This file contains only the Animatron Player core source code, without <em>Builder</em> or any <em>modules</em>
included. The player is written with as minimum publicily-visible classes as possible, but
its internal structure hides more things, of course. Code in the file goes in
natural order, mostly from general things to internal ones. However, to make
code work properly it is not always possible to keep this principle.</p>

<p>Here I'll give the actual order of things with few notes on each thing to make you have a good <em>view
from above</em>.</p>

<ul>
<li><strong>Utils</strong> —</li>
<li><strong>Constants</strong> —</li>
<li><strong>Modules</strong> —</li>
<li><strong>Player</strong> —
<ul><li><em>Player Control API</em> —</li></ul></li>
<li><strong>Scene</strong> —</li>
<li><strong>Element</strong> —</li>
<li><strong>Import</strong> —</li>
<li><strong>Drawing</strong> —</li>
<li><strong>Custom Rendering</strong> —</li>
<li><strong>Bands</strong> —</li>
<li><strong>Tweens</strong> —</li>
<li><strong>Easings</strong> —</li>
<li><strong>Path</strong> —
<ul><li><em>Segments</em> —</li></ul></li>
<li><strong>Text</strong> —</li>
<li><strong>Controls</strong> —</li>
<li><strong>Info Block</strong> —</li>
<li><strong>Strings</strong> —</li>
<li><strong>Exports</strong> —</li>
</ul>

<blockquote>
  <p>While doing future refactorings, I may change this order a bit accidently or rename some sections and
  forget to update this list (blame me), so please do not consider it to be the very strict
  and representing something more than a general feel of file.</p>
  
  <p>NB: Comments are in very early progress</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>So, let's start</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p><code>anm</code> is a player namespace; the function next to it is just a huge closure which covers the whole file and
is executed immediately after defenition, it allows us to hold all private things inside and to turn
only the considered classes and methods in public. <code>to_export</code> object in the end of the file is the one
that collects public things and returned from closure in the end.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">anm</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>Utils</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h3>Framing</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* ----------- */</span>

<span class="cm">/* http://www.html5canvastutorials.com/advanced/html5-canvas-start-and-stop-an-animation/</span>
<span class="cm">   http://www.w3.org/TR/animation-timing/</span>
<span class="cm">   https://gist.github.com/1579671 */</span>

<span class="kd">var</span> <span class="nx">__frameFunc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
           <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">||</span>
                  <span class="nb">window</span><span class="p">.</span><span class="nx">webkitRequestAnimationFrame</span> <span class="o">||</span>
                  <span class="nb">window</span><span class="p">.</span><span class="nx">mozRequestAnimationFrame</span> <span class="o">||</span>
                  <span class="nb">window</span><span class="p">.</span><span class="nx">oRequestAnimationFrame</span> <span class="o">||</span>
                  <span class="nb">window</span><span class="p">.</span><span class="nx">msRequestAnimationFrame</span> <span class="o">||</span>
                  <span class="nb">window</span><span class="p">.</span><span class="nx">__anm__frameGen</span> <span class="o">||</span>
                  <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">){</span>
                    <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">60</span><span class="p">);</span>
                  <span class="p">}</span> <span class="p">};</span>

<span class="kd">var</span> <span class="nx">__clearFrameFunc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
           <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span> <span class="o">||</span>
                  <span class="nb">window</span><span class="p">.</span><span class="nx">webkitCancelAnimationFrame</span> <span class="o">||</span>
                  <span class="nb">window</span><span class="p">.</span><span class="nx">mozCancelAnimationFrame</span> <span class="o">||</span>
                  <span class="nb">window</span><span class="p">.</span><span class="nx">oCancelAnimationFrame</span> <span class="o">||</span>
                  <span class="nb">window</span><span class="p">.</span><span class="nx">msCancelAnimationFrame</span> <span class="o">||</span>
                  <span class="nb">window</span><span class="p">.</span><span class="nx">__anm__frameRem</span> <span class="o">||</span>
                  <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
                    <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
                  <span class="p">}</span> <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>assigns to call a function on next animation frame</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">__nextFrame</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>stops the animation</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* FIXME: remove, not used, __supressFrames is used */</span>
<span class="kd">var</span> <span class="nx">__stopAnim</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">requestId</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">__clearFrameFunc</span><span class="p">()(</span><span class="nx">requestId</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h3>Errors</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* ---------- */</span>

<span class="kd">var</span> <span class="nx">SystemError</span> <span class="o">=</span> <span class="nx">__errorAs</span><span class="p">(</span><span class="s1">&#39;SystemError&#39;</span><span class="p">,</span>
                            <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">msg</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="p">});</span>
<span class="kd">var</span> <span class="nx">SysErr</span> <span class="o">=</span> <span class="nx">SystemError</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">PlayerError</span> <span class="o">=</span> <span class="nx">__errorAs</span><span class="p">(</span><span class="s1">&#39;PlayerError&#39;</span><span class="p">,</span>
                            <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">msg</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="p">});</span>
<span class="kd">var</span> <span class="nx">PlayerErr</span> <span class="o">=</span> <span class="nx">PlayerError</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">AnimationError</span> <span class="o">=</span> <span class="nx">__errorAs</span><span class="p">(</span><span class="s1">&#39;AnimationError&#39;</span><span class="p">,</span>
                               <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">msg</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="p">});</span>
<span class="kd">var</span> <span class="nx">AnimErr</span> <span class="o">=</span> <span class="nx">AnimationError</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h3>Internal utilities</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* ---------------------- */</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>collects all characters from string
before specified char, starting from start</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">__collect_to</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">ch</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">start</span><span class="p">;</span> <span class="nx">str</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">ch</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">SysErr</span><span class="p">(</span><span class="s1">&#39;Reached end of string&#39;</span><span class="p">);</span>
        <span class="nx">result</span> <span class="o">+=</span> <span class="nx">str</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">guid</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span>
          <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*function _strhash() {</span>
<span class="cm">  var hash = 0;</span>
<span class="cm">  if (this.length == 0) return hash;</span>
<span class="cm">  for (i = 0; i &lt; this.length; i++) {</span>
<span class="cm">    char = this.charCodeAt(i);</span>
<span class="cm">    hash = ((hash&lt;&lt;5)-hash)+char;</span>
<span class="cm">    hash = hash &amp; hash; // Convert to 32bit integer</span>
<span class="cm">  }</span>
<span class="cm">  return hash;</span>
<span class="cm">}*/</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h3>Arrays</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* ---------- */</span>

<span class="kd">function</span> <span class="nx">StopIteration</span><span class="p">()</span> <span class="p">{}</span>

<span class="kd">function</span> <span class="nx">iter</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">__iter</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">__iter</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">__iter</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">len</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">__iter</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">next</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">)</span> <span class="k">return</span> <span class="nx">a</span><span class="p">[</span><span class="nx">pos</span><span class="o">++</span><span class="p">];</span>
                  <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="k">throw</span> <span class="k">new</span> <span class="nx">StopIteration</span><span class="p">();</span>
              <span class="p">},</span>
        <span class="nx">hasNext</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">);</span> <span class="p">},</span>
        <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">len</span><span class="o">--</span><span class="p">;</span> <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="o">--</span><span class="nx">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="p">},</span>
        <span class="nx">reset</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="p">},</span>
        <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span><span class="p">[</span><span class="nx">pos</span><span class="p">];</span> <span class="p">},</span>
        <span class="nx">each</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">rf</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
                  <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasNext</span><span class="p">())</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">rf</span><span class="p">)</span> <span class="nx">rf</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">());</span> <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
                    <span class="p">}</span>
                  <span class="p">}</span>
              <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h3>DOM</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* ------- */</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>for one-level objects, so no hasOwnProperty check</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">obj_clone</span><span class="p">(</span><span class="nx">what</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">dest</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">what</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">dest</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">what</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">dest</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME: replace with elm.getBoundingClientRect();</span>
<span class="cm">   see http://stackoverflow.com/questions/8070639/find-elements-position-in-browser-scroll */</span>
<span class="kd">function</span> <span class="nx">find_pos</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">curleft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">curtop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="nx">curleft</span> <span class="o">+=</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="cm">/* - elm.scrollLeft*/</span><span class="p">;</span>
        <span class="nx">curtop</span> <span class="o">+=</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">offsetTop</span><span class="cm">/* - elm.scrollTop*/</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">elm</span> <span class="o">=</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">[</span> <span class="nx">curleft</span><span class="p">,</span> <span class="nx">curtop</span> <span class="p">];</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h3>AJAX</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* -------- */</span>

<span class="kd">function</span> <span class="nx">ajax</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="cm">/*, errback*/</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s2">&quot;Msxml2.XMLHTTP&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s2">&quot;Microsoft.XMLHTTP&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e2</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">SysErr</span><span class="p">(</span><span class="s1">&#39;No AJAX/XMLHttp support&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/*if (req.overrideMimeType) {</span>
<span class="cm">        req.overrideMimeType(&#39;text/xml&#39;);</span>
<span class="cm">      } */</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">SysErr</span><span class="p">(</span><span class="s1">&#39;Failed to create XMLHttp instance&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">whenDone</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">SysErr</span><span class="p">(</span><span class="s1">&#39;AJAX request for &#39;</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span>
                                 <span class="s1">&#39; returned &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">+</span>
                                 <span class="s1">&#39; instead of 200&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">whenDone</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h3>Canvas-related Utilities</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* ---------------------------- */</span>

<span class="kd">function</span> <span class="nx">getPxRatio</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">devicePixelRatio</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>

<span class="kd">var</span> <span class="nx">DEF_CNVS_WIDTH</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">DEF_CNVS_HEIGHT</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">DEF_CNVS_BG</span> <span class="o">=</span> <span class="s1">&#39;#fff&#39;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">canvasOpts</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">ratio</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">isObj</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="nx">opts</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">),</span>
        <span class="nx">_w</span> <span class="o">=</span> <span class="nx">isObj</span> <span class="o">?</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">width</span> <span class="o">:</span> <span class="nx">opts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">_h</span> <span class="o">=</span> <span class="nx">isObj</span> <span class="o">?</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">height</span> <span class="o">:</span> <span class="nx">opts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">bgfill</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* TODO: support other fill types */</span>
            <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">bgfill</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">__pxRatio</span> <span class="o">=</span> <span class="nx">ratio</span><span class="p">;</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">_w</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">_h</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="nx">_w</span> <span class="o">*</span> <span class="p">(</span><span class="nx">ratio</span> <span class="o">||</span> <span class="mi">1</span><span class="p">));</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="nx">_h</span> <span class="o">*</span> <span class="p">(</span><span class="nx">ratio</span> <span class="o">||</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">newCanvas</span><span class="p">(</span><span class="nx">dimen</span><span class="p">,</span> <span class="nx">ratio</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">);</span>
    <span class="nx">canvasOpts</span><span class="p">(</span><span class="nx">_canvas</span><span class="p">,</span> <span class="nx">dimen</span><span class="p">,</span> <span class="nx">ratio</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">_canvas</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">prepareImage</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">anm</span><span class="p">.</span><span class="nx">cache</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">anm</span><span class="p">.</span><span class="nx">cache</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">anm</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">loader</span> <span class="o">=</span> <span class="p">{</span><span class="nx">image</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">(),</span> <span class="nx">callbacks</span><span class="o">:</span><span class="p">[]};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
        <span class="nx">anm</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="nx">loader</span><span class="p">;</span>
        <span class="nx">loader</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">anm</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">url</span><span class="p">].</span><span class="nx">image</span><span class="p">.</span><span class="nx">isReady</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">loader</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">self</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">loader</span><span class="p">.</span><span class="nx">callbacks</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">anm</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">url</span><span class="p">].</span><span class="nx">image</span><span class="p">.</span><span class="nx">isReady</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">anm</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">url</span><span class="p">].</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">anm</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">url</span><span class="p">].</span><span class="nx">image</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h3>Internal Helpers</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* -------------------- */</span>

<span class="kd">function</span> <span class="nx">__builder</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">Builder</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
           <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Builder</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">__array</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">__num</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="nb">isFinite</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">__obj</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">obj</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">__close</span><span class="p">(</span><span class="nx">n1</span><span class="p">,</span> <span class="nx">n2</span><span class="p">,</span> <span class="nx">precision</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">precision</span> <span class="o">===</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">precision</span> <span class="o">=</span> <span class="nx">precision</span> <span class="o">||</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">multiplier</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nx">precision</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">n1</span> <span class="o">*</span> <span class="nx">multiplier</span><span class="p">)</span> <span class="o">==</span>
           <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">n2</span> <span class="o">*</span> <span class="nx">multiplier</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">__roundTo</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">precision</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">precision</span><span class="p">)</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>return n.toPrecision(precision);</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">multiplier</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nx">precision</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">n</span> <span class="o">*</span> <span class="nx">multiplier</span><span class="p">)</span> <span class="o">/</span> <span class="nx">multiplier</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">__errorAs</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">_constructor</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/* var _constructor = function(msg) { this.message = msg; } */</span>
  <span class="nx">_constructor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">();</span>
  <span class="cm">/* _constructor.prototype.constructor = _constructor; */</span>
  <span class="nx">_constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">;</span>
  <span class="nx">_constructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">name</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">?</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">);</span> <span class="p">}</span>
  <span class="k">return</span> <span class="nx">_constructor</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">_strf</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">subst</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">subst</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/{(\d+)}/g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="nx">number</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span>
      <span class="o">?</span> <span class="nx">args</span><span class="p">[</span><span class="nx">number</span><span class="p">]</span>
      <span class="o">:</span> <span class="nx">match</span>
    <span class="p">;</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">mrg_obj</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">backup</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">prop</span> <span class="k">in</span> <span class="nx">backup</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">src</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">src</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">:</span> <span class="nx">backup</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span> <span class="p">};</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">trashBin</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">disposeElm</span><span class="p">(</span><span class="nx">domElm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">trashBin</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">trashBin</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
        <span class="nx">trashBin</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;trash-bin&#39;</span><span class="p">;</span>
        <span class="nx">trashBin</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">trashBin</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">trashBin</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">domElm</span><span class="p">);</span>
    <span class="nx">trashBin</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h2>Internal Constants</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">TIME_PRECISION</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="c1">// the number of digits after the floating point</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>to round the time when comparing with bands and so on;
used to get rid of floating point-conversion issues</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">__adjust</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">__roundTo</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">TIME_PRECISION</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">__t_cmp</span><span class="p">(</span><span class="nx">t0</span><span class="p">,</span> <span class="nx">t1</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__adjust</span><span class="p">(</span><span class="nx">t0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">__adjust</span><span class="p">(</span><span class="nx">t1</span><span class="p">))</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">__adjust</span><span class="p">(</span><span class="nx">t0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">__adjust</span><span class="p">(</span><span class="nx">t1</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h2>Constants</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">C</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <h3>Player states</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* ----------------- */</span>

<span class="nx">C</span><span class="p">.</span><span class="nx">NOTHING</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">STOPPED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">PLAYING</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">PAUSED</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>public constants below are also appended to C object, but with <code>X_</code>-like prefix
to indicate their scope, see through all file</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <h3>Player Modes constants</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* -------------------------- */</span>

<span class="nx">C</span><span class="p">.</span><span class="nx">M_CONTROLS_DISABLED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">M_CONTROLS_ENABLED</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">M_INFO_DISABLED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">M_INFO_ENABLED</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">M_DO_NOT_HANDLE_EVENTS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">M_HANDLE_EVENTS</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">M_DO_NOT_DRAW_STILL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">M_DRAW_STILL</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">M_PREVIEW</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_CONTROLS_DISABLED</span>
              <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_INFO_DISABLED</span>
              <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_DO_NOT_HANDLE_EVENTS</span>
              <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_DO_NOT_DRAW_STILL</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">M_DYNAMIC</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_CONTROLS_DISABLED</span>
              <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_INFO_DISABLED</span>
              <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_HANDLE_EVENTS</span>
              <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_DO_NOT_DRAW_STILL</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">M_VIDEO</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_CONTROLS_ENABLED</span>
            <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_INFO_ENABLED</span>
            <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_DO_NOT_HANDLE_EVENTS</span>
            <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_DRAW_STILL</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h3>Events</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* ---------- */</span>

<span class="nx">C</span><span class="p">.</span><span class="nx">__enmap</span> <span class="o">=</span> <span class="p">{};</span>

<span class="kd">function</span> <span class="nx">__reg_event</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">C</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="nx">C</span><span class="p">.</span><span class="nx">__enmap</span><span class="p">[</span><span class="nx">value</span><span class="p">]</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>NB: All of the events must have different values, or the flow will be broken</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <ul>
<li>mouse</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;X_MCLICK&#39;</span><span class="p">,</span> <span class="s1">&#39;mclick&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;X_MDCLICK&#39;</span><span class="p">,</span> <span class="s1">&#39;mdclick&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;X_MUP&#39;</span><span class="p">,</span> <span class="s1">&#39;mup&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;X_MDOWN&#39;</span><span class="p">,</span> <span class="s1">&#39;mdown&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;X_MMOVE&#39;</span><span class="p">,</span> <span class="s1">&#39;mmove&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
<span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;X_MOVER&#39;</span><span class="p">,</span> <span class="s1">&#39;mover&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
<span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;X_MOUT&#39;</span><span class="p">,</span> <span class="s1">&#39;mout&#39;</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

<span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;XT_MOUSE&#39;</span><span class="p">,</span> <span class="s1">&#39;mouse&#39;</span><span class="p">,</span>
  <span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_MCLICK</span> <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MDCLICK</span> <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MUP</span> <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MDOWN</span> <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MMOVE</span> <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MOVER</span> <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MOUT</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <ul>
<li>keyboard</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;X_KPRESS&#39;</span><span class="p">,</span> <span class="s1">&#39;kpress&#39;</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
<span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;X_KUP&#39;</span><span class="p">,</span> <span class="s1">&#39;kup&#39;</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
<span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;X_KDOWN&#39;</span><span class="p">,</span> <span class="s1">&#39;kdown&#39;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>

<span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;XT_KEYBOARD&#39;</span><span class="p">,</span> <span class="s1">&#39;keyboard&#39;</span><span class="p">,</span>
  <span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_KPRESS</span> <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_KUP</span> <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_KDOWN</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <ul>
<li>controllers</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;XT_CONTROL&#39;</span><span class="p">,</span> <span class="s1">&#39;control&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">XT_KEYBOARD</span> <span class="o">|</span> <span class="nx">C</span><span class="p">.</span><span class="nx">XT_MOUSE</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <ul>
<li>draw</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;X_DRAW&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="mi">2048</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <ul>
<li>playing</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;S_PLAY&#39;</span><span class="p">,</span> <span class="s1">&#39;play&#39;</span><span class="p">,</span> <span class="s1">&#39;play&#39;</span><span class="p">);</span>
<span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;S_PAUSE&#39;</span><span class="p">,</span> <span class="s1">&#39;pause&#39;</span><span class="p">,</span> <span class="s1">&#39;pause&#39;</span><span class="p">);</span>
<span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;S_STOP&#39;</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">);</span>
<span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;S_LOAD&#39;</span><span class="p">,</span> <span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="s1">&#39;load&#39;</span><span class="p">);</span>
<span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;S_REPEAT&#39;</span><span class="p">,</span> <span class="s1">&#39;repeat&#39;</span><span class="p">,</span> <span class="s1">&#39;repeat&#39;</span><span class="p">);</span>
<span class="nx">__reg_event</span><span class="p">(</span><span class="s1">&#39;S_ERROR&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>

<span class="cm">/* X_ERROR, X_FOCUS, X_RESIZE, X_SELECT, touch events */</span>

<span class="cm">/* TODO: the problem with controls receiving events is that `handle_` method is now saved as &#39;handle_8&#39; instead of &#39;handle_mclick&#39; */</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <h2>Modules</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">M</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">C</span><span class="p">.</span><span class="nx">MOD_PLAYER</span> <span class="o">=</span> <span class="s1">&#39;player&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <h3>Options</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* ----------- */</span>

<span class="kd">var</span> <span class="nx">global_opts</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;liveDebug&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                    <span class="s1">&#39;autoFocus&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                    <span class="s1">&#39;setTabindex&#39;</span><span class="o">:</span> <span class="kc">true</span> <span class="p">};</span>

<span class="nx">M</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">MOD_PLAYER</span><span class="p">]</span> <span class="o">=</span> <span class="nx">global_opts</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <h2>Player</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">Player</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">anim</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">controls</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">info</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__canvasPrepared</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__instanceNum</span> <span class="o">=</span> <span class="o">++</span><span class="nx">Player</span><span class="p">.</span><span class="nx">__instances</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__makeSafe</span><span class="p">(</span><span class="nx">Player</span><span class="p">.</span><span class="nx">_SAFE_METHODS</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">__instances</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nx">Player</span><span class="p">.</span><span class="nx">PREVIEW_POS</span> <span class="o">=</span> <span class="mf">0.33</span><span class="p">;</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">PEFF</span> <span class="o">=</span> <span class="mf">0.07</span><span class="p">;</span> <span class="c1">// seconds to play more when reached end of movie</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">NO_TIME</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="nx">Player</span><span class="p">.</span><span class="nx">URL_ATTR</span> <span class="o">=</span> <span class="s1">&#39;data-url&#39;</span><span class="p">;</span>

<span class="nx">Player</span><span class="p">.</span><span class="nx">DEFAULT_CANVAS</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="nx">DEF_CNVS_WIDTH</span><span class="p">,</span>
                          <span class="s1">&#39;height&#39;</span><span class="o">:</span> <span class="nx">DEF_CNVS_HEIGHT</span><span class="p">,</span>
                          <span class="s1">&#39;bgfill&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="cm">/*{ &#39;color&#39;: DEF_CNVS_BG }*/</span> <span class="p">};</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">DEFAULT_CONFIGURATION</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;debug&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                                 <span class="s1">&#39;inParent&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                                 <span class="s1">&#39;muteErrors&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                                 <span class="s1">&#39;repeat&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                                 <span class="s1">&#39;mode&#39;</span><span class="o">:</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_VIDEO</span><span class="p">,</span>
                                 <span class="s1">&#39;zoom&#39;</span><span class="o">:</span> <span class="mf">1.0</span><span class="p">,</span>
                                 <span class="s1">&#39;meta&#39;</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;title&#39;</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;author&#39;</span><span class="o">:</span> <span class="s1">&#39;Anonymous&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;copyright&#39;</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;version&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                                           <span class="s1">&#39;description&#39;</span><span class="o">:</span> <span class="s1">&#39;&#39;</span> <span class="p">},</span>
                                 <span class="s1">&#39;anim&#39;</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;fps&#39;</span><span class="o">:</span> <span class="mi">30</span><span class="p">,</span>
                                           <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="nx">DEF_CNVS_WIDTH</span><span class="p">,</span>
                                           <span class="s1">&#39;height&#39;</span><span class="o">:</span> <span class="nx">DEF_CNVS_HEIGHT</span><span class="p">,</span>
                                           <span class="s1">&#39;bgfill&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                                           <span class="s1">&#39;duration&#39;</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span>
                               <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <h3>Playing Control API</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* ----------------------- */</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>methods listed below are directly wrapped with try/catch to check
which way of handling/suppressing errors is current one for this player
and act with catched errors basing on this way</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Player</span><span class="p">.</span><span class="nx">_SAFE_METHODS</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="s1">&#39;play&#39;</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="s1">&#39;pause&#39;</span><span class="p">,</span> <span class="s1">&#39;drawAt&#39;</span> <span class="p">];</span>

<span class="cm">/* TODO: add load/play/pause/stop events */</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p><code>id</code> is canvas id</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>you may pass null for options, but if you provide them, at least <code>mode</code> is required
to be set (all other are optional).</p>

<p>options format:</p>

<pre><code>{ "debug": false,
  "inParent": false,
  "muteErrors": false,
  "mode": C.M_VIDEO,
  "zoom": 1.0,
  "meta": { "title": "Default",
            "author": "Anonymous",
            "copyright": "© NaN",
            "version": -1.0,
            "description":
                    "Default project description",
            [ "modified": "2012-04-10T15:06:12.246Z" ] }, // not used
  "anim": { "fps": 30,
            "width": 400,
            "height": 250,
            "bgfill": { color: "#fff" },
            "duration": 0 } }
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cvs</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">PlayerErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">INIT_TWICE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">anim</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">PlayerErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">INIT_AFTER_LOAD</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_initHandlers</span><span class="p">();</span> <span class="cm">/* TODO: make automatic */</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_prepare</span><span class="p">(</span><span class="nx">cvs</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_loadOpts</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_postInit</span><span class="p">();</span>
    <span class="cm">/* TODO: if (this.canvas.hasAttribute(&#39;data-url&#39;)) */</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">load</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">importer</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">player</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">anim</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">_reset</span><span class="p">();</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">PlayerErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">NO_SCENE_PASSED</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="nx">player</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">happens</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PLAYING</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">happens</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PAUSED</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">PlayerErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">COULD_NOT_LOAD_WHILE_PLAYING</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">player</span><span class="p">.</span><span class="nx">__canvasPrepared</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">PlayerErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">CANVAS_NOT_PREPARED</span><span class="p">);</span>

    <span class="nx">player</span><span class="p">.</span><span class="nx">_reset</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">whenDone</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">mode</span> <span class="o">&amp;</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_HANDLE_EVENTS</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">player</span><span class="p">.</span><span class="nx">__subscribeDynamicEvents</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">anim</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">S_LOAD</span><span class="p">);</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="cm">/* TODO: configure canvas using clips bounds */</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">__builder</span><span class="p">(</span><span class="nx">object</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">// Builder instance</span>
            <span class="nx">L</span><span class="p">.</span><span class="nx">loadBuilder</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">whenDone</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">object</span> <span class="k">instanceof</span> <span class="nx">Scene</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Scene instance</span>
            <span class="nx">L</span><span class="p">.</span><span class="nx">loadScene</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">whenDone</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__array</span><span class="p">(</span><span class="nx">object</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// array of clips</span>
            <span class="nx">L</span><span class="p">.</span><span class="nx">loadClips</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">whenDone</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">object</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// URL</span>
            <span class="nx">L</span><span class="p">.</span><span class="nx">loadFromUrl</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">importer</span><span class="p">,</span> <span class="nx">whenDone</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// any object with importer</span>
            <span class="nx">L</span><span class="p">.</span><span class="nx">loadFromObj</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">importer</span><span class="p">,</span> <span class="nx">whenDone</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">anim</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Scene</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">player</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">play</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">speed</span><span class="p">,</span> <span class="nx">stopAfter</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">happens</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PLAYING</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">PlayerErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">ALREADY_PLAYING</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">player</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="nx">__nextFrame</span> <span class="o">=</span> <span class="nx">__frameFunc</span><span class="p">();</span>

    <span class="nx">player</span><span class="p">.</span><span class="nx">_ensureHasAnim</span><span class="p">();</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">_ensureHasState</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>

    <span class="nx">state</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">from</span> <span class="o">||</span> <span class="nx">state</span><span class="p">.</span><span class="nx">from</span><span class="p">;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">speed</span> <span class="o">=</span> <span class="nx">speed</span> <span class="o">||</span> <span class="nx">state</span><span class="p">.</span><span class="nx">speed</span><span class="p">;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">stopAfter</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">stopAfter</span> <span class="o">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">stop</span><span class="p">;</span>

    <span class="nx">state</span><span class="p">.</span><span class="nx">__startTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">__redraws</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">__rsec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="nx">state</span><span class="p">.</span><span class="nx">__supressFrames</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="cm">/*if (state.__drawInterval !== null) {</span>
<span class="cm">        clearInterval(player.state.__drawInterval);</span>
<span class="cm">    }*/</span>

    <span class="nx">state</span><span class="p">.</span><span class="nx">happens</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PLAYING</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">scene</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">anim</span><span class="p">;</span>
    <span class="nx">scene</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">setDuration</span><span class="p">(</span><span class="nx">scene</span><span class="p">.</span><span class="nx">duration</span><span class="p">);</span>

    <span class="nx">state</span><span class="p">.</span><span class="nx">__firstReq</span> <span class="o">=</span> <span class="nx">D</span><span class="p">.</span><span class="nx">drawNext</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span>
                                  <span class="nx">state</span><span class="p">,</span> <span class="nx">scene</span><span class="p">,</span>
                                  <span class="nx">player</span><span class="p">.</span><span class="nx">__beforeFrame</span><span class="p">(</span><span class="nx">scene</span><span class="p">),</span>
                                  <span class="nx">player</span><span class="p">.</span><span class="nx">__afterFrame</span><span class="p">(</span><span class="nx">scene</span><span class="p">));</span>

    <span class="nx">player</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">S_PLAY</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">from</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">player</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="cm">/* if (state.happens === C.STOPPED) return; */</span>

    <span class="kd">var</span> <span class="nx">player</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="nx">player</span><span class="p">.</span><span class="nx">_ensureHasState</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="nx">state</span><span class="p">.</span><span class="nx">happens</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PLAYING</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">happens</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PAUSED</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">__supressFrames</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">__stopAnim</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">__firstReq</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">state</span><span class="p">.</span><span class="nx">time</span> <span class="o">=</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">NO_TIME</span><span class="p">;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">NO_TIME</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">anim</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">happens</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">STOPPED</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">mode</span> <span class="o">&amp;</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_DRAW_STILL</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">player</span><span class="p">.</span><span class="nx">drawAt</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">duration</span> <span class="o">*</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">PREVIEW_POS</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">controls</span><span class="cm">/* &amp;&amp; !player.controls.hidden*/</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">player</span><span class="p">.</span><span class="nx">_renderControlsAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">happens</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">NOTHING</span><span class="p">;</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">_drawSplash</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nx">player</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">S_STOP</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">player</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pause</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">player</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="nx">player</span><span class="p">.</span><span class="nx">_ensureHasState</span><span class="p">();</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">_ensureHasAnim</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">happens</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">STOPPED</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">PlayerErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">PAUSING_WHEN_STOPPED</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">happens</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PLAYING</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">__supressFrames</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">__stopAnim</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">__firstReq</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">time</span> <span class="o">&gt;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">duration</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">time</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">duration</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">state</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">time</span><span class="p">;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">happens</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PAUSED</span><span class="p">;</span>

    <span class="nx">player</span><span class="p">.</span><span class="nx">drawAt</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">time</span><span class="p">);</span>

    <span class="nx">player</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">S_PAUSE</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">time</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">player</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*Player.prototype.reset = function() {</span>

<span class="cm">}*/</span>

<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__err_handler</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <h3>Inititalization</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* ------------------- */</span>

<span class="nx">provideEvents</span><span class="p">(</span><span class="nx">Player</span><span class="p">,</span> <span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">S_PLAY</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">S_PAUSE</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">S_STOP</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">S_LOAD</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">S_REPEAT</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">S_ERROR</span><span class="p">]);</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_prepare</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cvs</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">cvs</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">cvs</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">PlayerErr</span><span class="p">(</span><span class="nx">_strf</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">NO_CANVAS_WITH_ID</span><span class="p">,</span> <span class="p">[</span><span class="nx">cvs</span><span class="p">]));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">cvs</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cvs</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">PlayerErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">NO_CANVAS_PASSED</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">cvs</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="nx">cvs</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">createState</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">subscribeEvents</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_loadOpts</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cvs_opts</span> <span class="o">=</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">_mergeOpts</span><span class="p">(</span><span class="nx">Player</span><span class="p">.</span><span class="nx">_optsFromCvsAttrs</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">),</span>
                                     <span class="nx">Player</span><span class="p">.</span><span class="nx">DEFAULT_CONFIGURATION</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">?</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">_mergeOpts</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">cvs_opts</span><span class="p">)</span> <span class="o">:</span> <span class="nx">cvs_opts</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">inParent</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">inParent</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">mode</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">?</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">mode</span> <span class="o">:</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_VIDEO</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">debug</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">debug</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">zoom</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">zoom</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">repeat</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">repeat</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">configureAnim</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">anim</span> <span class="o">||</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">DEFAULT_CONFIGURATION</span><span class="p">.</span><span class="nx">anim</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">_checkMode</span><span class="p">();</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">configureMeta</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">meta</span> <span class="o">||</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">DEFAULT_CONFIGURATION</span><span class="p">.</span><span class="nx">meta</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>initial state of the player, called from constuctor</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_postInit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="cm">/* TODO: load some default information into player */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Text</span><span class="p">.</span><span class="nx">__buff</span><span class="p">)</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">__buff</span> <span class="o">=</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">_createBuffer</span><span class="p">();</span> <span class="cm">/* so it will be performed onload */</span>
    <span class="kd">var</span> <span class="nx">mayBeUrl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">Player</span><span class="p">.</span><span class="nx">URL_ATTR</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mayBeUrl</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">mayBeUrl</span><span class="cm">/*,</span>
<span class="cm">                            this.canvas.getAttribute(Player.IMPORTER_ATTR)*/</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">changeRect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rect</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_applyConfToCanvas</span><span class="p">({</span>
        <span class="nx">width</span><span class="o">:</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>
        <span class="nx">height</span><span class="o">:</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span>
        <span class="nx">x</span><span class="o">:</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
        <span class="nx">bgfill</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">bgfill</span>
    <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">anim</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">forceRedraw</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_rectChanged</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rect</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_canvasConf</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">width</span> <span class="o">!=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">height</span> <span class="o">!=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="o">||</span>
           <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">x</span> <span class="o">!=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">y</span> <span class="o">!=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">forceRedraw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">forceNextRedraw</span><span class="p">();</span>
    <span class="k">switch</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">happens</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">C</span><span class="p">.</span><span class="nx">STOPPED</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PAUSED</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">drawAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">time</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PLAYING</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">play</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">time</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">changeZoom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ratio</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">zoom</span> <span class="o">=</span> <span class="nx">ratio</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>update player state with passed configuration, usually done before
loading some scene or by importer, <code>conf</code> has the data about title,
author/copyright, fps and width/height of the player</p>

<p>Anim-info format:</p>

<pre><code>{ ["fps": 24.0,] // NB: currently not applied in any way, default is 30
  "width": 640,
  "height": 480,
  ["bgfill": { color: "#f00" },] // in canvas-friendly format
  ["duration": 10.0] // in seconds
}
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">configureAnim</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_animInfo</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cnvs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">conf</span><span class="p">.</span><span class="nx">width</span> <span class="o">&amp;&amp;</span> <span class="nx">cnvs</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">))</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">cnvs</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">conf</span><span class="p">.</span><span class="nx">height</span> <span class="o">&amp;&amp;</span> <span class="nx">cnvs</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">))</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">cnvs</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">_applyConfToCanvas</span><span class="p">(</span><span class="nx">conf</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">fps</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">fps</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">fps</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">duration</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">duration</span><span class="p">;</span>

<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>update player information block with passed configuration, usually done before
loading some scene or by importer, <code>conf</code> has the data about title,
author/copyright, version.</p>

<p>Meta-info format:</p>

<pre><code>{ ["id": "......",]
  "title": "Default",
  "author": "Anonymous",
  "copyright": "© 2011",
  "version": 0.1,
  "description": "Default project description"
}
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">configureMeta</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_metaInfo</span> <span class="o">=</span> <span class="nx">info</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="nx">info</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_animInfo</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>draw current scene at specified time</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawAt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">time</span> <span class="o">===</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">NO_TIME</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">PlayerErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">PASSED_TIME_VALUE_IS_NO_TIME</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">time</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">time</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">duration</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">PlayerErr</span><span class="p">(</span><span class="nx">_strf</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">PASSED_TIME_NOT_IN_RANGE</span><span class="p">,</span> <span class="p">[</span><span class="nx">time</span><span class="p">]));</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span>
        <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">width</span> <span class="o">*</span> <span class="nx">state</span><span class="p">.</span><span class="nx">ratio</span><span class="p">,</span>
                        <span class="nx">state</span><span class="p">.</span><span class="nx">height</span> <span class="o">*</span> <span class="nx">state</span><span class="p">.</span><span class="nx">ratio</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">anim</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">anim</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">zoom</span> <span class="o">*</span> <span class="nx">state</span><span class="p">.</span><span class="nx">ratio</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_renderControlsAt</span><span class="p">(</span><span class="nx">time</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">afterFrame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">happens</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PLAYING</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">PlayerErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">AFTERFRAME_BEFORE_PLAY</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__userAfterFrame</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">detach</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">detach</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">detach</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_reset</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">__getPosAndRedraw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/*var canvas = player.canvas;</span>
<span class="cm">        var pos = find_pos(canvas),</span>
<span class="cm">            rect = {</span>
<span class="cm">                &#39;width&#39;: canvas.clientWidth,</span>
<span class="cm">                &#39;height&#39;: canvas.clientHeight,</span>
<span class="cm">                &#39;x&#39;: pos[0],</span>
<span class="cm">                &#39;y&#39;: pos[1]</span>
<span class="cm">            };</span>
<span class="cm">        if (player._rectChanged(rect)) player.changeRect(rect);*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">controls</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">player</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>player._renderControls();</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">player</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>player.info.render(player.state, player.state.time);</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subscribeEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/*window.addEventListener(&#39;scroll&#39;, Player.__getPosAndRedraw(this), false);*/</span>
    <span class="cm">/*window.addEventListener(&#39;resize&#39;, Player.__getPosAndRedraw(this), false);*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mouseover&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">global_opts</span><span class="p">.</span><span class="nx">autoFocus</span> <span class="o">&amp;&amp;</span>
                                <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">mode</span> <span class="o">&amp;</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_HANDLE_EVENTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                                <span class="nx">player</span><span class="p">.</span><span class="nx">canvas</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">player</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
                            <span class="p">}</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">controls</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">player</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
                                <span class="nx">player</span><span class="p">.</span><span class="nx">_renderControls</span><span class="p">();</span>
                            <span class="p">}</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">info</span><span class="p">)</span> <span class="nx">player</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
                            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="p">};</span>
                    <span class="p">})(</span><span class="k">this</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mouseout&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">global_opts</span><span class="p">.</span><span class="nx">autoFocus</span> <span class="o">&amp;&amp;</span>
                                <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">mode</span> <span class="o">&amp;</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_HANDLE_EVENTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                                <span class="nx">player</span><span class="p">.</span><span class="nx">canvas</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">player</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">blur</span><span class="p">();</span>
                            <span class="p">}</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">controls</span> <span class="o">&amp;&amp;</span>
                                <span class="p">(</span><span class="o">!</span><span class="nx">player</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">evtInBounds</span><span class="p">(</span><span class="nx">evt</span><span class="p">)))</span> <span class="p">{</span>
                                <span class="nx">player</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
                            <span class="p">}</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">info</span> <span class="o">&amp;&amp;</span>
                                <span class="p">(</span><span class="o">!</span><span class="nx">player</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">evtInBounds</span><span class="p">(</span><span class="nx">evt</span><span class="p">)))</span> <span class="p">{</span>
                                <span class="nx">player</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
                            <span class="p">}</span>
                            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="p">};</span>
                    <span class="p">})(</span><span class="k">this</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setDuration</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">setDuration</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_drawSplash</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span>
        <span class="nx">w</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>
        <span class="nx">h</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span>
        <span class="nx">rsize</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>background</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s1">&#39;#ffe&#39;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>text</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s1">&#39;#999966&#39;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="s1">&#39;18px sans-serif&#39;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="s1">&#39;© Animatron Player&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="nx">h</span> <span class="o">-</span> <span class="mi">20</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>outer rect</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineWidth</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeStyle</span> <span class="o">=</span> <span class="s1">&#39;#fee&#39;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>inner rect</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span><span class="p">((</span><span class="nx">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">rsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="nx">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">rsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">grad</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">createLinearGradient</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">rsize</span><span class="p">,</span><span class="nx">rsize</span><span class="p">);</span>
    <span class="nx">grad</span><span class="p">.</span><span class="nx">addColorStop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;#00abeb&#39;</span><span class="p">);</span>
    <span class="nx">grad</span><span class="p">.</span><span class="nx">addColorStop</span><span class="p">(.</span><span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;#fff&#39;</span><span class="p">);</span>
    <span class="nx">grad</span><span class="p">.</span><span class="nx">addColorStop</span><span class="p">(.</span><span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;#6c0&#39;</span><span class="p">);</span>
    <span class="nx">grad</span><span class="p">.</span><span class="nx">addColorStop</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;#fff&#39;</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">grad</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeStyle</span> <span class="o">=</span> <span class="s1">&#39;#bbb&#39;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineWidth</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">globalAlpha</span> <span class="o">=</span> <span class="p">.</span><span class="mi">8</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">rsize</span><span class="p">,</span> <span class="nx">rsize</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">globalAlpha</span> <span class="o">=</span> <span class="p">.</span><span class="mi">9</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">rsize</span><span class="p">,</span> <span class="nx">rsize</span><span class="p">);</span>

    <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_drawLoadingSplash</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_drawSplash</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s1">&#39;#006&#39;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="s1">&#39;12px sans-serif&#39;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="nx">text</span> <span class="o">||</span> <span class="nx">Strings</span><span class="p">.</span><span class="nx">LOADING</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;[ Player &#39;&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot;&#39; m-&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">mode</span> <span class="o">+</span> <span class="s2">&quot; ]&quot;</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>reset player to initial state, called before loading any scene</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">debug</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">debug</span><span class="p">;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">happens</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">NOTHING</span><span class="p">;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">time</span> <span class="o">=</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">NO_TIME</span><span class="p">;</span>
    <span class="cm">/*state.zoom = 1;*/</span> <span class="c1">// do not override the zoom</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">width</span> <span class="o">*</span> <span class="nx">state</span><span class="p">.</span><span class="nx">ratio</span><span class="p">,</span>
                             <span class="nx">state</span><span class="p">.</span><span class="nx">height</span> <span class="o">*</span> <span class="nx">state</span><span class="p">.</span><span class="nx">ratio</span><span class="p">);</span>
    <span class="cm">/*this.stop();*/</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>update player's canvas with configuration</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_applyConfToCanvas</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">pxRatio</span> <span class="o">=</span> <span class="nx">getPxRatio</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_canvasConf</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_w</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">width</span> <span class="o">?</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span> <span class="o">:</span> <span class="nx">DEF_CNVS_WIDTH</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_h</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">height</span> <span class="o">?</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="o">:</span> <span class="nx">DEF_CNVS_HEIGHT</span><span class="p">;</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">_w</span><span class="p">;</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">_h</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">_w</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">_h</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">ratio</span> <span class="o">=</span> <span class="nx">pxRatio</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">bgfill</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">bgfill</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">bgfill</span><span class="p">;</span>
    <span class="nx">canvasOpts</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">pxRatio</span><span class="p">);</span>
    <span class="nx">Player</span><span class="p">.</span><span class="nx">_saveCanvasPos</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__canvasPrepared</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_enableControls</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">controls</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Controls</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_disableControls</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">detach</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">controls</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_enableInfo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">info</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InfoBlock</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_disableInfo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">detach</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">info</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_renderControls</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_renderControlsAt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">time</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_renderControlsAt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">t</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_checkMode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span> <span class="o">&amp;</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_CONTROLS_ENABLED</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_enableControls</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_disableControls</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mode</span> <span class="o">&amp;</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_INFO_ENABLED</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_enableInfo</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">info</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_disableInfo</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__subscribeDynamicEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scene</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">global_opts</span><span class="p">.</span><span class="nx">setTabindex</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;tabindex&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">__instanceNum</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">scene</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">scene</span><span class="p">.</span><span class="nx">__subscribedEvts</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">scene</span><span class="p">.</span><span class="nx">subscribeEvents</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span>
        <span class="nx">scene</span><span class="p">.</span><span class="nx">__subscribedEvts</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_ensureHasState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">PlayerErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">NO_STATE</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_ensureHasAnim</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">anim</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">PlayerErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">NO_SCENE</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__beforeFrame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scene</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">scene</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">happens</span> <span class="o">!==</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PLAYING</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(((</span><span class="nx">state</span><span class="p">.</span><span class="nx">stop</span> <span class="o">!==</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">NO_TIME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                 <span class="p">(</span><span class="nx">time</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">from</span> <span class="o">+</span> <span class="nx">state</span><span class="p">.</span><span class="nx">stop</span><span class="p">)))</span> <span class="o">||</span>
                 <span class="p">(</span><span class="nx">time</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">duration</span> <span class="o">+</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">PEFF</span><span class="p">)))</span> <span class="p">{</span>
                <span class="nx">state</span><span class="p">.</span><span class="nx">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="nx">scene</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
                <span class="nx">player</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">repeat</span><span class="p">)</span> <span class="p">{</span>
                   <span class="nx">player</span><span class="p">.</span><span class="nx">play</span><span class="p">();</span>
                   <span class="nx">player</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">S_REPEAT</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">})(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">scene</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__afterFrame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scene</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">scene</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">controls</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">player</span><span class="p">.</span><span class="nx">_renderControls</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">time</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">})(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">scene</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">__userAfterFrame</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Called when any error happens during player initialization or animation
Player should mute all non-system errors by default, and if it got a system error, it may show
this error over itself</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">player</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">doMute</span> <span class="o">=</span> <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">state</span> <span class="o">&amp;&amp;</span> <span class="nx">player</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">muteErrors</span><span class="p">);</span>
      <span class="nx">doMute</span> <span class="o">=</span> <span class="nx">doMute</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">err</span> <span class="k">instanceof</span> <span class="nx">SysErr</span><span class="p">);</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">S_ERROR</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>

    <span class="nx">player</span><span class="p">.</span><span class="nx">anim</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="cm">/*if (player.state)*/</span> <span class="nx">player</span><span class="p">.</span><span class="nx">__unsafe_stop</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">SysErr</span><span class="p">(</span><span class="nx">_strf</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">S</span><span class="p">.</span><span class="nx">ERROR_HANDLING_FAILED</span><span class="p">,</span> <span class="p">[</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="o">||</span> <span class="nx">err</span><span class="p">]));</span> <span class="p">}</span>

  <span class="nx">doMute</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__err_handler</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">__err_handler</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span> <span class="o">||</span> <span class="nx">doMute</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doMute</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__callSafe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__onerror</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__makeSafe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">methods</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">player</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">il</span> <span class="o">=</span> <span class="nx">methods</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">il</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">methods</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">player</span><span class="p">[</span><span class="nx">method</span><span class="p">])</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">SysErr</span><span class="p">(</span><span class="nx">_strf</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">S</span><span class="p">.</span><span class="nx">NO_METHOD_FOR_PLAYER</span><span class="p">,</span> <span class="p">[</span><span class="nx">method</span><span class="p">]));</span>
    <span class="nx">player</span><span class="p">[</span><span class="s1">&#39;__unsafe_&#39;</span><span class="o">+</span><span class="nx">method</span><span class="p">]</span> <span class="o">=</span> <span class="nx">player</span><span class="p">[</span><span class="nx">method</span><span class="p">];</span>
    <span class="nx">player</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">method_f</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">__safe_ctx</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">__safe_ctx</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">try</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ret_val</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">__callSafe</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">method_f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">__safe_ctx</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">ret_val</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">__safe_ctx</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">method_f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="p">})(</span><span class="nx">player</span><span class="p">[</span><span class="nx">method</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Player.prototype.__originateErrors = function() {</span>
<span class="cm">    return (function(player) { return function(err) {</span>
<span class="cm">        return player._fireError(err);</span>
<span class="cm">    }})(this);</span>
<span class="cm">} */</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">_saveCanvasPos</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cvs</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">gcs</span> <span class="o">=</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">defaultView</span> <span class="o">&amp;&amp;</span>
               <span class="nb">document</span><span class="p">.</span><span class="nx">defaultView</span><span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">);</span> <span class="c1">// last is assigned</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>computed padding-left</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">cpl</span> <span class="o">=</span> <span class="nx">gcs</span> <span class="o">?</span>
          <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">gcs</span><span class="p">(</span><span class="nx">cvs</span><span class="p">,</span> <span class="kc">null</span><span class="p">).</span><span class="nx">paddingLeft</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>computed padding-top</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">cpt</span> <span class="o">=</span> <span class="nx">gcs</span> <span class="o">?</span>
          <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">gcs</span><span class="p">(</span><span class="nx">cvs</span><span class="p">,</span> <span class="kc">null</span><span class="p">).</span><span class="nx">paddingTop</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>computed bodrer-left</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">cbl</span> <span class="o">=</span> <span class="nx">gcs</span> <span class="o">?</span>
          <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">gcs</span><span class="p">(</span><span class="nx">cvs</span><span class="p">,</span> <span class="kc">null</span><span class="p">).</span><span class="nx">borderLeftWidth</span><span class="p">,</span>  <span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>computed bodrer-top</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">cbt</span> <span class="o">=</span> <span class="nx">gcs</span> <span class="o">?</span>
          <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">gcs</span><span class="p">(</span><span class="nx">cvs</span><span class="p">,</span> <span class="kc">null</span><span class="p">).</span><span class="nx">borderTopWidth</span><span class="p">,</span>  <span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span>
        <span class="nx">htol</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">,</span>
        <span class="nx">htot</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">offsetTop</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">elm</span> <span class="o">=</span> <span class="nx">cvs</span><span class="p">,</span>
        <span class="nx">ol</span> <span class="o">=</span> <span class="nx">cpl</span> <span class="o">+</span> <span class="nx">cbl</span> <span class="o">+</span> <span class="nx">htol</span><span class="p">,</span>
        <span class="nx">ot</span> <span class="o">=</span> <span class="nx">cpt</span> <span class="o">+</span> <span class="nx">cbt</span> <span class="o">+</span> <span class="nx">htot</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">offsetParent</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="nx">ol</span> <span class="o">+=</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">;</span>
            <span class="nx">ot</span> <span class="o">+=</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">offsetTop</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">elm</span> <span class="o">=</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">ol</span> <span class="o">+=</span> <span class="nx">cpl</span> <span class="o">+</span> <span class="nx">cbl</span> <span class="o">+</span> <span class="nx">htol</span><span class="p">;</span>
    <span class="nx">ot</span> <span class="o">+=</span> <span class="nx">cpt</span> <span class="o">+</span> <span class="nx">cbt</span> <span class="o">+</span> <span class="nx">htot</span><span class="p">;</span>

    <span class="cm">/* FIXME: find a method with no injection of custom properties</span>
<span class="cm">              (data-xxx attributes are stored as strings and may work</span>
<span class="cm">               a bit slower for events) */</span>
    <span class="nx">cvs</span><span class="p">.</span><span class="nx">__rOffsetLeft</span> <span class="o">=</span> <span class="nx">ol</span><span class="p">;</span>
    <span class="nx">cvs</span><span class="p">.</span><span class="nx">__rOffsetTop</span> <span class="o">=</span> <span class="nx">ot</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">Player</span><span class="p">.</span><span class="nx">createState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;time&#39;</span><span class="o">:</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">NO_TIME</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="o">:</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">NO_TIME</span><span class="p">,</span>
        <span class="s1">&#39;speed&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;fps&#39;</span><span class="o">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;afps&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;debug&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;iactive&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="cm">/* TODO: use iactive to determine if controls/info should be init-zed */</span>
        <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="nx">player</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">,</span>
        <span class="s1">&#39;height&#39;</span><span class="o">:</span> <span class="nx">player</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">,</span>
        <span class="s1">&#39;zoom&#39;</span><span class="o">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;bgfill&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="s1">&#39;happens&#39;</span><span class="o">:</span> <span class="nx">C</span><span class="p">.</span><span class="nx">NOTHING</span><span class="p">,</span>
        <span class="s1">&#39;__startTime&#39;</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;__redraws&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;__rsec&#39;</span><span class="o">:</span> <span class="mi">0</span>
        <span class="cm">/*&#39;__drawInterval&#39;: null*/</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">__attrOr</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">_default</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span>
           <span class="o">?</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span>
           <span class="o">:</span> <span class="nx">_default</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">_mergeOpts</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">what</span><span class="p">,</span> <span class="nx">where</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mrg_obj</span><span class="p">(</span><span class="nx">what</span><span class="p">,</span> <span class="nx">where</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">meta</span> <span class="o">=</span> <span class="nx">what</span><span class="p">.</span><span class="nx">meta</span> <span class="o">?</span> <span class="nx">mrg_obj</span><span class="p">(</span><span class="nx">what</span><span class="p">.</span><span class="nx">meta</span><span class="p">,</span> <span class="nx">where</span><span class="p">.</span><span class="nx">meta</span> <span class="o">||</span> <span class="p">{})</span> <span class="o">:</span> <span class="p">(</span><span class="nx">where</span><span class="p">.</span><span class="nx">meta</span> <span class="o">||</span> <span class="p">{});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">anim</span> <span class="o">=</span> <span class="nx">what</span><span class="p">.</span><span class="nx">anim</span> <span class="o">?</span> <span class="nx">mrg_obj</span><span class="p">(</span><span class="nx">what</span><span class="p">.</span><span class="nx">anim</span><span class="p">,</span> <span class="nx">where</span><span class="p">.</span><span class="nx">anim</span> <span class="o">||</span> <span class="p">{})</span> <span class="o">:</span> <span class="p">(</span><span class="nx">where</span><span class="p">.</span><span class="nx">anim</span> <span class="o">||</span> <span class="p">{});</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">_optsFromCvsAttrs</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">,</span>
        <span class="nx">pxRatio</span> <span class="o">=</span> <span class="nx">getPxRatio</span><span class="p">();</span>
    <span class="k">return</span> <span class="p">{</span> <span class="s1">&#39;debug&#39;</span><span class="o">:</span> <span class="nx">__attrOr</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;data-debug&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">),</span>
             <span class="s1">&#39;inParent&#39;</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
             <span class="s1">&#39;muteErrors&#39;</span><span class="o">:</span> <span class="nx">__attrOr</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;data-mute-errors&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">),</span>
             <span class="s1">&#39;repeat&#39;</span><span class="o">:</span> <span class="nx">__attrOr</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;data-repeat&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">),</span>
             <span class="s1">&#39;mode&#39;</span><span class="o">:</span> <span class="nx">__attrOr</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;data-mode&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">),</span>
             <span class="s1">&#39;zoom&#39;</span><span class="o">:</span> <span class="nx">__attrOr</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;data-zoom&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">),</span>
             <span class="s1">&#39;meta&#39;</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;title&#39;</span><span class="o">:</span> <span class="nx">__attrOr</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;data-title&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">),</span>
                       <span class="s1">&#39;author&#39;</span><span class="o">:</span> <span class="nx">__attrOr</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;data-author&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">),</span>
                       <span class="s1">&#39;copyright&#39;</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
                       <span class="s1">&#39;version&#39;</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
                       <span class="s1">&#39;description&#39;</span><span class="o">:</span> <span class="kc">undefined</span> <span class="p">},</span>
             <span class="s1">&#39;anim&#39;</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;fps&#39;</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
                       <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="p">(</span><span class="nx">__attrOr</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;data-width&#39;</span><span class="p">,</span>
                                <span class="p">(</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">__attrOr</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">),</span>
                                 <span class="nx">width</span> <span class="o">?</span> <span class="p">(</span><span class="nx">width</span> <span class="o">/</span> <span class="nx">pxRatio</span><span class="p">)</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">))),</span>
                       <span class="s1">&#39;height&#39;</span><span class="o">:</span> <span class="p">(</span><span class="nx">__attrOr</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;data-height&#39;</span><span class="p">,</span>
                                 <span class="p">(</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">__attrOr</span><span class="p">(</span><span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">),</span>
                                  <span class="nx">height</span> <span class="o">?</span> <span class="p">(</span><span class="nx">height</span> <span class="o">/</span> <span class="nx">pxRatio</span><span class="p">)</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">))),</span>
                       <span class="s1">&#39;bgfill&#39;</span><span class="o">:</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="p">(</span><span class="s1">&#39;data-bgcolor&#39;</span><span class="p">)</span>
                                 <span class="o">?</span> <span class="p">{</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-bgcolor&#39;</span><span class="p">)</span> <span class="p">}</span>
                                 <span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
                       <span class="s1">&#39;duration&#39;</span><span class="o">:</span> <span class="kc">undefined</span> <span class="p">}</span> <span class="p">};</span>
<span class="p">};</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">_optsFromURLParams</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="cm">/* as json */</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="s1">&#39;debug&#39;</span><span class="o">:</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">debug</span><span class="p">,</span>
             <span class="s1">&#39;inParent&#39;</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
             <span class="s1">&#39;muteErrors&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
             <span class="s1">&#39;repeat&#39;</span><span class="o">:</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span>
             <span class="s1">&#39;mode&#39;</span><span class="o">:</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span>
             <span class="s1">&#39;zoom&#39;</span><span class="o">:</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">z</span><span class="p">,</span>
             <span class="s1">&#39;anim&#39;</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;fps&#39;</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
                       <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">w</span><span class="p">,</span>
                       <span class="s1">&#39;height&#39;</span><span class="o">:</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">h</span><span class="p">,</span>
                       <span class="s1">&#39;bgfill&#39;</span><span class="o">:</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">bg</span> <span class="p">},</span>
                       <span class="s1">&#39;duration&#39;</span><span class="o">:</span> <span class="kc">undefined</span> <span class="p">}</span> <span class="p">};</span>
<span class="p">}</span>
<span class="nx">Player</span><span class="p">.</span><span class="nx">forSnapshot</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">canvasId</span><span class="p">,</span> <span class="nx">snapshotURL</span><span class="p">,</span> <span class="nx">params</span><span class="cm">/* as json */</span><span class="p">,</span> <span class="nx">importer</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">_optsFromURLParams</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">player</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Player</span><span class="p">();</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">canvasId</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nx">updateWithParams</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">params</span><span class="p">.</span><span class="nx">t</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">player</span><span class="p">.</span><span class="nx">play</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">t</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">params</span><span class="p">.</span><span class="nx">p</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">player</span><span class="p">.</span><span class="nx">play</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">p</span> <span class="o">/</span> <span class="mi">100</span><span class="p">).</span><span class="nx">pause</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">w</span> <span class="o">&amp;&amp;</span> <span class="nx">params</span><span class="p">.</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">player</span><span class="p">.</span><span class="nx">_applyConfToCanvas</span><span class="p">({</span> <span class="nx">width</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">w</span><span class="p">,</span> <span class="nx">height</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">h</span> <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">bg</span><span class="p">)</span> <span class="nx">player</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">params</span><span class="p">.</span><span class="nx">bg</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">player</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">snapshotURL</span><span class="p">,</span> <span class="nx">importer</span><span class="p">,</span> <span class="nx">updateWithParams</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">player</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <h2>Scene</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <blockquote>
  <p>Scene % ()</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">Scene</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">tree</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_initHandlers</span><span class="p">();</span> <span class="c1">// TODO: make automatic</span>
<span class="p">}</span>

<span class="nx">Scene</span><span class="p">.</span><span class="nx">DEFAULT_VIDEO_DURATION</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>mouse/keyboard events are assigned in L.loadScene</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* TODO: move them into scene */</span>
<span class="nx">provideEvents</span><span class="p">(</span><span class="nx">Scene</span><span class="p">,</span> <span class="p">[</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MCLICK</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MDCLICK</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MUP</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MDOWN</span><span class="p">,</span>
                       <span class="nx">C</span><span class="p">.</span><span class="nx">X_MMOVE</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MOVER</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MOUT</span><span class="p">,</span>
                       <span class="nx">C</span><span class="p">.</span><span class="nx">X_KPRESS</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_KUP</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_KDOWN</span><span class="p">,</span>
                       <span class="nx">C</span><span class="p">.</span><span class="nx">X_DRAW</span> <span class="p">]);</span>
<span class="cm">/* TODO: add chaining to all external Scene methods? */</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <blockquote>
  <p>Scene.add % (elem: Element | Clip)
  Scene.add % (elems: Array[Element]) => Clip
  Scene.add % (draw: Function(ctx: Context),
                 onframe: Function(time: Float),
                 [ transform: Function(ctx: Context,
                                       prev: Function(Context)) ])
                 => Element
  Scene.add % (builder: Builder)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Scene</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arg1</span><span class="p">,</span> <span class="nx">arg2</span><span class="p">,</span> <span class="nx">arg3</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arg2</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// element by functions mode</span>
        <span class="kd">var</span> <span class="nx">_elm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="nx">arg1</span><span class="p">,</span> <span class="nx">arg2</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">arg3</span><span class="p">)</span> <span class="nx">_elm</span><span class="p">.</span><span class="nx">changeTransform</span><span class="p">(</span><span class="nx">arg3</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_addToTree</span><span class="p">(</span><span class="nx">_elm</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">_elm</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__array</span><span class="p">(</span><span class="nx">arg1</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// elements array mode</span>
        <span class="kd">var</span> <span class="nx">_clip</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Clip</span><span class="p">();</span>
        <span class="nx">_clip</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">arg1</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_addToTree</span><span class="p">(</span><span class="nx">_clip</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">_clip</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__builder</span><span class="p">(</span><span class="nx">arg1</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// builder instance</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_addToTree</span><span class="p">(</span><span class="nx">arg1</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// element object mode</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_addToTree</span><span class="p">(</span><span class="nx">arg1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <blockquote>
  <p>Scene.addS % (dimen: Array[Int, 2],
                  draw: Function(ctx: Context),
                  onframe: Function(time: Float),
                  [ transform: Function(ctx: Context,
                                        prev: Function(Context)) ])
                  => Clip</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Scene</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addS</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dimen</span><span class="p">,</span> <span class="nx">draw</span><span class="p">,</span> <span class="nx">onframe</span><span class="p">,</span> <span class="nx">transform</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_clip</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Clip</span><span class="p">();</span>
    <span class="nx">_clip</span><span class="p">.</span><span class="nx">addS</span><span class="p">(</span><span class="nx">dimen</span><span class="p">,</span> <span class="nx">draw</span><span class="p">,</span> <span class="nx">onframe</span><span class="p">,</span> <span class="nx">transform</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">_clip</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">_clip</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <blockquote>
  <p>Scene.remove % (elm: Element)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Scene</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>error will be thrown in <em>unregister method
if (!this.hash[elm.id]) throw new AnimErr(Errors.A.ELEMENT</em>IS<em>NOT</em>REGISTERED);</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>it will unregister element inside</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">elm</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">elm</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_unregister</span><span class="p">(</span><span class="nx">elm</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <blockquote>
  <p>Scene.prototype.clear % ()</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* Scene.prototype.clear = function() {</span>
<span class="cm">    this.hash = {};</span>
<span class="cm">    this.tree = [];</span>
<span class="cm">    this.duration = 0;</span>
<span class="cm">    var hash = this.hash;</span>
<span class="cm">    this.hash = {};</span>
<span class="cm">    for (var elmId in hash) {</span>
<span class="cm">        hash[elm.id]._unbind(); // unsafe, because calls unregistering</span>
<span class="cm">    }</span>
<span class="cm">} */</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <blockquote>
  <p>Scene.visitElems % (visitor: Function(elm: Element))</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Scene</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">visitElems</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">visitor</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">elmId</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">visitor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hash</span><span class="p">[</span><span class="nx">elmId</span><span class="p">],</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <blockquote>
  <p>Scene.visitRoots % (visitor: Function(elm: Element))</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Scene</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">visitRoots</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">visitor</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">tlen</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tree</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">tlen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">visitor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tree</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Scene</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">zoom</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">zoom</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="nx">zoom</span><span class="p">,</span> <span class="nx">zoom</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visitRoots</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">elm</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">time</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_DRAW</span><span class="p">,</span><span class="nx">ctx</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Scene</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">handle__x</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visitElems</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">visible</span><span class="p">)</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Scene</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateDuration</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">max_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">me</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visitRoots</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">elm_tpos</span> <span class="o">=</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">_max_tpos</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">elm_tpos</span> <span class="o">&gt;</span> <span class="nx">me</span><span class="p">.</span><span class="nx">duration</span><span class="p">)</span> <span class="nx">me</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="nx">elm_tpos</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">duration</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Scene</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visitRoots</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">elm</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="nx">Scene</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dispose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">disposeHandlers</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">me</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="cm">/* FIXME: unregistering removes from tree, ensure it is safe */</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visitRoots</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">me</span><span class="p">.</span><span class="nx">_unregister</span><span class="p">(</span><span class="nx">elm</span><span class="p">);</span>
        <span class="nx">elm</span><span class="p">.</span><span class="nx">dispose</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="nx">Scene</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;[ Scene &quot;</span><span class="o">+</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">?</span> <span class="s2">&quot;&#39;&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Scene</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subscribeEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">anim</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">anim</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_MUP</span><span class="p">,</span> <span class="nx">mevt</span><span class="p">(</span><span class="nx">evt</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">));</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">anim</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_MDOWN</span><span class="p">,</span> <span class="nx">mevt</span><span class="p">(</span><span class="nx">evt</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">));</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">anim</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_MMOVE</span><span class="p">,</span> <span class="nx">mevt</span><span class="p">(</span><span class="nx">evt</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">));</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mouseover&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">anim</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_MOVER</span><span class="p">,</span> <span class="nx">mevt</span><span class="p">(</span><span class="nx">evt</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">));</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mouseout&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">anim</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_MOUT</span><span class="p">,</span> <span class="nx">mevt</span><span class="p">(</span><span class="nx">evt</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">));</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">anim</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_MCLICK</span><span class="p">,</span> <span class="nx">mevt</span><span class="p">(</span><span class="nx">evt</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">));</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;dblclick&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">anim</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_MDCLICK</span><span class="p">,</span> <span class="nx">mevt</span><span class="p">(</span><span class="nx">evt</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">));</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">anim</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_KUP</span><span class="p">,</span> <span class="nx">kevt</span><span class="p">(</span><span class="nx">evt</span><span class="p">));</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">anim</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_KDOWN</span><span class="p">,</span> <span class="nx">kevt</span><span class="p">(</span><span class="nx">evt</span><span class="p">));</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;keypress&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">anim</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_KPRESS</span><span class="p">,</span> <span class="nx">kevt</span><span class="p">(</span><span class="nx">evt</span><span class="p">));</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Scene</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_addToTree</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">elm</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="s1">&#39;It appears that it is not a clip object or element that you pass&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_register</span><span class="p">(</span><span class="nx">elm</span><span class="p">);</span>
    <span class="cm">/*if (elm.children) this._addElems(elm.children);*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">tree</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">elm</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">updateDuration</span><span class="p">();</span>
<span class="p">}</span>
<span class="cm">/*Scene.prototype._addElems = function(elems) {</span>
<span class="cm">    for (var ei = 0; ei &lt; elems.length; ei++) {</span>
<span class="cm">        var _elm = elems[ei];</span>
<span class="cm">        this._register(_elm);</span>
<span class="cm">    }</span>
<span class="cm">}*/</span>
<span class="nx">Scene</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hash</span><span class="p">[</span><span class="nx">elm</span><span class="p">.</span><span class="nx">id</span><span class="p">])</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">ELEMENT_IS_REGISTERED</span><span class="p">);</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">registered</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">scene</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hash</span><span class="p">[</span><span class="nx">elm</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">elm</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">me</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">visitChildren</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">me</span><span class="p">.</span><span class="nx">_register</span><span class="p">(</span><span class="nx">elm</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="nx">Scene</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_unregister</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">elm</span><span class="p">.</span><span class="nx">registered</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">ELEMENT_IS_NOT_REGISTERED</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">me</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">visitChildren</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">me</span><span class="p">.</span><span class="nx">_unregister</span><span class="p">(</span><span class="nx">elm</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">((</span><span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tree</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">elm</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">tree</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">hash</span><span class="p">[</span><span class="nx">elm</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">updateDuration</span><span class="p">();</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">registered</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">scene</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>elm.parent = null;</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <h2>Element</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>repeat mode</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">C</span><span class="p">.</span><span class="nx">R_ONCE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">R_STAY</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">R_LOOP</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">R_BOUNCE</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>composite operation</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">C</span><span class="p">.</span><span class="nx">C_SRC_OVER</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// first (default) is 1, to pass if test</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">C_SRC_ATOP</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">C_SRC_IN</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">C_SRC_OUT</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">C_DST_OVER</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">C_DST_ATOP</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">C_DST_IN</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">C_DST_OUT</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">C_LIGHTER</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">C_DARKER</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">C_COPY</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">C_XOR</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>

<span class="nx">C</span><span class="p">.</span><span class="nx">AC_NAMES</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">AC_NAMES</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">C_SRC_OVER</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;source-over&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">AC_NAMES</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">C_SRC_ATOP</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;source-atop&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">AC_NAMES</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">C_SRC_IN</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;source-in&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">AC_NAMES</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">C_SRC_OUT</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;source-out&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">AC_NAMES</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">C_DST_OVER</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;destination-over&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">AC_NAMES</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">C_DST_ATOP</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;destination-atop&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">AC_NAMES</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">C_DST_IN</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;destination-in&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">AC_NAMES</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">C_DST_OUT</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;destination-out&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">AC_NAMES</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">C_LIGHTER</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lighter&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">AC_NAMES</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">C_DARKER</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;darker&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">AC_NAMES</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">C_COPY</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;copy&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">AC_NAMES</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">C_XOR</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;xor&#39;</span><span class="p">;</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">TYPE_MAX_BIT</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">PRRT_MAX_BIT</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="c1">// used to calculate modifiers/painters id&#39;s:</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>they are: (type &lt;&lt; TYPE<em>MAX</em>BIT) | (priot &lt;&lt; PRRT<em>MAX</em>BIT) | i</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>modifiers classes
the order is also determined with value</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_MOD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">TWEEN_MOD</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">USER_MOD</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="cm">/* TODO: JUMP_MOD */</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">EVENT_MOD</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>these two simplify checking in <strong>mafter/</strong>mbefore</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">FIRST_MOD</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_MOD</span><span class="p">;</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">LAST_MOD</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">EVENT_MOD</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>modifiers groups</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">ALL_MODIFIERS</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_MOD</span><span class="p">,</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">TWEEN_MOD</span><span class="p">,</span>
                          <span class="nx">Element</span><span class="p">.</span><span class="nx">USER_MOD</span><span class="p">,</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">EVENT_MOD</span> <span class="p">];</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">NOEVT_MODIFIERS</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_MOD</span><span class="p">,</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">TWEEN_MOD</span><span class="p">,</span>
                            <span class="nx">Element</span><span class="p">.</span><span class="nx">USER_MOD</span> <span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>painters classes
the order is also determined with value</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_PNT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">USER_PNT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">DEBUG_PNT</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>these two simplify checking in <strong>mafter/</strong>mbefore</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">FIRST_PNT</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_PNT</span><span class="p">;</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">LAST_PNT</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">DEBUG_PNT</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>painters groups</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">ALL_PAINTERS</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_PNT</span><span class="p">,</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">USER_PNT</span><span class="p">,</span>
                         <span class="nx">Element</span><span class="p">.</span><span class="nx">DEBUG_PNT</span> <span class="p">];</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">NODBG_PAINTERS</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_PNT</span><span class="p">,</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">USER_PNT</span> <span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <blockquote>
  <p>Element % (draw: Function(ctx: Context),
                onframe: Function(time: Float))</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">Element</span><span class="p">(</span><span class="nx">draw</span><span class="p">,</span> <span class="nx">onframe</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">guid</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">createState</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">createXData</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">scene</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sprite</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">registered</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">rendering</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__data</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_modifiers</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_painters</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">onframe</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">__modify</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">USER_MOD</span> <span class="p">},</span> <span class="nx">onframe</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">draw</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">__paint</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">USER_PNT</span> <span class="p">},</span> <span class="nx">draw</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__lastJump</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__jumpLock</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__modifying</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// current modifiers class, if modifying</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__painting</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// current painters class, if painting</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__evtCache</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__detachQueue</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_initHandlers</span><span class="p">();</span> <span class="c1">// TODO: make automatic</span>
    <span class="kd">var</span> <span class="nx">_me</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
        <span class="nx">default_on</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">&amp;</span> <span class="nx">C</span><span class="p">.</span><span class="nx">XT_CONTROL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">m_on</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">_me</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">handler</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="nx">default_on</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">_me</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">handler</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">Element</span><span class="p">.</span><span class="nx">__addSysModifiers</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="nx">Element</span><span class="p">.</span><span class="nx">__addSysPainters</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">global_opts</span><span class="p">.</span><span class="nx">liveDebug</span><span class="p">)</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">__addDebugRender</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">NO_BAND</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">DEFAULT_LEN</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="nx">provideEvents</span><span class="p">(</span><span class="nx">Element</span><span class="p">,</span> <span class="p">[</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MCLICK</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MDCLICK</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MUP</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MDOWN</span><span class="p">,</span>
                         <span class="nx">C</span><span class="p">.</span><span class="nx">X_MMOVE</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MOVER</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_MOUT</span><span class="p">,</span>
                         <span class="nx">C</span><span class="p">.</span><span class="nx">X_KPRESS</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_KUP</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_KDOWN</span><span class="p">,</span>
                         <span class="nx">C</span><span class="p">.</span><span class="nx">X_DRAW</span> <span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <blockquote>
  <p>Element.prepare % () => Boolean</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">prepare</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">_matrix</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sprite</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">canvas</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_drawToCache</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <blockquote>
  <p>Element.onframe % (gtime: Float) => Boolean</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onframe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ltime</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__callModifiers</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">ALL_MODIFIERS</span><span class="p">,</span> <span class="nx">ltime</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <blockquote>
  <p>Element.drawTo % (ctx: Context)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawTo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__callPainters</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">ALL_PAINTERS</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <blockquote>
  <p>Element.draw % (ctx: Context)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">sprite</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">drawTo</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sheet</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">tw</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">th</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sheet</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">w</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">sheet</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                    <span class="nx">h</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">sheet</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                    <span class="nx">tw</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sheet</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                    <span class="nx">th</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sheet</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">w</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">sheet</span><span class="p">;</span>
                    <span class="nx">tw</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sheet</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="kd">var</span> <span class="nx">sy</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">frame</span> <span class="o">/</span> <span class="nx">w</span> <span class="p">)</span> <span class="o">*</span> <span class="nx">tw</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">sx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">frame</span> <span class="o">%</span> <span class="nx">w</span> <span class="o">*</span> <span class="nx">th</span><span class="p">;</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">sx</span><span class="p">,</span> <span class="nx">sy</span><span class="p">,</span> <span class="nx">tw</span><span class="p">,</span> <span class="nx">th</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">tw</span><span class="p">,</span> <span class="nx">th</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{};</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">canvas</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <blockquote>
  <p>Element.transform % (ctx: Context)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">_matrix</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">_getMatrixOf</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">_matrix</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">globalAlpha</span> <span class="o">*=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">alpha</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">_matrix</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <blockquote>
  <p>Element.render % (ctx: Context, gtime: Float)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">gtime</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">disabled</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">rendering</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">wasDrawn</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>checks if any time jumps (including repeat
modes) were performed</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">ltime</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ltime</span><span class="p">(</span><span class="nx">gtime</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">wasDrawn</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fits</span><span class="p">(</span><span class="nx">ltime</span><span class="p">)</span>
                    <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">onframe</span><span class="p">(</span><span class="nx">ltime</span><span class="p">)</span>
                    <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">prepare</span><span class="p">()))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>update gtime, if it was changed by ltime()</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">gtime</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gtime</span><span class="p">(</span><span class="nx">ltime</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">__mask</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>draw directly to context, if has no mask</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">visitChildren</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">elm</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">gtime</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>draw to back canvas, if has</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">__ensureHasMaskCanvas</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">mcvs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__maskCvs</span><span class="p">,</span>
                <span class="nx">mctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__maskCtx</span><span class="p">,</span>
                <span class="nx">bcvs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__backCvs</span><span class="p">,</span>
                <span class="nx">bctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__backCtx</span><span class="p">;</span>

            <span class="kd">var</span> <span class="nx">scene_width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">scene</span><span class="p">.</span><span class="nx">awidth</span><span class="p">,</span>
                <span class="nx">scene_height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">scene</span><span class="p">.</span><span class="nx">aheight</span><span class="p">,</span>
                <span class="nx">dbl_scene_width</span> <span class="o">=</span> <span class="nx">scene_width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                <span class="nx">dbl_scene_height</span> <span class="o">=</span> <span class="nx">scene_height</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>at this point:
mcvs.height is twice scene height
mcvs.width  is twice scene width</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">bctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
            <span class="nx">bctx</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dbl_scene_width</span><span class="p">,</span>
                                 <span class="nx">dbl_scene_height</span><span class="p">);</span>

            <span class="nx">bctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
            <span class="nx">bctx</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">scene_width</span><span class="p">,</span> <span class="nx">scene_height</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">bctx</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">visitChildren</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">elm</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">bctx</span><span class="p">,</span> <span class="nx">gtime</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">bctx</span><span class="p">);</span>
            <span class="nx">bctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
            <span class="nx">bctx</span><span class="p">.</span><span class="nx">globalCompositeOperation</span> <span class="o">=</span> <span class="s1">&#39;destination-in&#39;</span><span class="p">;</span>

            <span class="nx">mctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
            <span class="nx">mctx</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dbl_scene_width</span><span class="p">,</span>
                                 <span class="nx">dbl_scene_height</span><span class="p">);</span>
            <span class="nx">mctx</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">scene_width</span><span class="p">,</span> <span class="nx">scene_height</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">__mask</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">mctx</span><span class="p">,</span> <span class="nx">gtime</span><span class="p">);</span>
            <span class="nx">mctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>

            <span class="nx">bctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">mcvs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dbl_scene_width</span><span class="p">,</span>
                                       <span class="nx">dbl_scene_height</span><span class="p">);</span>
            <span class="nx">bctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>

            <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">bcvs</span><span class="p">,</span> <span class="o">-</span><span class="nx">scene_width</span><span class="p">,</span> <span class="o">-</span><span class="nx">scene_height</span><span class="p">,</span>
                          <span class="nx">dbl_scene_width</span><span class="p">,</span> <span class="nx">dbl_scene_height</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>immediately when drawn, element becomes visible,
it is reasonable</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="nx">wasDrawn</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__postRender</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">rendering</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">wasDrawn</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_DRAW</span><span class="p">,</span><span class="nx">ctx</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <blockquote>
  <p>Element.addModifier % (( configuration: Object,
                             modifier: Function(time: Float,
                                                data: Any) => Boolean)
                         | ( modifier: Function(time: Float,
                                              data: Any) => Boolean,
                             [easing: Function()],
                             [data: Any],
                             [priority: Int]
                          ) => Integer</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addModifier</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">modifier</span><span class="p">,</span> <span class="nx">easing</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">priority</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">__obj</span><span class="p">(</span><span class="nx">modifier</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>modifier is configuration here and easing is modifier factually</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">modifier</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">USER_MOD</span><span class="p">;</span> <span class="c1">// here, type should always be user-modifier</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__modify</span><span class="p">(</span><span class="nx">modifier</span><span class="p">,</span> <span class="nx">easing</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__modify</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">USER_MOD</span><span class="p">,</span>
                             <span class="nx">priority</span><span class="o">:</span> <span class="nx">priority</span><span class="p">,</span>
                             <span class="nx">easing</span><span class="o">:</span> <span class="nx">easing</span><span class="p">,</span>
                             <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span> <span class="p">},</span> <span class="nx">modifier</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <blockquote>
  <p>Element.addTModifier % (restriction: Array[Float, 2] | Float,
                            modifier: Function(time: Float,
                                               data: Any) => Boolean,
                            [easing: Function()],
                            [data: Any],
                            [priority: Int]
                           ) => Integer</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addTModifier</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">modifier</span><span class="p">,</span> <span class="nx">easing</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">priority</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__modify</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">USER_MOD</span><span class="p">,</span>
                           <span class="nx">priority</span><span class="o">:</span> <span class="nx">priority</span><span class="p">,</span>
                           <span class="nx">time</span><span class="o">:</span> <span class="nx">time</span><span class="p">,</span>
                           <span class="nx">easing</span><span class="o">:</span> <span class="nx">easing</span><span class="p">,</span>
                           <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span> <span class="p">},</span> <span class="nx">modifier</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <blockquote>
  <p>Element.addRModifier % (modifier: Function(time: Float,
                                              data: Any) => Boolean,
                            [easing: Function()],
                            [data: Any],
                            [priority: Int]
                           ) => Integer</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addRModifier</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">modifier</span><span class="p">,</span> <span class="nx">easing</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">priority</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__modify</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">USER_MOD</span><span class="p">,</span>
                           <span class="nx">priority</span><span class="o">:</span> <span class="nx">priority</span><span class="p">,</span>
                           <span class="nx">easing</span><span class="o">:</span> <span class="nx">easing</span><span class="p">,</span>
                           <span class="nx">relative</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                           <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span> <span class="p">},</span> <span class="nx">modifier</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <blockquote>
  <p>Element.addRTModifier % (restriction: Array[Float, 2] | Float,
                             modifier: Function(time: Float,
                                                data: Any) => Boolean,
                             [easing: Function()],
                             [data: Any],
                             [priority: Int]
                            ) => Integer</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addRTModifier</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">modifier</span><span class="p">,</span> <span class="nx">easing</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">priority</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__modify</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">USER_MOD</span><span class="p">,</span>
                           <span class="nx">priority</span><span class="o">:</span> <span class="nx">priority</span><span class="p">,</span>
                           <span class="nx">time</span><span class="o">:</span> <span class="nx">time</span><span class="p">,</span>
                           <span class="nx">easing</span><span class="o">:</span> <span class="nx">easing</span><span class="p">,</span>
                           <span class="nx">relative</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                           <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span> <span class="p">},</span> <span class="nx">modifier</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <blockquote>
  <p>Element.removeModifier % (modifier: Function)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeModifier</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">modifier</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">modifier</span><span class="p">.</span><span class="nx">__m_ids</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">MODIFIER_NOT_ATTACHED</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>if (this.__modifying) throw new AnimErr("Can't remove modifiers while modifying");</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">modifier</span><span class="p">.</span><span class="nx">__m_ids</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">id</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="s1">&#39;Modifier wasn\&#39;t applied to this element&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">TB</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">TYPE_MAX_BIT</span><span class="p">,</span>
        <span class="nx">PB</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">PRRT_MAX_BIT</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">id</span> <span class="o">&gt;&gt;</span> <span class="nx">TB</span><span class="p">,</span>
        <span class="nx">priority</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span> <span class="o">-</span> <span class="p">(</span><span class="nx">type</span> <span class="o">&lt;&lt;</span> <span class="nx">TB</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="nx">PB</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="nx">id</span> <span class="o">-</span> <span class="p">(</span><span class="nx">type</span> <span class="o">&lt;&lt;</span> <span class="nx">TB</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">priority</span> <span class="o">&lt;&lt;</span> <span class="nx">PB</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_modifiers</span><span class="p">[</span><span class="nx">type</span><span class="p">][</span><span class="nx">priority</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <blockquote>
  <p>Element.addPainter % (painter: Function(ctx: Context))
                          => Integer</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addPainter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">painter</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">priority</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__paint</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">USER_PNT</span><span class="p">,</span>
                          <span class="nx">priority</span><span class="o">:</span> <span class="nx">priority</span><span class="p">,</span>
                          <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span> <span class="p">},</span> <span class="nx">painter</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <blockquote>
  <p>Element.removePainter % (painter: Function)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removePainter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">painter</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">painter</span><span class="p">.</span><span class="nx">__p_ids</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="s1">&#39;Painter wasn\&#39;t applied to anything&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>if (this.__painting) throw new AnimErr("Can't remove painters while painting");</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">painter</span><span class="p">.</span><span class="nx">__p_ids</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">TB</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">TYPE_MAX_BIT</span><span class="p">,</span>
        <span class="nx">PB</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">PRRT_MAX_BIT</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">id</span> <span class="o">&gt;&gt;</span> <span class="nx">TB</span><span class="p">,</span>
        <span class="nx">priority</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span> <span class="o">-</span> <span class="p">(</span><span class="nx">type</span> <span class="o">&lt;&lt;</span> <span class="nx">TB</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="nx">PB</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="nx">id</span> <span class="o">-</span> <span class="p">(</span><span class="nx">type</span> <span class="o">&lt;&lt;</span> <span class="nx">TB</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">priority</span> <span class="o">&lt;&lt;</span> <span class="nx">PB</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_painters</span><span class="p">[</span><span class="nx">type</span><span class="p">][</span><span class="nx">priority</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <blockquote>
  <p>Element.addTween % (tween: Tween)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addTween</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tween</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">__addTweenModifier</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">tween</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <blockquote>
  <p>Element.changeTransform % (transform: Function(ctx: Context,
                                                    prev: Function(Context)))</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">changeTransform</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">transform</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">,</span> <span class="nx">new_</span><span class="p">,</span> <span class="nx">prev</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">new_</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">elm</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">prev</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="p">)(</span><span class="k">this</span><span class="p">,</span> <span class="nx">transform</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">transform</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <blockquote>
  <p>Element.add % (elem: Element | Clip)
  Element.add % (elems: Array[Element])
  Element.add % (draw: Function(ctx: Context),
                    onframe: Function(time: Float),
                    [ transform: Function(ctx: Context,
                                          prev: Function(Context)) ])
                    => Element</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arg1</span><span class="p">,</span> <span class="nx">arg2</span><span class="p">,</span> <span class="nx">arg3</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arg2</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// element by functions mode</span>
        <span class="kd">var</span> <span class="nx">_elm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">(</span><span class="nx">arg1</span><span class="p">,</span> <span class="nx">arg2</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">arg3</span><span class="p">)</span> <span class="nx">_elm</span><span class="p">.</span><span class="nx">changeTransform</span><span class="p">(</span><span class="nx">arg3</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_addChild</span><span class="p">(</span><span class="nx">_elm</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">_elm</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__array</span><span class="p">(</span><span class="nx">arg1</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// elements array mode</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_addChildren</span><span class="p">(</span><span class="nx">arg1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__builder</span><span class="p">(</span><span class="nx">arg1</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// builder instance</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_addChild</span><span class="p">(</span><span class="nx">arg1</span><span class="p">.</span><span class="nx">v</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// element object mode</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_addChild</span><span class="p">(</span><span class="nx">arg1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <blockquote>
  <p>Element.addS % (dimen: Array[Int, 2],
                    draw: Function(ctx: Context),
                    onframe: Function(time: Float),
                    [ transform: Function(ctx: Context,
                                          prev: Function(Context)) ])
                    => Element</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addS</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dimen</span><span class="p">,</span> <span class="nx">draw</span><span class="p">,</span> <span class="nx">onframe</span><span class="p">,</span> <span class="nx">transform</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_elm</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">draw</span><span class="p">,</span> <span class="nx">onframe</span><span class="p">,</span> <span class="nx">transform</span><span class="p">);</span>
    <span class="nx">_elm</span><span class="p">.</span><span class="nx">sprite</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">_elm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">dimen</span> <span class="o">=</span> <span class="nx">dimen</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">_elm</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__safeDetach</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">what</span><span class="p">,</span> <span class="nx">_cnt</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">_cnt</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">pos</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">what</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rendering</span> <span class="o">||</span> <span class="nx">what</span><span class="p">.</span><span class="nx">rendering</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">__detachQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">what</span><span class="cm">/*pos*/</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__unsafeToRemove</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">UNSAFE_TO_REMOVE</span><span class="p">);</span>
            <span class="nx">what</span><span class="p">.</span><span class="nx">_unbind</span><span class="p">();</span>
            <span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">visitChildren</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ielm</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">found</span> <span class="o">+=</span> <span class="nx">ielm</span><span class="p">.</span><span class="nx">__safeDetach</span><span class="p">(</span><span class="nx">what</span><span class="p">,</span> <span class="nx">found</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">found</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <blockquote>
  <p>Element.remove % (elm: Element)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">elm</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">NO_ELEMENT_TO_REMOVE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__safeDetach</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">NO_ELEMENT</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_unbind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">__unsafeToRemove</span> <span class="o">||</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">__unsafeToRemove</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">UNSAFE_TO_REMOVE</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scene</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">scene</span><span class="p">.</span><span class="nx">_unregister</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>this.scene should be null after unregistering</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <blockquote>
  <p>Element.detach % ()</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">detach</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">__safeDetach</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">ELEMENT_NOT_ATTACHED</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>make element band fit all children bands</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">makeBandFit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">wband</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">findWrapBand</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">gband</span> <span class="o">=</span> <span class="nx">wband</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">wband</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">wband</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setBand</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">band</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">lband</span> <span class="o">=</span> <span class="nx">band</span><span class="p">;</span>
    <span class="nx">Bands</span><span class="p">.</span><span class="nx">recalc</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scene</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">scene</span><span class="p">.</span><span class="nx">updateDuration</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>
<span class="cm">/* TODO: duration cut with global band */</span>
<span class="cm">/* Element.prototype.rel_duration = function() {</span>
<span class="cm">    return</span>
<span class="cm">} */</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_max_tpos</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">gband</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">gband</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* Element.prototype.neg_duration = function() {</span>
<span class="cm">    return (this.xdata.lband[0] &lt; 0)</span>
<span class="cm">            ? ((this.xdata.lband[1] &lt; 0) ? Math.abs(this.xdata.lband[0] + this.xdata.lband[1]) : Math.abs(this.xdata.lband[0]))</span>
<span class="cm">            : 0;</span>
<span class="cm">} */</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fits</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ltime</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ltime</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">__t_cmp</span><span class="p">(</span><span class="nx">ltime</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">gtime</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ltime</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">gband</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">ltime</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ltime</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gtime</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">C</span><span class="p">.</span><span class="nx">R_ONCE</span><span class="o">:</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__checkGJump</span><span class="p">(</span><span class="nx">gtime</span><span class="p">);</span>
        <span class="k">case</span> <span class="nx">C</span><span class="p">.</span><span class="nx">R_STAY</span><span class="o">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="nx">__t_cmp</span><span class="p">(</span><span class="nx">gtime</span><span class="p">,</span> <span class="nx">x</span><span class="p">.</span><span class="nx">gband</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
                   <span class="o">?</span> <span class="p">(</span><span class="nx">gtime</span> <span class="o">-</span> <span class="nx">x</span><span class="p">.</span><span class="nx">gband</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                   <span class="o">:</span> <span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">x</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">case</span> <span class="nx">C</span><span class="p">.</span><span class="nx">R_LOOP</span><span class="o">:</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">durtn</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                            <span class="nx">x</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="nx">pdurtn</span> <span class="o">=</span> <span class="nx">p</span>
                        <span class="o">?</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                           <span class="nx">p</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="o">:</span> <span class="nx">durtn</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">durtn</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">times</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">pdurtn</span> <span class="o">/</span> <span class="nx">durtn</span><span class="p">),</span>
                    <span class="nx">fits</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">gtime</span> <span class="o">-</span> <span class="nx">x</span><span class="p">.</span><span class="nx">gband</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nx">durtn</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">fits</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">gtime</span> <span class="o">-</span> <span class="nx">x</span><span class="p">.</span><span class="nx">gband</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="nx">fits</span> <span class="o">*</span> <span class="nx">durtn</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">fits</span> <span class="o">&lt;=</span> <span class="nx">times</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">__checkJump</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="nx">C</span><span class="p">.</span><span class="nx">R_BOUNCE</span><span class="o">:</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">durtn</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                            <span class="nx">x</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="nx">pdurtn</span> <span class="o">=</span> <span class="nx">p</span>
                        <span class="o">?</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                           <span class="nx">p</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="o">:</span> <span class="nx">durtn</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">durtn</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">times</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">pdurtn</span> <span class="o">/</span> <span class="nx">durtn</span><span class="p">),</span>
                    <span class="nx">fits</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">gtime</span> <span class="o">-</span> <span class="nx">x</span><span class="p">.</span><span class="nx">gband</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nx">durtn</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">fits</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">gtime</span> <span class="o">-</span> <span class="nx">x</span><span class="p">.</span><span class="nx">gband</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="nx">fits</span> <span class="o">*</span> <span class="nx">durtn</span><span class="p">),</span>
                    <span class="nx">t</span> <span class="o">=</span> <span class="p">((</span><span class="nx">fits</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">t</span> <span class="o">:</span> <span class="nx">durtn</span> <span class="o">-</span> <span class="nx">t</span><span class="p">;</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">fits</span> <span class="o">&lt;=</span> <span class="nx">times</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">__checkJump</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">m_on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__modify</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">EVENT_MOD</span> <span class="p">},</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* FIXME: handlers must have priority? */</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__evt_st</span> <span class="o">&amp;</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">evts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__evts</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">evts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">handler</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">evts</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">t</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="cm">/*Element.prototype.posAtStart = function(ctx) {</span>
<span class="cm">    var s = this.state;</span>
<span class="cm">    ctx.translate(s.lx, s.ly);</span>
<span class="cm">    ctx.scale(s.sx, s.sy);</span>
<span class="cm">    ctx.rotate(s.angle);</span>
<span class="cm">}*/</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>calculates band that fits all child elements, recursively</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* FIXME: test */</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">findWrapBand</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">gband</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">MAX_VALUE</span><span class="p">,</span> <span class="mi">0</span> <span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visitChildren</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">Bands</span><span class="p">.</span><span class="nx">expand</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">findWrapBand</span><span class="p">());</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">MAX_VALUE</span><span class="p">)</span> <span class="o">?</span> <span class="nx">result</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dispose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">disposeHandlers</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visitChildren</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">elm</span><span class="p">.</span><span class="nx">dispose</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__resetState</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__lastJump</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__mask</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">__removeMaskCanvases</span><span class="p">();</span>
    <span class="cm">/*this.__clearEvtState();*/</span>
    <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">elm</span><span class="p">.</span><span class="nx">__forAllModifiers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">modifier</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">modifier</span><span class="p">.</span><span class="nx">__wasCalled</span><span class="p">)</span> <span class="nx">modifier</span><span class="p">.</span><span class="nx">__wasCalled</span><span class="p">[</span><span class="nx">elm</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">modifier</span><span class="p">.</span><span class="nx">__wasCalledAt</span><span class="p">)</span> <span class="nx">modifier</span><span class="p">.</span><span class="nx">__wasCalledAt</span><span class="p">[</span><span class="nx">elm</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">})(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visitChildren</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">elm</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">visitChildren</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__unsafeToRemove</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">ei</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">el</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">ei</span> <span class="o">&lt;</span> <span class="nx">el</span><span class="p">;</span> <span class="nx">ei</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">func</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">ei</span><span class="p">]);</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__unsafeToRemove</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">travelChildren</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__unsafeToRemove</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">ei</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">el</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">ei</span> <span class="o">&lt;</span> <span class="nx">el</span><span class="p">;</span> <span class="nx">ei</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">ei</span><span class="p">];</span>
        <span class="nx">func</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
        <span class="nx">elem</span><span class="p">.</span><span class="nx">travelChildren</span><span class="p">(</span><span class="nx">func</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__unsafeToRemove</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">iterateChildren</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">rfunc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__unsafeToRemove</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">iter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">rfunc</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__unsafeToRemove</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deepIterateChildren</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">rfunc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__unsafeToRemove</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">iter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">elem</span><span class="p">.</span><span class="nx">deepIterateChildren</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">rfunc</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">func</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">rfunc</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__unsafeToRemove</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__performDetach</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
    <span class="nx">iter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__detachQueue</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">idx</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">elm</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="nx">elm</span><span class="p">.</span><span class="nx">_unbind</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__detachQueue</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clear</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__unsafeToRemove</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">UNSAFE_TO_REMOVE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">rendering</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">iter</span><span class="p">(</span><span class="nx">children</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">_unbind</span><span class="p">();</span> <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">__detachQueue</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__detachQueue</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">lock</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__jumpLock</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__lstate</span> <span class="o">=</span> <span class="nx">obj_clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__pstate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_state</span> <span class="o">?</span> <span class="nx">obj_clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_state</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">unlock</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__lstate</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__pstate</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__lstate</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__jumpLock</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stateAt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* FIXME: test */</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lock</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">success</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__callModifiers</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">NOEVT_MODIFIERS</span><span class="p">,</span> <span class="nx">t</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">unlock</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">success</span> <span class="o">?</span> <span class="nx">state</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">xsum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ysum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ps</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
        <span class="nx">xsum</span> <span class="o">+=</span> <span class="nx">ps</span><span class="p">.</span><span class="nx">lx</span> <span class="o">+</span> <span class="nx">ps</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
        <span class="nx">ysum</span> <span class="o">+=</span> <span class="nx">ps</span><span class="p">.</span><span class="nx">ly</span> <span class="o">+</span> <span class="nx">ps</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
        <span class="nx">p</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span> <span class="nx">xsum</span><span class="p">,</span> <span class="nx">ysum</span> <span class="p">];</span>
<span class="p">}</span>
<span class="cm">/*Element.prototype.local = function(pt) {</span>
<span class="cm">    var off = this.offset();</span>
<span class="cm">    return [ pt[0] - off[0], pt[1] - off[1] ];</span>
<span class="cm">}</span>
<span class="cm">Element.prototype.global = function(pt) {</span>
<span class="cm">    var off = this.offset();</span>
<span class="cm">    return [ pt[0] + off[0], pt[1] + off[1] ];</span>
<span class="cm">}*/</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">lbounds</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">__bounds</span><span class="p">)</span> <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">__bounds</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">bounds</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">bounds</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">bounds</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">image</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">bounds</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">x</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">x</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">height</span> <span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">bounds</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">bounds</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">bounds</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">lrect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lbounds</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">b</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>returns clockwise coordinates of the points
for easier drawing
minX, minY, maxX, minY,</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="p">[</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>maxX, maxY, minX, maxY</p>             </td>             <td class="code">               <div class="highlight"><pre>             <span class="nx">b</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">];</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setMask</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">elm</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="s1">&#39;No valid masking element was passed&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scene</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">__ensureHasMaskCanvas</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__mask</span> <span class="o">=</span> <span class="nx">elm</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__ensureHasMaskCanvas</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__maskCvs</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">__backCvs</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">scene</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">scene</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">scene</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="s1">&#39;Element to be masked should be attached to scene when rendering&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__maskCvs</span> <span class="o">=</span> <span class="nx">newCanvas</span><span class="p">([</span><span class="nx">scene</span><span class="p">.</span><span class="nx">awidth</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">aheight</span> <span class="o">*</span> <span class="mi">2</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">ratio</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__maskCtx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__maskCvs</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__backCvs</span> <span class="o">=</span> <span class="nx">newCanvas</span><span class="p">([</span><span class="nx">scene</span><span class="p">.</span><span class="nx">awidth</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">aheight</span> <span class="o">*</span> <span class="mi">2</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">ratio</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__backCtx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__backCvs</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
    <span class="cm">/* document.body.appendChild(this.__maskCvs); */</span>
    <span class="cm">/* document.body.appendChild(this.__backCvs); */</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__removeMaskCanvases</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__maskCvs</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">disposeElm</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__maskCvs</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">__maskCvs</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">__maskCtx</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__backCvs</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">disposeElm</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__backCvs</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">__backCvs</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">__backCtx</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clearMask</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__mask</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__removeMaskCanvases</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">val</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__data</span> <span class="o">=</span> <span class="nx">val</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__data</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;[ Element &#39;</span> <span class="p">];</span>
    <span class="nx">buf</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;\&#39;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;\&#39; &#39;</span><span class="p">);</span>
    <span class="cm">/*if (this.children.length &gt; 0) {</span>
<span class="cm">        buf.push(&#39;( &#39;);</span>
<span class="cm">        this.visitChildren(function(child) {</span>
<span class="cm">            buf.push(child.toString() + &#39;, &#39;);</span>
<span class="cm">        });</span>
<span class="cm">        buf.push(&#39;) &#39;);</span>
<span class="cm">    }</span>
<span class="cm">    if (this.parent) {</span>
<span class="cm">        buf.push(&#39;&lt; \&#39;&#39; + (this.parent.name || this.parent.id) + &#39;\&#39; &gt; &#39;);</span>
<span class="cm">    }*/</span>
    <span class="nx">buf</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clone</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">clone</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Element</span><span class="p">();</span>
    <span class="nx">clone</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
    <span class="nx">clone</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">);</span>
    <span class="nx">clone</span><span class="p">.</span><span class="nx">sprite</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sprite</span><span class="p">;</span>
    <span class="nx">clone</span><span class="p">.</span><span class="nx">sheet</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sheet</span><span class="p">;</span>
    <span class="nx">clone</span><span class="p">.</span><span class="nx">_modifiers</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_modifiers</span><span class="p">);</span>
    <span class="nx">clone</span><span class="p">.</span><span class="nx">_painters</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_painters</span><span class="p">);</span>
    <span class="nx">clone</span><span class="p">.</span><span class="nx">xdata</span> <span class="o">=</span> <span class="nx">obj_clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">);</span>
    <span class="nx">clone</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">$</span> <span class="o">=</span> <span class="nx">clone</span><span class="p">;</span>
    <span class="nx">clone</span><span class="p">.</span><span class="nx">__data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__data</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">clone</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deepClone</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">clone</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
    <span class="nx">clone</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">src_children</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">trg_children</span> <span class="o">=</span> <span class="nx">clone</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">sci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">scl</span> <span class="o">=</span> <span class="nx">src_children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">sci</span> <span class="o">&lt;</span> <span class="nx">scl</span><span class="p">;</span> <span class="nx">sci</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">csrc</span> <span class="o">=</span> <span class="nx">src_children</span><span class="p">[</span><span class="nx">sci</span><span class="p">],</span>
            <span class="nx">cclone</span> <span class="o">=</span> <span class="nx">csrc</span><span class="p">.</span><span class="nx">deepClone</span><span class="p">();</span>
        <span class="nx">cclone</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">clone</span><span class="p">;</span>
        <span class="nx">trg_children</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cclone</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">clone</span><span class="p">.</span><span class="nx">_modifiers</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="cm">/* FIXME: use __forAllModifiers &amp; __forAllPainters */</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>loop through type</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">mti</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">mtl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_modifiers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">mti</span> <span class="o">&lt;</span> <span class="nx">mtl</span><span class="p">;</span> <span class="nx">mti</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">type_group</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_modifiers</span><span class="p">[</span><span class="nx">mti</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">type_group</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="nx">clone</span><span class="p">.</span><span class="nx">_modifiers</span><span class="p">[</span><span class="nx">mti</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>loop through priority</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">mpi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">mpl</span> <span class="o">=</span> <span class="nx">type_group</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">mpi</span> <span class="o">&lt;</span> <span class="nx">mpl</span><span class="p">;</span> <span class="nx">mpi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">priority_group</span> <span class="o">=</span> <span class="nx">type_group</span><span class="p">[</span><span class="nx">mpi</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">priority_group</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
            <span class="nx">clone</span><span class="p">.</span><span class="nx">_modifiers</span><span class="p">[</span><span class="nx">mti</span><span class="p">][</span><span class="nx">mpi</span><span class="p">]</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">priority_group</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">mi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ml</span> <span class="o">=</span> <span class="nx">priority_group</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">mi</span> <span class="o">&lt;</span> <span class="nx">ml</span><span class="p">;</span> <span class="nx">mi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">modifier</span> <span class="o">=</span> <span class="nx">priority_group</span><span class="p">[</span><span class="nx">mi</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">modifier</span> <span class="o">&amp;&amp;</span> <span class="nx">modifier</span><span class="p">.</span><span class="nx">__m_ids</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">modifier</span><span class="p">.</span><span class="nx">__m_ids</span><span class="p">[</span><span class="nx">clone</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">modifier</span><span class="p">.</span><span class="nx">__m_ids</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">clone</span><span class="p">.</span><span class="nx">_painters</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>loop through type</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">pti</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ptl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_painters</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">pti</span> <span class="o">&lt;</span> <span class="nx">ptl</span><span class="p">;</span> <span class="nx">pti</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">type_group</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_painters</span><span class="p">[</span><span class="nx">pti</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">type_group</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="nx">clone</span><span class="p">.</span><span class="nx">_painters</span><span class="p">[</span><span class="nx">pti</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>loop through priority</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">ppi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ppl</span> <span class="o">=</span> <span class="nx">type_group</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">ppi</span> <span class="o">&lt;</span> <span class="nx">ppl</span><span class="p">;</span> <span class="nx">ppi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">priority_group</span> <span class="o">=</span> <span class="nx">type_group</span><span class="p">[</span><span class="nx">ppi</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">priority_group</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
            <span class="nx">clone</span><span class="p">.</span><span class="nx">_painters</span><span class="p">[</span><span class="nx">pti</span><span class="p">][</span><span class="nx">ppi</span><span class="p">]</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">priority_group</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pl</span> <span class="o">=</span> <span class="nx">priority_group</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">pi</span> <span class="o">&lt;</span> <span class="nx">pl</span><span class="p">;</span> <span class="nx">pi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">painter</span> <span class="o">=</span> <span class="nx">priority_group</span><span class="p">[</span><span class="nx">pi</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">painter</span> <span class="o">&amp;&amp;</span> <span class="nx">painter</span><span class="p">.</span><span class="nx">__p_ids</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">painter</span><span class="p">.</span><span class="nx">__p_ids</span><span class="p">[</span><span class="nx">clone</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">painter</span><span class="p">.</span><span class="nx">__p_ids</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">clone</span><span class="p">.</span><span class="nx">__data</span> <span class="o">=</span> <span class="nx">obj_clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__data</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">src_x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">,</span>
        <span class="nx">trg_x</span> <span class="o">=</span> <span class="nx">clone</span><span class="p">.</span><span class="nx">xdata</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">src_x</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="nx">trg_x</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">src_x</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
    <span class="cm">/* if (src_x.image) trg_x.image = src_x.image.clone(); */</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">src_x</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span> <span class="nx">trg_x</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">src_x</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
    <span class="nx">trg_x</span><span class="p">.</span><span class="nx">pos</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">src_x</span><span class="p">.</span><span class="nx">pos</span><span class="p">);</span>
    <span class="nx">trg_x</span><span class="p">.</span><span class="nx">reg</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">src_x</span><span class="p">.</span><span class="nx">reg</span><span class="p">);</span>
    <span class="nx">trg_x</span><span class="p">.</span><span class="nx">lband</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">src_x</span><span class="p">.</span><span class="nx">lband</span><span class="p">);</span>
    <span class="nx">trg_x</span><span class="p">.</span><span class="nx">gband</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">src_x</span><span class="p">.</span><span class="nx">gband</span><span class="p">);</span>
    <span class="nx">trg_x</span><span class="p">.</span><span class="nx">keys</span> <span class="o">=</span> <span class="nx">obj_clone</span><span class="p">(</span><span class="nx">src_x</span><span class="p">.</span><span class="nx">keys</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">clone</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_addChild</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">elm</span><span class="p">);</span> <span class="cm">/* or add elem.id? */</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scene</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">scene</span><span class="p">.</span><span class="nx">_register</span><span class="p">(</span><span class="nx">elm</span><span class="p">);</span> <span class="cm">/* TODO: rollback parent and child? */</span>
    <span class="nx">Bands</span><span class="p">.</span><span class="nx">recalc</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_addChildren</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elms</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">ei</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">el</span> <span class="o">=</span> <span class="nx">elms</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">ei</span> <span class="o">&lt;</span> <span class="nx">el</span><span class="p">;</span> <span class="nx">ei</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_addChild</span><span class="p">(</span><span class="nx">elms</span><span class="p">[</span><span class="nx">ei</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_drawToCache</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">dim</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">dimen</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sheet</span><span class="p">)</span> <span class="nx">dim</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">height</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">_canvas</span> <span class="o">=</span> <span class="nx">newCanvas</span><span class="p">(</span><span class="nx">dim</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">ratio</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">_ctx</span> <span class="o">=</span> <span class="nx">_canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">drawTo</span><span class="p">(</span><span class="nx">_ctx</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="nx">_canvas</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_stateStr</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
    <span class="k">return</span> <span class="s2">&quot;x: &quot;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot; y: &quot;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span>
           <span class="s2">&quot;lx: &quot;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">lx</span> <span class="o">+</span> <span class="s2">&quot; ly: &quot;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ly</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span>
           <span class="s2">&quot;rx: &quot;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">rx</span> <span class="o">+</span> <span class="s2">&quot; ry: &quot;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ry</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span>
           <span class="s2">&quot;sx: &quot;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">sx</span> <span class="o">+</span> <span class="s2">&quot; sy: &quot;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">sy</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span>
           <span class="s2">&quot;angle: &quot;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">angle</span> <span class="o">+</span> <span class="s2">&quot; alpha: &quot;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">alpha</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span>
           <span class="s2">&quot;p: &quot;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">p</span> <span class="o">+</span> <span class="s2">&quot; t: &quot;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">t</span> <span class="o">+</span> <span class="s2">&quot; key: &quot;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__adaptModTime</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ltime</span><span class="p">,</span> <span class="nx">conf</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">modifier</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">lband</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">lband</span><span class="p">,</span>
      <span class="nx">elm_duration</span> <span class="o">=</span> <span class="nx">lband</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">lband</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">easing</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">easing</span><span class="p">,</span>
      <span class="nx">time</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">time</span><span class="p">,</span> <span class="c1">// time or band of the modifier, if set</span>
      <span class="nx">relative</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">relative</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">_tpair</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">time</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_tpair</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">relative</span>
                     <span class="o">?</span> <span class="nx">__adjust</span><span class="p">(</span><span class="nx">ltime</span><span class="p">)</span> <span class="o">/</span> <span class="nx">__adjust</span><span class="p">(</span><span class="nx">elm_duration</span><span class="p">)</span>
                     <span class="o">:</span> <span class="nx">__adjust</span><span class="p">(</span><span class="nx">ltime</span><span class="p">),</span>
                 <span class="nx">__adjust</span><span class="p">(</span><span class="nx">elm_duration</span><span class="p">)</span> <span class="p">];</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__array</span><span class="p">(</span><span class="nx">time</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// modifier is band-restricted</span>
      <span class="kd">var</span> <span class="nx">band</span> <span class="o">=</span> <span class="nx">time</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">relative</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">mod_duration</span> <span class="o">=</span> <span class="nx">band</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">band</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">__t_cmp</span><span class="p">(</span><span class="nx">ltime</span><span class="p">,</span> <span class="nx">band</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">__t_cmp</span><span class="p">(</span><span class="nx">ltime</span><span class="p">,</span> <span class="nx">band</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nx">_tpair</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">__adjust</span><span class="p">(</span><span class="nx">ltime</span> <span class="o">-</span> <span class="nx">band</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                     <span class="nx">__adjust</span><span class="p">(</span><span class="nx">mod_duration</span><span class="p">)</span> <span class="p">];</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">abs_band</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">band</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">elm_duration</span><span class="p">,</span>
                           <span class="nx">band</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">elm_duration</span> <span class="p">];</span>
          <span class="kd">var</span> <span class="nx">mod_duration</span> <span class="o">=</span> <span class="nx">abs_band</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">abs_band</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">__t_cmp</span><span class="p">(</span><span class="nx">ltime</span><span class="p">,</span> <span class="nx">abs_band</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">__t_cmp</span><span class="p">(</span><span class="nx">ltime</span><span class="p">,</span> <span class="nx">abs_band</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nx">_tpair</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">__adjust</span><span class="p">(</span><span class="nx">ltime</span> <span class="o">-</span> <span class="nx">abs_band</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nx">__adjust</span><span class="p">(</span><span class="nx">mod_duration</span><span class="p">),</span>
                     <span class="nx">__adjust</span><span class="p">(</span><span class="nx">mod_duration</span><span class="p">)</span> <span class="p">];</span>
      <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">__num</span><span class="p">(</span><span class="nx">time</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">modifier</span><span class="p">.</span><span class="nx">__wasCalled</span> <span class="o">&amp;&amp;</span> <span class="nx">modifier</span><span class="p">.</span><span class="nx">__wasCalled</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">])</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">tpos</span> <span class="o">=</span> <span class="nx">relative</span> <span class="o">?</span> <span class="p">(</span><span class="nx">time</span> <span class="o">*</span> <span class="nx">elm_duration</span><span class="p">)</span> <span class="o">:</span> <span class="nx">time</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">__t_cmp</span><span class="p">(</span><span class="nx">ltime</span><span class="p">,</span> <span class="nx">tpos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">modifier</span><span class="p">.</span><span class="nx">__wasCalled</span><span class="p">)</span> <span class="nx">modifier</span><span class="p">.</span><span class="nx">__wasCalled</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">modifier</span><span class="p">.</span><span class="nx">__wasCalledAt</span><span class="p">)</span> <span class="nx">modifier</span><span class="p">.</span><span class="nx">__wasCalledAt</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="nx">modifier</span><span class="p">.</span><span class="nx">__wasCalled</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="nx">modifier</span><span class="p">.</span><span class="nx">__wasCalledAt</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ltime</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">_tpair</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">relative</span>
                     <span class="o">?</span> <span class="nx">__adjust</span><span class="p">(</span><span class="nx">ltime</span><span class="p">)</span> <span class="o">/</span> <span class="nx">__adjust</span><span class="p">(</span><span class="nx">elm_duration</span><span class="p">)</span>
                     <span class="o">:</span> <span class="nx">__adjust</span><span class="p">(</span><span class="nx">ltime</span><span class="p">),</span>
                 <span class="nx">__adjust</span><span class="p">(</span><span class="nx">elm_duration</span><span class="p">)</span> <span class="p">];</span>
  <span class="p">}</span> <span class="k">else</span> <span class="nx">_tpair</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">relative</span>
                        <span class="o">?</span> <span class="nx">__adjust</span><span class="p">(</span><span class="nx">ltime</span><span class="p">)</span> <span class="o">/</span> <span class="nx">__adjust</span><span class="p">(</span><span class="nx">elm_duration</span><span class="p">)</span>
                        <span class="o">:</span> <span class="nx">__adjust</span><span class="p">(</span><span class="nx">ltime</span><span class="p">),</span>
                    <span class="nx">__adjust</span><span class="p">(</span><span class="nx">elm_duration</span><span class="p">)</span> <span class="p">];</span>
  <span class="k">return</span> <span class="o">!</span><span class="nx">easing</span> <span class="o">?</span> <span class="nx">_tpair</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">easing</span><span class="p">(</span><span class="nx">_tpair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">_tpair</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nx">_tpair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">];</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__callModifiers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">order</span><span class="p">,</span> <span class="nx">ltime</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>save the previous state</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">elm</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">_</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// clear the pointer, so it will not be cloned</span>
        <span class="nx">elm</span><span class="p">.</span><span class="nx">_state</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">createState</span><span class="p">(</span><span class="nx">elm</span><span class="p">);</span>
        <span class="nx">elm</span><span class="p">.</span><span class="nx">_state</span><span class="p">.</span><span class="nx">_</span> <span class="o">=</span> <span class="nx">obj_clone</span><span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">state</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>now it looks like:</p>

<pre><code>this.
    .state    -&gt; state from the last modifiers call
    ._state   -&gt; clone of the last state, it is passed to modifiers as `this`
    ._state._ -&gt; a pointer to the last state, so it will be accessible in
                 modifiers as `this._`
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">elm</span><span class="p">.</span><span class="nx">__loadEvts</span><span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">_state</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">elm</span><span class="p">.</span><span class="nx">__forAllModifiers</span><span class="p">(</span><span class="nx">order</span><span class="p">,</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">modifier</span><span class="p">,</span> <span class="nx">conf</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* each modifier */</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>lbtime is band-apadted time, if modifier has its own band</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">lbtime</span> <span class="o">=</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">__adaptModTime</span><span class="p">(</span><span class="nx">ltime</span><span class="p">,</span> <span class="nx">conf</span><span class="p">,</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">_state</span><span class="p">,</span> <span class="nx">modifier</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p><code>false</code> will be returned from <code>__adaptModTime</code>
for trigger-like modifier if it is required to skip current one,
on the other hand <code>true</code> in <code>forAllModifiers</code> means
"skip this one, but not finish the whole process",
FIXME: this unobvious line</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">lbtime</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>modifier will return false if it is required to skip all next modifiers,
returning false from our function means the same</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">return</span> <span class="nx">modifier</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">_state</span><span class="p">,</span> <span class="nx">lbtime</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">lbtime</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
            <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* before each new type */</span>
                <span class="nx">elm</span><span class="p">.</span><span class="nx">__modifying</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
                <span class="nx">elm</span><span class="p">.</span><span class="nx">__mbefore</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
            <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* after each new type */</span>
                <span class="nx">elm</span><span class="p">.</span><span class="nx">__mafter</span><span class="p">(</span><span class="nx">ltime</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
            <span class="p">}))</span> <span class="p">{</span> <span class="c1">// one of modifiers returned false</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>forget things...</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">elm</span><span class="p">.</span><span class="nx">__mafter</span><span class="p">(</span><span class="nx">ltime</span><span class="p">,</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">__modifying</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
                <span class="nx">elm</span><span class="p">.</span><span class="nx">__modifying</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="nx">elm</span><span class="p">.</span><span class="nx">__clearEvts</span><span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">_state</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>NB: nothing happens to the state or element here,
    the modified things are not applied</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// ...and get out of the function</span>
            <span class="p">};</span>

        <span class="nx">elm</span><span class="p">.</span><span class="nx">__modifying</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="nx">elm</span><span class="p">.</span><span class="nx">_state</span><span class="p">.</span><span class="nx">_applied</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">elm</span><span class="p">.</span><span class="nx">_state</span><span class="p">.</span><span class="nx">_appliedAt</span> <span class="o">=</span> <span class="nx">ltime</span><span class="p">;</span>

        <span class="nx">elm</span><span class="p">.</span><span class="nx">__clearEvts</span><span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">_state</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>save modified state as last</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">elm</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">_state</span><span class="p">;</span>
        <span class="nx">elm</span><span class="p">.</span><span class="nx">_state</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>state._ keeps pointing to prev state</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>apply last state</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">})(</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__callPainters</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">order</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">elm</span><span class="p">.</span><span class="nx">__forAllPainters</span><span class="p">(</span><span class="nx">order</span><span class="p">,</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">painter</span><span class="p">,</span> <span class="nx">conf</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* each painter */</span>
                <span class="nx">painter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">xdata</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
            <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* before each new type */</span>
                <span class="nx">elm</span><span class="p">.</span><span class="nx">__painting</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
                <span class="nx">elm</span><span class="p">.</span><span class="nx">__pbefore</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">type</span><span class="p">);</span>
            <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* after each new type */</span>
                <span class="nx">elm</span><span class="p">.</span><span class="nx">__pafter</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">type</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="nx">elm</span><span class="p">.</span><span class="nx">__painting</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">})(</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>Element.prototype.__addTypedModifier = function(type, priority, band, modifier, easing, data) {</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__addTypedModifier</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conf</span><span class="p">,</span> <span class="nx">modifier</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">modifier</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">NO_MODIFIER_PASSED</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">modifiers</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_modifiers</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">elm_id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">modifier</span><span class="p">.</span><span class="nx">__m_ids</span><span class="p">)</span> <span class="nx">modifier</span><span class="p">.</span><span class="nx">__m_ids</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">modifier</span><span class="p">.</span><span class="nx">__m_ids</span><span class="p">[</span><span class="nx">elm_id</span><span class="p">])</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">MODIFIER_REGISTERED</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">priority</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">priority</span> <span class="o">||</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">modifiers</span><span class="p">[</span><span class="nx">type</span><span class="p">])</span> <span class="nx">modifiers</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">modifiers</span><span class="p">[</span><span class="nx">type</span><span class="p">][</span><span class="nx">priority</span><span class="p">])</span> <span class="nx">modifiers</span><span class="p">[</span><span class="nx">type</span><span class="p">][</span><span class="nx">priority</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">modifiers</span><span class="p">[</span><span class="nx">type</span><span class="p">][</span><span class="nx">priority</span><span class="p">].</span><span class="nx">push</span><span class="p">([</span> <span class="nx">modifier</span><span class="p">,</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span> <span class="c1">// configuration is cloned for safety</span>
                                                 <span class="nx">priority</span><span class="o">:</span> <span class="nx">priority</span><span class="p">,</span>
                                                 <span class="nx">time</span><span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">time</span><span class="p">,</span>
                                                 <span class="nx">relative</span><span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">relative</span><span class="p">,</span>
                                                 <span class="nx">easing</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">__convertEasing</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">easing</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">relative</span><span class="p">),</span>
                                                 <span class="nx">data</span><span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">data</span> <span class="p">}</span> <span class="p">]);</span>
    <span class="nx">modifier</span><span class="p">.</span><span class="nx">__m_ids</span><span class="p">[</span><span class="nx">elm_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">type</span> <span class="o">&lt;&lt;</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">TYPE_MAX_BIT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">priority</span> <span class="o">&lt;&lt;</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">PRRT_MAX_BIT</span><span class="p">)</span> <span class="o">|</span>
                               <span class="p">(</span><span class="nx">modifiers</span><span class="p">[</span><span class="nx">type</span><span class="p">][</span><span class="nx">priority</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">modifier</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__modify</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__addTypedModifier</span><span class="p">;</span> <span class="c1">// quick alias</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__forAllModifiers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">order</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">before_type</span><span class="p">,</span> <span class="nx">after_type</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">modifiers</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_modifiers</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">seq</span><span class="p">,</span> <span class="nx">cur</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">typenum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">order</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
         <span class="nx">typenum</span> <span class="o">&lt;</span> <span class="nx">last</span><span class="p">;</span> <span class="nx">typenum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="nx">order</span><span class="p">[</span><span class="nx">typenum</span><span class="p">];</span>
        <span class="nx">seq</span> <span class="o">=</span> <span class="nx">modifiers</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">before_type</span><span class="p">)</span> <span class="nx">before_type</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">seq</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pl</span> <span class="o">=</span> <span class="nx">seq</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">pi</span> <span class="o">&lt;</span> <span class="nx">pl</span><span class="p">;</span> <span class="nx">pi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// by priority</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span> <span class="o">=</span> <span class="nx">seq</span><span class="p">[</span><span class="nx">pi</span><span class="p">])</span> <span class="p">{</span>
              <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">ci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cl</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">ci</span> <span class="o">&lt;</span> <span class="nx">cl</span><span class="p">;</span> <span class="nx">ci</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">modifier</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">modifier</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">[</span><span class="nx">ci</span><span class="p">])</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">modifier</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">modifier</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span> <span class="cm">/* if cur[ci] */</span>
              <span class="p">}</span> <span class="cm">/* for var ci */</span>
            <span class="p">}</span> <span class="cm">/* if cur = seq[pi] */</span>
          <span class="p">}</span> <span class="cm">/* for var pi */</span>
        <span class="p">}</span> <span class="cm">/* if seq */</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">after_type</span><span class="p">)</span> <span class="nx">after_type</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__addTypedPainter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conf</span><span class="p">,</span> <span class="nx">painter</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">painter</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">NO_PAINTER_PASSED</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">painters</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_painters</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">elm_id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">painter</span><span class="p">.</span><span class="nx">__p_ids</span><span class="p">)</span> <span class="nx">painter</span><span class="p">.</span><span class="nx">__p_ids</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">painter</span><span class="p">.</span><span class="nx">__p_ids</span><span class="p">[</span><span class="nx">elm_id</span><span class="p">])</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">PAINTER_REGISTERED</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">priority</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">priority</span> <span class="o">||</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">painters</span><span class="p">[</span><span class="nx">type</span><span class="p">])</span> <span class="nx">painters</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">painters</span><span class="p">[</span><span class="nx">type</span><span class="p">][</span><span class="nx">priority</span><span class="p">])</span> <span class="nx">painters</span><span class="p">[</span><span class="nx">type</span><span class="p">][</span><span class="nx">priority</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">painters</span><span class="p">[</span><span class="nx">type</span><span class="p">][</span><span class="nx">priority</span><span class="p">].</span><span class="nx">push</span><span class="p">([</span> <span class="nx">painter</span><span class="p">,</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span> <span class="c1">// configuration is cloned for safety</span>
                                               <span class="nx">priority</span><span class="o">:</span> <span class="nx">priority</span><span class="p">,</span>
                                               <span class="nx">data</span><span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">data</span> <span class="p">}</span> <span class="p">]);</span>
    <span class="nx">painter</span><span class="p">.</span><span class="nx">__p_ids</span><span class="p">[</span><span class="nx">elm_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">type</span> <span class="o">&lt;&lt;</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">TYPE_MAX_BIT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nx">priority</span> <span class="o">&lt;&lt;</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">PRRT_MAX_BIT</span><span class="p">)</span> <span class="o">|</span>
                              <span class="p">(</span><span class="nx">painters</span><span class="p">[</span><span class="nx">type</span><span class="p">][</span><span class="nx">priority</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">painter</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__paint</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__addTypedPainter</span><span class="p">;</span> <span class="c1">// quick alias</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__forAllPainters</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">order</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">before_type</span><span class="p">,</span> <span class="nx">after_type</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">painters</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_painters</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">seq</span><span class="p">,</span> <span class="nx">cur</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">typenum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">order</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
         <span class="nx">typenum</span> <span class="o">&lt;</span> <span class="nx">last</span><span class="p">;</span> <span class="nx">typenum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="nx">order</span><span class="p">[</span><span class="nx">typenum</span><span class="p">];</span>
        <span class="nx">seq</span> <span class="o">=</span> <span class="nx">painters</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">before_type</span><span class="p">)</span> <span class="nx">before_type</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">seq</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pl</span> <span class="o">=</span> <span class="nx">seq</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">pi</span> <span class="o">&lt;</span> <span class="nx">pl</span><span class="p">;</span> <span class="nx">pi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// by priority</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span> <span class="o">=</span> <span class="nx">seq</span><span class="p">[</span><span class="nx">pi</span><span class="p">])</span> <span class="p">{</span>
              <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">ci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cl</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">ci</span> <span class="o">&lt;</span> <span class="nx">cl</span><span class="p">;</span> <span class="nx">ci</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span><span class="p">[</span><span class="nx">ci</span><span class="p">])</span> <span class="nx">f</span><span class="p">(</span><span class="nx">cur</span><span class="p">[</span><span class="nx">ci</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nx">cur</span><span class="p">[</span><span class="nx">ci</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">after_type</span><span class="p">)</span> <span class="nx">after_type</span><span class="p">(</span><span class="nx">type</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__mbefore</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/*if (type === Element.EVENT_MOD) {</span>
<span class="cm">        this.__loadEvtsFromCache();</span>
<span class="cm">    }*/</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__mafter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/*if (!result || (type === Element.USER_MOD)) {</span>
<span class="cm">        this.__lmatrix = Element._getIMatrixOf(this.state);</span>
<span class="cm">    }*/</span>
    <span class="cm">/*if (!result || (type === Element.EVENT_MOD)) {</span>
<span class="cm">        this.__clearEvtState();</span>
<span class="cm">    }*/</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__pbefore</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__pafter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__checkGJump</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gtime</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__checkJump</span><span class="p">(</span><span class="nx">gtime</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">gband</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__checkJump</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">at</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>FIXME: test if jumping do not fails with floating points problems</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xdata</span><span class="p">,</span>
        <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">tf</span><span class="p">)</span> <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">tf</span><span class="p">(</span><span class="nx">at</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">duration</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">x</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>if jump-time was set either
directly or relatively or with key,
get its absolute local value</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">p</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">?</span> <span class="nx">s</span><span class="p">.</span><span class="nx">p</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">t</span> <span class="o">=</span> <span class="p">((</span><span class="nx">t</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">t</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">))</span>
        <span class="o">?</span> <span class="nx">s</span><span class="p">.</span><span class="nx">t</span> <span class="o">*</span> <span class="nx">duration</span>
        <span class="o">:</span> <span class="nx">t</span><span class="p">;</span>
    <span class="nx">t</span> <span class="o">=</span> <span class="p">((</span><span class="nx">t</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">key</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">))</span>
        <span class="o">?</span> <span class="nx">x</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="nx">s</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span>
        <span class="o">:</span> <span class="nx">t</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">t</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&gt;</span> <span class="nx">duration</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="s1">&#39;failed to calculate jump&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">__jumpLock</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>jump was performed if t or rt or key
were set:
save jump time and return it</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">__lastJump</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">at</span><span class="p">,</span> <span class="nx">t</span> <span class="p">];</span>
            <span class="nx">s</span><span class="p">.</span><span class="nx">p</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="nx">s</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="nx">s</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">t</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>set t to jump-time, and if no jump-time
was passed or it requires to be ignored,
just set it to actual local time</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">t</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">?</span> <span class="nx">t</span> <span class="o">:</span> <span class="nx">at</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__lastJump</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
       <span class="cm">/* return (jump_pos + (t - jumped_at)) */</span>
       <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__lastJump</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="nx">t</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">__lastJump</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>overflow will be checked in fits() method,
or recalculated with loop/bounce mode
so if this clip longs more than allowed,
it will be just ended there</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="cm">/* return ((this.__lastJump + t) &gt; x.gband[1])</span>
<span class="cm">             ? (this.__lastJump + t)</span>
<span class="cm">             : x.gband[1]; */</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">t</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">handle__x</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__saveEvt</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__saveEvt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__evtCache</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">type</span><span class="p">,</span> <span class="nx">evt</span><span class="p">]);</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__loadEvts</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__evtCache</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">cache_len</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__clearEvts</span><span class="p">(</span><span class="nx">to</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cache_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">edata</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">evts</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">ei</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ei</span> <span class="o">&lt;</span> <span class="nx">cache_len</span><span class="p">;</span> <span class="nx">ei</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">edata</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">ei</span><span class="p">];</span>
            <span class="nx">type</span> <span class="o">=</span> <span class="nx">edata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="nx">to</span><span class="p">.</span><span class="nx">__evt_st</span> <span class="o">|=</span> <span class="nx">type</span><span class="p">;</span>
            <span class="nx">evts</span> <span class="o">=</span> <span class="nx">to</span><span class="p">.</span><span class="nx">__evts</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">evts</span><span class="p">[</span><span class="nx">type</span><span class="p">])</span> <span class="nx">evts</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="nx">evts</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">edata</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">__evtCache</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__clearEvts</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">from</span><span class="p">.</span><span class="nx">__evt_st</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">from</span><span class="p">.</span><span class="nx">__evts</span> <span class="o">=</span> <span class="p">{};</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__postRender</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>clear detach-queue</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">__performDetach</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__resetState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">lx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">sx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">sy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">p</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">t</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">_applied</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">_appliedAt</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">_matrix</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>state of the element</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">createState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">owner</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="s1">&#39;x&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>   <span class="c1">// dynamic position</span>
             <span class="s1">&#39;lx&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;ly&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// static position</span>
             <span class="s1">&#39;rx&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;ry&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// registration point shift</span>
             <span class="s1">&#39;angle&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>       <span class="c1">// rotation angle</span>
             <span class="s1">&#39;sx&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sy&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">// scale by x / by y</span>
             <span class="s1">&#39;alpha&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>       <span class="c1">// opacity</span>
             <span class="s1">&#39;p&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>cur local time (p) or 0..1 time (t) or by key (p have highest priority),
if both are null — stays as defined</p>             </td>             <td class="code">               <div class="highlight"><pre>             <span class="s1">&#39;_matrix&#39;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Transform</span><span class="p">(),</span>
             <span class="s1">&#39;_evts&#39;</span><span class="o">:</span> <span class="p">{},</span>
             <span class="s1">&#39;_evt_st&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
             <span class="s1">&#39;$&#39;</span><span class="o">:</span> <span class="nx">owner</span> <span class="p">};</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p>geometric data of the element</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Element</span><span class="p">.</span><span class="nx">createXData</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">owner</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="s1">&#39;pos&#39;</span><span class="o">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>      <span class="c1">// position in parent clip space</span>
             <span class="s1">&#39;reg&#39;</span><span class="o">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>      <span class="c1">// registration point</span>
             <span class="s1">&#39;image&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>    <span class="c1">// cached Image instance, if it is an image</span>
             <span class="s1">&#39;path&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>     <span class="c1">// Path instanse, if it is a shape</span>
             <span class="s1">&#39;text&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>     <span class="c1">// Text data, if it is a text (`path` holds stroke and fill)</span>
             <span class="s1">&#39;mode&#39;</span><span class="o">:</span> <span class="nx">C</span><span class="p">.</span><span class="nx">R_ONCE</span><span class="p">,</span>            <span class="c1">// playing mode</span>
             <span class="s1">&#39;lband&#39;</span><span class="o">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">DEFAULT_LEN</span><span class="p">],</span> <span class="c1">// local band</span>
             <span class="s1">&#39;gband&#39;</span><span class="o">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">DEFAULT_LEN</span><span class="p">],</span> <span class="c1">// global band</span>
             <span class="s1">&#39;canvas&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>   <span class="c1">// own canvas for static (cached) elements</span>
             <span class="s1">&#39;dimen&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>    <span class="c1">// dimensions for static (cached) elements</span>
             <span class="s1">&#39;keys&#39;</span><span class="o">:</span> <span class="p">{},</span>
             <span class="s1">&#39;tf&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
             <span class="s1">&#39;acomp&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>    <span class="c1">// alpha composition</span>
             <span class="s1">&#39;_mpath&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
             <span class="s1">&#39;$&#39;</span><span class="o">:</span> <span class="nx">owner</span> <span class="p">};</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">__addSysModifiers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>band check performed in checkJump</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="cm">/* if (xdata.gband) this.__modify(Element.SYS_MOD, 0, null, Render.m_checkBand, xdata.gband); */</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">__modify</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_MOD</span> <span class="p">},</span> <span class="nx">Render</span><span class="p">.</span><span class="nx">m_saveReg</span><span class="p">);</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">__modify</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_MOD</span> <span class="p">},</span> <span class="nx">Render</span><span class="p">.</span><span class="nx">m_applyPos</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">__addSysPainters</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">__paint</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_PNT</span> <span class="p">},</span> <span class="nx">Render</span><span class="p">.</span><span class="nx">p_applyAComp</span><span class="p">);</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">__paint</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_PNT</span> <span class="p">},</span> <span class="nx">Render</span><span class="p">.</span><span class="nx">p_drawPath</span><span class="p">);</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">__paint</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_PNT</span> <span class="p">},</span> <span class="nx">Render</span><span class="p">.</span><span class="nx">p_drawImage</span><span class="p">);</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">__paint</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_PNT</span> <span class="p">},</span> <span class="nx">Render</span><span class="p">.</span><span class="nx">p_drawText</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">__addDebugRender</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">__paint</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_PNT</span> <span class="p">},</span> <span class="nx">Render</span><span class="p">.</span><span class="nx">p_drawReg</span><span class="p">);</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">__paint</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">SYS_PNT</span> <span class="p">},</span> <span class="nx">Render</span><span class="p">.</span><span class="nx">p_drawName</span><span class="p">);</span>
    <span class="cm">/* elm.__paint({ type: Element.DEBUG_PNT,</span>
<span class="cm">                     priority: 1 },</span>
<span class="cm">                   Render.p_drawMPath); */</span>

    <span class="nx">elm</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_DRAW</span><span class="p">,</span> <span class="nx">Render</span><span class="p">.</span><span class="nx">h_drawMPath</span><span class="p">);</span> <span class="c1">// to call out of the 2D context changes</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">__addTweenModifier</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">,</span> <span class="nx">conf</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p>if (!conf.type) throw new AnimErr('Tween type is not defined');</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">tween_f</span> <span class="o">=</span> <span class="nx">Tweens</span><span class="p">[</span><span class="nx">conf</span><span class="p">.</span><span class="nx">type</span><span class="p">](),</span>
        <span class="nx">m_tween</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <p>all tweens functions actually work with 0..1 parameter, but modifiers
differ by 'relative' option</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">relative</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">m_tween</span> <span class="o">=</span> <span class="nx">tween_f</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">m_tween</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">tween_f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">t</span> <span class="o">/</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">__modify</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">TWEEN_MOD</span><span class="p">,</span>
                          <span class="nx">priority</span><span class="o">:</span> <span class="nx">Tween</span><span class="p">.</span><span class="nx">TWEENS_PRIORITY</span><span class="p">[</span><span class="nx">conf</span><span class="p">.</span><span class="nx">type</span><span class="p">],</span>
                          <span class="nx">time</span><span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">band</span> <span class="o">||</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">time</span><span class="p">,</span>
                          <span class="nx">relative</span><span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">relative</span><span class="p">,</span>
                          <span class="nx">easing</span><span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">easing</span><span class="p">,</span>
                          <span class="nx">data</span><span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">data</span> <span class="p">},</span> <span class="nx">m_tween</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">__convertEasing</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">easing</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">relative</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">easing</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">easing</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">EasingImpl</span><span class="p">[</span><span class="nx">easing</span><span class="p">](</span><span class="nx">data</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">relative</span> <span class="o">?</span> <span class="nx">f</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">len</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">t</span> <span class="o">/</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">len</span><span class="p">)</span> <span class="o">*</span> <span class="nx">len</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">((</span><span class="k">typeof</span> <span class="nx">easing</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="k">return</span> <span class="nx">easing</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">((</span><span class="k">typeof</span> <span class="nx">easing</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">)</span> <span class="k">return</span> <span class="nx">easing</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">easing</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">EasingImpl</span><span class="p">[</span><span class="nx">easing</span><span class="p">.</span><span class="nx">type</span><span class="p">](</span><span class="nx">easing</span><span class="p">.</span><span class="nx">data</span> <span class="o">||</span> <span class="nx">data</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">relative</span> <span class="o">?</span> <span class="nx">f</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">len</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">t</span> <span class="o">/</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">len</span><span class="p">)</span> <span class="o">*</span> <span class="nx">len</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">easing</span><span class="p">.</span><span class="nx">f</span><span class="p">)</span> <span class="k">return</span> <span class="nx">easing</span><span class="p">.</span><span class="nx">f</span><span class="p">(</span><span class="nx">easing</span><span class="p">.</span><span class="nx">data</span> <span class="o">||</span> <span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">Element</span><span class="p">.</span><span class="nx">_getMatrixOf</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">m</span> <span class="o">?</span> <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">reset</span><span class="p">(),</span> <span class="nx">m</span><span class="p">)</span>
                <span class="o">:</span> <span class="k">new</span> <span class="nx">Transform</span><span class="p">());</span>
    <span class="nx">_t</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">lx</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ly</span><span class="p">);</span>
    <span class="nx">_t</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
    <span class="nx">_t</span><span class="p">.</span><span class="nx">rotate</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">angle</span><span class="p">);</span>
    <span class="nx">_t</span><span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">sx</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">sy</span><span class="p">);</span>
    <span class="nx">_t</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="o">-</span><span class="nx">s</span><span class="p">.</span><span class="nx">rx</span><span class="p">,</span> <span class="o">-</span><span class="nx">s</span><span class="p">.</span><span class="nx">ry</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">_t</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">_getIMatrixOf</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_t</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">.</span><span class="nx">_getMatrixOf</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">m</span><span class="p">);</span>
    <span class="nx">_t</span><span class="p">.</span><span class="nx">invert</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">_t</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Element</span><span class="p">.</span><span class="nx">imgFromUrl</span> <span class="o">=</span> <span class="nx">prepareImage</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">Clip</span> <span class="o">=</span> <span class="nx">Element</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <h2>Events</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <p>adds specified events support to the <code>subj</code> object. <code>subj</code> object receives
<code>handlers</code> property that keeps the listeners for each event. Also, it gets
<code>e_&lt;evt_name&gt;</code> function for every event provided to call it when it is
required to call all handlers of all of thise event name
(<code>fire('&lt;evt_name&gt;', ...)</code> is the same but can not be reassigned by user).
<code>subj</code> can define <code>handle_&lt;evt_name&gt;</code> function to handle concrete event itself,
but without messing with other handlers.
And, user gets <code>on</code> function to subcribe to events and <code>provides</code> to check
if it is allowed.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">provideEvents</span><span class="p">(</span><span class="nx">subj</span><span class="p">,</span> <span class="nx">events</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">subj</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_initHandlers</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">evts</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// FIXME: make automatic</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">_hdls</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">=</span> <span class="nx">_hdls</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">ei</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ei</span> <span class="o">&lt;</span> <span class="nx">evts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">ei</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">_hdls</span><span class="p">[</span><span class="nx">evts</span><span class="p">[</span><span class="nx">ei</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">})(</span><span class="nx">events</span><span class="p">);</span>
    <span class="nx">subj</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">provides</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="s1">&#39;Event \&#39;&#39;</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">__enmap</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">+</span>
                                                     <span class="s1">&#39;\&#39; not provided by &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">handler</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="s1">&#39;You are trying to assign &#39;</span> <span class="o">+</span>
                                        <span class="s1">&#39;undefined handler for event &#39;</span> <span class="o">+</span> <span class="nx">event</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">handler</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">subj</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fire</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">evtobj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">provides</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="s1">&#39;Event \&#39;&#39;</span> <span class="o">+</span> <span class="nx">C</span><span class="p">.</span><span class="nx">__enmap</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">+</span>
                                                     <span class="s1">&#39;\&#39; not provided by &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">disabled</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handle__x</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handle__x</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">evtobj</span><span class="p">)))</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">__enmap</span><span class="p">[</span><span class="nx">event</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="s1">&#39;handle_&#39;</span><span class="o">+</span><span class="nx">name</span><span class="p">])</span> <span class="k">this</span><span class="p">[</span><span class="s1">&#39;handle_&#39;</span><span class="o">+</span><span class="nx">name</span><span class="p">](</span><span class="nx">evtobj</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">_hdls</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">hi</span> <span class="o">&lt;</span> <span class="nx">_hdls</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">hi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">_hdls</span><span class="p">[</span><span class="nx">hi</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">evtobj</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="nx">subj</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">provides</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">evts</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">event</span><span class="p">)</span> <span class="k">return</span> <span class="nx">evts</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">})(</span><span class="nx">events</span><span class="p">);</span>
    <span class="nx">subj</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">unbind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">idx</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">provides</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="s1">&#39;Event &#39;</span> <span class="o">+</span> <span class="nx">event</span> <span class="o">+</span>
                                                     <span class="s1">&#39; not provided by &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">][</span><span class="nx">idx</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">splice</span><span class="p">(</span><span class="nx">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">AnimErr</span><span class="p">(</span><span class="s1">&#39;No such handler &#39;</span> <span class="o">+</span> <span class="nx">idx</span> <span class="o">+</span> <span class="s1">&#39; for event &#39;</span> <span class="o">+</span> <span class="nx">event</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="nx">subj</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">disposeHandlers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_hdls</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handlers</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">evt</span> <span class="k">in</span> <span class="nx">_hdls</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">_hdls</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">evt</span><span class="p">))</span> <span class="nx">_hdls</span><span class="p">[</span><span class="nx">evt</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/* FIXME: call fire/e_-funcs only from inside of their providers, */</span>
    <span class="cm">/* TODO: wrap them with event objects */</span>
    <span class="kd">var</span> <span class="nx">_event</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">ei</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ei</span> <span class="o">&lt;</span> <span class="nx">events</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">ei</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_event</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span><span class="nx">ei</span><span class="p">];</span>
        <span class="nx">subj</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="s1">&#39;e_&#39;</span><span class="o">+</span><span class="nx">_event</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evtobj</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">evtobj</span><span class="p">);</span>
            <span class="p">};</span>
        <span class="p">})(</span><span class="nx">_event</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/* subj.prototype.before = function(event, handler) { } */</span>
    <span class="cm">/* subj.prototype.after = function(event, handler) { } */</span>
    <span class="cm">/* subj.prototype.provide = function(event, provider) { } */</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">kevt</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="p">((</span><span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">?</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span><span class="p">),</span>
             <span class="nx">ch</span><span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">charCode</span> <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">mevt</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">cvs</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="nx">pos</span><span class="o">:</span> <span class="p">[</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">-</span> <span class="nx">cvs</span><span class="p">.</span><span class="nx">__rOffsetLeft</span><span class="p">,</span>
                    <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">-</span> <span class="nx">cvs</span><span class="p">.</span><span class="nx">__rOffsetTop</span> <span class="p">]</span> <span class="p">};</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <h2>Drawing</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">D</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// means &quot;Drawing&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <p>draws current state of animation on canvas and postpones to call itself for
the next time period (so to start animation, you just need to call it once
when the first time must occur and it will chain its own calls automatically)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">D</span><span class="p">.</span><span class="nx">drawNext</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">scene</span><span class="p">,</span> <span class="nx">before</span><span class="p">,</span> <span class="nx">after</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <p>NB: state here is a player state, not an element state</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">happens</span> <span class="o">!==</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PLAYING</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">msec</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">state</span><span class="p">.</span><span class="nx">__startTime</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">sec</span> <span class="o">=</span> <span class="nx">msec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">time</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sec</span> <span class="o">*</span> <span class="nx">state</span><span class="p">.</span><span class="nx">speed</span><span class="p">)</span> <span class="o">+</span> <span class="nx">state</span><span class="p">.</span><span class="nx">from</span><span class="p">;</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">time</span> <span class="o">=</span> <span class="nx">time</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">before</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">before</span><span class="p">(</span><span class="nx">time</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">__rsec</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">state</span><span class="p">.</span><span class="nx">__rsec</span> <span class="o">=</span> <span class="nx">msec</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">msec</span> <span class="o">-</span> <span class="nx">state</span><span class="p">.</span><span class="nx">__rsec</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">afps</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">__redraws</span><span class="p">;</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">__rsec</span> <span class="o">=</span> <span class="nx">msec</span><span class="p">;</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">__redraws</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">__redraws</span><span class="o">++</span><span class="p">;</span>

    <span class="nx">ctx</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">width</span> <span class="o">*</span> <span class="nx">state</span><span class="p">.</span><span class="nx">ratio</span><span class="p">,</span>
                        <span class="nx">state</span><span class="p">.</span><span class="nx">height</span> <span class="o">*</span> <span class="nx">state</span><span class="p">.</span><span class="nx">ratio</span><span class="p">);</span>

    <span class="nx">scene</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">zoom</span> <span class="o">*</span> <span class="nx">state</span><span class="p">.</span><span class="nx">ratio</span><span class="cm">/*, state.afps*/</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <p>show fps</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// TODO: move to player.onrender</span>
        <span class="nx">D</span><span class="p">.</span><span class="nx">drawFPS</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">afps</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">after</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">after</span><span class="p">(</span><span class="nx">time</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">__supressFrames</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">__nextFrame</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">D</span><span class="p">.</span><span class="nx">drawNext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">scene</span><span class="p">,</span> <span class="nx">before</span><span class="p">,</span> <span class="nx">after</span><span class="p">);</span>
    <span class="p">});</span>

<span class="p">}</span>
<span class="cm">/* D.drawAt = function(ctx, state, scene, time) {</span>
<span class="cm">    ctx.clearRect(0, 0, state.width, state.height);</span>
<span class="cm">    scene.render(ctx, time);</span>
<span class="cm">} */</span>
<span class="nx">D</span><span class="p">.</span><span class="nx">drawFPS</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">fps</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s1">&#39;#999&#39;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="s1">&#39;20px sans-serif&#39;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">fps</span><span class="p">),</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <h3>Drawing: Utils</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* ------------------ */</span>

<span class="kd">var</span> <span class="nx">DU</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// means &quot;Drawing Utils&quot;</span>

<span class="cm">/* FIXME: move to `Path`? */</span>
<span class="nx">DU</span><span class="p">.</span><span class="nx">applyStroke</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">stroke</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">stroke</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineWidth</span> <span class="o">=</span> <span class="nx">stroke</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeStyle</span> <span class="o">=</span> <span class="nx">stroke</span><span class="p">.</span><span class="nx">_style</span> <span class="c1">// calculated once for stroke</span>
                      <span class="o">||</span> <span class="p">(</span><span class="nx">stroke</span><span class="p">.</span><span class="nx">_style</span> <span class="o">=</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">createStyle</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">stroke</span><span class="p">));</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineCap</span> <span class="o">=</span> <span class="nx">stroke</span><span class="p">.</span><span class="nx">cap</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineJoin</span> <span class="o">=</span> <span class="nx">stroke</span><span class="p">.</span><span class="nx">join</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME: move to `Path`? */</span>
<span class="nx">DU</span><span class="p">.</span><span class="nx">applyFill</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">fill</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fill</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">fill</span><span class="p">.</span><span class="nx">_style</span> <span class="c1">// calculated once for fill</span>
                  <span class="o">||</span> <span class="p">(</span><span class="nx">fill</span><span class="p">.</span><span class="nx">_style</span> <span class="o">=</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">createStyle</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">fill</span><span class="p">));</span>
<span class="p">}</span>

<span class="nx">DU</span><span class="p">.</span><span class="nx">_hasVal</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fsval</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">fsval</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">fsval</span><span class="p">.</span><span class="nx">color</span> <span class="o">||</span> <span class="nx">fsval</span><span class="p">.</span><span class="nx">lgrad</span> <span class="o">||</span> <span class="nx">fsval</span><span class="p">.</span><span class="nx">rgrad</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* FIXME: move to `Path`? */</span>
<span class="nx">DU</span><span class="p">.</span><span class="nx">qDraw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">stroke</span><span class="p">,</span> <span class="nx">fill</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
    <span class="nx">DU</span><span class="p">.</span><span class="nx">applyFill</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">fill</span><span class="p">);</span>
    <span class="nx">DU</span><span class="p">.</span><span class="nx">applyStroke</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">stroke</span><span class="p">);</span>
    <span class="nx">func</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">closePath</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">DU</span><span class="p">.</span><span class="nx">_hasVal</span><span class="p">(</span><span class="nx">fill</span><span class="p">))</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">DU</span><span class="p">.</span><span class="nx">_hasVal</span><span class="p">(</span><span class="nx">stroke</span><span class="p">))</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <h2>Import</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">L</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// means &quot;Loading/Loader&quot;</span>

<span class="nx">L</span><span class="p">.</span><span class="nx">loadFromUrl</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">importer</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">JSON</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">SysErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">S</span><span class="p">.</span><span class="nx">NO_JSON_PARSER</span><span class="p">);</span>

    <span class="nx">player</span><span class="p">.</span><span class="nx">_drawLoadingSplash</span><span class="p">(</span><span class="nx">_strf</span><span class="p">(</span><span class="nx">Strings</span><span class="p">.</span><span class="nx">LOADING_ANIMATION</span><span class="p">,</span> <span class="p">[</span><span class="nx">url</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)]));</span>

    <span class="nx">ajax</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">L</span><span class="p">.</span><span class="nx">loadFromObj</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">),</span> <span class="nx">importer</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="nx">L</span><span class="p">.</span><span class="nx">loadFromObj</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">importer</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">importer</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">PlayerErr</span><span class="p">(</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">NO_IMPORTER_TO_LOAD_WITH</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">importer</span><span class="p">.</span><span class="nx">configureAnim</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">configureAnim</span><span class="p">(</span><span class="nx">importer</span><span class="p">.</span><span class="nx">configureAnim</span><span class="p">(</span><span class="nx">object</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">importer</span><span class="p">.</span><span class="nx">configureMeta</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">configureMeta</span><span class="p">(</span><span class="nx">importer</span><span class="p">.</span><span class="nx">configureMeta</span><span class="p">(</span><span class="nx">object</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="nx">L</span><span class="p">.</span><span class="nx">loadScene</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">importer</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">object</span><span class="p">),</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">L</span><span class="p">.</span><span class="nx">loadScene</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">scene</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">anim</span><span class="p">)</span> <span class="nx">player</span><span class="p">.</span><span class="nx">anim</span><span class="p">.</span><span class="nx">dispose</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-149">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-149">&#182;</a>               </div>               <p>add debug rendering</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">debug</span>
        <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">global_opts</span><span class="p">.</span><span class="nx">liveDebug</span><span class="p">)</span>
        <span class="nx">scene</span><span class="p">.</span><span class="nx">visitElems</span><span class="p">(</span><span class="nx">Element</span><span class="p">.</span><span class="nx">__addDebugRender</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-150">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-150">&#182;</a>               </div>               <p>assign</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">player</span><span class="p">.</span><span class="nx">anim</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-151">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-151">&#182;</a>               </div>               <p>update duration</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">player</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">duration</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">player</span><span class="p">.</span><span class="nx">mode</span> <span class="o">&amp;</span> <span class="nx">C</span><span class="p">.</span><span class="nx">M_DYNAMIC</span><span class="p">)</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">MAX_VALUE</span><span class="p">;</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">setDuration</span><span class="p">(</span><span class="nx">scene</span><span class="p">.</span><span class="nx">duration</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">scene</span><span class="p">.</span><span class="nx">awidth</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="nx">scene</span><span class="p">.</span><span class="nx">aheight</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">player</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">L</span><span class="p">.</span><span class="nx">loadClips</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">clips</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_anim</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Scene</span><span class="p">();</span>
    <span class="nx">_anim</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">clips</span><span class="p">);</span>
    <span class="nx">L</span><span class="p">.</span><span class="nx">loadScene</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">_anim</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">L</span><span class="p">.</span><span class="nx">loadBuilder</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">builder</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_anim</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Scene</span><span class="p">();</span>
    <span class="nx">_anim</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">builder</span><span class="p">.</span><span class="nx">v</span><span class="p">);</span>
    <span class="nx">L</span><span class="p">.</span><span class="nx">loadScene</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">_anim</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-152">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-152">&#182;</a>               </div>               <h2>Custom Rendering</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Render</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// means &quot;Render&quot;, system modifiers &amp; painters</span>

<span class="nx">Render</span><span class="p">.</span><span class="nx">p_drawReg</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">reg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">reg</span> <span class="o">=</span> <span class="nx">reg</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">reg</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nx">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineWidth</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeStyle</span> <span class="o">=</span> <span class="s1">&#39;#600&#39;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-153">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-153">&#182;</a>               </div>               <p>ctx.moveTo(0, 5);</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ctx</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">closePath</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">Render</span><span class="p">.</span><span class="nx">p_drawPath</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">path</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">Render</span><span class="p">.</span><span class="nx">p_drawImage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">image</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">image</span> <span class="o">=</span> <span class="nx">image</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">image</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">isReady</span><span class="p">)</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">Render</span><span class="p">.</span><span class="nx">p_drawText</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">text</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">Render</span><span class="p">.</span><span class="nx">p_drawName</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s1">&#39;#666&#39;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="s1">&#39;12px sans-serif&#39;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">Render</span><span class="p">.</span><span class="nx">p_applyAComp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">acomp</span><span class="p">)</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">globalCompositeOperation</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">AC_NAMES</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">acomp</span><span class="p">];</span>
<span class="p">}</span>

<span class="nx">Render</span><span class="p">.</span><span class="nx">h_drawMPath</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">mPath</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">mPath</span> <span class="o">=</span> <span class="nx">mPath</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">_mpath</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">lx</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ly</span><span class="p">);</span>
    <span class="nx">mPath</span><span class="p">.</span><span class="nx">cstroke</span><span class="p">(</span><span class="s1">&#39;#600&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
    <span class="nx">mPath</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">closePath</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
<span class="p">}</span>

<span class="nx">Render</span><span class="p">.</span><span class="nx">m_checkBand</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">band</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">band</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">*</span> <span class="nx">time</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// exit</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">band</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">*</span> <span class="nx">time</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// exit</span>
<span class="p">}</span>

<span class="nx">Render</span><span class="p">.</span><span class="nx">m_saveReg</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">reg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">reg</span> <span class="o">=</span> <span class="nx">reg</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">reg</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">rx</span> <span class="o">=</span> <span class="nx">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ry</span> <span class="o">=</span> <span class="nx">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="nx">Render</span><span class="p">.</span><span class="nx">m_applyPos</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">pos</span> <span class="o">=</span> <span class="nx">pos</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">pos</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lx</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ly</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-154">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-154">&#182;</a>               </div>               <h2>Bands</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Bands</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-155">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-155">&#182;</a>               </div>               <p>recalculate all global bands down to the very
child, starting from given element</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Bands</span><span class="p">.</span><span class="nx">recalc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elm</span><span class="p">,</span> <span class="nx">in_band</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">xdata</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">in_band</span> <span class="o">=</span> <span class="nx">in_band</span> <span class="o">||</span>
                  <span class="p">(</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">parent</span>
                  <span class="o">?</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">xdata</span><span class="p">.</span><span class="nx">gband</span>
                  <span class="o">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="p">);</span>
    <span class="nx">x</span><span class="p">.</span><span class="nx">gband</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">in_band</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">x</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="nx">in_band</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">x</span><span class="p">.</span><span class="nx">lband</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">];</span>
    <span class="nx">elm</span><span class="p">.</span><span class="nx">visitChildren</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">celm</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Bands</span><span class="p">.</span><span class="nx">recalc</span><span class="p">(</span><span class="nx">celm</span><span class="p">,</span> <span class="nx">x</span><span class="p">.</span><span class="nx">gband</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-156">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-156">&#182;</a>               </div>               <p>makes inner band coords relative to outer space</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Bands</span><span class="p">.</span><span class="nx">wrap</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">outer</span><span class="p">,</span> <span class="nx">inner</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">outer</span><span class="p">)</span> <span class="k">return</span> <span class="nx">inner</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span> <span class="nx">outer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">inner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
             <span class="p">((</span><span class="nx">outer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">inner</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="nx">outer</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
              <span class="o">?</span> <span class="p">(</span><span class="nx">outer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">inner</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
              <span class="o">:</span> <span class="nx">outer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">];</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-157">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-157">&#182;</a>               </div>               <p>makes band maximum wide to fith both bands</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Bands</span><span class="p">.</span><span class="nx">expand</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">from</span><span class="p">)</span> <span class="k">return</span> <span class="nx">to</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span> <span class="p">((</span><span class="nx">to</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">from</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
              <span class="o">?</span> <span class="nx">to</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">from</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
             <span class="p">((</span><span class="nx">to</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">from</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
              <span class="o">?</span> <span class="nx">to</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="nx">from</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
           <span class="p">];</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-158">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-158">&#182;</a>               </div>               <p>finds minimum intersection of the bands</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Bands</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">from</span><span class="p">)</span> <span class="k">return</span> <span class="nx">to</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span> <span class="p">((</span><span class="nx">to</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">from</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
              <span class="o">?</span> <span class="nx">to</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">from</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
             <span class="p">((</span><span class="nx">to</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">from</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
              <span class="o">?</span> <span class="nx">to</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="nx">from</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
           <span class="p">];</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-159">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-159">&#182;</a>               </div>               <h2>Tweens</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-160">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-160">&#182;</a>               </div>               <p>Tween constants</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">C</span><span class="p">.</span><span class="nx">T_TRANSLATE</span>   <span class="o">=</span> <span class="s1">&#39;TRANSLATE&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">T_SCALE</span>       <span class="o">=</span> <span class="s1">&#39;SCALE&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">T_ROTATE</span>      <span class="o">=</span> <span class="s1">&#39;ROTATE&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">T_ROT_TO_PATH</span> <span class="o">=</span> <span class="s1">&#39;ROT_TO_PATH&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">T_ALPHA</span>       <span class="o">=</span> <span class="s1">&#39;ALPHA&#39;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">Tween</span> <span class="o">=</span> <span class="p">{};</span>
<span class="kd">var</span> <span class="nx">Easing</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-161">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-161">&#182;</a>               </div>               <p>tween order</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Tween</span><span class="p">.</span><span class="nx">TWEENS_PRIORITY</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">Tween</span><span class="p">.</span><span class="nx">TWEENS_PRIORITY</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">T_TRANSLATE</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">Tween</span><span class="p">.</span><span class="nx">TWEENS_PRIORITY</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">T_SCALE</span><span class="p">]</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">Tween</span><span class="p">.</span><span class="nx">TWEENS_PRIORITY</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">T_ROTATE</span><span class="p">]</span>      <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="nx">Tween</span><span class="p">.</span><span class="nx">TWEENS_PRIORITY</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">T_ROT_TO_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="nx">Tween</span><span class="p">.</span><span class="nx">TWEENS_PRIORITY</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">T_ALPHA</span><span class="p">]</span>       <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

<span class="nx">Tween</span><span class="p">.</span><span class="nx">TWEENS_COUNT</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">Tweens</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">Tweens</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">T_ROTATE</span><span class="p">]</span> <span class="o">=</span>
    <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">t</span><span class="p">)</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">t</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-162">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-162">&#182;</a>               </div>               <p>state.angle = (Math.PI / 180) * 45;</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">};</span>
    <span class="p">};</span>
<span class="nx">Tweens</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">T_TRANSLATE</span><span class="p">]</span> <span class="o">=</span>
    <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">pointAt</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">_mpath</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">};</span>
    <span class="p">};</span>
<span class="nx">Tweens</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">T_ALPHA</span><span class="p">]</span> <span class="o">=</span>
    <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">alpha</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="nx">t</span><span class="p">)</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">t</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">};</span>
<span class="nx">Tweens</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">T_SCALE</span><span class="p">]</span> <span class="o">=</span>
    <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sx</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="nx">t</span><span class="p">)</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">t</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sy</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="nx">t</span><span class="p">)</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">t</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">};</span>
<span class="nx">Tweens</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">T_ROT_TO_PATH</span><span class="p">]</span> <span class="o">=</span>
    <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mpath</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">tangentAt</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span> <span class="c1">// Math.atan2(this.y, this.x);</span>
      <span class="p">};</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-163">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-163">&#182;</a>               </div>               <h2>Easings</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-164">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-164">&#182;</a>               </div>               <p>Easings constants</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">C</span><span class="p">.</span><span class="nx">E_PATH</span> <span class="o">=</span> <span class="s1">&#39;PATH&#39;</span><span class="p">;</span> <span class="c1">// Path</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">E_FUNC</span> <span class="o">=</span> <span class="s1">&#39;FUNC&#39;</span><span class="p">;</span> <span class="c1">// Function</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">E_CSEG</span> <span class="o">=</span> <span class="s1">&#39;CSEG&#39;</span><span class="p">;</span> <span class="c1">// Function</span>
<span class="cm">/*C.E_CINOUT = &#39;CINOUT&#39;; // Cubic InOut*/</span>
<span class="cm">/*....*/</span></pre></div>             </td>           </tr>                               <tr id="section-165">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-165">&#182;</a>               </div>               <p>function-based easings</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">EasingImpl</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">EasingImpl</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">E_PATH</span><span class="p">]</span> <span class="o">=</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/*var path = Path.parse(str);*/</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">pointAt</span><span class="p">(</span><span class="nx">t</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="nx">EasingImpl</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">E_FUNC</span><span class="p">]</span> <span class="o">=</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">f</span><span class="p">;</span>
    <span class="p">};</span>
<span class="nx">EasingImpl</span><span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">E_CSEG</span><span class="p">]</span> <span class="o">=</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">seg</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">seg</span><span class="p">.</span><span class="nx">atT</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="nx">t</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="cm">/*EasingImpl[C.E_CINOUT] =</span>
<span class="cm">    function() {</span>
<span class="cm">        return function(t) {</span>
<span class="cm">            var t =  2 * t;</span>
<span class="cm">            if (t &lt; 1) {</span>
<span class="cm">                return -1/2 * (Math.sqrt(1 - t*t) - 1);</span>
<span class="cm">            } else {</span>
<span class="cm">                return 1/2 * (Math.sqrt(1 - (t-2)*(t-2)) + 1);</span>
<span class="cm">            }</span>
<span class="cm">        }</span>
<span class="cm">    };*/</span></pre></div>             </td>           </tr>                               <tr id="section-166">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-166">&#182;</a>               </div>               <p>segment-based easings</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Easing</span><span class="p">.</span><span class="nx">__SEGS</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// segments cache for easings</span>

<span class="kd">function</span> <span class="nx">__registerSegEasing</span><span class="p">(</span><span class="nx">alias</span><span class="p">,</span> <span class="nx">points</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">C</span><span class="p">[</span><span class="s1">&#39;E_&#39;</span><span class="o">+</span><span class="nx">alias</span><span class="p">]</span> <span class="o">=</span> <span class="nx">alias</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">seg</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSeg</span><span class="p">(</span><span class="nx">points</span><span class="p">);</span>
    <span class="nx">Easing</span><span class="p">.</span><span class="nx">__SEGS</span><span class="p">[</span><span class="nx">alias</span><span class="p">]</span> <span class="o">=</span> <span class="nx">seg</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">func</span> <span class="o">=</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">seg</span><span class="p">.</span><span class="nx">atT</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="nx">t</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">};</span>
    <span class="nx">C</span><span class="p">[</span><span class="s1">&#39;EF_&#39;</span><span class="o">+</span><span class="nx">alias</span><span class="p">]</span> <span class="o">=</span> <span class="nx">func</span><span class="p">;</span>
    <span class="nx">EasingImpl</span><span class="p">[</span><span class="nx">alias</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">func</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;DEF&#39;</span><span class="p">,</span>    <span class="p">[</span><span class="mf">0.250</span><span class="p">,</span> <span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.250</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Default</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;IN&#39;</span><span class="p">,</span>     <span class="p">[</span><span class="mf">0.420</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// In</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span>    <span class="p">[</span><span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.580</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Out</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;INOUT&#39;</span><span class="p">,</span>  <span class="p">[</span><span class="mf">0.420</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.580</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// InOut</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;SIN&#39;</span><span class="p">,</span>    <span class="p">[</span><span class="mf">0.470</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.745</span><span class="p">,</span> <span class="mf">0.715</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Sine In</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;SOUT&#39;</span><span class="p">,</span>   <span class="p">[</span><span class="mf">0.390</span><span class="p">,</span> <span class="mf">0.575</span><span class="p">,</span> <span class="mf">0.565</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Sine Out</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;SINOUT&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.445</span><span class="p">,</span> <span class="mf">0.050</span><span class="p">,</span> <span class="mf">0.550</span><span class="p">,</span> <span class="mf">0.950</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Sine InOut</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;QIN&#39;</span><span class="p">,</span>    <span class="p">[</span><span class="mf">0.550</span><span class="p">,</span> <span class="mf">0.085</span><span class="p">,</span> <span class="mf">0.680</span><span class="p">,</span> <span class="mf">0.530</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Quad In</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;QOUT&#39;</span><span class="p">,</span>   <span class="p">[</span><span class="mf">0.250</span><span class="p">,</span> <span class="mf">0.460</span><span class="p">,</span> <span class="mf">0.450</span><span class="p">,</span> <span class="mf">0.940</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Quad Out</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;QINOUT&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.455</span><span class="p">,</span> <span class="mf">0.030</span><span class="p">,</span> <span class="mf">0.515</span><span class="p">,</span> <span class="mf">0.955</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Quad InOut</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;CIN&#39;</span><span class="p">,</span>    <span class="p">[</span><span class="mf">0.550</span><span class="p">,</span> <span class="mf">0.055</span><span class="p">,</span> <span class="mf">0.675</span><span class="p">,</span> <span class="mf">0.190</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Cubic In</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;COUT&#39;</span><span class="p">,</span>   <span class="p">[</span><span class="mf">0.215</span><span class="p">,</span> <span class="mf">0.610</span><span class="p">,</span> <span class="mf">0.355</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Cubic Out</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;CINOUT&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.645</span><span class="p">,</span> <span class="mf">0.045</span><span class="p">,</span> <span class="mf">0.355</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Cubic InOut</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;QTIN&#39;</span><span class="p">,</span>   <span class="p">[</span><span class="mf">0.895</span><span class="p">,</span> <span class="mf">0.030</span><span class="p">,</span> <span class="mf">0.685</span><span class="p">,</span> <span class="mf">0.220</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Quart In</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;QTOUT&#39;</span><span class="p">,</span>  <span class="p">[</span><span class="mf">0.165</span><span class="p">,</span> <span class="mf">0.840</span><span class="p">,</span> <span class="mf">0.440</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Quart Out</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;QTINOUT&#39;</span><span class="p">,[</span><span class="mf">0.770</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.175</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Quart InOut</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;QIIN&#39;</span><span class="p">,</span>   <span class="p">[</span><span class="mf">0.755</span><span class="p">,</span> <span class="mf">0.050</span><span class="p">,</span> <span class="mf">0.855</span><span class="p">,</span> <span class="mf">0.060</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Quint In</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;QIOUT&#39;</span><span class="p">,</span>  <span class="p">[</span><span class="mf">0.230</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">0.320</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Quart Out</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;QIINOUT&#39;</span><span class="p">,[</span><span class="mf">0.860</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.070</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Quart InOut</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;EIN&#39;</span><span class="p">,</span>    <span class="p">[</span><span class="mf">0.950</span><span class="p">,</span> <span class="mf">0.050</span><span class="p">,</span> <span class="mf">0.795</span><span class="p">,</span> <span class="mf">0.035</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Expo In</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;EOUT&#39;</span><span class="p">,</span>   <span class="p">[</span><span class="mf">0.190</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">0.220</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Expo Out</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;EINOUT&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.000</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Expo InOut</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;CRIN&#39;</span><span class="p">,</span>   <span class="p">[</span><span class="mf">0.600</span><span class="p">,</span> <span class="mf">0.040</span><span class="p">,</span> <span class="mf">0.980</span><span class="p">,</span> <span class="mf">0.335</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Circ In</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;CROUT&#39;</span><span class="p">,</span>  <span class="p">[</span><span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.820</span><span class="p">,</span> <span class="mf">0.165</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Circ Out</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;CRINOUT&#39;</span><span class="p">,[</span><span class="mf">0.785</span><span class="p">,</span> <span class="mf">0.135</span><span class="p">,</span> <span class="mf">0.150</span><span class="p">,</span> <span class="mf">0.860</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Circ InOut</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;BIN&#39;</span><span class="p">,</span>    <span class="p">[</span><span class="mf">0.600</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.280</span><span class="p">,</span> <span class="mf">0.735</span><span class="p">,</span> <span class="mf">0.045</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Back In</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;BOUT&#39;</span><span class="p">,</span>   <span class="p">[</span><span class="mf">0.175</span><span class="p">,</span> <span class="mf">0.885</span><span class="p">,</span> <span class="mf">0.320</span><span class="p">,</span> <span class="mf">1.275</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Back Out</span>
<span class="nx">__registerSegEasing</span><span class="p">(</span><span class="s1">&#39;BINOUT&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.680</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.550</span><span class="p">,</span> <span class="mf">0.265</span><span class="p">,</span> <span class="mf">1.550</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">]);</span> <span class="c1">// Back InOut</span></pre></div>             </td>           </tr>                               <tr id="section-167">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-167">&#182;</a>               </div>               <h2>Paths</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-168">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-168">&#182;</a>               </div>               <p>M<X> <Y> - move to
L<X> <Y> - line to
C<X1> <Y1> <X2> <Y2> <X3> <Y3> - curve to
Z - close path
lowercase marker means relative coord
Example: "M0 10 L20 20 C10 20 15 30 10 9 Z"</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-169">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-169">&#182;</a>               </div>               <p>all commands:
V = vertical lineto
C = curveto
S = smooth curveto
Q = quadratic Bézier curve
T = smooth quadratic Bézier curveto
A = elliptical Arc
Z = closepath</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-170">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-170">&#182;</a>               </div>               <p>Currently our format differs in a number format:
"M0.0 10.0 L20.0 20.0 C10.0 20.0 15.0 30.0 10.0 9.0 Z"</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-171">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-171">&#182;</a>               </div>               <p>path constants</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">C</span><span class="p">.</span><span class="nx">P_MOVETO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">P_LINETO</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">P_CURVETO</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="nx">C</span><span class="p">.</span><span class="nx">PC_ROUND</span> <span class="o">=</span> <span class="s1">&#39;round&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">PC_BUTT</span> <span class="o">=</span> <span class="s1">&#39;butt&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">PC_MITER</span> <span class="o">=</span> <span class="s1">&#39;miter&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">PC_SQUARE</span> <span class="o">=</span> <span class="s1">&#39;square&#39;</span><span class="p">;</span>
<span class="nx">C</span><span class="p">.</span><span class="nx">PC_BEVEL</span> <span class="o">=</span> <span class="s1">&#39;bevel&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-172">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-172">&#182;</a>               </div>               <blockquote>
  <p>Path % (str: String)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">Path</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">fill</span><span class="p">,</span> <span class="nx">stroke</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">str</span> <span class="o">=</span> <span class="nx">str</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fill</span> <span class="o">=</span> <span class="nx">fill</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stroke</span> <span class="o">=</span> <span class="nx">stroke</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">segs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">Path</span><span class="p">.</span><span class="nx">DEFAULT_CAP</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PC_ROUND</span><span class="p">;</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">DEFAULT_JOIN</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PC_ROUND</span><span class="p">;</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">EMPTY_FILL</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="s1">&#39;transparent&#39;</span> <span class="p">};</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">DEFAULT_FILL</span> <span class="o">=</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">EMPTY_FILL</span><span class="p">;</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">BASE_FILL</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="s1">&#39;#fff666&#39;</span> <span class="p">};</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">EMPTY_STROKE</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;transparent&#39;</span> <span class="p">};</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">DEFAULT_STROKE</span> <span class="o">=</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">EMPTY_STROKE</span><span class="p">;</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">BASE_STROKE</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="mf">1.0</span><span class="p">,</span>
                     <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="s1">&#39;#000&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;cap&#39;</span><span class="o">:</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">DEFAULT_CAP</span><span class="p">,</span>
                     <span class="s1">&#39;join&#39;</span><span class="o">:</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">DEFAULT_JOIN</span>
                   <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-173">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-173">&#182;</a>               </div>               <p>visits every chunk of path in array-form and calls
visitor function, so visitor function gets
chunk marker and positions sequentially
data argument will be also passed to visitor if specified</p>

<blockquote>
  <p>Path.visit % (visitor: Function[Segment, Any], data: Any)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">visit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">visitor</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">segments</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">si</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">si</span> <span class="o">&lt;</span> <span class="nx">segments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">si</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">visitor</span><span class="p">(</span><span class="nx">segments</span><span class="p">[</span><span class="nx">si</span><span class="p">],</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-174">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-174">&#182;</a>               </div>               <p>path length, in points</p>

<blockquote>
  <p>Path.length % () => Double</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">segment</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">length</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
        <span class="nx">p</span> <span class="o">=</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">last</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">sum</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-175">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-175">&#182;</a>               </div>               <blockquote>
  <p>Path.add % (seg: Segment)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">seg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">seg</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-176">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-176">&#182;</a>               </div>               <blockquote>
  <p>Path.apply % (ctx: Context)</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">apply</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">DU</span><span class="p">.</span><span class="nx">qDraw</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">stroke</span> <span class="o">||</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">DEFAULT_STROKE</span><span class="p">,</span>
                  <span class="nx">p</span><span class="p">.</span><span class="nx">fill</span> <span class="o">||</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">DEFAULT_FILL</span><span class="p">,</span>
             <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">p</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="nx">Path</span><span class="p">.</span><span class="nx">_applyVisitor</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span> <span class="p">});</span>

    <span class="cm">/*ctx.beginPath();</span>
<span class="cm">    DU.applyFill(ctx, this.fill || Path.DEFAULT_FILL);</span>
<span class="cm">    DU.applyStroke(ctx, this.stroke || Path.DEFAULT_STROKE);</span>
<span class="cm">    this.visit(this._applyVisitor,ctx);</span>
<span class="cm">    ctx.closePath();</span>

<span class="cm">    ctx.fill();</span>
<span class="cm">    ctx.stroke();*/</span>

<span class="p">}</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">cstroke</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">color</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">cap</span><span class="p">,</span> <span class="nx">join</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stroke</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="p">(</span><span class="nx">width</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">?</span> <span class="nx">width</span>
                 <span class="o">:</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">DEFAULT_STROKE</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>
        <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="nx">color</span><span class="p">,</span>
        <span class="s1">&#39;cap&#39;</span><span class="o">:</span> <span class="nx">cap</span> <span class="o">||</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">DEFAULT_CAP</span><span class="p">,</span>
        <span class="s1">&#39;join&#39;</span><span class="o">:</span> <span class="nx">join</span> <span class="o">||</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">DEFAULT_JOIN</span>
    <span class="p">};</span>
<span class="p">}</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">cfill</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fill</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="nx">color</span>
    <span class="p">};</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-177">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-177">&#182;</a>               </div>               <blockquote>
  <p>Path.parse % (str: String) => Path</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-178">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-178">&#182;</a>               </div>               <p>find a segment data in a path that corresponds to specified distance (t)
of the path (0..1),</p>

<blockquote>
  <p>Path.hitAt % (t: [0..1]) => Array[Int, 2]</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hitAt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="cm">/*, func*/</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">startp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span>
          <span class="s1">&#39;seg&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;start&#39;</span><span class="o">:</span> <span class="nx">startp</span><span class="p">,</span> <span class="s1">&#39;slen&#39;</span><span class="o">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;segt&#39;</span><span class="o">:</span> <span class="mf">0.0</span>
        <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">endp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="cm">/*if (t == 1) return func ? func(startp, endp) : endp;*/</span>

    <span class="kd">var</span> <span class="nx">plen</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">();</span> <span class="c1">// path length in pixels</span>
    <span class="kd">var</span> <span class="nx">nsegs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="c1">// number of segments</span>
    <span class="kd">var</span> <span class="nx">distance</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">plen</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">startp</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// checked length in pixels</span>
    <span class="kd">var</span> <span class="nx">seg</span><span class="p">,</span> <span class="nx">slen</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">si</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">si</span> <span class="o">&lt;</span> <span class="nx">nsegs</span><span class="p">;</span> <span class="nx">si</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">seg</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">[</span><span class="nx">si</span><span class="p">];</span>
        <span class="nx">slen</span> <span class="o">=</span> <span class="nx">seg</span><span class="p">.</span><span class="nx">length</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span> <span class="c1">// segment length</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">distance</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">slen</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-179">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-179">&#182;</a>               </div>               <p>inside current segment</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">segdist</span> <span class="o">=</span> <span class="nx">distance</span> <span class="o">-</span> <span class="nx">length</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">{</span>
              <span class="s1">&#39;seg&#39;</span><span class="o">:</span> <span class="nx">seg</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="o">:</span> <span class="nx">p</span><span class="p">,</span> <span class="s1">&#39;slen&#39;</span><span class="o">:</span> <span class="nx">slen</span><span class="p">,</span> <span class="s1">&#39;segt&#39;</span><span class="o">:</span> <span class="p">(</span><span class="nx">slen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="nx">segdist</span> <span class="o">/</span> <span class="nx">slen</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span>
            <span class="p">};</span>
        <span class="p">}</span>
        <span class="nx">length</span> <span class="o">+=</span> <span class="nx">slen</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-180">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-180">&#182;</a>               </div>               <p>end point of segment</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">p</span> <span class="o">=</span> <span class="nx">seg</span><span class="p">.</span><span class="nx">last</span><span class="p">();</span>
    <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">lseg</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="s1">&#39;seg&#39;</span><span class="o">:</span> <span class="nx">lseg</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="o">:</span> <span class="nx">p</span><span class="p">,</span> <span class="s1">&#39;slen&#39;</span><span class="o">:</span> <span class="nx">lseg</span><span class="p">.</span><span class="nx">length</span><span class="p">(</span><span class="nx">p</span><span class="p">),</span> <span class="s1">&#39;segt&#39;</span><span class="o">:</span> <span class="mf">1.0</span>
    <span class="p">};</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-181">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-181">&#182;</a>               </div>               <p>find a point on a path at specified distance (t) of the path (0..1),
a function that transforms the result point (using given start point of
segment and a point on a segment) may be passed</p>

<blockquote>
  <p>Path.pointAt % (t: [0..1]) => Array[Int, 2]</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pointAt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">hit</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hitAt</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">seg</span><span class="p">.</span><span class="nx">atT</span><span class="p">(</span><span class="nx">hit</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">segt</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-182">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-182">&#182;</a>               </div>               <p>find a tangent on a path at specified distance (t) of the path (0..1)</p>

<blockquote>
  <p>Path.tangentAt % (t: [0..1]) => Double</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">tangentAt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">hit</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hitAt</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">seg</span><span class="p">.</span><span class="nx">tangentAt</span><span class="p">(</span><span class="nx">hit</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">segt</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>   <span class="c1">// first-x</span>
             <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">];</span> <span class="c1">// first-y</span>
<span class="p">}</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">lastidx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">[</span><span class="nx">lastidx</span><span class="p">].</span><span class="nx">count</span><span class="p">;</span> <span class="c1">// size of the last segment</span>
    <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">[</span><span class="nx">lastidx</span><span class="p">].</span><span class="nx">pts</span><span class="p">[</span><span class="nx">s</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>   <span class="c1">// last-x</span>
             <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">[</span><span class="nx">lastidx</span><span class="p">].</span><span class="nx">pts</span><span class="p">[</span><span class="nx">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">];</span> <span class="c1">// last-y</span>
<span class="p">}</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bounds</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-183">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-183">&#182;</a>               </div>               <p>FIXME: it is not ok for curve path, possibly</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">minX</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">maxX</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">minY</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">maxY</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">segs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">segment</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">pts</span> <span class="o">=</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">pts</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">pi</span> <span class="o">&lt;</span> <span class="nx">pts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">pi</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">minX</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">minX</span><span class="p">,</span> <span class="nx">pts</span><span class="p">[</span><span class="nx">pi</span><span class="p">]);</span>
            <span class="nx">maxX</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">maxX</span><span class="p">,</span> <span class="nx">pts</span><span class="p">[</span><span class="nx">pi</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">pi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">pi</span> <span class="o">&lt;</span> <span class="nx">pts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">pi</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">minY</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">minY</span><span class="p">,</span> <span class="nx">pts</span><span class="p">[</span><span class="nx">pi</span><span class="p">]);</span>
            <span class="nx">maxY</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">maxY</span><span class="p">,</span> <span class="nx">pts</span><span class="p">[</span><span class="nx">pi</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="p">[</span> <span class="nx">minX</span><span class="p">,</span> <span class="nx">minY</span><span class="p">,</span> <span class="nx">maxX</span><span class="p">,</span> <span class="nx">maxY</span> <span class="p">];</span>
<span class="p">}</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-184">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-184">&#182;</a>               </div>               <p>returns clockwise coordinates of the points
for easier drawing
minX, minY, maxX, minY,</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="p">[</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span></pre></div>             </td>           </tr>                               <tr id="section-185">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-185">&#182;</a>               </div>               <p>maxX, maxY, minX, maxY</p>             </td>             <td class="code">               <div class="highlight"><pre>             <span class="nx">b</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">];</span>
<span class="p">}</span>
<span class="cm">/* TODO: rename to `modify`? */</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">vpoints</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">segment</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">pts</span> <span class="o">=</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">pts</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">pi</span> <span class="o">&lt;</span> <span class="nx">pts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">pi</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">func</span><span class="p">(</span><span class="nx">pts</span><span class="p">[</span><span class="nx">pi</span><span class="p">],</span> <span class="nx">pts</span><span class="p">[</span><span class="nx">pi</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">pts</span><span class="p">[</span><span class="nx">pi</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="nx">pts</span><span class="p">[</span><span class="nx">pi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shift</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vpoints</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="nx">y</span> <span class="o">+</span> <span class="nx">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">];</span>
    <span class="p">});</span>
<span class="p">};</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">zoom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">vals</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vpoints</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="nx">y</span> <span class="o">*</span> <span class="nx">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">];</span>
    <span class="p">});</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-186">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-186">&#182;</a>               </div>               <p>moves path to be positioned at 0,0 and
returns subtracted top-left point
and a center point</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">normalize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">bounds</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="p">(</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="nx">h</span> <span class="o">=</span> <span class="p">(</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="kd">var</span> <span class="nx">hw</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">w</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
        <span class="nx">hh</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">h</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">min_x</span> <span class="o">=</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">min_y</span> <span class="o">=</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vpoints</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span> <span class="nx">x</span> <span class="o">-</span> <span class="nx">min_x</span> <span class="o">-</span> <span class="nx">hw</span><span class="p">,</span>
                 <span class="nx">y</span> <span class="o">-</span> <span class="nx">min_y</span> <span class="o">-</span> <span class="nx">hh</span><span class="p">];</span>
        <span class="p">});</span>
    <span class="k">return</span> <span class="p">[</span> <span class="nx">hw</span><span class="p">,</span> <span class="nx">hh</span> <span class="p">];</span>
<span class="p">}</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getPoints</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">points</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">seg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">points</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">seg</span><span class="p">.</span><span class="nx">pts</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">points</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;[ Path &#39;&quot;</span> <span class="o">+</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">toSVGString</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; ]&quot;</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-187">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-187">&#182;</a>               </div>               <p>not a clone, but only segments-copy</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">duplicate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">seg_copy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Path</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">seg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">seg_copy</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">Path</span><span class="p">.</span><span class="nx">makeSeg</span><span class="p">(</span><span class="nx">seg</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">seg</span><span class="p">.</span><span class="nx">pts</span><span class="p">)));</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">seg_copy</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clone</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">clone</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">duplicate</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stroke</span><span class="p">)</span> <span class="nx">clone</span><span class="p">.</span><span class="nx">stroke</span> <span class="o">=</span> <span class="nx">obj_clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stroke</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fill</span><span class="p">)</span> <span class="nx">clone</span><span class="p">.</span><span class="nx">fill</span> <span class="o">=</span> <span class="nx">obj_clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fill</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">clone</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-188">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-188">&#182;</a>               </div>               <p>visits every chunk of path in string-form and calls
visitor function, so visitor function gets
chunk marker and positions sequentially
data argument will be also passed to visitor if specified</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">visitStrPath</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">visitor</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cur_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">path</span><span class="p">[</span><span class="nx">cur_pos</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span> <span class="o">===</span> <span class="s1">&#39;Z&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">visitor</span><span class="p">(</span><span class="nx">marker</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">data</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">pos_data</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">marker</span> <span class="o">===</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">marker</span> <span class="o">===</span> <span class="s1">&#39;L&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">pos_data</span> <span class="o">=</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">_collectPositions</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">cur_pos</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span> <span class="o">===</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">pos_data</span> <span class="o">=</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">_collectPositions</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">cur_pos</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">cur_pos</span> <span class="o">+=</span> <span class="nx">pos_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">positions</span> <span class="o">=</span> <span class="nx">pos_data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="nx">visitor</span><span class="p">(</span><span class="nx">marker</span><span class="p">,</span> <span class="nx">positions</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">toSVGString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">path</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="nx">Path</span><span class="p">.</span><span class="nx">_encodeVisitor</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">);</span>
    <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-189">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-189">&#182;</a>               </div>               <p>parses <code>count</code> positions from path (string form),
starting at <code>start</code>, returns a length of parsed data and
positions array</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">_collectPositions</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">positions</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">got</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">got</span> <span class="o">!=</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">posstr</span> <span class="o">=</span> <span class="nx">__collect_to</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">);</span>
        <span class="nx">pos</span> <span class="o">+=</span> <span class="nx">posstr</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">got</span><span class="o">++</span><span class="p">;</span>
        <span class="nx">positions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">posstr</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">pos</span> <span class="o">-</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">positions</span><span class="p">];</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-190">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-190">&#182;</a>               </div>               <p>visitor to parse a string path into Path object</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">_parserVisitor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">marker</span><span class="p">,</span> <span class="nx">positions</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span> <span class="o">===</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">path</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">MSeg</span><span class="p">(</span><span class="nx">positions</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span> <span class="o">===</span> <span class="s1">&#39;L&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">path</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">LSeg</span><span class="p">(</span><span class="nx">positions</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span> <span class="o">===</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">path</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">CSeg</span><span class="p">(</span><span class="nx">positions</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-191">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-191">&#182;</a>               </div>               <p>visitor to apply string path to context</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">_strApplyVisitor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">marker</span><span class="p">,</span> <span class="nx">positions</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span> <span class="o">===</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span> <span class="o">===</span> <span class="s1">&#39;L&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">marker</span> <span class="o">===</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">bezierCurveTo</span><span class="p">(</span><span class="nx">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                          <span class="nx">positions</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                          <span class="nx">positions</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">_applyVisitor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">segment</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">positions</span> <span class="o">=</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">pts</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">P_MOVETO</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">P_LINETO</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">P_CURVETO</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">bezierCurveTo</span><span class="p">(</span><span class="nx">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                          <span class="nx">positions</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                          <span class="nx">positions</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">_encodeVisitor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">segment</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">positions</span> <span class="o">=</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">pts</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">P_MOVETO</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="o">+</span><span class="nx">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nx">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">P_LINETO</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="o">+</span><span class="nx">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nx">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">P_CURVETO</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="o">+</span><span class="nx">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nx">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span>
                        <span class="nx">positions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nx">positions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span>
                        <span class="nx">positions</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nx">positions</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-192">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-192">&#182;</a>               </div>               <p>converts path given in string form to array of segments</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">target</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">Path</span><span class="p">();</span>
    <span class="nx">target</span><span class="p">.</span><span class="nx">segs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">Path</span><span class="p">.</span><span class="nx">visitStrPath</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">_parserVisitor</span><span class="p">,</span> <span class="nx">target</span><span class="p">);</span>
    <span class="nx">target</span><span class="p">.</span><span class="nx">str</span> <span class="o">=</span> <span class="nx">path</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-193">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-193">&#182;</a>               </div>               <p>parses a path in string form and immediately applies it to context</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">parseAndApply</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Path</span><span class="p">.</span><span class="nx">visitStrPath</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">_strApplyVisitor</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Path</span><span class="p">.</span><span class="nx">makeSeg</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">pts</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">P_MOVETO</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">MSeg</span><span class="p">(</span><span class="nx">pts</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">P_LINETO</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">LSeg</span><span class="p">(</span><span class="nx">pts</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">P_CURVETO</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">CSeg</span><span class="p">(</span><span class="nx">pts</span><span class="p">);</span> <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-194">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-194">&#182;</a>               </div>               <p>create canvas-compatible style from brush</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Path</span><span class="p">.</span><span class="nx">createStyle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">brush</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">brush</span><span class="p">.</span><span class="nx">color</span><span class="p">)</span> <span class="k">return</span> <span class="nx">brush</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">brush</span><span class="p">.</span><span class="nx">lgrad</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">src</span> <span class="o">=</span> <span class="nx">brush</span><span class="p">.</span><span class="nx">lgrad</span><span class="p">,</span>
            <span class="nx">stops</span> <span class="o">=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">stops</span><span class="p">,</span>
            <span class="nx">dir</span> <span class="o">=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">dir</span><span class="p">,</span>
            <span class="nx">bounds</span> <span class="o">=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">bounds</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">grad</span> <span class="o">=</span> <span class="nx">bounds</span>
            <span class="o">?</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">createLinearGradient</span><span class="p">(</span>
                            <span class="nx">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">dir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="c1">// b.x + x0 * b.width</span>
                            <span class="nx">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">dir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="c1">// b.y + y0 * b.height</span>
                            <span class="nx">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">dir</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="c1">// b.x + x1 * b.width</span>
                            <span class="nx">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">dir</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">// b.y + y1 * b.height</span>
            <span class="o">:</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">createLinearGradient</span><span class="p">(</span>
                            <span class="nx">dir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nx">dir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>  <span class="c1">// x0, y0</span>
                            <span class="nx">dir</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nx">dir</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span> <span class="c1">// x1, y1</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">slen</span> <span class="o">=</span> <span class="nx">stops</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">slen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">stop</span> <span class="o">=</span> <span class="nx">stops</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="nx">grad</span><span class="p">.</span><span class="nx">addColorStop</span><span class="p">(</span><span class="nx">stop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">grad</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">brush</span><span class="p">.</span><span class="nx">rgrad</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">src</span> <span class="o">=</span> <span class="nx">brush</span><span class="p">.</span><span class="nx">rgrad</span><span class="p">,</span>
            <span class="nx">stops</span> <span class="o">=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">stops</span><span class="p">,</span>
            <span class="nx">dir</span> <span class="o">=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">dir</span><span class="p">,</span>
            <span class="nx">r</span> <span class="o">=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span>
            <span class="nx">bounds</span> <span class="o">=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">bounds</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">grad</span> <span class="o">=</span> <span class="nx">bounds</span>
            <span class="o">?</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">createRadialGradient</span><span class="p">(</span>
                            <span class="nx">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">dir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="c1">// b.x + x0 * b.width</span>
                            <span class="nx">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">dir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="c1">// b.y + y0 * b.height</span>
                            <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="nx">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="c1">// max(width, height) * r0</span>
                            <span class="nx">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">dir</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="c1">// b.x + x1 * b.width</span>
                            <span class="nx">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">dir</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="c1">// b.y + y1 * b.height</span>
                            <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="nx">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">// max(width, height) * r1</span>
            <span class="o">:</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">createRadialGradient</span><span class="p">(</span>
                           <span class="nx">dir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nx">dir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nx">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1">// x0, y0, r0</span>
                           <span class="nx">dir</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nx">dir</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nx">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="c1">// x1, y1, r1</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">slen</span> <span class="o">=</span> <span class="nx">stops</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">slen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">stop</span> <span class="o">=</span> <span class="nx">stops</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="nx">grad</span><span class="p">.</span><span class="nx">addColorStop</span><span class="p">(</span><span class="nx">stop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">grad</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">MSeg</span><span class="p">(</span><span class="nx">pts</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">P_MOVETO</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pts</span> <span class="o">=</span> <span class="nx">pts</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="nx">pts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-195">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-195">&#182;</a>               </div>               <blockquote>
  <p>MSeg.length(start: Array[Int,2]) => Double</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">MSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-196">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-196">&#182;</a>               </div>               <p>distance is specified in points</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">MSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">atDist</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">dist</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">];</span>
<span class="p">}</span>
<span class="nx">MSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">atT</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">atDist</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">MSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">tangentAt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>
<span class="nx">MSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">last</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">LSeg</span><span class="p">(</span><span class="nx">pts</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">P_LINETO</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pts</span> <span class="o">=</span> <span class="nx">pts</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="nx">pts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">LSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">dx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">start</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">dy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">start</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">dx</span><span class="o">*</span><span class="nx">dx</span> <span class="o">+</span> <span class="nx">dy</span><span class="o">*</span><span class="nx">dy</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">LSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">atDist</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">dist</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">atT</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">dist</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">(</span><span class="nx">start</span><span class="p">));</span>
<span class="p">}</span>
<span class="nx">LSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">atT</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">p0x</span> <span class="o">=</span> <span class="nx">start</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p0y</span> <span class="o">=</span> <span class="nx">start</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p1x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p1y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="nx">p0x</span> <span class="o">+</span> <span class="p">(</span><span class="nx">p1x</span> <span class="o">-</span> <span class="nx">p0x</span><span class="p">)</span> <span class="o">*</span> <span class="nx">t</span><span class="p">,</span>
        <span class="nx">p0y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">p1y</span> <span class="o">-</span> <span class="nx">p0y</span><span class="p">)</span> <span class="o">*</span> <span class="nx">t</span>
    <span class="p">];</span>
<span class="p">}</span>
<span class="nx">LSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">tangentAt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                      <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>
<span class="nx">LSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">last</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">CSeg</span><span class="p">(</span><span class="nx">pts</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">P_CURVETO</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pts</span> <span class="o">=</span> <span class="nx">pts</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="nx">pts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">CSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* FIXME: cache length data and points somewhere */</span>
    <span class="kd">var</span> <span class="nx">positions</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">p0x</span> <span class="o">=</span> <span class="nx">start</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p0y</span> <span class="o">=</span> <span class="nx">start</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p1x</span> <span class="o">=</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p1y</span> <span class="o">=</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p2x</span> <span class="o">=</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p2y</span> <span class="o">=</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p3x</span> <span class="o">=</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p3y</span> <span class="o">=</span> <span class="nx">positions</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

    <span class="kd">var</span> <span class="nx">p0to1</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">p1x</span><span class="o">-</span><span class="nx">p0x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">p1y</span><span class="o">-</span><span class="nx">p0y</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">p1to2</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">p2x</span><span class="o">-</span><span class="nx">p1x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">p2y</span><span class="o">-</span><span class="nx">p1y</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">p2to3</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">p3x</span><span class="o">-</span><span class="nx">p2x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">p3y</span><span class="o">-</span><span class="nx">p2y</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

    <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">p0to1</span> <span class="o">+</span> <span class="nx">p1to2</span> <span class="o">+</span> <span class="nx">p2to3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">len</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-197">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-197">&#182;</a>               </div>               <p>choose the step as 1/len</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">dt</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nx">len</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">q1</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="nx">dt</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">q2</span> <span class="o">=</span> <span class="nx">q1</span> <span class="o">*</span> <span class="nx">dt</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">q3</span> <span class="o">=</span> <span class="nx">dt</span> <span class="o">*</span> <span class="nx">dt</span> <span class="o">*</span> <span class="nx">dt</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">q4</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">q2</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">q5</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="nx">q3</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">q6x</span> <span class="o">=</span> <span class="nx">p0x</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">p1x</span> <span class="o">+</span> <span class="nx">p2x</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">q6y</span> <span class="o">=</span> <span class="nx">p0y</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">p1y</span> <span class="o">+</span> <span class="nx">p2y</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">q7x</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="nx">p1x</span> <span class="o">-</span> <span class="nx">p2x</span><span class="p">)</span> <span class="o">-</span> <span class="nx">p0x</span> <span class="o">+</span> <span class="nx">p3x</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">q7y</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="nx">p1y</span> <span class="o">-</span> <span class="nx">p2y</span><span class="p">)</span> <span class="o">-</span> <span class="nx">p0y</span> <span class="o">+</span> <span class="nx">p3y</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">bx</span> <span class="o">=</span> <span class="nx">p0x</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">by</span> <span class="o">=</span> <span class="nx">p0y</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">dbx</span> <span class="o">=</span> <span class="p">(</span><span class="nx">p1x</span> <span class="o">-</span> <span class="nx">p0x</span><span class="p">)</span> <span class="o">*</span> <span class="nx">q1</span> <span class="o">+</span> <span class="nx">q6x</span> <span class="o">*</span> <span class="nx">q2</span> <span class="o">+</span> <span class="nx">q3</span> <span class="o">*</span> <span class="nx">q7x</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">dby</span> <span class="o">=</span> <span class="p">(</span><span class="nx">p1y</span> <span class="o">-</span> <span class="nx">p0y</span><span class="p">)</span> <span class="o">*</span> <span class="nx">q1</span> <span class="o">+</span> <span class="nx">q6y</span> <span class="o">*</span> <span class="nx">q2</span> <span class="o">+</span> <span class="nx">q3</span> <span class="o">*</span> <span class="nx">q7y</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">ddbx</span> <span class="o">=</span> <span class="nx">q6x</span> <span class="o">*</span> <span class="nx">q4</span> <span class="o">+</span> <span class="nx">q7x</span> <span class="o">*</span> <span class="nx">q5</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ddby</span> <span class="o">=</span> <span class="nx">q6y</span> <span class="o">*</span> <span class="nx">q4</span> <span class="o">+</span> <span class="nx">q7y</span> <span class="o">*</span> <span class="nx">q5</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">dddbx</span> <span class="o">=</span> <span class="nx">q7x</span> <span class="o">*</span> <span class="nx">q5</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">dddby</span> <span class="o">=</span> <span class="nx">q7y</span> <span class="o">*</span> <span class="nx">q5</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">idx</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="nx">idx</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">px</span> <span class="o">=</span> <span class="nx">bx</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">py</span> <span class="o">=</span> <span class="nx">by</span><span class="p">;</span>

        <span class="nx">bx</span> <span class="o">+=</span> <span class="nx">dbx</span><span class="p">;</span>
        <span class="nx">by</span> <span class="o">+=</span> <span class="nx">dby</span><span class="p">;</span>

        <span class="nx">dbx</span> <span class="o">+=</span> <span class="nx">ddbx</span><span class="p">;</span>
        <span class="nx">dby</span> <span class="o">+=</span> <span class="nx">ddby</span><span class="p">;</span>

        <span class="nx">ddbx</span> <span class="o">+=</span> <span class="nx">dddbx</span><span class="p">;</span>
        <span class="nx">ddby</span> <span class="o">+=</span> <span class="nx">dddby</span><span class="p">;</span>

        <span class="nx">length</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">((</span><span class="nx">bx</span> <span class="o">-</span> <span class="nx">px</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">bx</span> <span class="o">-</span> <span class="nx">px</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">by</span> <span class="o">-</span> <span class="nx">py</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">by</span> <span class="o">-</span> <span class="nx">py</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">length</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">CSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">atDist</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">dist</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">atT</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">dist</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">(</span><span class="nx">start</span><span class="p">));</span>
<span class="p">}</span>
<span class="nx">CSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">atT</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tt</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span><span class="p">,</span>       <span class="c1">// t^2</span>
        <span class="nx">ttt</span> <span class="o">=</span> <span class="nx">tt</span> <span class="o">*</span> <span class="nx">t</span><span class="p">,</span>      <span class="c1">// t^3</span>
        <span class="nx">t1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="nx">t</span><span class="p">,</span>       <span class="c1">// 1-t</span>
        <span class="nx">tt1</span> <span class="o">=</span> <span class="nx">t1</span> <span class="o">*</span> <span class="nx">t1</span><span class="p">,</span>     <span class="c1">// (1-t)^2</span>
        <span class="nx">tt2</span> <span class="o">=</span> <span class="nx">tt1</span> <span class="o">*</span> <span class="nx">t1</span><span class="p">,</span>    <span class="c1">// (1-t)^3</span>
        <span class="nx">tt3</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">tt1</span><span class="p">,</span>   <span class="c1">// 3*t*(1-t)^2</span>
        <span class="nx">tt4</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="nx">tt</span> <span class="o">*</span> <span class="nx">t1</span><span class="p">;</span>   <span class="c1">// 3*t^2*(1-t)</span>

    <span class="k">return</span> <span class="p">[</span> <span class="nx">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">tt2</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">tt3</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nx">tt4</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="nx">ttt</span><span class="p">,</span>
             <span class="nx">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">tt2</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">tt3</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="nx">tt4</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="nx">ttt</span> <span class="p">];</span>
<span class="p">}</span>
<span class="nx">CSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">last</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">];</span>
<span class="p">}</span>
<span class="nx">CSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">tangentAt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_ensure_params</span><span class="p">(</span><span class="nx">start</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">par</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_params</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">tt</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span><span class="p">;</span> <span class="c1">// t^2</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">3</span> <span class="o">*</span> <span class="nx">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">tt</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">par</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">+</span> <span class="nx">par</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
              <span class="mi">3</span> <span class="o">*</span> <span class="nx">par</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="nx">tt</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">par</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">+</span> <span class="nx">par</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="p">];</span>
    <span class="cm">/*var p = this.atT(start, t);*/</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>
<span class="nx">CSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_ensure_params</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_lstart</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_lstart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">start</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_lstart</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="nx">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_lstart</span> <span class="o">=</span> <span class="nx">start</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_params</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_calc_params</span><span class="p">(</span><span class="nx">start</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">CSeg</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_calc_params</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-198">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-198">&#182;</a>               </div>               <p>See http://www.planetclegg.com/projects/WarpingTextToSplines.html</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">pts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pts</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">p0x</span> <span class="o">=</span> <span class="nx">start</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p0y</span> <span class="o">=</span> <span class="nx">start</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p1x</span> <span class="o">=</span> <span class="nx">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p1y</span> <span class="o">=</span> <span class="nx">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p2x</span> <span class="o">=</span> <span class="nx">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p2y</span> <span class="o">=</span> <span class="nx">pts</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p3x</span> <span class="o">=</span> <span class="nx">pts</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">p3y</span> <span class="o">=</span> <span class="nx">pts</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

    <span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">p3x</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="nx">p2x</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="nx">p1x</span> <span class="o">-</span> <span class="nx">p0x</span><span class="p">;</span>  <span class="c1">// A = x3 - 3 * x2 + 3 * x1 - x0</span>
    <span class="nx">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="nx">p2x</span> <span class="o">-</span> <span class="mi">6</span><span class="o">*</span><span class="nx">p1x</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="nx">p0x</span><span class="p">;</span>      <span class="c1">// B = 3 * x2 - 6 * x1 + 3 * x0</span>
    <span class="nx">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="nx">p1x</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="nx">p0x</span><span class="p">;</span>              <span class="c1">// C = 3 * x1 - 3 * x0</span>
    <span class="nx">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nx">p0x</span><span class="p">;</span>                        <span class="c1">// D = x0</span>

    <span class="nx">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nx">p3y</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="nx">p2y</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="nx">p1y</span> <span class="o">-</span> <span class="nx">p0y</span><span class="p">;</span>  <span class="c1">// E = y3 - 3 * y2 + 3 * y1 - y0</span>
    <span class="nx">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="nx">p2y</span> <span class="o">-</span> <span class="mi">6</span><span class="o">*</span><span class="nx">p1y</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="nx">p0y</span><span class="p">;</span>      <span class="c1">// F = 3 * y2 - 6 * y1 + 3 * y0</span>
    <span class="nx">params</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="nx">p1y</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="nx">p0y</span><span class="p">;</span>              <span class="c1">// G = 3 * y1 - 3 * y0</span>
    <span class="nx">params</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="nx">p0y</span><span class="p">;</span>                        <span class="c1">// H = y0</span>

    <span class="k">return</span> <span class="nx">params</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-199">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-199">&#182;</a>               </div>               <h2>Text</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Text</span><span class="p">.</span><span class="nx">DEFAULT_CAP</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PC_ROUND</span><span class="p">;</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">DEFAULT_JOIN</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PC_ROUND</span><span class="p">;</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">DEFAULT_FFACE</span> <span class="o">=</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">;</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">DEFAULT_FSIZE</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">DEFAULT_FONT</span> <span class="o">=</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">DEFAULT_FSIZE</span> <span class="o">+</span> <span class="s1">&#39;px &#39;</span> <span class="o">+</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">DEFAULT_FFACE</span><span class="p">;</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">DEFAULT_FILL</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="s1">&#39;#000&#39;</span> <span class="p">};</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">BASELINE_RULE</span> <span class="o">=</span> <span class="s1">&#39;bottom&#39;</span><span class="p">;</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">DEFAULT_STROKE</span> <span class="o">=</span> <span class="kc">null</span><span class="cm">/*Path.EMPTY_STROKE*/</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">Text</span><span class="p">(</span><span class="nx">lines</span><span class="p">,</span> <span class="nx">font</span><span class="p">,</span>
              <span class="nx">fill</span><span class="p">,</span> <span class="nx">stroke</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lines</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="nx">font</span> <span class="o">||</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">DEFAULT_FONT</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fill</span> <span class="o">=</span> <span class="nx">fill</span> <span class="o">||</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">DEFAULT_FILL</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stroke</span> <span class="o">=</span> <span class="nx">stroke</span> <span class="o">||</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">DEFAULT_STROKE</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_bnds</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">apply</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">point</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">point</span> <span class="o">=</span> <span class="nx">point</span> <span class="o">||</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="nx">dimen</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dimen</span><span class="p">(),</span>
        <span class="nx">accent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">accent</span><span class="p">(</span><span class="nx">dimen</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">font</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">textBaseline</span> <span class="o">=</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">BASELINE_RULE</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="cm">/* + (dimen[0] / 2)*/</span><span class="p">,</span> <span class="nx">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fill</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">DU</span><span class="p">.</span><span class="nx">applyFill</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">fill</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">visitLines</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">accent</span><span class="p">);</span>
            <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="nx">accent</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stroke</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">DU</span><span class="p">.</span><span class="nx">applyStroke</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">stroke</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">visitLines</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">ctx</span><span class="p">.</span><span class="nx">strokeText</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">accent</span><span class="p">);</span>
            <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="nx">accent</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dimen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_dimen</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_dimen</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Text</span><span class="p">.</span><span class="nx">__buff</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">SysErr</span><span class="p">(</span><span class="s1">&#39;no Text buffer, bounds call failed&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">buff</span> <span class="o">=</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">__buff</span><span class="p">;</span>
    <span class="nx">buff</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">font</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">buff</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">buff</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&lt;br/&gt;&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_dimen</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">buff</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">,</span>
                            <span class="nx">buff</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="p">]);</span>

<span class="p">}</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bounds</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">dimen</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dimen</span><span class="p">();</span>
    <span class="k">return</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dimen</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">dimen</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">];</span>
<span class="p">}</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">accent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">height</span><span class="p">;</span> <span class="cm">/* FIXME */</span>
<span class="p">}</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">_createBuffer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="cm">/* FIXME: dispose buffer when text is removed from scene */</span>
    <span class="kd">var</span> <span class="nx">_div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
    <span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="s1">&#39;hidden&#39;</span><span class="p">;</span>
    <span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s1">&#39;absolute&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_span</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">);</span>
    <span class="nx">_div</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">_span</span><span class="p">);</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">_div</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">_span</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">cstroke</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">color</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">cap</span><span class="p">,</span> <span class="nx">join</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stroke</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="p">(</span><span class="nx">width</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">?</span> <span class="nx">width</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="nx">color</span><span class="p">,</span>
        <span class="s1">&#39;cap&#39;</span><span class="o">:</span> <span class="nx">cap</span> <span class="o">||</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">DEFAULT_CAP</span><span class="p">,</span>
        <span class="s1">&#39;join&#39;</span><span class="o">:</span> <span class="nx">join</span> <span class="o">||</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">DEFAULT_JOIN</span>
    <span class="p">};</span>
<span class="p">}</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">cfill</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fill</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;color&#39;</span><span class="o">:</span> <span class="nx">color</span>
    <span class="p">};</span>
<span class="p">}</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">visitLines</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">lines</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">lines</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">func</span><span class="p">(</span><span class="nx">lines</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">line</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ilen</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ilen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">line</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="nx">func</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Text</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clone</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">font</span><span class="p">,</span>
                     <span class="k">this</span><span class="p">.</span><span class="nx">stroke</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">fill</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lines</span> <span class="o">&amp;&amp;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">lines</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stroke</span><span class="p">)</span> <span class="nx">c</span><span class="p">.</span><span class="nx">stroke</span> <span class="o">=</span> <span class="nx">obj_clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stroke</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fill</span><span class="p">)</span> <span class="nx">c</span><span class="p">.</span><span class="nx">fill</span> <span class="o">=</span> <span class="nx">obj_clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fill</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-200">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-200">&#182;</a>               </div>               <h2>Controls</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">Controls</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">player</span> <span class="o">=</span> <span class="nx">player</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">elapsed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_ratio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_lhappens</span> <span class="o">=</span> <span class="nx">C</span><span class="p">.</span><span class="nx">NOTHING</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_initHandlers</span><span class="p">();</span> <span class="cm">/* TODO: make automatic */</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_inParent</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">inParent</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* TODO: move these settings to default css rule? */</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">HEIGHT</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">MARGIN</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">OPACITY</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">;</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">DEF_FGCOLOR</span> <span class="o">=</span> <span class="s1">&#39;#faa&#39;</span><span class="p">;</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">DEF_BGCOLOR</span> <span class="o">=</span> <span class="s1">&#39;#c22&#39;</span><span class="p">;</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">_BH</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">HEIGHT</span> <span class="o">-</span> <span class="p">(</span><span class="nx">Controls</span><span class="p">.</span><span class="nx">MARGIN</span> <span class="o">+</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">MARGIN</span><span class="p">);</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">_TS</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">_BH</span><span class="p">;</span> <span class="c1">// text size</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">_TW</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">_TS</span> <span class="o">*</span> <span class="mf">4.4</span><span class="p">;</span> <span class="c1">// text width</span>
<span class="nx">provideEvents</span><span class="p">(</span><span class="nx">Controls</span><span class="p">,</span> <span class="p">[</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_MDOWN</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">X_DRAW</span><span class="p">]);</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_ratio</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">__pxRatio</span><span class="p">,</span>
        <span class="nx">_w</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="nx">_ratio</span><span class="p">,</span>
        <span class="nx">_h</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">HEIGHT</span><span class="p">,</span>
        <span class="nx">_hdiff</span> <span class="o">=</span> <span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="nx">_ratio</span><span class="p">)</span> <span class="o">-</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">HEIGHT</span><span class="p">,</span>
        <span class="nx">_pp</span> <span class="o">=</span> <span class="nx">find_pos</span><span class="p">(</span><span class="nx">parent</span><span class="p">),</span> <span class="c1">// parent position</span>
        <span class="nx">_bp</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">_pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">_pp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">_hdiff</span> <span class="p">],</span> <span class="c1">// bounds position</span>
        <span class="nx">_cp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_inParent</span> <span class="o">?</span> <span class="p">[</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">,</span>
                                 <span class="nx">parent</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">offsetTop</span> <span class="o">+</span> <span class="nx">_hdiff</span> <span class="p">]</span>
                             <span class="o">:</span> <span class="nx">_bp</span><span class="p">;</span> <span class="c1">// position to set in styles</span>
    <span class="kd">var</span> <span class="nx">_canvas</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_canvas</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_canvas</span> <span class="o">=</span> <span class="nx">newCanvas</span><span class="p">([</span> <span class="nx">_w</span><span class="p">,</span> <span class="nx">_h</span> <span class="p">],</span> <span class="nx">_ratio</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span> <span class="nx">_canvas</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;__&#39;</span><span class="o">+</span><span class="nx">parent</span><span class="p">.</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39;_ctrls&#39;</span><span class="p">;</span> <span class="p">}</span>
        <span class="nx">_canvas</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;anm-controls&#39;</span><span class="p">;</span>
        <span class="nx">_canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s1">&#39;absolute&#39;</span><span class="p">;</span>
        <span class="nx">_canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">OPACITY</span><span class="p">;</span>
        <span class="nx">_canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">zIndex</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">_canvas</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="nx">_canvas</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span> <span class="o">=</span> <span class="nx">_canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">subscribeEvents</span><span class="p">(</span><span class="nx">_canvas</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">changeColor</span><span class="p">(</span><span class="nx">Controls</span><span class="p">.</span><span class="nx">DEF_FGCOLOR</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">canvasOpts</span><span class="p">(</span><span class="nx">_canvas</span><span class="p">,</span> <span class="p">[</span> <span class="nx">_w</span><span class="p">,</span> <span class="nx">_h</span> <span class="p">],</span> <span class="nx">_ratio</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">_canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">_cp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
    <span class="nx">_canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nx">_cp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_ratio</span> <span class="o">=</span> <span class="nx">_ratio</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">Controls</span><span class="p">.</span><span class="nx">_TS</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;px sans-serif&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ready</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">appendTo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_inParent</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parentNode</span>
                                      <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
        <span class="cm">/* FIXME: a dirty hack? */</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_inParent</span><span class="p">)</span> <span class="p">{</span> <span class="nx">appendTo</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s1">&#39;relative&#39;</span><span class="p">;</span> <span class="p">}</span>
        <span class="nx">appendTo</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">_canvas</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span><span class="p">)</span> <span class="nx">_canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">DEF_BGCOLOR</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">_bp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="nx">_w</span><span class="o">*</span><span class="nx">_ratio</span><span class="p">),</span>
                                    <span class="nx">_bp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="nx">_h</span><span class="o">*</span><span class="nx">_ratio</span><span class="p">)</span> <span class="p">];</span>
<span class="p">}</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subscribeEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">controls</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">controls</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_MDOWN</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
            <span class="p">};</span>
        <span class="p">})(</span><span class="k">this</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mouseout&#39;</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">controls</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">controls</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
            <span class="p">};</span>
        <span class="p">})(</span><span class="k">this</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">__force</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">_s</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">happens</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">time</span> <span class="o">=</span> <span class="p">(</span><span class="nx">time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">time</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">__force</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="nx">time</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">_time</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="nx">_s</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">_lhappens</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_time</span> <span class="o">=</span> <span class="nx">time</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_lhappens</span> <span class="o">=</span> <span class="nx">_s</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span>
        <span class="nx">_ratio</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_ratio</span><span class="p">;</span> <span class="c1">// pixelRatio (or use this.canvas.__pxRatio?)</span>
    <span class="kd">var</span> <span class="nx">_bh</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">_BH</span><span class="p">,</span> <span class="c1">// button height</span>
        <span class="nx">_w</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">_h</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nx">_m</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">MARGIN</span><span class="p">,</span>
        <span class="nx">_tw</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">_TW</span><span class="p">,</span> <span class="c1">// text width</span>
        <span class="nx">_pw</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_w</span> <span class="o">/</span> <span class="nx">_ratio</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="nx">_m</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="nx">_tw</span> <span class="o">+</span> <span class="nx">_bh</span><span class="p">);</span> <span class="c1">// progress width</span>
    <span class="cm">/* TODO: update only progress if state not changed? */</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_w</span><span class="p">,</span> <span class="nx">_h</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_ratio</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="nx">_ratio</span><span class="p">,</span> <span class="nx">_ratio</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">_m</span><span class="p">,</span> <span class="nx">_m</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">__fgcolor</span> <span class="o">||</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">DEF_FGCOLOR</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-201">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-201">&#182;</a>               </div>               <p>play/pause/stop button</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">_s</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PLAYING</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-202">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-202">&#182;</a>               </div>               <p>pause button</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Controls</span><span class="p">.</span><span class="nx">__pause_btn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_s</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">STOPPED</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-203">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-203">&#182;</a>               </div>               <p>play button</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Controls</span><span class="p">.</span><span class="nx">__play_btn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_s</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PAUSED</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-204">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-204">&#182;</a>               </div>               <p>play button</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Controls</span><span class="p">.</span><span class="nx">__play_btn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-205">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-205">&#182;</a>               </div>               <p>stop button</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Controls</span><span class="p">.</span><span class="nx">__stop_btn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-206">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-206">&#182;</a>               </div>               <p>progress</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">_bh</span> <span class="o">+</span> <span class="nx">_m</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">Controls</span><span class="p">.</span><span class="nx">__progress</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">_pw</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">duration</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-207">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-207">&#182;</a>               </div>               <p>time</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">_pw</span> <span class="o">+</span> <span class="nx">_m</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">Controls</span><span class="p">.</span><span class="nx">__time</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">elapsed</span>
                         <span class="o">?</span> <span class="p">(</span><span class="nx">time</span> <span class="o">-</span> <span class="nx">state</span><span class="p">.</span><span class="nx">duration</span><span class="p">)</span> <span class="o">:</span> <span class="nx">time</span><span class="p">);</span>

    <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nx">X_DRAW</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">__force</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* TODO: take initial state from imported project */</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hide</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">elapsed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">detach</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_inParent</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parentNode</span>
                    <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">handle_mdown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hidden</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_lx</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">_ly</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nx">_bh</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">_BH</span><span class="p">,</span>
        <span class="nx">_m</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">MARGIN</span><span class="p">,</span>
        <span class="nx">_tw</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">_TW</span><span class="p">,</span>
        <span class="nx">_w</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">_ratio</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_ratio</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_lx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">_bh</span> <span class="o">+</span> <span class="nx">_m</span> <span class="o">+</span> <span class="p">(</span><span class="nx">_m</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span> <span class="c1">// play button area</span>
        <span class="kd">var</span> <span class="nx">_s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">happens</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_s</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">STOPPED</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">play</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_s</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PAUSED</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">play</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_time</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_s</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PLAYING</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_lx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">_w</span> <span class="o">-</span> <span class="p">(</span><span class="nx">_tw</span> <span class="o">+</span> <span class="nx">_m</span><span class="p">)))</span> <span class="p">{</span> <span class="c1">// progress area</span>
        <span class="kd">var</span> <span class="nx">_s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">happens</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_s</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">NOTHING</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">_pw</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_w</span> <span class="o">/</span> <span class="nx">_ratio</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="nx">_m</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="nx">_tw</span> <span class="o">+</span> <span class="nx">_bh</span><span class="p">),</span> <span class="c1">// progress width</span>
            <span class="nx">_px</span> <span class="o">=</span> <span class="nx">_lx</span> <span class="o">-</span> <span class="p">(</span><span class="nx">_bh</span> <span class="o">+</span> <span class="nx">_m</span> <span class="o">+</span> <span class="nx">_m</span><span class="p">),</span> <span class="c1">// progress leftmost x</span>
            <span class="nx">_d</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">duration</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">_tpos</span> <span class="o">=</span> <span class="nx">_px</span> <span class="o">/</span> <span class="p">(</span><span class="nx">_pw</span> <span class="o">/</span> <span class="nx">_d</span><span class="p">);</span> <span class="c1">// time position</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_s</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PLAYING</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">play</span><span class="p">(</span><span class="nx">_tpos</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">_s</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">PAUSED</span><span class="p">)</span> <span class="o">||</span>
                 <span class="p">(</span><span class="nx">_s</span> <span class="o">===</span> <span class="nx">C</span><span class="p">.</span><span class="nx">STOPPED</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">drawAt</span><span class="p">(</span><span class="nx">_tpos</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// time area</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">elapsed</span> <span class="o">=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">elapsed</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inBounds</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">point</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hidden</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">_b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
           <span class="p">(</span><span class="nx">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">_b</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
           <span class="p">(</span><span class="nx">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">_b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
           <span class="p">(</span><span class="nx">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">_b</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">evtInBounds</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hidden</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">inBounds</span><span class="p">([</span><span class="nx">evt</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">pageY</span><span class="p">]);</span>
<span class="p">}</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">changeColor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">front</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__fgcolor</span> <span class="o">=</span> <span class="nx">front</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">forceNextRedraw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__force</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">__play_btn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_bh</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">_BH</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">_bh</span><span class="p">,</span> <span class="nx">_bh</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_bh</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">closePath</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">__pause_btn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_bh</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">_BH</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_w</span> <span class="o">=</span> <span class="nx">_bh</span> <span class="o">/</span> <span class="mf">2.3</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_d</span> <span class="o">=</span> <span class="nx">_bh</span> <span class="o">-</span> <span class="p">(</span><span class="nx">_w</span> <span class="o">+</span> <span class="nx">_w</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">_nl</span> <span class="o">=</span> <span class="nx">_w</span> <span class="o">+</span> <span class="nx">_d</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">_w</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">_w</span><span class="p">,</span> <span class="nx">_bh</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_bh</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">closePath</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">_nl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">_bh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">_bh</span><span class="p">,</span> <span class="nx">_bh</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">_nl</span><span class="p">,</span> <span class="nx">_bh</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">_nl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">closePath</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">__stop_btn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_bh</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">_BH</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">_bh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">_bh</span><span class="p">,</span> <span class="nx">_bh</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_bh</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">closePath</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">__time</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_bh</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">_BH</span><span class="p">,</span>
        <span class="nx">_time</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">time</span><span class="p">),</span>
        <span class="nx">_h</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">_time</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">),</span>
        <span class="nx">_m</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">_time</span> <span class="o">-</span> <span class="p">(</span><span class="nx">_h</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">))</span> <span class="o">/</span> <span class="mi">60</span><span class="p">),</span>
        <span class="nx">_s</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">_time</span> <span class="o">-</span> <span class="p">(</span><span class="nx">_h</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">_m</span> <span class="o">*</span> <span class="mi">60</span><span class="p">));</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(((</span><span class="nx">time</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;(&#39;</span> <span class="o">:</span> <span class="s1">&#39;[&#39;</span><span class="p">)</span> <span class="o">+</span>
                 <span class="p">((</span><span class="nx">_h</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">_h</span><span class="p">)</span> <span class="o">:</span> <span class="nx">_h</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span>
                 <span class="p">((</span><span class="nx">_m</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">_m</span><span class="p">)</span> <span class="o">:</span> <span class="nx">_m</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span>
                 <span class="p">((</span><span class="nx">_s</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">_s</span><span class="p">)</span> <span class="o">:</span> <span class="nx">_s</span><span class="p">)</span> <span class="o">+</span>
                 <span class="p">((</span><span class="nx">time</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;)&#39;</span> <span class="o">:</span> <span class="s1">&#39;]&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_bh</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Controls</span><span class="p">.</span><span class="nx">__progress</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">_w</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">duration</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_bh</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">_BH</span><span class="p">,</span>
        <span class="nx">_m</span> <span class="o">=</span> <span class="nx">Controls</span><span class="p">.</span><span class="nx">MARGIN</span><span class="p">,</span>
        <span class="nx">_px</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_w</span> <span class="o">/</span> <span class="nx">duration</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">,</span>
        <span class="nx">_lh</span> <span class="o">=</span> <span class="nx">_bh</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nx">_ly</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_bh</span> <span class="o">-</span> <span class="nx">_lh</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_ly</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">_w</span><span class="p">,</span> <span class="nx">_ly</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">_w</span><span class="p">,</span> <span class="nx">_ly</span><span class="o">+</span><span class="nx">_lh</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_ly</span><span class="o">+</span><span class="nx">_lh</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_ly</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">closePath</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">duration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">_px</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">_px</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">_px</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="nx">_bh</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">_px</span><span class="p">,</span> <span class="nx">_bh</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">_px</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">closePath</span><span class="p">();</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-208">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-208">&#182;</a>               </div>               <h2>Info Block</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">InfoBlock</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_inParent</span> <span class="o">=</span> <span class="nx">player</span><span class="p">.</span><span class="nx">inParent</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* TODO: move these settings to default css rule? */</span>
<span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">DEF_BGCOLOR</span> <span class="o">=</span> <span class="s1">&#39;#fff&#39;</span><span class="p">;</span>
<span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">DEF_FGCOLOR</span> <span class="o">=</span> <span class="s1">&#39;#000&#39;</span><span class="p">;</span>
<span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">OPACITY</span> <span class="o">=</span> <span class="mf">0.85</span><span class="p">;</span>
<span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">HEIGHT</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
<span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">PADDING</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">detach</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_inParent</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parentNode</span>
                    <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">div</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_p</span> <span class="o">=</span> <span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">PADDING</span><span class="p">,</span>
        <span class="nx">_w</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">width</span> <span class="o">-</span> <span class="p">(</span><span class="nx">_p</span> <span class="o">+</span> <span class="nx">_p</span><span class="p">),</span>
        <span class="nx">_h</span> <span class="o">=</span> <span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">HEIGHT</span> <span class="o">-</span> <span class="p">(</span><span class="nx">_p</span> <span class="o">+</span> <span class="nx">_p</span><span class="p">),</span>
        <span class="nx">_pp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_inParent</span> <span class="o">?</span> <span class="p">[</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">,</span>
                                 <span class="nx">parent</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">offsetTop</span> <span class="p">]</span>
                             <span class="o">:</span> <span class="nx">find_pos</span><span class="p">(</span><span class="nx">parent</span><span class="p">),</span>
        <span class="nx">_l</span> <span class="o">=</span> <span class="nx">_pp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">_t</span> <span class="o">=</span> <span class="nx">_pp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">_div</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">div</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_div</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span> <span class="nx">_div</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;__&#39;</span><span class="o">+</span><span class="nx">parent</span><span class="p">.</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39;_info&#39;</span><span class="p">;</span> <span class="p">}</span>
        <span class="nx">_div</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;anm-info&#39;</span><span class="p">;</span>
        <span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s1">&#39;absolute&#39;</span><span class="p">;</span>
        <span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">OPACITY</span><span class="p">;</span>
        <span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">zIndex</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">fontSize</span><span class="p">)</span> <span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">fontSize</span> <span class="o">=</span> <span class="s1">&#39;10px&#39;</span><span class="p">;</span>
        <span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">padding</span> <span class="o">=</span> <span class="nx">_p</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">div</span> <span class="o">=</span> <span class="nx">_div</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">_div</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">_w</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
    <span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">_h</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
    <span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nx">_t</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
    <span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">_l</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">_l</span><span class="p">,</span> <span class="nx">_t</span><span class="p">,</span> <span class="nx">_l</span><span class="o">+</span><span class="nx">_w</span><span class="p">,</span> <span class="nx">_t</span><span class="o">+</span><span class="nx">_h</span> <span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ready</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">appendTo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_inParent</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parentNode</span>
                                      <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
        <span class="cm">/* FIXME: a dirty hack */</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_inParent</span><span class="p">)</span> <span class="p">{</span> <span class="nx">appendTo</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="s1">&#39;relative&#39;</span><span class="p">;</span> <span class="p">}</span>
        <span class="nx">appendTo</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">_div</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span><span class="p">)</span> <span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">DEF_FGCOLOR</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span><span class="p">)</span> <span class="nx">_div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">DEF_BGCOLOR</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">meta</span><span class="p">,</span> <span class="nx">anim</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* TODO: show speed */</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;p&gt;&lt;span class=&quot;title&quot;&gt;&#39;</span><span class="o">+</span><span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">title</span> <span class="o">||</span> <span class="s1">&#39;[No title]&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&lt;/span&gt;&#39;</span><span class="o">+</span>
            <span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">author</span> <span class="o">?</span> <span class="s1">&#39; by &lt;span class=&quot;author&quot;&gt;&#39;</span><span class="o">+</span><span class="nx">meta</span><span class="p">.</span><span class="nx">author</span><span class="o">+</span><span class="s1">&#39;&lt;/span&gt;&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&lt;br/&gt; &#39;</span><span class="o">+</span>
            <span class="s1">&#39;&lt;span class=&quot;duration&quot;&gt;&#39;</span><span class="o">+</span><span class="nx">anim</span><span class="p">.</span><span class="nx">duration</span><span class="o">+</span><span class="s1">&#39;sec&lt;/span&gt;&#39;</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span>
            <span class="p">(((</span><span class="nx">anim</span><span class="p">.</span><span class="nx">width</span><span class="o">!=</span><span class="kc">null</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">anim</span><span class="p">.</span><span class="nx">height</span><span class="o">!=</span><span class="kc">null</span><span class="p">))</span>
             <span class="o">?</span> <span class="s1">&#39;&lt;span class=&quot;dimen&quot;&gt;&#39;</span><span class="o">+</span><span class="nx">anim</span><span class="p">.</span><span class="nx">width</span><span class="o">+</span><span class="s1">&#39;x&#39;</span><span class="o">+</span><span class="nx">anim</span><span class="p">.</span><span class="nx">height</span><span class="o">+</span><span class="s1">&#39;&lt;/span&gt;&#39;</span><span class="o">+</span><span class="s1">&#39;&lt;br/&gt; &#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span>
            <span class="s1">&#39;&lt;span class=&quot;copy&quot;&gt;&#39;</span><span class="o">+</span><span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">version</span> <span class="o">?</span> <span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="o">+</span><span class="nx">meta</span><span class="p">.</span><span class="nx">version</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                                 <span class="o">+</span><span class="nx">meta</span><span class="p">.</span><span class="nx">copyright</span><span class="o">+</span><span class="s1">&#39;&lt;/span&gt;&#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span>
            <span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">description</span> <span class="o">?</span> <span class="s1">&#39;&lt;br/&gt;&lt;span class=&quot;desc&quot;&gt;&#39;</span><span class="o">+</span><span class="nx">meta</span><span class="p">.</span><span class="nx">description</span><span class="o">+</span><span class="s1">&#39;&lt;/span&gt;&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span>
            <span class="s1">&#39;&lt;/p&gt;&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inBounds</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">point</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">bounds</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">bounds</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">_b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
           <span class="p">(</span><span class="nx">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">_b</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
           <span class="p">(</span><span class="nx">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">_b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
           <span class="p">(</span><span class="nx">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">_b</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>
<span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">evtInBounds</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hidden</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">inBounds</span><span class="p">([</span><span class="nx">evt</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">pageY</span><span class="p">]);</span>
<span class="p">}</span>
<span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>
<span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hide</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setDuration</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">value</span><span class="o">+</span><span class="s1">&#39;sec&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">InfoBlock</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">changeColors</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">front</span><span class="p">,</span> <span class="nx">back</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">front</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="nx">back</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-209">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-209">&#182;</a>               </div>               <h2>Strings</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Strings</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">Strings</span><span class="p">.</span><span class="nx">LOADING</span> <span class="o">=</span> <span class="s1">&#39;Loading...&#39;</span><span class="p">;</span>
<span class="nx">Strings</span><span class="p">.</span><span class="nx">LOADING_ANIMATION</span> <span class="o">=</span> <span class="s1">&#39;Loading {0}...&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-210">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-210">&#182;</a>               </div>               <h3>Errors Strings</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/* ------------------ */</span>

<span class="cm">/* TODO: Move Scene and Element errors here */</span>

<span class="kd">var</span> <span class="nx">Errors</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">S</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// System Errors</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// Player Errors</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// Animation Errors</span>

<span class="nx">Errors</span><span class="p">.</span><span class="nx">S</span><span class="p">.</span><span class="nx">NO_JSON_PARSER</span> <span class="o">=</span> <span class="s1">&#39;JSON parser is not accessible&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">S</span><span class="p">.</span><span class="nx">ERROR_HANDLING_FAILED</span> <span class="o">=</span> <span class="s1">&#39;Error-handling mechanics were broken with error {0}&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">S</span><span class="p">.</span><span class="nx">NO_METHOD_FOR_PLAYER</span> <span class="o">=</span> <span class="s1">&#39;No method \&#39;{0}\&#39; exist for player.&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">NO_IMPORTER_TO_LOAD_WITH</span> <span class="o">=</span> <span class="s1">&#39;Cannot load project without importer. Please define it&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">NO_CANVAS_WITH_ID</span> <span class="o">=</span> <span class="s1">&#39;No canvas found with given id: {0}&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">NO_CANVAS_WAS_PASSED</span> <span class="o">=</span> <span class="s1">&#39;No canvas was passed&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">CANVAS_NOT_PREPARED</span> <span class="o">=</span> <span class="s1">&#39;Canvas is not prepared, don\&#39;t forget to call \&#39;init\&#39; method&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">ALREADY_PLAYING</span> <span class="o">=</span> <span class="s1">&#39;Player is already in playing mode, please call &#39;</span> <span class="o">+</span>
                           <span class="s1">&#39;\&#39;stop\&#39; or \&#39;pause\&#39; before playing again&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">PAUSING_WHEN_STOPPED</span> <span class="o">=</span> <span class="s1">&#39;Player is stopped, so it is not allowed to pause&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">NO_SCENE_PASSED</span> <span class="o">=</span> <span class="s1">&#39;No scene passed to load method&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">NO_STATE</span> <span class="o">=</span> <span class="s1">&#39;There\&#39;s no player state defined, nowhere to draw, &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;please load something in player before &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;calling its playing-related methods&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">NO_SCENE</span> <span class="o">=</span> <span class="s1">&#39;There\&#39;s nothing at all to manage with, &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;please load something in player before &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;calling its playing-related methods&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">COULD_NOT_LOAD_WHILE_PLAYING</span> <span class="o">=</span> <span class="s1">&#39;Could not load any scene while playing or paused, &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;please stop player before loading&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">AFTERFRAME_BEFORE_PLAY</span> <span class="o">=</span> <span class="s1">&#39;Please assign afterFrame callback before calling play()&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">PASSED_TIME_VALUE_IS_NO_TIME</span> <span class="o">=</span> <span class="s1">&#39;Given time is not allowed, it is treated as no-time&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">PASSED_TIME_NOT_IN_RANGE</span> <span class="o">=</span> <span class="s1">&#39;Passed time ({0}) is not in scene range&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">INIT_TWICE</span> <span class="o">=</span> <span class="s1">&#39;Initialization was called twice&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">P</span><span class="p">.</span><span class="nx">INIT_AFTER_LOAD</span> <span class="o">=</span> <span class="s1">&#39;Initialization was called after loading a scene&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">ELEMENT_IS_REGISTERED</span> <span class="o">=</span> <span class="s1">&#39;This element is already registered in scene&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">ELEMENT_IS_NOT_REGISTERED</span> <span class="o">=</span> <span class="s1">&#39;There is no such element registered in scene&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">UNSAFE_TO_REMOVE</span> <span class="o">=</span> <span class="s1">&#39;Unsafe to remove, please use iterator-based looping (with returning false from iterating function) to remove safely&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">NO_ELEMENT_TO_REMOVE</span> <span class="o">=</span> <span class="s1">&#39;Please pass some element or use detach() method&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">NO_ELEMENT</span> <span class="o">=</span> <span class="s1">&#39;No such element found&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">ELEMENT_NOT_ATTACHED</span> <span class="o">=</span> <span class="s1">&#39;Element is not attached to something at all&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">MODIFIER_NOT_ATTACHED</span> <span class="o">=</span> <span class="s1">&#39;Modifier wasn\&#39;t applied to anything&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">NO_MODIFIER_PASSED</span> <span class="o">=</span> <span class="s1">&#39;No modifier was passed&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">NO_PAINTER_PASSED</span> <span class="o">=</span> <span class="s1">&#39;No painter was passed&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">MODIFIER_REGISTERED</span> <span class="o">=</span> <span class="s1">&#39;Modifier was already added to this element&#39;</span><span class="p">;</span>
<span class="nx">Errors</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nx">PAINTER_REGISTERED</span> <span class="o">=</span> <span class="s1">&#39;Painter was already added to this element&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-211">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-211">&#182;</a>               </div>               <h2>Exports</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">to_export</span> <span class="o">=</span> <span class="p">{</span>

    <span class="s1">&#39;C&#39;</span><span class="o">:</span> <span class="nx">C</span><span class="p">,</span> <span class="c1">// constants</span>
    <span class="s1">&#39;M&#39;</span><span class="o">:</span> <span class="nx">M</span><span class="p">,</span> <span class="c1">// modules</span>
    <span class="s1">&#39;Player&#39;</span><span class="o">:</span> <span class="nx">Player</span><span class="p">,</span>
    <span class="s1">&#39;Scene&#39;</span><span class="o">:</span> <span class="nx">Scene</span><span class="p">,</span>
    <span class="s1">&#39;Element&#39;</span><span class="o">:</span> <span class="nx">Element</span><span class="p">,</span>
    <span class="s1">&#39;Clip&#39;</span><span class="o">:</span> <span class="nx">Clip</span><span class="p">,</span>
    <span class="s1">&#39;Path&#39;</span><span class="o">:</span> <span class="nx">Path</span><span class="p">,</span> <span class="s1">&#39;Text&#39;</span><span class="o">:</span> <span class="nx">Text</span><span class="p">,</span>
    <span class="s1">&#39;Tweens&#39;</span><span class="o">:</span> <span class="nx">Tweens</span><span class="p">,</span> <span class="s1">&#39;Tween&#39;</span><span class="o">:</span> <span class="nx">Tween</span><span class="p">,</span> <span class="s1">&#39;Easing&#39;</span><span class="o">:</span> <span class="nx">Easing</span><span class="p">,</span>
    <span class="s1">&#39;Render&#39;</span><span class="o">:</span> <span class="nx">Render</span><span class="p">,</span> <span class="s1">&#39;Bands&#39;</span><span class="o">:</span> <span class="nx">Bands</span><span class="p">,</span> <span class="c1">// why Render and Bands classes are visible to pulic?</span>
    <span class="s1">&#39;MSeg&#39;</span><span class="o">:</span> <span class="nx">MSeg</span><span class="p">,</span> <span class="s1">&#39;LSeg&#39;</span><span class="o">:</span> <span class="nx">LSeg</span><span class="p">,</span> <span class="s1">&#39;CSeg&#39;</span><span class="o">:</span> <span class="nx">CSeg</span><span class="p">,</span>
    <span class="s1">&#39;DU&#39;</span><span class="o">:</span> <span class="nx">DU</span><span class="p">,</span> <span class="c1">// why DU class is visible to pulic?</span>
    <span class="s1">&#39;Errors&#39;</span><span class="o">:</span> <span class="nx">Errors</span><span class="p">,</span> <span class="s1">&#39;SystemError&#39;</span><span class="o">:</span> <span class="nx">SystemError</span><span class="p">,</span>
                      <span class="s1">&#39;PlayerError&#39;</span><span class="o">:</span> <span class="nx">PlayerError</span><span class="p">,</span>
                      <span class="s1">&#39;AnimationError&#39;</span><span class="o">:</span> <span class="nx">AnimationError</span><span class="p">,</span>
    <span class="s1">&#39;MODULES&#39;</span><span class="o">:</span> <span class="p">{},</span>

    <span class="s1">&#39;obj_clone&#39;</span><span class="o">:</span> <span class="nx">obj_clone</span><span class="p">,</span>

    <span class="s1">&#39;createPlayer&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cvs</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Player</span><span class="p">();</span>
                                          <span class="nx">p</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">cvs</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="k">return</span> <span class="nx">p</span><span class="p">;</span> <span class="p">},</span>
    <span class="s1">&#39;ajax&#39;</span><span class="o">:</span> <span class="nx">ajax</span><span class="p">,</span>
    <span class="s1">&#39;_typecheck&#39;</span><span class="o">:</span> <span class="p">{</span> <span class="nx">builder</span><span class="o">:</span> <span class="nx">__builder</span><span class="p">,</span>
                    <span class="nx">array</span><span class="o">:</span> <span class="nx">__array</span><span class="p">,</span>
                    <span class="nx">num</span><span class="o">:</span> <span class="nx">__num</span> <span class="p">},</span>

    <span class="s1">&#39;__dev&#39;</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;strf&#39;</span><span class="o">:</span> <span class="nx">_strf</span><span class="p">,</span>
               <span class="s1">&#39;adjust&#39;</span><span class="o">:</span> <span class="nx">__adjust</span><span class="p">,</span>
               <span class="s1">&#39;t_cmp&#39;</span><span class="o">:</span> <span class="nx">__t_cmp</span><span class="p">,</span>
               <span class="s1">&#39;TIME_PRECISION&#39;</span><span class="o">:</span> <span class="nx">TIME_PRECISION</span><span class="cm">/*,</span>
<span class="cm">               &#39;Controls&#39;: Controls, &#39;Info&#39;: InfoBlock*/</span> <span class="p">},</span>

<span class="p">};</span>

<span class="nx">to_export</span><span class="p">.</span><span class="nx">_$</span> <span class="o">=</span> <span class="nx">to_export</span><span class="p">.</span><span class="nx">createPlayer</span><span class="p">;</span>
<span class="cm">/*to_export.__js_pl_all = this;*/</span>
<span class="nx">to_export</span><span class="p">.</span><span class="nx">__inject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">as</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">to</span><span class="p">[</span><span class="nx">as</span><span class="p">]</span> <span class="o">=</span> <span class="nx">to_export</span><span class="p">;</span>
  <span class="nx">to</span><span class="p">.</span><span class="nx">createPlayer</span> <span class="o">=</span> <span class="nx">to_export</span><span class="p">.</span><span class="nx">createPlayer</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">return</span> <span class="nx">to_export</span><span class="p">;</span>

<span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-212">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-212">&#182;</a>               </div>               <p>We add all required public things as the child objects of given namespace (<code>anm</code>) to the given global object
(<code>window</code> or <code>exports</code>, it depends on platform, browser or some server-side JS like <strong>node.js</strong>)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">anm</span><span class="p">.</span><span class="nx">__inject</span><span class="p">(</span><span class="s1">&#39;anm&#39;</span><span class="p">,</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span>
                    <span class="o">?</span> <span class="nb">window</span>
                    <span class="o">:</span> <span class="nx">exports</span><span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 