<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">var utils = require(&#39;./utils.js&#39;),
    SystemError = require(&#39;./errors.js&#39;).SystemError,
    PlayerError = require(&#39;./errors.js&#39;).PlayerError,
    engine = require(&#39;engine&#39;),
    global_opts = require(&#39;./global_opts.js&#39;),
    C = require(&#39;./constants.js&#39;),
    is = utils.is;

var Loader = {};

Loader.loadFromUrl = function(player, url, importer, callback) {
    if (!JSON) throw new SystemError(Errors.S.NO_JSON_PARSER);

    mporter = importer || anm.importers.create(&#39;animatron&#39;);

    var url_with_params = url.split(&#39;?&#39;);
        url = url_with_params[0];
    var url_params = url_with_params[1], // TODO: validate them?
        params = (url_params &amp;&amp; url_params.length &gt; 0) ? utils.paramsToObj(url_params) : {},
        options = optsFromUrlParams(params);

    if (options) {
        player._addOpts(options);
        player._checkOpts();
    }

    var failure = player.__defAsyncSafe(function(err) {
        throw new SystemError(utils.strf(Errors.P.SNAPSHOT_LOADING_FAILED,
                               [ (err ? (err.message || err) : &#39;¿Por qué?&#39;) ]));
    });

    var success = function(req) {
        try {
            Loader.loadFromObj(player, JSON.parse(req.responseText), importer, function(anim) {
                player._applyUrlParamsToAnimation(params);
                if (callback) callback.call(player, anim);
            });
        } catch(e) { failure(e); }
    };

    var anm_cookie = engine.getCookie(&#39;_animatronauth&#39;);

    engine.ajax(url, success, failure, &#39;GET&#39;,
        anm_cookie ? { &#39;Animatron-Security-Token&#39;: anm_cookie } : null);
};

Loader.loadFromObj = function(player, object, importer, callback) {
    if (!importer) throw new PlayerError(Errors.P.NO_IMPORTER_TO_LOAD_WITH);
    var anim = importer.load(object);
    player.fire(C.S_IMPORT, importer, anim, object);
    Loader.loadAnimation(player, anim, callback);
};

Loader.loadAnimation = function(player, anim, callback) {
    if (player.anim) player.anim.dispose();
    // add debug rendering
    if (player.debug &amp;&amp; !global_opts.liveDebug)
        anim.visitElems(function(e) {e.addDebugRender();}); /* FIXME: ensure not to add twice */
    if (!anim.width || !anim.height) {
        anim.width = player.width;
        anim.height = player.height;
    } else if (player.forceAnimationSize) {
        player._resize(anim.width, anim.height);
    }
    // assign
    player.anim = anim;
    if (callback) callback.call(player, anim);
};

Loader.loadElements = function(player, elms, callback) {
    var anim = new Animation();
    anim.add(elms);
    Loader.loadAnimation(player, anim, callback);
};

var optsFromUrlParams = function(params/* as object */) {
    function __boolParam(val) {
        if (!val) return false;
        if (val === 0) return false;
        if (val == 1) return true;
        if (val == &#39;false&#39;) return false;
        if (val == &#39;true&#39;) return true;
        if (val == &#39;off&#39;) return false;
        if (val == &#39;on&#39;) return true;
        if (val == &#39;no&#39;) return false;
        if (val == &#39;yes&#39;) return true;
    }
    function __extractBool() {
        var variants = arguments;
        for (var i = 0; i &lt; variants.length; i++) {
            if (is.defined(params[variants[i]])) return __boolParam(params[variants[i]]);
        }
        return undefined;
    }
    var opts = {};
    opts.debug = is.defined(params.debug) ? __boolParam(params.debug) : undefined;
    opts.muteErrors = __extractBool(&#39;me&#39;, &#39;muterrors&#39;);
    opts.repeat = __extractBool(&#39;r&#39;, &#39;repeat&#39;);
    opts.autoPlay = __extractBool(&#39;a&#39;, &#39;auto&#39;, &#39;autoplay&#39;);
    opts.mode = params.m || params.mode || undefined;
    opts.zoom = params.z || params.zoom;
    opts.speed = params.v || params.speed;
    opts.width = params.w || params.width;
    opts.height = params.h || params.height;
    opts.infiniteDuration = __extractBool(&#39;i&#39;, &#39;inf&#39;, &#39;infinite&#39;);
    opts.audioEnabled = __extractBool(&#39;s&#39;, &#39;snd&#39;, &#39;sound&#39;, &#39;audio&#39;);
    opts.controlsEnabled = __extractBool(&#39;c&#39;, &#39;controls&#39;);
    opts.infoEnabled = __extractBool(&#39;info&#39;);
    opts.loadingMode = params.lm || params.lmode || params.loadingmode || undefined;
    opts.thumbnail = params.th || params.thumb || undefined;
    opts.bgColor = params.bg || params.bgcolor;
    opts.ribbonsColor = params.ribbons || params.ribcolor;
    return opts;
};

module.exports = Loader;
</pre>
</body>
</html>
