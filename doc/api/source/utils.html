<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">var C = require(&#39;./constants.js&#39;),
    SystemError = require(&#39;./errors.js&#39;).SystemError;

var is = {};

// FIXME: rename all to full-names
is.defined = function(v) {
  return !((typeof v === &#39;undefined&#39;)
   || (v === null)
   || (v === undefined));
};
is.finite = global.isFinite;
is.nan = global.isNaN;
is.arr = Array.isArray;
is.num = function(n) {
  n = global.parseFloat(n);
  return !is.nan(n) &amp;&amp; is.finite(n);
};
is.fun = function(f) {
  return typeof f === &#39;function&#39;;
};
is.obj = function(o) {
  return typeof o === &#39;object&#39;;
};
is.str = function(s) {
  return typeof s === &#39;string&#39;;
};
is.not_empty = function(obj) {
    if (Object.keys) return (Object.keys(obj).length &gt; 0);
    else return (Object.getOwnPropertyNames(obj).length &gt; 0);
};

is.modifier = function(f) {
  return f.hasOwnProperty(C.MARKERS.MODIFIER_MARKER);
};
is.painter = function(f) {
  return f.hasOwnProperty(C.MARKERS.PAINTER_MARKER);
};
is.tween = function(f) {
  return f.is_tween &amp;&amp; is.modifier(f);
};

// Iterator
// -----------------------------------------------------------------------------

function StopIteration() {}
function iter(a) {
    if (a.__iter) {
        a.__iter.reset();
        return a.__iter;
    }
    var pos = 0,
        len = a.length;
    return (a.__iter = {
        next: function() {
                  if (pos &lt; len) return a[pos++];
                  pos = 0;
                  throw new StopIteration();
              },
        hasNext: function() { return (pos &lt; len); },
        remove: function() { len--; return a.splice(--pos, 1); },
        reset: function() { pos = 0; len = a.length; },
        get: function() { return a[pos]; },
        each: function(f, rf) {
                  this.reset();
                  while (this.hasNext()) {
                    if (f(this.next()) === false) {
                        if (rf) rf(this.remove()); else this.remove();
                    }
                  }
              }
    });
}


function fmt_time(time) {
  if (!is.finite(time)) return &#39;âˆž&#39;;
  var absTime = Math.abs(time),
      h = Math.floor(absTime / 3600),
      m = Math.floor((absTime - (h * 3600)) / 60),
      s = Math.floor(absTime - (h * 3600) - (m * 60));

  return ((time &lt; 0) ? &#39;-&#39; : &#39;&#39;) +
          ((h &gt; 0)  ? (((h &lt; 10) ? (&#39;0&#39; + h) : h) + &#39;:&#39;) : &#39;&#39;) +
          ((m &lt; 10) ? (&#39;0&#39; + m) : m) + &#39;:&#39; +
          ((s &lt; 10) ? (&#39;0&#39; + s) : s)
}

function ell_text(text, max_len) {
    if (!text) return &#39;&#39;;
    var len = text.length;
    if (len &lt;= max_len) return text;
    var semilen = Math.floor(_len / 2) - 2;
    return text.slice(0, semilen) + &#39;...&#39;
         + text.slice(len - semilen);
}

// ### Internal Helpers
/* -------------------- */

// #### mathematics

function compareFloat(n1, n2, precision) {
    if (precision !== 0) {
        precision = precision || 2;
    }
    var multiplier = Math.pow(10, precision);
    return Math.round(n1 * multiplier) ==
           Math.round(n2 * multiplier);
}

function roundTo(n, precision) {
    if (!precision) return Math.round(n);
    //return n.toPrecision(precision);
    var multiplier = Math.pow(10, precision);
    return Math.round(n * multiplier) / multiplier;
}

function interpolateFloat(a, b, t) {
    return a*(1-t)+b*t;
}

// #### other

function paramsToObj(pstr) {
    var o = {}, ps = pstr.split(&#39;&amp;&#39;), i = ps.length, pair;
    while (i--) { pair = ps[i].split(&#39;=&#39;); o[pair[0]] = pair[1]; }
    return o;
}

// for one-level objects, so no hasOwnProperty check
function obj_clone(what) {
    var dest = {};
    for (var prop in what) {
        dest[prop] = what[prop];
    }
    return dest;
}

function mrg_obj(src, backup, trg) {
    if (!backup) return src;
    var res = trg || {};
    for (var prop in backup) {
        res[prop] = is.defined(src[prop]) ? src[prop] : backup[prop]; };
    return res;
}

function strf(str, subst) {
    var args = subst;
    return str.replace(/{(\d+)}/g, function(match, number) {
      return is.defined(args[number])
        ? args[number]
        : match
      ;
    });
}

// collects all characters from string
// before specified char, starting from start
function collect_to(str, start, ch) {
    var result = &#39;&#39;;
    for (var i = start; str[i] !== ch; i++) {
        if (i === str.length) throw new SystemError(&#39;Reached end of string&#39;);
        result += str[i];
    }
    return result;
}


function guid() {
   return Math.random().toString(36).substring(2, 10) +
          Math.random().toString(36).substring(2, 10);
}

function fit_rects(pw, ph, aw, ah) {
    // pw == player width, ph == player height
    // aw == anim width,   ah == anim height
    var xw = pw / aw,
        xh = ph / ah;
    var factor = Math.min(xw, xh);
    var hcoord = (pw - aw * factor) / 2,
        vcoord = (ph - ah * factor) / 2;
    if ((xw != 1) || (xh != 1)) {
        var anim_rect = [ hcoord, vcoord, aw * factor, ah * factor ];
        if (hcoord !== 0) {
            return [ factor,
                     anim_rect,
                     [ 0, 0, hcoord, ph ],
                     [ hcoord + (aw * factor), 0, hcoord, ph ] ];
        } else if (vcoord !== 0) {
            return [ factor,
                     anim_rect,
                     [ 0, 0, aw, vcoord ],
                     [ 0, vcoord + (ah * factor), aw, vcoord ] ];
        } else return [ factor, anim_rect ];
    } else return [ 1, [ 0, 0, aw, ah ] ];
}

// TODO: add array cloning

module.exports = {
    fmt_time: fmt_time,
    ell_text: ell_text,
    compareFloat: compareFloat,
    roundTo: roundTo,
    interpolateFloat: interpolateFloat,
    paramsToObj: paramsToObj,
    obj_clone: obj_clone,
    mrg_obj: mrg_obj,
    strf: strf,
    collect_to: collect_to,
    guid: guid,
    fit_rects: fit_rects,
    is: is,
    iter: iter
};
</pre>
</body>
</html>
